# 第七章：Linux 上的 DHCP 服务

在本章中，我们将涵盖几个涉及**动态主机控制协议（DHCP**）的主题。顾名思义，DHCP 用于提供主机连接到网络所需的基本信息，并在某些情况下提供其他配置的位置，这使其成为大多数基础设施的关键部分。

在本章中，我们将介绍这种协议的基本工作原理，然后逐步构建和最终解决 DHCP 服务的问题，具体包括：

+   DHCP 是如何工作的？

+   保护您的 DHCP 服务

+   安装和配置 DHCP 服务器

让我们开始吧！

# DHCP 是如何工作的？

让我们首先描述 DHCP 实际是如何工作的。我们将首先看一下 DHCP 请求和响应中的数据包是如何工作的 - 客户端请求了什么信息，服务器提供了什么信息，以及它是如何工作的。然后我们将开始讨论 DHCP 选项如何在许多实现中发挥作用。

## 基本的 DHCP 操作

**DHCP**允许系统管理员在服务器上集中定义设备配置，以便当这些设备启动时，它们可以请求这些配置参数。这种*中央配置*几乎总是包括 IP 地址、子网掩码、默认网关、DNS 服务器和 DNS 域名的基本网络参数。在大多数组织中，这意味着在大多数情况下，几乎没有设备获得静态 IP 地址或其他网络定义；所有工作站网络配置都是由 DHCP 服务器设置的。当我们更深入地探讨协议时，您将看到 DHCP 的其他用途通常是*附加*到这些基本设置上。

DHCP 过程是从客户端发送广播**DISCOVER**数据包开始的，基本上是在说“有没有 DHCP 服务器？这是我正在寻找的信息。” DHCP 服务器然后回复一个**OFFER**数据包，其中包含所有信息。客户端回复一个**REQUEST**数据包，这个名字似乎有点奇怪 - 基本上，客户端是通过确认的方式将刚刚从服务器得到的信息发送回去。然后服务器再次发送最终的**ACKNOWLEDGEMENT**数据包，再次包含相同的信息，再次确认。

这通常被称为**DORA**序列（**Discover, Offer, Request, Acknowledgement**），通常是这样描述的：

![图 7.1 - DHCP DORA 序列](img/B16336_07_001.jpg)

图 7.1 - DHCP DORA 序列

由于这些都是 UDP 数据包，请记住 UDP 协议中没有内置的会话信息，那么是什么将这四个数据包绑定成一个“会话”？为此，初始的 Discover 数据包具有一个事务 ID，在三个后续数据包中匹配 - 下面显示的 Wireshark 跟踪说明了这一点：

![图 7.2 - 在 Wireshark 中显示的 DHCP DORA 序列](img/B16336_07_002.jpg)

图 7.2 - 在 Wireshark 中显示的 DHCP DORA 序列

重要提示

客户端实际上直到第四个数据包才有地址，因此 Discover 和 Request 数据包来自客户端的 MAC 地址，IP 地址为`0.0.0.0`，发送到广播地址`255.255.255.255`（即整个本地网络）。

现在我们了解了 DHCP 工作的基础知识，我们看到它严重依赖于广播地址，这些地址限制在本地子网。在更实际的设置中，我们如何在不同的子网中使用 DHCP，甚至可能在不同的城市或国家中使用 DHCP 服务器？

## 来自其他子网的 DHCP 请求（转发器、中继或辅助程序）

但是，您可能会说 - 在许多公司网络中，服务器位于它们自己的子网上 - 将服务器和工作站分开是一种非常常见的做法。在这种情况下，DHCP 序列是如何工作的？DORA 序列的前三个数据包发送到广播地址，因此它们只能到达同一 VLAN 上的其他主机。

我们通过在客户端子网上的主机上放置 DHCP“转发器”或“中继”进程来完成工作。该进程接收本地广播，然后将其转发到 DHCP 服务器作为单播。当服务器回复（作为单播到转发器主机）时，转发器将数据包转换回客户端期望的广播回复。几乎总是在客户端子网上的路由器或交换机 IP 地址上执行此转发器功能 - 换句话说，最终将成为客户端默认网关的接口。这个功能在技术上不需要在该接口上，但我们知道该接口将存在，并且该功能几乎总是可供我们使用。此外，如果我们将其作为一种不成文的惯例使用，那么如果以后需要更改它，就更容易找到该命令！在思科路由器或交换机上，此命令如下：

```
interface VLAN <x>  ip helper-address 10.10.10.10
```

这里，`10.10.10.10`是我们的 DHCP 服务器的 IP。

在操作中，这将改变大多数家庭网络上的简单广播操作，以包括到位于另一个子网上的 DHCP 服务器的单播“腿”：

![图 7.3 - DHCP 中继或转发器操作](img/B16336_07_003.jpg)

图 7.3 - DHCP 中继或转发器操作

这如何修改我们的 DORA 序列？简短的答案是它实际上并没有修改任何数据包的 DHCP 内容。它所做的是修改数据包中的上层“IP 地址”字段 - 在路由器和服务器之间修改的数据包具有“真实”的源和目的地 IP 地址。然而，客户端看到的数据包内容保持不变。如果您深入研究 DHCP 数据包，您会发现无论是否使用中继，DHCP 客户端 MAC 地址和 DHCP 服务器 IP 地址实际上都包含在第 7 层 DHCP 协议的数据字段中。

我们现在已经具备了为基本工作站操作配置 DHCP 服务器的条件，但在开始之前，我们需要考虑一下我们需要为 iPhone、**无线接入点（WAP）**或甚至**预执行环境（PXE）**设备等特殊用途设备提供什么信息。

## DHCP 选项

在 DHCP Discover 数据包中发送的选项基本上是客户端知道如何处理的 DHCP 网络参数列表。服务器的 Offer 数据包将尽可能填充此列表。最常见的请求的选项（并在服务器上配置）如下：

+   子网掩码

+   路由器（默认网关）

+   DNS 服务器列表

+   DNS 域名

有关 DHCP 选项的更完整参考可以在 IANA 网站上找到，[`www.iana.org/assignments/bootp-dhcp-parameters/bootp-dhcp-parameters.xhtml`](https://www.iana.org/assignments/bootp-dhcp-parameters/bootp-dhcp-parameters.xhtml)，或者在相关的 RFC 中找到：[`tools.ietf.org/html/rfc2132`](https://tools.ietf.org/html/rfc2132)。

然而，在许多公司网络中，您可能会看到其他请求和提供的信息 - 这通常是为了支持**Voice over IP（VOIP）**电话的启动。这些选项通常是特定于供应商的，但在大多数情况下，客户端设备将请求的信息列表如下：

+   **我需要在哪个 VLAN 上？**：这个选项在现代网络中使用得较少，而是更倾向于使用**链路层发现协议（LLDP）**在交换机上识别 VOICE VLAN。在思科交换机上，只需在 VLAN 定义中添加 voice 关键字即可。

+   **我将连接到的 PBX 的 IP 是多少？**

+   **我应该连接到哪个 TFTP 或 HTTP 服务器以收集我的硬件配置？**

如果服务器有所请求的信息，它将在 DHCP 提供中作为服务器的响应数据包提供。

通常，您会看到以下 DHCP 选项，但如果您使用不同的电话手柄供应商，当然，您的情况可能会有所不同：

![](img/Table_012.jpg)

请注意，Mitel 和 Shortel 电话使用相同的 DHCP 选项，但语法略有不同。

DHCP 选项有时也用于告诉 WAP 使用哪个 IP 地址来找到它们的控制器，控制 PXE 站的引导顺序，或者任何其他自定义用途。在大多数情况下，DHCP 选项的作用是确保远程设备获取它需要的信息，以便从一个中心位置引导启动，而无需为每个设备进行配置。如果您需要这些选项用于您的特定设备，详细信息将在供应商的文档中（查找**DHCP 选项**）。

如果您正在解决 DHCP 序列的问题，特别是为什么 DHCP 选项的工作方式不如您所期望的那样，任何特定设备所需的 DHCP 选项将始终包含在初始的 Discover 数据包中，即 DORA 序列中的第一个数据包。始终从那里开始调查，您通常会发现所请求的 DHCP 选项并非配置的选项。

现在我们已经了解了 DHCP 的基本原理，我们如何才能使其免受常见攻击或操作问题的影响呢？

# 保护您的 DHCP 服务

关于 DHCP 的有趣之处在于，在几乎所有情况下，保护服务是在网络交换机上进行的，而不是在 DHCP 服务器本身上进行的。在大多数情况下，DHCP 服务器接收匿名请求，然后适当地回复 - 没有太多机会在不增加太多复杂性（使用签名和 PKI，我们将介绍），或者通过维护授权的 MAC 地址列表（这将增加很多复杂性）的情况下保护我们的服务。这两种方法都与拥有 DHCP 服务的初衷背道而驰，即“自动”对工作站、电话和其他网络连接设备进行网络配置，而不增加太多复杂性或管理开销。

那么我们如何保护我们的服务呢？让我们看一些攻击场景，然后添加最常见的防御措施。

## 恶意 DHCP 服务器

首先，让我们看看`192.168.1.0/24`或`192.168.0.0/24`，这几乎总是*不*是我们在工作中配置的。因此，一旦连接到网络，工作站将开始在此子网上获取地址，并且将失去与真正的企业网络的连接。

我们如何防御？答案在网络交换机上。我们在每个交换机上评估拓扑结构，并决定哪些端口可以信任发送 DHCP Offer 数据包 - 换句话说，“哪些端口引导我们到 DHCP 服务器？”这几乎总是交换机上行链路，这是我们连接服务器的链路。

一旦在交换机上识别出来，我们启用所谓的**DHCP 监听**，指示交换机检查 DHCP 数据包。这是按 VLAN 逐个进行的，在大多数环境中，我们通常列出所有 VLAN。然后我们配置我们的上行端口为“受信任”以发送 DHCP 数据包。这通常是一个非常简单的配置更改，看起来类似于这样（显示了 Cisco 配置）：

```
ip dhcp snooping vlan 1 2 10
interface e1/48
    ip dhcp snooping trust
```

如果在任何端口或 IP 地址上接收到 DHCP Offer 数据包，而不是我们配置为“受信任”的端口，默认情况下，该端口将被关闭，并发送警报（尽管您可以配置它们只发送警报）。然后，该端口处于所谓的*错误禁用*状态，通常需要网络管理员追踪根本原因并进行修复。这使得日志记录和警报过程非常重要。如果这对您的组织立即很重要，您可以直接跳到*第十三章*，*Linux 上的入侵防护系统*。

对于一些交换机供应商，我们可以信任 DHCP 服务器 IP 而不是上行端口。例如，在 HP 交换机上，我们仍然可以使用上面概述的方法，但我们还可以根据 IP 地址添加一个更简单的配置：

```
dhcp-snooping
dhcp-snooping vlan 1 2 10
dhcp-snooping authorized-server <server ip address>
```

在较大的网络中，这种方法使我们的配置变得更加简单 – 无需识别可能与交换机不同的上行端口；这两行可以简单地复制到所有工作站交换机上。

当我们到达服务器 VLAN 和数据中心交换机时，我们面临的事实是我们的 DHCP 服务器很可能是一个虚拟机。这给我们留下了两种选择 – 要么我们在连接到我们的虚拟化服务器的所有上行端口上配置 DHCP 信任，要么在服务器交换机上，我们根本不配置 DHCP 监听或信任。这两种选择都是有效的选择，老实说，第二种选择是我们经常看到的 – 在许多情况下，网络管理员可以相信服务器交换机在一个封闭的房间或机柜中，这成为我们的 DHCP 服务的安全层。这也意味着服务器和虚拟化管理员在进行服务器端的更改时不需要太多考虑物理网络（或在许多情况下根本不需要涉及网络管理员）。

我们确实提到“意外的 DHCP 服务器”是迄今为止最常见的恶意 DHCP 服务器攻击。但是有关有意的 DHCP 服务器攻击呢？这些攻击是什么样的？第一种情况是 DHCP 服务器将恶意主机添加为默认网关（通常是它自己）。当接收到数据包时，恶意主机将检查要窃取、窥视或修改的流量信息，然后将其转发到合法路由器（该子网的默认网关）：

![图 7.4 – 使用 DHCP 的第 3 层 MiTM 攻击](img/B16336_07_004.jpg)

图 7.4 – 使用 DHCP 的第 3 层 MiTM 攻击

另一种情况是，恶意 DHCP 服务器向客户端提供了所有正确的信息，但在 DHCP 租约中添加了一个“额外”的 DHCP 信息 – DHCP 选项`252`。选项`252`是一个文本字符串，指向一个`http://<恶意服务器>/link/<filename.pac>`。PAC 文件是特殊格式的。攻击者将其构建为使用他们的恶意代理服务器来针对目标网站，并对其他网站的 Web 流量进行正常路由。这两种**中间人**（通常缩写为**MiTM**）的意图是窃取凭据 – 当您浏览到目标网站，如 PayPal、Amazon 或您的银行时，攻击者将准备好一个假网站来收集您的用户 ID 和密码。这通常被称为**WPAD 攻击**（**Windows 代理自动发现**），因为它对默认情况下配置为信任 DHCP 服务器获取代理设置的 Windows 客户端非常成功。在大多数情况下，WPAD 攻击是首选，因为攻击者不必担心解密 HTTPS、SSH 或任何其他加密流量：

![图 7.5 – WPAD 攻击 – 恶意 DHCP 服务器设置代理服务器](img/B16336_07_005.jpg)

图 7.5 – WPAD 攻击 – 恶意 DHCP 服务器设置代理服务器

在这两种恶意 DHCP 服务器的情况下，我们的“DHCP 信任”防御效果非常好。

WPAD 攻击的另一个防御措施是在 DNS 服务器上为 WPAD 添加 DNS 条目– `yourinternaldomain.com`。这对于 WPAD 攻击可以结合其他攻击（特别是针对任何多播 DNS 协议，如 LLMNR）是有帮助的，但如果该主机名有 DNS 条目，那么这些攻击就会被很好地规避。此外，记录所有对 WPAD 等可疑主机名的 DNS 请求是帮助您在攻击发生时识别和定位攻击的绝佳实践。

但是，如何防范来自其他方向的攻击呢？未经授权的客户端呢？

## Rogue DHCP 客户端

较少见的攻击向量是恶意的 DHCP 客户端-一个人将他们的服务器从家里带到工作中的未使用的以太网端口，或者将一个微型的、专门设计的攻击 PC（通常称为**pwnplug**）插入大堂或任何可访问的位置的未使用的以太网端口。这些地方的后面，植物、打印机或其他障碍物是这些攻击的最爱位置。

对抗这种攻击的老派方法是在公司中保留所有授权的 MAC 地址的数据库，并将它们设置为 DHCP 中的授权客户端，或者为每个客户端设置一个静态的 DHCP 保留。在现代企业中，这两种方法都不是理想的。首先，这是一个相当重要的管理过程。我们正在为服务器团队的流程添加手动库存组件。由于 DHCP 服务器通常是一个低开销的服务器组件，没有人会对此感到高兴。其次，如果采用“静态保留”方法，您将需要为客户端可能需要连接的每个 VLAN、无线 SSID 或可能的位置添加保留。不用说，大多数组织都不喜欢这两种方法。

防止未经授权的客户端的较新方法是使用 802.1x 认证，其中客户端必须在被允许连接到网络之前进行身份验证。这涉及使用*Linux 的 RADIUS 服务*（*第九章*）和*Linux 上的证书服务*（*第八章*）。证书用于强制执行信任-客户端需要信任 RADIUS 服务器，更重要的是，RADIUS 服务器需要信任连接的客户端，以便进行安全的认证。正如您所期望的那样，我们将在本书的后面部分介绍这个解决方案（在*第八章*中，*Linux 上的证书服务*和*第九章*中，*Linux 的 RADIUS 服务*）。

完成所有这些理论的学习和内化后，让我们开始配置 DHCP 服务器。

# 安装和配置 DHCP 服务器

我们将把配置任务分成三个部分：

+   DHCP 服务器和范围的基本配置

+   DHCP 租约的静态保留-例如，用于服务器或打印机。

+   使用 DHCP 日志进行网络智能和库存检查或人口统计。

让我们开始吧。

## 基本配置

正如您所期望的，我们将从`apt`命令开始我们的旅程，在我们的实验室主机上安装 ISC DHCP 服务器：

```
$ sudo apt-get install isc-dhcp-server
```

安装完成后，我们可以配置基本的服务器选项。设置租约时间和任何不依赖于范围的内容-例如，我们将配置中央 DNS 服务器。另外，请注意我们正在添加一个 ping 检查-在分配租约之前，主机会 ping 候选地址，以确保没有其他人静态分配了它。这是一个很好的检查，可以避免重复的 IP 地址，默认情况下是关闭的。在我们的示例中，ping 的超时设置为 2 秒（默认值为 1 秒）。请注意，对于某些 dhcpd 服务器，`ping-check`参数可能会缩短为`ping`。

还要注意租约时间变量。这些变量决定 DHCP“租约”有效的时间以及客户端何时开始请求租约续订。这些对几个原因很重要：

+   尽管我们努力将 IP 地址与各种诊断工具分离，但在事件响应中，能够相对依赖地址不会发生太大变化是非常有帮助的。例如，如果您正在解决一个问题，并且在问题发生之初确定了某人的工作站 IP 地址，如果您能够依赖在接下来的 3-4 天内不会发生变化，那将非常有帮助。这意味着您可以只针对所有相关日志进行一次基于地址的搜索，这非常有帮助。因此，内部工作站 DHCP 租约通常设置为长达 4 天的周末或长达 2-3 周的假期，保持 DHCP 租约在这段时间内有效。

+   当然，例外情况是访客网络，特别是访客无线网络。如果您不将访客地址与其身份或其赞助者的身份关联起来，那么在这里设置较短的租约时间会有所帮助。此外，访客网络通常会看到更多“瞬时”用户的出现和离开，因此较短的租约时间可以在一定程度上保护您免受地址池枯竭的影响。如果您曾经在具有较短租约时间的“匿名访客”网络上进行事件响应，您很可能会基于 MAC 地址而不是 IP 地址来建立“伪身份”（并以相同的方式阻止可疑主机）。

可用的三个租约时间变量如下：

+   `default-lease-time`：如果客户端没有请求租约时间，则租约的持续时间

+   最长租约时间：服务器能够提供的最长租约时间

+   `min-lease-time`：如果客户端请求的租约时间短于此间隔，则用于强制客户端使用更长的租约

在所有情况下，客户端可以在协商的租约间隔的 50%点开始请求租约续订。

让我们编辑 DHCP 服务器的主配置-`/etc/dhcp/dhcpd.conf`。确保使用`sudo`以便在编辑此文件时具有适当的权限：

```
default-lease-time 3600;
max-lease-time 7200;
ping true;
ping-timeout 2;
option domain-name-servers 192.168.122.10, 192.168.124.11;
```

在文件中稍后取消注释`authoritative`参数：

```
# If this DHCP server is the official DHCP server for the local
# network, the authoritative directive should be uncommented.
authoritative;
```

在文件的末尾，添加范围的详细信息。请注意，如果您正在部署新的子网，请尽量避免使用`192168.0.0/24`或`192.168.1.0/24`-因为这些在家庭网络中经常使用，在工作中使用它们可能会给远程人员造成很大的麻烦。如果他们使用 VPN，他们将不得不处理两个不同的`192.168.1.0`网络-其中一个可能无法访问：

```
# Specify the network address and subnet-mask
  subnet 192.168.122.0 netmask 255.255.255.0 {
  # Specify the default gateway address
  option routers 192.168.122.1;
  # Specify the subnet-mask
  option subnet-mask 255.255.255.0;
  # Specify the range of leased IP addresses
  range 192.168.122.10 192.168.122.200;
}
```

这也是您可以放置任何其他 DHCP 选项的地方，我们在本章前面讨论过这些选项-例如，支持 VOIP 电话、PXE 主机或无线接入点的选项。

最后，重新启动 DHCP 服务器：

```
$ sudo systemctl restart isc-dhcp-server.service
```

仅供娱乐，如果您希望客户端尝试使用他们的信息更新 DNS 服务器，可以添加以下内容：

```
ddns-update-style interim;
# If you have fixed-address entries you want to use dynamic dns
update-static-leases on;
```

现在，让我们将我们的基本配置扩展到包括静态预留-使用 DHCP 为打印机或其他网络设备（如时间钟、IP 摄像头、门锁甚至服务器）分配固定 IP 地址。

## 静态预留

要为主机添加静态定义，我们在`dhcpd.conf`中添加一个`host`部分。在其最基本的配置中，我们在看到特定 MAC 地址时分配一个固定的 IP 地址：

```
host PrtAccounting01 {
  hardware ethernet 00:b1:48:bd:14:9a;
  fixed-address 172.16.12.49;}
```

在某些情况下，工作站可能会漫游-例如，如果设备是无线的，并且可能在不同时间出现在不同的网络中，我们将希望分配其他选项，但保留 IP 地址动态。在这种情况下，我们告诉设备使用什么 DNS 后缀，并如何使用动态 DNS 进行注册：

```
host LTOP-0786 {
    hardware ethernet 3C:52:82:15:57:1D;
    option host-name "LTOP-0786";
    option domain-name "coherentsecurity.com";
    ddns-hostname "LTOP-786";
    ddns-domain-name "coherentsecurity.com";
}
```

或者，要为一组主机添加静态定义，请执行以下命令：

```
group {
    option domain-name "coherentsecurity.com";
    ddns-domainname "coherentsecurity";
    host PrtAccounting01 {
        hardware ethernet 40:b0:34:72:48:e4;
        option host-name "PrtAccounting01";
        ddns-hostname "PrtAccounting01";
        fixed-address 192.168.122.10;
    }
    host PrtCafe01 {
        hardware ethernet 00:b1:48:1c:ac:12;
        option host-name "PrtCafe01";
        ddns-hostname "PrtCafe01";
        fixed-address 192.168.125.9
    }
}
```

现在我们已经配置并运行了 DHCP，如果出现故障，我们有哪些工具可以帮助进行故障排除？让我们首先查看 DHCP 租约信息，然后深入分析`dhcpd`守护程序的日志。

## 日常使用中的简单 DHCP 日志记录和故障排除

要查看当前 DHCP 租约列表，请使用`dhcp-lease-list`命令，该命令应该给出以下列表（请注意，文本已换行；此输出每个设备租约一行）：

```
$ dhcp-lease-list
Reading leases from /var/lib/dhcp/dhcpd.leases
MAC                IP              hostname       valid until         manufacturer
===============================================================================================
e0:37:17:6b:c1:39  192.168.122.161 -NA-           2021-03-22 14:53:26 Technicolor CH USA Inc.
```

请注意，此输出已从每个 MAC 地址中提取了 OUI，因此，例如，您可以使用此命令及其输出来寻找“奇怪”的 NIC 类型。这些在您的 VOIP 子网或大多数移动设备的子网中应立即显眼。即使在标准数据 VLAN 中，基于 OUI 的奇怪设备类型通常也很容易被发现。当客户端有一个标准的电话类型并且在第一次看到 OUI 提取时发现了一个非品牌电话，或者如果他们是 Windows 商店并且看到了他们没有预期的苹果电脑时，我经常看到这种情况。

您可以轻松地将租约信息“收集”到您选择的电子表格中，以便您可以修改该列表以满足您的需求，或者满足您的库存应用程序对输入的需求。或者，如果您只想将 MAC 地址提取到主机名表中，例如，执行以下命令：

```
$ dhcp-lease-list | sed –n '3,$p' |  tr –s " " | cut –d " " –f 1,3 > output.txt
```

用通俗的语言来说，这意味着运行`dhcp-lease-list`命令。从第 3 行开始打印整个列表，删除重复的空格，然后使用单个空格作为列分隔符取列 1 和 3。

如果您需要更详细的信息，或者如果您正在调查过去发生的事件，您可能需要更多或不同的数据 - 为此，您需要日志。 DHCP 日志到`/var/log/dhcpd.log`，输出非常详细。例如，您可以收集任何特定 MAC 地址的整个 DORA 序列：

```
cat dhcpd.log | grep e0:37:17:6b:c1:39 | grep "Mar 19" | more
Mar 19 13:54:15 pfSense dhcpd: DHCPDISCOVER from e0:37:17:6b:c1:39 via vmx1
Mar 19 13:54:16 pfSense dhcpd: DHCPOFFER on 192.168.122.113 to e0:37:17:6b:c1:39 via vmx1
Mar 19 13:54:16 pfSense dhcpd: DHCPREQUEST for 192.168.122.113 (192.168.122.1) from e0:37:17:6b:c1:39 via vmx1
Mar 19 13:54:16 pfSense dhcpd: DHCPACK on 192.168.122.113 to e0:37:17:6b:c1:39 via vmx1
```

或者您可以迈出下一步，问“谁在这个日期使用了这个 IP 地址？”我们将收集整天的数据，以防多台主机可能使用了该地址。为了获得最终的地址分配，我们只需要确认（`DHCPACK`）数据包：

```
cat /var/log/dhcpd.log | grep 192.168.122.113 | grep DHCPACK | grep "Mar 19"
Mar 19 13:54:16 pfSense dhcpd: DHCPACK on 192.168.122.113 to
 e0:37:17:6b:c1:39 via vmx1
Mar 19 16:43:29 pfSense dhcpd: DHCPACK on 192.168.122.113 to e0:37:17:6b:c1:39 via vmx1
Mar 19 19:29:19 pfSense dhcpd: DHCPACK on 192.168.122.113 to e0:37:17:6b:c1:39 via vmx1
Mar 19 08:12:18 pfSense dhcpd: DHCPACK on 192.168.122.113 to e0:37:17:6b:c1:39 via vmx1
Mar 19 11:04:42 pfSense dhcpd: DHCPACK on 192.168.122.113 to e0:37:17:6b:c1:39 via vmx1
```

或者，更进一步地缩小范围，收集当天使用该 IP 地址的 MAC 地址，执行以下命令：

```
$ cat dhcpd.log | grep 192.168.122.113 | grep DHCPACK | grep "Mar 19" | cut -d " " -f 10 | sort | uniq
e0:37:17:6b:c1:39
```

现在我们有了从租约表和日志中提取 MAC 地址的工具，您可以在故障排除、更新库存或查找网络中的超出库存或“意外”主机时使用这些方法。我们将在本章的问答部分进一步探讨故障排除序列。

# 总结

通过讨论 DHCP 的内容，您现在应该有工具来为您的组织构建基本的 DHCP 服务器，无论是用于本地子网还是远程子网。您还应该能够实施基本的安全措施，以防止流氓 DHCP 服务器在您的网络上运行。从活动租约表和 DHCP 日志中提取基本数据应该是您组织工具包的一部分。

综合起来，这应该涵盖大多数组织在安装、配置和故障排除方面的需求，以及在库存输入和事件响应方面使用 DHCP。

在下一章中，我们将继续向我们的 Linux 主机添加核心网络服务。我们旅程的下一步将是使用**公钥基础设施**（**PKI**）-使用私人和公共证书颁发机构和证书来帮助保护我们的基础设施。

# 问题

最后，这里是一些问题列表，供您测试对本章材料的了解。您将在*附录*的*评估*部分找到答案：

1.  现在是星期一，一个远程销售办事处刚刚打电话给 Helpdesk 说他们没有获得 DHCP 地址。您将如何排除故障？

1.  您的工程部门没有网络访问权限，但您仍然可以访问子网。您将如何确定这是否与流氓 DHCP 服务器有关，如果是，您将如何找到该流氓设备？

# 进一步阅读

要了解更多关于这个主题的内容：

+   DHCP 监听和信任配置：

[`isc.sans.edu/forums/diary/Layer+2+Network+Protections+against+Man+in+the+Middle+Attacks/7567/`](https://isc.sans.edu/forums/diary/Layer+2+Network+Protections+against+Man+in+the+Middle+Attacks/7567/%20)

+   WPAD 攻击：

https://nakedsecurity.sophos.com/2016/05/25/when-domain-names-attack-the-wpad-name-collision-vulnerability/

https://us-cert.cisa.gov/ncas/alerts/TA16-144A

https://blogs.msdn.microsoft.com/ieinternals/2012/06/05/the-intranet-zone/

+   DHCP 和 DHCP 选项 RFC；还有关于 DHCP 选项的 IANA 参考：

动态主机配置协议：https://tools.ietf.org/html/rfc2131

DHCP 选项和**引导协议**（**BOOTP**）供应商扩展：https://tools.ietf.org/html/rfc2132

用于动态主机配置协议版本 4（DHCPv4）的供应商标识供应商选项：https://tools.ietf.org/html/rfc3925

DHCP 和 BOOTP 参数：https://www.iana.org/assignments/bootp-dhcp-parameters/bootp-dhcp-parameters.xhtml
