# 第十三章：*第十三章*：Linux 上的入侵防范系统

在本章中，我们将在数据包捕获和日志记录的基础上，探讨 Linux 平台上的入侵防范选项。**入侵防范系统**（**IPS**）确切地做了它听起来的事情-它监视流量，并且要么警报要么阻止可疑或已知的恶意流量。这可以通过各种方式来实现，具体取决于您要监视的流量。

特别是，我们将涵盖以下主题：

+   什么是 IPS？

+   架构/IPS 位置

+   Linux 的经典 IPS 解决方案-Snort 和 Suricata

+   IPS 回避技术

+   Suricata IPS 示例

+   构建 IPS 规则

+   被动流量监控

+   Zeek 示例-收集网络元数据

让我们开始吧！

# 技术要求

在本章的示例中，我们将使用预打包的虚拟机，基于**Suricata-Elasticsearch-Logstash-Kibana-Scurius**（**SELKS**）或 Security Onion（两种不同的预打包 Linux 发行版）。与我们的数据包捕获示例一样，IPS 解决方案通常针对捕获的流量进行操作，因此您可能需要参考*第十一章*，*Linux 中的数据包捕获和分析*，以确保您具有适当的 SPAN 端口配置。然而，IPS 解决方案通常与数据包流一起运行，通常具有一些解密功能-因此，您可能会发现自己更多地将架构与我们在*第十章*中的负载均衡器示例进行比较，*Linux 的负载均衡器服务*。

由于 IPS 安装经常更改，这反映在这两个发行版的安装中。因此，在本章中，我们不会详细介绍安装软件包等内容，请参考在线安装，以了解您想在实验室中探索的任何解决方案。或者，像往常一样，您可以选择跟随我们在本章中进行。虽然您可能确实想要实施我们将在本章中讨论的一些工具，但它们大多是复杂的-例如，您可能不想构建一个测试 IPS，直到您接近为生产构建一个 IPS。

# 什么是 IPS？

IPS 始于 20 世纪 90 年代的入侵检测系统。从一开始（早在 20 世纪 90 年代），最常用的 IDS/IPS 产品是 Snort，它仍然是一个产品（开源和商业），许多其他现代 IPS 产品现在都是基于它的。

IPS 监视已知攻击的网络流量，然后阻止它们。当然，在这个过程中有一些失败：

+   *列举恶意行为*是一个不错的失败命题，这是反病毒行业长期以来意识到的。无论您为何种签名模式列举，攻击者都可以进行相同的攻击，只需稍作修改即可逃避基于签名的检测。

+   误报是这些产品的一个负担。如果它们没有正确配置，签名可能会错误地标记正常流量为恶意并将其阻止。

+   在光谱的另一端，如果配置过于宽松，很容易不会警报或阻止攻击流量。

正如您所看到的，部署 IPS 通常需要频繁的调整。幸运的是，现代 IPS 系统通常设置了良好的默认值，可以阻止已知攻击的合理部分，并且存在误报。

调整组织的规则时，通常会看到每个规则都有一个严重性评级，这给您一些关于相关攻击有多严重的指示。规则还将具有忠实度评级，告诉您规则在检测攻击方面有多“可靠”，即这个规则在正常流量中误报的可能性有多大。您通常可以使用这两个评级来决定在您的情况下启用哪些规则。

既然我们已经提供了 IPS 解决方案的一些背景，让我们看看您可能希望在数据中心中插入 IPS 的位置。

# 架构选项 - 入侵防御系统在数据中心的位置？

在数据中心中放置入侵防御系统是一个重要的决定，因此我们将在提供入侵防御系统/入侵检测系统历史的同时讨论这个决定。

回顾过去，数据中心配置为“脆壳，软心”架构。换句话说，保护重点放在边缘，以防范外部攻击。内部系统大多是受信任的（通常是过于信任）。

这将使入侵检测系统处于边缘位置，通常在 SPAN 端口或网络监听器上。如果您回顾我们在《第十一章》中讨论的监听选项，*Linux 中的数据包捕获和分析*，如果以这种方式部署，通常是单向监听，电气上阻止入侵检测系统发送流量。这是为了最大程度地减少入侵检测系统本身可能被 compromise 的可能性。

第二个受信任的接口将用于管理入侵检测系统。

这种配置逐渐发展，最终包括入侵检测系统发送**RST**（**TCP 复位**）数据包给攻击者、防御者或两者，以终止任何攻击流量，如下图所示：

![图 13.1 - 入侵防御系统位于防火墙外部，SPAN 端口用于流量收集，并发送 RESET 数据包以阻止检测到的攻击](img/B16336_13_001.jpg)

图 13.1 - 入侵防御系统位于防火墙外部，SPAN 端口用于流量收集，并发送 RESET 数据包以阻止检测到的攻击

随着攻击变得更加被理解和互联网变得更加敌对，这种配置也发生了变化。在互联网上观察恶意流量变得不再那么有效，因为观察外部流量很可能只会产生持续的警报，因为攻击者开始将恶意软件和相关攻击商品化。

您仍然希望监视入站攻击，但在可能的情况下，您只希望监视可以应用于任何给定主机的攻击。例如，如果您的防火墙只允许邮件流量进入邮件服务器，那么寻找并警报针对该主机的基于网络的攻击就不再有意义。有了这种入站攻击的方法，我们现在看到入侵检测系统和入侵防御系统更频繁地部署在防火墙后面。

在同一时间段，我们开始看到恶意软件更多地通过电子邮件分发 - 特别是作为办公文档中的宏。有效地保护组织免受这些攻击变得困难，特别是因为许多组织已经围绕宏构建了工作流程，并拒绝禁用它们。这意味着非常有效地寻找来自受 Compromise 的工作站和服务器的出站流量，这将表明攻击成功。通常，这种流量采取**命令和控制**（**C2**）流量的形式，其中受 Compromise 的工作站联系攻击者以获取下一步的指示：

![图 13.2 - 防火墙内部的入侵防御系统检测 C2 流量。此外，一些互联网“噪音”被过滤掉](img/B16336_13_002.jpg)

图 13.2 - 防火墙内部的入侵防御系统检测 C2 流量。此外，一些互联网“噪音”被过滤掉

加密的兴起意味着将入侵防御系统置于半被动模式变得越来越不够有效。为了有效地检测攻击流量，在今天的互联网上，至少有一部分需要被解密。这意味着入侵防御系统必须处于线路中，通常在防火墙上运行。这种架构的变化与更便宜的处理器相配，使人们能够为他们的防火墙分配更多的 CPU（通常还有匹配的磁盘和内存）。

对于入站流量，这意味着 IPS 现在托管与目标服务器匹配的证书。它在 IPS 上解密，检查可疑内容，然后转发（通常重新加密）如果它得到绿灯。这应该看起来很熟悉，因为当我们讨论*第十章*中的负载均衡器时，我们讨论了一个非常相似的架构，*Linux 的负载均衡器服务*：

![图 13.3-周边防火墙上的 IPS。Web 服务器证书允许入站 HTTPS 解密](img/B16336_13_003.jpg)

图 13.3-周边防火墙上的 IPS。Web 服务器证书允许入站 HTTPS 解密

出站解密要复杂一些。为了使其工作，IPS 需要托管在其上的**证书颁发机构**（**CA**），内部工作站必须信任。当出站流量传输时，IPS 动态创建目标的证书，这就是用户现在在浏览器中查看的 HTTPS 证书。

这允许 IPS 解密出站流量。然后，从 IPS 到目标主机的出站流量将按照新的加密会话正常进行，使用目标主机上的真实证书。

当检测到攻击时，任何产生的警报都将具有客户工作站的 IP 地址。在 Windows/Active Directory 环境中，通常，IPS 将具有一个匹配的“代理”，用于监视每个域控制器的安全日志。这允许 IPS 将 IP 地址与在任何给定时间在该站点上使用的用户帐户名称进行匹配。

如果 IPS 和防火墙共享一个公共平台，这也允许防火墙根据用户帐户、组、证书信息（其中包括域名和通常是目标主机的 FQDN），以及基于源和目标 IP 地址、端口等的传统规则添加规则：

![图 13.4-周边防火墙上的 IPS。CA 证书允许出站客户端流量解密](img/B16336_13_004.jpg)

图 13.4-周边防火墙上的 IPS。CA 证书允许出站客户端流量解密

在同一时间，IPS 的一个特殊情况也在增长，被称为**Web 应用防火墙**（**WAFs**）。这些是主要专注于入站基于 Web 的攻击的设备。随着互联网几乎完全转向用于 Web 目的地的 HTTPS 内容，这些 WAF 解决方案也需要解密来检测大多数攻击。

起初，这些 WAF 解决方案采用专用设备的形式，但后来已经转变为大多数负载均衡器上可用的功能。最常见的开源 WAF 解决方案包括 ModSecurity（适用于 Apache 和 Nginx），但还有许多其他解决方案：

![图 13.5-入站 IPS（WAF）和解密托管在负载均衡器上，防火墙内](img/B16336_13_005.jpg)

图 13.5-入站 IPS（WAF）和解密托管在负载均衡器上，防火墙内

WAF 解决方案的主要问题与我们在传统 IPS 中看到的问题相同-覆盖范围要么太过激进，要么太过松散。在光谱的一端，有一些 WAF 解决方案不需要太多的配置-这些解决方案倾向于保护特定攻击，如跨站脚本或 SQL 注入，其中语法通常是可预测的，但不包括其他常见攻击。在光谱的另一端，我们有一些产品需要针对应用程序中的各个字段进行配置，以全面验证输入。这些产品工作得很好，但需要与应用程序匹配，因为更改和新功能的实施。如果不这样做，应用程序可能会被用来保护它的工具破坏。

新的 WAF 选项考虑到较大的基于云的网站通常不使用负载均衡器设备或防火墙。在某些情况下，它们通过**内容交付网络**（**CDN**）提供其内容，但即使它们直接从较大的云服务提供商中运行，它们也可能在互联网上。此外，对于上行速率为 10、40 或 100 Gbps 的较大站点，WAF 设备解决方案的扩展性并不那么好。

对于这些站点，防火墙被推送到主机本身（正如我们在*第四章*中讨论的那样，*Linux 防火墙*），WAF 也移动到主机上。在这里，每个主机或容器都成为一个独立的工作单元，扩展站点的容量只是添加另一个工作单元的问题。

对于这些情况，我们的 WAF 已经演变成了**运行时应用自我保护**（**RASP**）解决方案。顾名思义，RASP 软件不仅在与应用程序相同的平台上，而且与应用程序更紧密地联系在一起。RASP 代码出现在站点的每个页面上，通常作为一个简单的标记，每个页面都加载 RASP 组件。这不仅可以防止已知攻击，而且在许多情况下，还可以防止“异常”输入和流量，甚至防止站点或站点代码被修改：

![图 13.6–云 Web 服务托管本地防火墙和 RASP IPS 解决方案](img/B16336_13_006.jpg)

图 13.6–云 Web 服务托管本地防火墙和 RASP IPS 解决方案

这些 RASP 解决方案已被证明非常有效，它们正在取代许多企业站点中的传统 WAF 产品。在这些情况下，防火墙通常位于周边而不是主机上：

![图 13.7–RASP 在企业环境中显示了周边防火墙](img/B16336_13_007.jpg)

图 13.7–RASP 在企业环境中显示了周边防火墙

RASP 解决方案包括在自由/开源方面的 OpenRASP，以及商业方面的 Signal Sciences 或 Imperva 等产品。

现在您对各种 IPS 系统有了一些背景知识，让我们花点时间从攻击者或渗透测试人员的角度来看一下它们。

# IPS 规避技术

入站规避利用 IPS（基于 Linux）解释恶意数据包和数据流的方式与目标解释这些数据包的方式之间的差异。这对传统 IPS 系统和 WAF 系统都是如此。

## 检测 WAF

对于 WAF，攻击者知道 WAF 正在起作用以及其基础是很方便的。Wafw00f 是一个很好的起点。Wafw00f 是一个免费的扫描程序，可以检测超过 150 种不同的 WAF 系统，其中许多也是负载均衡器。它是用 Python 编写的，托管在[`github.com/EnableSecurity/wafw00f`](https://github.com/EnableSecurity/wafw00f)，但也打包在 Kali Linux 中。

通过测试一些站点，我们可以看到托管提供商托管的不同 WAF 解决方案：

```
└─$ wafw00f isc.sans.edu
[*] Checking https://isc.sans.edu
[+] The site https://isc.sans.edu is behind Cloudfront (Amazon) WAF.
[~] Number of requests: 2
└─$ wafw00f www.coherentsecurity.com
[*] Checking https://www.coherentsecurity.com
[+] The site https://www.coherentsecurity.com is behind Fastly (Fastly CDN) WAF.
[~] Number of requests: 2
```

对于第三个站点，我们可以看到一个商业 WAF（也是基于云的）：

```
└─$ wafw00f www.sans.org
 [*] Checking https://www.sans.org
[+] The site https://www.sans.org is behind Incapsula (Imperva Inc.) WAF.
[~] Number of requests: 2
```

正如我们所指出的，如果您知道正在使用哪种 WAF，那么您就有更好的机会规避该 WAF。当然，如果您是攻击者或渗透测试人员，您仍然必须 compromise WAF 后面的网站，但这是另一回事。

由于入站目标通常是 Web 服务器，而且通常也是 Windows 主机，因此这些流量上的规避通常利用处理分段数据包。

## 分段和其他 IPS 规避方法

人为分段数据包，然后以无序方式发送它们，并且在某些情况下，发送具有不同信息的重复片段号码是规避或检测 IPS 的一种常用方法。

这利用了 IPS 操作系统（通常是 Linux 变体）处理片段的方式与操作系统背后的主机处理片段的方式之间的差异，后者可能是完全不同的操作系统。

即使是简单地将`maliciousdomain.com`分解为`malic`和`iousdomain.com`也可能产生重大影响，如果 IPS 根本不重新组装片段。然而，更常见的是，你会看到一系列类似于以下的数据包片段：

![](img/B16336_13_Table_01.jpg)

攻击者的目标是管理重复片段的重新组装方式。如果 Linux 将其重新组装为`MalicASDFdomain.com`，而 Windows 将其重新组装为`mailicousdomain.com`，那么攻击者就有了一种通过基于 Linux 的 IPS 从恶意域渗透或向其渗透的方法。大多数现代 IPS 将以几种不同的方式重新组装片段，或者将识别目标主机的操作系统，并根据那个操作系统进行重新组装。

这是一种较早的攻击，由*Dug Song*在他的`fragroute`工具中在 21 世纪初首创。虽然这个工具在配置正确的现代 IPS 上将不再起作用，但一些供应商在其商业产品中默认情况下没有启用片段重组的正确设置。因此，虽然它不应该起作用，但对于渗透测试人员来说，有时尝试一下总是一个方便的事情，因为有时候你会幸运地绕过 IPS。

出站逃避通常会利用在安装和配置 IPS 时做出的决定；以下是一些例子：

+   IPS 系统可能会绕过任何看起来像 Windows 更新的东西 - 这可以让攻击者使用 BITS 协议绕过 IPS 来传输文件。

+   有时，出于性能原因，流媒体服务将被绕过。这种设置可以让攻击者将 C2 信息嵌入到特定 YouTube 视频的评论中。

+   如果没有进行解密，攻击者可以简单地使用 HTTPS 并顺利通过，只要他们的外部主机没有被其 IP 或 DNS 名称标记为可疑。

+   即使解密正在进行，如果攻击者使用有效的固定证书，解密将失败，这通常意味着 IPS 将退回到“允许”而不是“拒绝”的响应。

+   总会有一些协议在解密和重新签名机制方面处理得不好；这些也经常是选项。

+   “自行加密”也是我们看到攻击者使用的一种方法。

+   使用 DNS 进行数据隧道传输也是一个古老的选择。你可以简单地在端口`53/udp`上传输数据，你会惊讶地发现这种方法经常有效，即使数据包本身看起来与 DNS 数据包完全不同。然而，即使 IPS 检查 DNS 数据包以确保有效性，你也可以使用有效的 DNS 查询来传输大量数据 - 尤其是对于入站传输（数据在`TXT`响应中）特别是`TXT`查询，或者对于出站查询（数据在被查询的 DNS 主机名中）特别是`A`查询。

+   或者，最常见的是，攻击者将简单地使用**C 和 C 框架**来建立他们的通道。有几种选项可供选择，商业、盗版或开源工具的受欢迎程度会不断变化，取决于它们在任何特定时间的有效性。

长话短说，如果你的 IPS 不理解特定的数据流，你可能会考虑将其设置为阻止该流量。这种方法会阻止一些生产流量，但你会发现这是一个需要权衡的持续的紧绷绳索，权衡你所保护的社区的需求与 IPS 的有效性。

在攻击者的角度得到了涵盖（至少在高层次上），让我们来看一些实际应用 - 从网络 IDS/IPS 系统开始。

# 经典/基于网络的 IPS 解决方案 - Snort 和 Suricata

正如我们之前讨论的，传统的 IPS 故事始于 20 世纪 90 年代，当*Martin Roesch*编写了 Snort。当 Sourcefire 成立时，Snort 成为了一种商业产品，但即使在 Cisco 收购 Sourcefire 之后，Snort 仍然有一个可以安装在任何 Linux 平台上的开源版本。

由于 Snort 如此普遍，它既直接在 Sourcefire 产品中使用，也被许多（许多）**下一代防火墙**（**NGFW**）产品许可使用。在 Cisco 收购之后，这种情况发生了变化；没有商业防火墙希望在其平台上使用来自竞争公司的 IPS。

撇开营销不谈，“传统”的 Snort（2.x）版本存在一些缺陷：

+   它完全基于文本，没有 GUI。然而，Snort 有几个 Web 前端项目可用。

+   消息通常是神秘的-通常，您需要是安全专家才能完全理解 Snort 消息。

+   它是单线程的。随着网络带宽上行从数百 Mbps 到 Gbps，然后到 10、40 和 100 Gbps，这产生了巨大影响。无论 CPU、内存和磁盘的组合如何，Snort 都无法在这些容量上跟上。

然而，Snort 的方法，特别是 Snort 签名规则集，是非常宝贵的，几乎所有 IPS 解决方案都可以使用 Snort 签名。

这些因素的组合推动了行业向替代方案发展。在许多情况下，这就是 Suricata，这是一个在 2009 年发布的 IPS，自那以后一直在改进。Suricata 很有吸引力，因为从一开始它就是多线程的，因此更多的 CPU 核心有效地转化为更多可用的 CPU。这使得它比 Snort 更具可扩展性。Suricata 直接使用 Snort 规则而不进行修改，因此在创建签名和行业专业知识方面的多年工作仍然完整。

Suricata 还有许多其他安全产品的插件和集成，包括 Splunk、Logstash 和 Kibana/Elasticsearch。Suricata 可以直接集成到许多流行的防火墙中，如 pfSense 或 Untangle。

最后，许多发行版将 Suricata 与基础 Linux 操作系统、合理的 Web 界面和后端数据库捆绑在一起-如果您的硬件和网络已经准备就绪，您可以在几小时内安装 Suricata 并拥有一个可用的系统。

Snort 团队自那时发布了他们的 IPS 的 3.0 版本（2021 年 1 月）；然而，它仍然没有 GUI（除非您购买商业版本作为 Cisco Firepower 安装的一部分）。Snort 仍然是一个优秀的产品和行业最受欢迎的产品，但现在他们必须赶上 Suricata 解决方案。

足够的背景和理论-让我们构建和使用一个实际的 IPS！

# Suricata IPS 示例

在这个例子中，我们将使用 Stamus Networks 的 SELKS（[`www.stamus-networks.com/selks`](https://www.stamus-networks.com/selks)）。 **SELKS**名称反映了它的主要组件：**Suricata，Elasticsearch，Logstash，Kibana 和 Stamus** Scirius 社区版。这是在 Debian Linux 上打包的，所以如果您一直在阅读本书，这些东西应该看起来很熟悉，因为 Ubuntu 根源于 Debian“父”发行版。

SELKS 有一个**live**选项和一个**install**选项。**live**选项从 ISO 映像运行整个解决方案。这对于小型实验室或快速评估工具非常方便，您可以选择在本章中采用这种方式。然而，在生产中，您将希望使用安装在真实磁盘上的图像（最好是 SSD 或其他快速存储选项）。

SELKS 的安装指南位于这里：[`github.com/StamusNetworks/SELKS/wiki/First-time-setup`](https://github.com/StamusNetworks/SELKS/wiki/First-time-setup)。由于这些内容经常更改，我们在本章中不会进行实际安装（如果我们这样做，它将在几个月内过时）。

对于大多数 IPS 解决方案来说，拥有两个网卡是一个要求。第一个网卡用于实际的 IPS 功能，需要混杂模式并进行数据包捕获-完成后，此适配器不应该有 IP。另一个网卡用于管理平台-通常，解决方案的 Web UI 在此网卡上。

在运行 Suricata 时，请确保它处于捕获数据包的位置，可以是 SPAN 端口、TAP 或启用了`混杂模式`的 hypervisor vSwitch。

在开始使用系统之前，最好定义一下定义您的环境的各种主机和子网。所有这些信息都在`/etc/suricata/suricata.yaml`中。

以下是需要设置的关键变量：

![](img/B16336_13_Table_02.jpg)

在许多环境中，这些默认设置都可以保持不变，但正如前面所述，定义各种服务器变量可以帮助优化规则处理。例如，如果您可以缩小范围，使得在域控制器或 SQL 服务器上不进行 HTTP 检查，这可以帮助降低处理不必要检查的 CPU 需求。

MODBUS 协议通常在 SCADA 系统中使用，并且通常在制造业或公共事业中很常见，通常是非常严格定义的。通常，这些服务器和客户端被隔离到它们自己的子网中。

此外，定义组织内部的各种 DNS 服务器也是有帮助的。

在这个文件中有许多其他选项，它们控制着 Suricata 及其相关产品的操作方式，但是为了演示 IPS（甚至在许多生产环境中），您不需要修改它们。不过，我建议您查看一下这个文件；它有很好的注释，这样您就可以看到每个变量的作用。

在一段正常活动的时间之后，可能在几分钟内，您将开始在 SELKS 的警报的 Web 界面 EveBox 中看到活动：

![图 13.8 – Suricata 中的基本警报（EveBox 事件仪表板）](img/B16336_13_008.jpg)

图 13.8 – Suricata 中的基本警报（EveBox 事件仪表板）

让我们来看一下**伪装的 Firefox 字体更新**警报：

![图 13.9 – 规则详细信息（1）– 基本信息和地理 IP 信息](img/B16336_13_009.jpg)

图 13.9 – 规则详细信息（1）– 基本信息和地理 IP 信息

在这个显示中特别重要的是源 IP 和目标 IP – 如果这是出站流量，可能表明有受感染的主机。然而，在我们的情况中更重要的是**签名 ID**（通常缩写为**SID**），它唯一标识这个攻击签名。我们稍后会回到这个值。

在下面是远程地址的地理 IP 信息。这并不总是 100%准确，但如果您所在的企业关注间谍活动（企业或国家级），这些位置信息可能很重要。如果 IP 是本地的，您可能需要收集证据以供执法机构使用，特别是如果您怀疑攻击来自“内部人员”。

向下滚动一点；因为这次攻击是通过 HTTPS 进行的，我们将看到涉及的 TLS 信息：

![图 13.10 – 规则详细信息（2）– TLS 和指纹信息以及有效载荷显示](img/B16336_13_010.jpg)

图 13.10 – 规则详细信息（2）– TLS 和指纹信息以及有效载荷显示

在这里，我们可以看到`self.events.data.microsoft.com`，并且证书是由有效的 Microsoft Azure CA 颁发的。这些组合告诉我们，虽然使用伪装的字体更新的攻击是一个真正的问题，但这个签名一遍又一遍地被触发，是虚假的阳性。

仅供参考，再往下看一节，我们将看到**有效载荷**部分。左侧显示数据包中的字符串值，右侧显示数据包的十六进制表示。有趣的是**PCAP**按钮，让我们点击一下：

![图 13.11 – 从事件显示中调用的数据包捕获](img/B16336_13_011.jpg)

图 13.11 – 从事件显示中调用的数据包捕获

如预期的那样，点击`server_name/SNI`部分。

回到警报页面，继续向下滚动，我们将看到规则的 JSON 表示。回到规则名称，记住它是如何引用单词`JA3`的吗？`JA`签名是加密流量初始握手数据包中交换的各种值的哈希。使用`JA`值，我们可以识别源和目标应用程序，通常还可以识别服务器名称（在这种情况下，使用`JA3`签名是由 Salesforce 的*John Althouse*，*Jeff Atkinson*和*Josh Atkins*（因此称为 JA3）开创的。有关此方法的更多信息可以在本章末尾找到。HASSH 框架对 SSH 流量执行类似的功能。

查看 JSON 规则显示中的`JA3`部分，我们可以看到有关触发 IPS 警报的网络事件的详细信息：

![图 13.12 - 触发 IPS 警报的网络事件的 JSON 详细信息](img/B16336_13_012.jpg)

图 13.12 - 触发 IPS 警报的网络事件的 JSON 详细信息

请注意，此 JSON 显示是“我们正在寻找的”和“我们看到的”混合体。您必须查看规则本身才能看到是什么触发了规则（尽管在这种情况下，它是 JA3 哈希）。

现在我们已经探索完这个警报并认为它是误报，我们有两种可能的行动方案：

+   我们可以禁用此警报。很可能，您会发现自己在新的 IPS 上经常这样做，直到事情平稳下来

+   您可以编辑警报，也许使其按预期触发，但不适用于以`Microsoft.com`结尾的 SNI。请注意，我们说的是*以...结尾*，而不是*包含*。攻击者通常会寻找定义错误 - 例如，`foo.microsoft.com.maliciousdomain.com` SNI 将符合`包含 microsofot.com`，而实际的`self.events.data.microsoft.com`只会符合*以...结尾*。如果您还记得我们在*第十一章*中的正则表达式讨论，以`Microsoft.com`结尾将看起来像`*.microsoft.com$`（一个或多个字符，后跟`Microsoft.com`，紧接着字符串的结尾）。

在这种情况下，我们将禁用警报。从命令行，编辑`/etc/suricata/disable.conf`文件并将 SID 添加到此文件。通常会添加注释，以便您可以跟踪删除各种签名的原因，何时以及由谁删除：

```
$ cat /etc/suricata/disable.conf
2028371    # firefox font attack false positive - disabled 7/5/2021 robv
```

要添加被忽略的规则，只需将 SID 添加到`/etc/suricata/enable.conf`文件中。

最后，再次运行`suricata_update`以更新 IPS 的运行配置。您将看到`disable.conf`文件已被处理：

```
$ sudo  suricata-update | grep disa
5/7/2021 -- 09:38:47 - <Info> -- Loading /etc/suricata/disable.conf
```

编辑 SID 的第二个选择是使其不会在特定 SNI 上触发更有意义，但你不能直接编辑 SID；下一个更新将简单地覆盖您的更新。要编辑 SID，请将其复制为“自定义”或“本地”范围内的 SID，然后进行编辑。将新的 SID 添加到`enable.conf`文件中。

回到我们的主要 EveBox 显示，打开任何事件并进行探索。您可以单击任何链接的值并获取有关其更多信息。例如，如果您怀疑内部主机已被入侵，您可以单击任何显示中该主机的 IP，并获取有关与该主机之间的所有流量的详细信息：

![图 13.13 - EveBox 显示由一个目标主机触发的所有事件](img/B16336_13_013.jpg)

图 13.13 - EveBox 显示由一个目标主机触发的所有事件

请注意顶部的搜索字段 - 随着您对界面的熟悉程度越来越高，您可以根据需要手动输入这些内容。在这种情况下，我们可以看到一堆“无意义”的 DNS 请求（显示中的第 4、5 和 6 行，以及第 8、9 和 10 行）。这种无意义的查询经常出现在使用**快速通道 DNS**的攻击中，其中 C2 服务器的 DNS 名称一天内会多次更改。通常，客户端根据日期和时间计算 DNS 名称，或者定期检索它们。不幸的是，我们在广告世界的朋友们使用了许多与我们的恶意软件朋友们相同的技术，因此情况并不像以前那样清晰。

更改显示（单击用户 ID 旁边的右上角图标）可让您导航到**Hunting**显示。

在这个显示中，您将看到相同的警报，但是总结而不是按时间戳依次列出。这让您可以寻找最频繁的警报，或者寻找异常值 - 可能指示更不寻常情况的最不频繁的警报。

让我们再次查看我们的 Firefox 字体警报 - 打开该行以获取更多详细信息。特别是，您将看到一个时间轴显示：

![图 13.14 – 搜索显示，主仪表板](img/B16336_13_014.jpg)

图 13.14 – 搜索显示，主仪表板

请注意，这为我们提供了实际触发的规则：

```
alert tls $HOME_NET any -> $EXTERNAL_NET any (msg:"ET JA3 Hash - Possible Malware - Fake Firefox Font Update"; ja3_hash; content:"a0e9f5d64349fb13191bc781f81f42e1"; metadata: former_category JA3; reference:url,github.com/trisulnsm/trisul-scripts/blob/master/lua/frontend_scripts/reassembly/ja3/prints/ja3fingerprint.json; reference:url,www.malware-traffic-analysis.net; classtype:unknown; sid:2028371; rev:2; metadata:created_at 2019_09_10, updated_at 2019_10_29;)
```

基本上，这是“与此 JA3 哈希匹配的出站流量”。在[`ja3er.com`](https://ja3er.com)上查找此哈希值，我们将发现这是来自以下用户代理的基本 Windows 10 TLS 协商：

+   Excel/16.0（计数：375，最后查看：2021-02-26 07:26:44）

+   WebexTeams（计数：38，最后查看：2021-06-30 16:17:14）

+   Mozilla/5.0（Windows NT 6.1; WOW64; rv:40.0）Gecko/20100101 Firefox/40.1（计数：31，最后查看：2020-06-04 09:58:02）

这再次强调了这个签名的价值有限；我们最好是简单地禁用它。正如我们之前讨论的，您可能决定将其编辑为不同的规则，但在这种特殊情况下，您将永远在尝试获取正确的 SNI 字符串或 CA 的正确组合时进行捉迷藏。

另一个值得探索的显示是**管理**显示：

![图 13.15 – 管理视图，所有警报](img/B16336_13_015.jpg)

图 13.15 – 管理视图，所有警报

这以另一种格式显示相同的数据。点击相同的 Firefox 字体警报（2028371），我们将更全面地了解这个警报背后的活动：

![图 13.16 – 示例 Firefox 字体警报的管理视图](img/B16336_13_016.jpg)

图 13.16 – 示例 Firefox 字体警报的管理视图

请注意，在左侧列中，我们现在可以看到**禁用规则**和**启用规则**的选择。由于 IPS 界面主要在 UI 中，这更有可能成为您的主要规则管理方法，至少在禁用和启用规则方面是如此：

![图 13.17 – 从 Web UI 禁用 Suricata 规则](img/B16336_13_017.jpg)

图 13.17 – 从 Web UI 禁用 Suricata 规则

正如之前提到的，IPS 功能是一个因人而异的领域。如果您在家庭网络上部署，不同的门铃、恒温器或游戏平台将极大地影响您的流量组合以及 IPS 将发现的结果。在企业环境中，情况更加戏剧性。

最好的建议是学习一些基础知识，其中我们在这里涵盖了一些，并探索您的 IPS 告诉您有关网络上发生的情况。您会发现一些要删除或修改的签名，您希望保留但从显示中抑制的消息，以及各种优先级的真实安全警报。

在这个平台上，您还会看到 Suricata 的严重级别可能与您的不匹配。我们探讨的规则就是一个很好的例子 - Suricata 将其标记为高优先级，但经过一些调查，我们将其归类为误报并将其禁用。

我们已经多次提到规则。因此，让我们深入了解规则是如何构建的，然后从头开始构建一个规则。

# 构建 IPS 规则

我们已经多次提到 IPS 签名，特别是 Snort 规则 - 让我们看看它们是如何构建的。让我们看一个示例规则，它会警报我们包含`.cloud`文本的可疑 DNS 请求：

```
alert dns $HOME_NET any -> any (msg:"ET INFO Observed DNS Query to .cloud TLD"; dns.query; content:".cloud"; nocase; endswith; reference:url,www.spamhaus.org/statistics/tlds/; classtype:bad-unknown; sid:2027865; rev:4; metadata:affected_product Any, attack_target Client_Endpoint, created_at 2019_08_13, deployment Perimeter, former_category INFO, signature_severity Major, updated_at 2020_09_17;)
```

规则分为几个部分。从规则的开头开始，我们有我们的**规则头**：

![](img/B16336_13_Table_03.jpg)

**流**部分不显示 - Suricata 通常只检测 TCP 数据的流。

接下来是规则的**消息**部分：

![](img/B16336_13_Table_04.jpg)

**检测**部分概述了规则正在寻找的内容以及将触发警报的流量：

![](img/B16336_13_Table_05.jpg)

**参考**部分通常包含 URL、CVE 编号或供应商安全公告：

![](img/B16336_13_Table_06.jpg)

**签名 ID**部分包含 SID 值和修订号：

![](img/B16336_13_Table_07.jpg)

元数据部分包括以下内容：

![](img/B16336_13_Table_08.jpg)

其中许多是可选的，在某些情况下，部分的顺序可以改变。有关 Suricata 规则格式的完整说明，产品文档是一个很好的起点：[`suricata.readthedocs.io/en/suricata-6.0.3/rules/intro.html`](https://suricata.readthedocs.io/en/suricata-6.0.3/rules/intro.html)。

由于 Suricata 规则基本上与 Snort 规则相同，因此您可能会发现 Snort 文档也很有用。

如果您为您的组织添加自定义规则，则本地规则的 SID 范围为`1000000`-`1999999`。

按照惯例，本地规则通常放在一个名为`local.rules`的文件中，或者至少放在反映此自定义状态的规则文件中。此外，规则消息通常以单词`LOCAL`、您的组织名称或其他使其明显是内部开发规则的指示符开头。填充规则元数据也被认为是一个良好的做法 - 添加规则的作者、日期和版本号可能非常有帮助。

例如，让我们创建一组规则，用于检测 telnet 流量 - 入站和出站。您可能已经添加了此规则，以解决组织中一群坚持部署启用 telnet 的敏感系统的管理员。使用 telnet 登录，然后运行或管理应用程序，是一种危险的方法，因为所有凭据和所有应用程序数据都以明文形式通过网络传输。

让我们将其分为两条规则：

```
alert tcp any -> $HOME_NET [23,2323,3323,4323] (msg:"LOCAL TELNET SUSPICIOUS CLEAR TEXT PROTOCOL"; flow:to_server; classtype:suspicious-login; sid:1000100; rev:1;)
alert tcp $HOME_NET any -> any [23,2323,3323,4323] (msg:"LOCAL TELNET SUSPICIOUS CLEAR TEXT PROTOCOL"; flow:to_server; classtype:suspicious-login; sid:1000101; rev:1;)
```

请注意，协议是 TCP，并且目标端口包括`23/tcp`，以及许多其他常见端口，人们可能会将 telnet 放入其中以“隐藏”它。

这些规则的文本被放入`/etc/suricata/rules/local.rules`（或者您想要存储本地规则的任何其他位置）。

更新`/etc/suricata/suricata.yaml`以反映这一点：

```
default-rule-path: /var/lib/suricata/rules
rule-files:
  - suricata.rules
  - local.rules
```

现在，要重新编译规则列表，请运行`sudo selks-update`。您可能还需要运行`sudo suricata-update –local /etc/suricata/rules/local.rules`。

更新后，您可以通过列出最终规则集并过滤您的 SID 来验证您的规则是否已就位：

```
$ cat /var/lib/suricata/rules/suricata.rules | grep 100010
alert tcp any -> $HOME_NET [23,2323,3323,4323] (msg:"LOCAL TELNET SUSPICIOUS CLEAR TEXT PROTOCOL"; flow:to_server; classtype:suspicious-login; sid:1000100; rev:1;)
alert tcp $HOME_NET any -> any [23,2323,3323,4323] (msg:"LOCAL TELNET SUSPICIOUS CLEAR TEXT PROTOCOL"; flow:to_server; classtype:suspicious-login; sid:1000101; rev:1;)
```

现在，要重新加载规则集，请执行以下操作之一：

+   通过执行`sudo kill -USR2 $(pidof suricata)`重新加载 Suricata。这不建议，因为它会重新加载整个应用程序。

+   使用`suricatasc -c reload-rules`重新加载规则。这是一个阻塞式的重新加载；Suricata 在重新加载期间仍然处于离线状态。如果您的 IPS 与流量处于一条线上，这是不建议的。

+   使用`suricatasc -c ruleset-reload-nonblocking`重新加载规则。这会在不阻止流量的情况下重新加载规则集，对于内联部署是“友好”的。

当触发时，此警报是什么样子？EveBox 中此规则的警报如下：

![图 13.18 - 触发的自定义 IPS 规则生成的警报](img/B16336_13_018.jpg)

图 13.18 - 触发的自定义 IPS 规则生成的警报

在这里，我们可以看到警报中的一个是从内部到内部主机，而另一个是从内部到互联网的。第一个规则触发了两次 - 回顾一下规则定义；你能看出为什么吗？这表明，触发任何自定义规则并优化它们，使每个条件只触发一次警报或阻止，并且它们触发所有您能想到的条件和变化是很有意义的。

让我们扩展第一个（请注意 SID）：

![图 13.19 - 警报 1 的事件详细信息](img/B16336_13_019.jpg)

图 13.19 - 警报 1 的事件详细信息

现在，让我们扩展第二个 - 请注意，这是相同的事件，但它以不同的 SID 触发了第二次：

![图 13.20 - 警报 2 的事件详细信息](img/B16336_13_020.jpg)

图 13.20 - 警报 2 的事件详细信息

然后，扩展最后一个（再次，请注意 SID）：

![图 13.21 - 警报 3 的事件详细信息](img/B16336_13_021.jpg)

图 13.21 - 警报 3 的事件详细信息

请注意，我们有这两个的完整数据包捕获 - 对这些要非常小心，因为您将在浏览这些 PCAP 文件时看到有效的凭据。

既然我们已经了解了网络 IPS 的工作原理，让我们看看通过被动监控数据包在网络中传递时我们能找到什么。

# 被动流量监控

另一种增强 IPS 解决方案的方法是使用**被动漏洞扫描器**（**PVS**）。与寻找攻击流量不同，PVS 解决方案收集数据包并寻找可能有助于识别正在使用的操作系统或应用程序的流量或握手数据（例如 JA3、SSH 指纹或任何可以以明文收集的数据）。您可以使用此方法来识别可能使用其他方法不会出现的问题应用程序，甚至使用其他清点方法可能会错过的主机。

例如，PVS 解决方案可能会识别过时的浏览器或 SSH 客户端。Windows 上的 SSH 客户端通常过时，因为许多更常见的客户端（如 PuTTY）没有自动更新功能。

PVS 解决方案也是发现可能没有被清点的主机的好工具。如果它连接到互联网甚至其他内部主机，PVS 工具可以仅从“流浪”数据包中收集令人惊讶的数据。

P0F 是更常见的开源 PVS 解决方案之一。在商业上，Teneble 的 PVS 服务器通常被部署。

## 使用 P0F 进行被动监控 - 示例

要运行 P0f，请将要使用的以太网接口设置为`混杂模式`。这意味着接口将读取和处理所有数据包，而不仅仅是目标为我们正在处理的主机的数据包。这是一个常见的模式，大多数依赖数据包捕获的实用程序会自动设置，但 P0F 仍然足够“老派”，需要手动设置。然后，运行该工具：

```
$ sudo ifconfig eth0 promisc
$ sudo p0f –i eth0
.-[ 192.168.122.121/63049 -> 52.96.88.162/443 (syn) ]-
|
| client   = 192.168.122.121/63049
| os       = Mac OS X
| dist     = 0
| params   = generic fuzzy
| raw_sig  = 4:64+0:0:1250:65535,6:mss,nop,ws,nop,nop,ts,sok,eol+1:df:0
|
`----
.-[ 192.168.122.160/34308 -> 54.163.193.110/443 (syn) ]-
|
| client   = 192.168.122.160/34308
| os       = Linux 3.1-3.10
| dist     = 1
| params   = none
| raw_sig  = 4:63+1:0:1250:mss*10,4:mss,sok,ts,nop,ws:df,id+:0
|
`----
```

更有用的是，您可以将`p0f`输出重定向到文件，然后处理文件的内容。请注意，我们需要 root 权限来捕获数据包：

```
$ sudo p0f -i eth0 -o pvsout.txt
```

接下来，我们可以收集在各个主机上收集的数据，使用`grep`来过滤只有`p0f`能够识别操作系统的主机。请注意，由于我们以 root 身份创建了`pvsout.txt`，我们将需要 root 权限来读取该文件：

```
$ sudo cat pvsout.txt | grep os= | grep -v ???
[2021/07/06 12:00:30] mod=syn|cli=192.168.122.179/43590|srv=34.202.50.154/443|subj=cli|os=Linux 3.1-3.10|dist=0|params=none|raw_sig=4:64+0:0:1250:mss*10,6:mss,sok,ts,nop,ws:df,id+:0
[2021/07/06 12:00:39] mod=syn|cli=192.168.122.140/58178|srv=23.76.198.83/443|subj=cli |os=Mac OS X|dist=0|params=generic fuzzy|raw_sig=4:64+0:0:1250:65535,6:mss,nop,ws,nop,nop,ts,sok,eol+1:df:0
[2021/07/06 12:00:47] mod=syn|cli=192.168.122.179/54213|srv=3.229.211.69/443|subj=cli |os=Linux 3.1-3.10|dist=0|params=none|raw_sig=4:64+0:0:1250:mss*10,6:mss,sok,ts,nop,ws:df,id+:0
[2021/07/06 12:01:10] mod=syn|cli=192.168.122.160/41936|srv=34.230.112.184/443|subj=cli|os=Linux 3.1-3.10|dist=1|params=none|raw_sig=4:63+1:0:1250:mss*10,4:mss,sok,ts,nop,ws:df,id+:0
[2021/07/06 12:01:10] mod=syn|cli=192.168.122.181/61880|srv=13.33.160.44/443|subj=cli |os=Windows NT kernel|dist=0|params=generic|raw_sig=4:128+0:0:1460:mss*44,8:mss,nop,ws,nop,nop,sok:df,id+:0
```

我们可以解析这个快速清单清单：

```
$ sudo cat pvsout.txt | grep os= | grep -v ??? | sed -e s#/#\|#g | cut -d "|" -f 4,9 | sort | uniq
cli=192.168.122.113|os=Linux 2.2.x-3.x
cli=192.168.122.121|os=Mac OS X
cli=192.168.122.129|os=Linux 2.2.x-3.x
cli=192.168.122.140|os=Mac OS X
cli=192.168.122.149|os=Linux 3.1-3.10
cli=192.168.122.151|os=Mac OS X
cli=192.168.122.160|os=Linux 2.2.x-3.x
cli=192.168.122.160|os=Linux 3.1-3.10
cli=192.168.122.179|os=Linux 3.1-3.10
cli=192.168.122.181|os=Windows 7 or 8
cli=192.168.122.181|os=Windows NT kernel
cli=192.168.122.181|os=Windows NT kernel 5.x
```

请注意，我们必须使用`sed`来删除每个主机的源端口，以便`uniq`命令能够工作。还要注意，主机`192.168.122.181`注册为三个不同的 Windows 版本 - 这个主机值得一看！

更令人担忧的是`192.168.122.113`、`129`和`160`上的主机，它们似乎在运行较旧的 Linux 内核。事实证明以下是真的：

+   `192.168.122.160` 是一个门铃摄像头 - 它启用了自动更新，所以它是一个较旧的内核，但是尽可能新。

+   `192.168.122.129` 是运营商的 PVR/电视控制器。这与之前的情况相同。

+   `192.168.122.113`是一个 Ubuntu 20.04.2 主机，所以这是一个误报。连接到该主机后，`uname -r`告诉我们正在运行内核版本 5.8.0.55。

现在我们已经安装了基本的 IPS 服务和 PVSes，所以让我们扩展一下，并添加一些元数据，使我们的 IPS 信息更有意义。我所说的“元数据”是什么？继续阅读，我们将描述这些数据，以及 Zeek 如何用于收集它。

# Zeek 示例 - 收集网络元数据

**Zeek**（以前称为 Bro）实际上并不是 IPS，但它可以作为 IPS 的一个很好的附属服务器，用于日志记录平台以及网络管理。随着我们在本节中的进展，您将明白这是为什么。

首先，有几种安装选项：

+   您可以在现有的 Linux 主机上安装（[`docs.zeek.org/en/master/install.html`](https://docs.zeek.org/en/master/install.html)）。

+   您可以安装安全 Onion 发行版并在安装过程中选择 Zeek（[`download.securityonion.net`](https://download.securityonion.net)，[`docs.securityonion.net/en/2.3/installation.html`](https://docs.securityonion.net/en/2.3/installation.html)）。安全 Onion 可能很有吸引力，因为它除了 Zeek 之外还安装了其他几个组件，这可能会为您提供更有用的工具集。

默认情况下，安全 Onion 安装时会与 Zeek 一起安装 Suricata，因此在较小的环境中，这是有道理的 - 同样，在同一主机上拥有这两个应用程序的信息也很方便。

记得我们说过 Zeek 是一个“元数据”收集器吗？一旦我们在实时网络上运行安全 Onion 几分钟，就会明白我的意思。为了种植一些“有趣”的数据，我启动了浏览器并导航到[`badssl.com`](https://badssl.com)。从那里，我测试了各种 SSL 错误条件：

![图 13.22 - 使用 BADSSL.com 测试 SSL 错误检测](img/B16336_13_022.jpg)

图 13.22 - 使用 BADSSL.com 测试 SSL 错误检测

Bro 中显示了什么？从 Security Onion 主界面中，选择 Kibana，然后选择`443`中的 SSL 协议：

![图 13.23 - 仅显示 SSL 数据](img/B16336_13_023.jpg)

图 13.23 - 仅显示 SSL 数据

请注意，每个页面都可以独立翻页，并且原始日志立即显示在这些窗格下方。

在`443`中滚动，您将看到一些选项：

![图 13.24 - 过滤出 443/tcp 端口](img/B16336_13_024.jpg)

图 13.24 - 过滤出 443/tcp 端口

您可以单击**+**仅过滤该值，或单击**-**从报告中删除此值。让我们将其删除，然后向下滚动到日志窗格。单击日志中的任何事件的**>**图标以展开该特定会话的详细信息：

![图 13.25 - 展开事件以显示完整元数据](img/B16336_13_025.jpg)

图 13.25 - 展开事件以显示完整元数据

向下滚动，您将看到地理位置数据（对于这个 IP 在地球上的确切位置的良好估计），以及此特定会话的 SSL 证书详细信息：

![图 13.26 - 向下滚动，仅显示 SSL/TLS 证书元数据](img/B16336_13_026.jpg)

图 13.26 - 向下滚动，仅显示 SSL/TLS 证书元数据

在屏幕顶部，单击`ssl`以查看其中的内容：

![图 13.27 - SSL 仪表板](img/B16336_13_027.jpg)

图 13.27 - SSL 仪表板

选择**Security Onion - SSL**；我们将看到以下输出：

![图 13.28 - 安全 Onion - SSL 仪表板](img/B16336_13_028.jpg)

图 13.28 - 安全 Onion - SSL 仪表板

请注意，在页面中间，我们将看到实际的服务器名称。这些大部分都是从每次交互中涉及的 SSL 证书中收集的（尽管在其他仪表板中使用了反向 DNS）。让我们看看**验证状态**窗格 - 请注意我们有一些状态描述：

![](img/B16336_13_Table_09.jpg)

单击**证书已过期**，然后选择**+**以深入到只有该数据：

![图 13.29 - 缩小搜索范围 - 仅过期的 SSL 证书](img/B16336_13_029.jpg)

图 13.29 - 缩小搜索范围 - 仅过期的 SSL 证书

这使我们得到了涉及的确切交易，以及涉及人员的 IP！

请注意，当我们导航和深入时，您会看到许多屏幕上显示了**搜索词**字段，该字段显示了对 Elasticsearch 的原始查询。您可以随时手动添加它们，但使用 UI 可以在这方面提供很大的帮助。

让我们探索**Kibana** | **Discover Analytics**页面。一开始，我们将看到各种新信息：

![图 13.30 - 流量的发现视图](img/B16336_13_030.jpg)

图 13.30 - 流量的发现视图

在`ssl`中缩小搜索范围。您会看到它在您输入时给出匹配的搜索结果。

接下来，单击**ssl.version**和**ssl.certificate.issuer**，然后按**更新**：

![图 13.31 - 显示所选的 SSL/TLS 信息](img/B16336_13_031.jpg)

图 13.31 - 显示所选的 SSL/TLS 信息

接下来，在字段区域中，输入`source`并将**source.ip**添加到我们的报告中：

![图 13.32 - 通过添加更多信息构建我们的查询](img/B16336_13_032.jpg)

图 13.32 - 通过添加更多信息构建我们的查询

您可以快速看到我们如何将显示范围缩小到我们想要的内容。

或者，我们可以按地理位置进行过滤。构建一个显示 TLS 版本、源 IP、目的 IP、国家和城市的列表：

![图 13.34 - 移除“US”目的地](img/B16336_13_033.jpg)

图 13.33 - 将地理查找信息添加到查询中

现在，突出显示**Country**列中的**US**条目，并选择**-**以过滤掉美国目的地：

![](img/B16336_13_034.jpg)

图 13.34 - 移除“US”目的地

这给我们提供了一个更有趣的列表：

![图 13.35 - 最终查询](img/B16336_13_035.jpg)

图 13.35 - 最终查询

深入挖掘和处理数据可以迅速轻松地为您提供诸如“TLSv1.0 或更低版本，目的地在中国、俄罗斯或朝鲜”的显示。

甚至过滤 TLS 版本也可以迅速将您带到“未知”TLS 版本的候选名单。请注意，随时可以展开任何行以获取该会话的完整元数据：

![图 13.36 - 仅未知的 TLS 版本](img/B16336_13_036.jpg)

图 13.36 - 仅未知的 TLS 版本

让我们探索第一行中的目的地 IP：

![图 13.37 - 可疑 IP 的详细信息](img/B16336_13_037.jpg)

图 13.37 - 可疑 IP 的详细信息

还有谁使用 SSL 连接到该问题主机？在真实的安全事件中，您可以使用这种方法来回答重要的问题，比如“我们知道客户端 X 受到了影响；还有谁有类似的流量，以便我们可以看到这个问题是否更加普遍？”

![图 13.38 - 具有相同可疑流量的其他内部主机](img/B16336_13_038.jpg)

图 13.38 - 具有相同可疑流量的其他内部主机

在这里，您可以看到诸如 SSL 版本、SSL 证书颁发者和目的地 IP 的国家代码等元数据如何可以快速为您提供一些有趣的信息。想象一下，有了成千上万个可用的搜索词，您可以挖掘得更深！

如果您正在探索流量以解决问题或正在处理安全事件，您可以看到收集流量元数据如何在获取有用信息方面非常有效 - 不仅关于已识别的主机和会话，还有关于可能受到影响的类似主机和会话的信息！

这只是冰山一角。您不仅可以深入研究 SSL/TLS 流量，还可以探索数百种其他协议！

# 总结

在本章中，我们讨论了几种检测和防止入侵事件的方法。我们首先讨论了这些各种技术在我们的架构中最适合的位置，然后进入了具体的解决方案。我们讨论了经典的基于网络的 IPS 解决方案，即 Snort 和 Suricata。我们还简要涉及了特定于 Web 的 IPS，特别是 WAF 和 RASP 解决方案。

在我们的示例中，我们介绍了 IPS（Suricata）如何被用来查找和防止安全问题，甚至创建自定义规则来检测或防止 telnet 会话。使用 P0f 来 passively 收集流量进行硬件和软件清单，以及安全问题的示例也得到了说明。最后，我们使用 Zeek 来获取我们收集的数据，并收集和计算元数据，使数据更有意义。特别是 Zeek 非常有用，可以深入研究网络流量，以找到可能指示安全事件或操作问题的异常情况。

在下一章中，我们将进一步扩展这种方法，从更被动的收集模型转向使用“蜜罐”方法，利用基于网络的“欺骗”来高度准确地找到恶意主机。

# 问题

最后，这里有一些问题供您测试对本章材料的了解。您将在*附录*的*评估*部分找到答案：

1.  如果我怀疑发生了数据外泄事件，并且使用了“未知”的 TLS 版本到特定国家，我应该使用哪个工具来查找受影响的内部主机？

1.  如果您知道您有大量使用 PuTTY SSH 客户端的 Windows 客户端机器，您如何进行清点而不搜索每台机器的本地存储？

1.  为什么您决定将 IPS 放在内部网络或实际防火墙上？

# 进一步阅读

在本章涵盖的主题上了解更多信息，您可以参考以下链接：

+   SELKS 安装：[`github.com/StamusNetworks/SELKS/wiki/First-time-setup`](https://github.com/StamusNetworks/SELKS/wiki/First-time-setup)

+   Security Onion 安装：[`docs.securityonion.net/en/2.3/installation.html`](https://docs.securityonion.net/en/2.3/installation.html)

+   Suricata 安装（6.0.0）：[`suricata.readthedocs.io/en/suricata-6.0.0/install.html`](https://suricata.readthedocs.io/en/suricata-6.0.0/install.html)

+   Suricata 文档：[`suricata.readthedocs.io`](https://suricata.readthedocs.io)

+   Snort 文档：[`www.snort.org/documents`](https://www.snort.org/documents)

+   Snort 规则：[`snort.org/downloads/#rule-downloads`](https://snort.org/downloads/#rule-downloads)

+   JA3 指纹识别：[`ja3er.com`](https://ja3er.com)

[`engineering.salesforce.com/tls-fingerprinting-with-ja3-and-ja3s-247362855967`](https://engineering.salesforce.com/tls-fingerprinting-with-ja3-and-ja3s-247362855967)

+   HASSH：[`github.com/salesforce/hassh`](https://github.com/salesforce/hassh)

+   OpenRASP：[`github.com/baidu/openrasp`](https://github.com/baidu/openrasp)

+   ModSecurity：[`github.com/SpiderLabs/ModSecurity/wiki/Reference-Manual-(v2.x)modsemodse`](https://github.com/SpiderLabs/ModSecurity/wiki/Reference-Manual-(v2.x)modsemodse)

+   负载均衡器上的 WAF 服务：[`www.haproxy.com/haproxy-web-application-firewall-trial/`](https://www.haproxy.com/haproxy-web-application-firewall-trial/)

+   Zeek 文档：[`docs.zeek.org/en/master/`](https://docs.zeek.org/en/master/)

+   Security Onion：[`securityonionsolutions.com/software`](https://securityonionsolutions.com/software)
