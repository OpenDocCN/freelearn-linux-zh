- en: '*Chapter 10*: Automated Windows Guest Deployment and Customization'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: '*第10章*：自动化Windows客户端部署和自定义'
- en: Now that we have covered the different ways of deploying Linux-based **Virtual
    Machines** (**VMs**) in KVM, it's time to switch our focus to Microsoft Windows.
    Specifically, we'll work on Windows Server 2019 machines running on KVM, and cover
    prerequisites and different scenarios for the deployment and customization of
    Windows Server 2019 VMs. This book isn't based on the idea of **Virtual desktop
    infrastructure** (**VDI**) and desktop operating systems, which require a completely
    different scenario, approach, and technical implementation than virtualizing server
    operating systems.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，我们已经介绍了在KVM中部署基于Linux的**虚拟机**（**VMs**）的不同方法，是时候将我们的重点转移到Microsoft Windows了。具体来说，我们将专注于在KVM上运行的Windows
    Server 2019机器，并涵盖部署和自定义Windows Server 2019虚拟机的先决条件和不同场景。本书不是基于**虚拟桌面基础设施**（**VDI**）和桌面操作系统的想法，这需要与虚拟化服务器操作系统完全不同的场景、方法和技术实施。
- en: 'In this chapter, we will cover the following topics:'
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们将涵盖以下主题：
- en: The prerequisites to creating Windows VMs on KVM
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在KVM上创建Windows虚拟机的先决条件
- en: Creating Windows VMs using the `virt-install` utility
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用`virt-install`实用程序创建Windows虚拟机
- en: The customization of Windows VMs using `cloudbase-init`
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用`cloudbase-init`自定义Windows虚拟机
- en: '`cloudbase-init` customization examples'
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`cloudbase-init`自定义示例'
- en: Troubleshooting common `cloudbase-init` customization issues
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 解决常见的`cloudbase-init`自定义问题
- en: The prerequisites to creating Windows VMs on KVM
  id: totrans-8
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 在KVM上创建Windows虚拟机的先决条件
- en: 'When starting the installation of a guest operating system on KVM virtualization,
    we always have the same starting points. We need either of the following:'
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 在KVM虚拟化上启动客户操作系统的安装时，我们总是有相同的起点。我们需要以下之一：
- en: An ISO file with operating system installation
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 具有操作系统安装的ISO文件
- en: An image with a VM template
  id: totrans-11
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 具有虚拟机模板的镜像
- en: An existing VM to clone and reconfigure
  id: totrans-12
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 一个现有的虚拟机进行克隆和重新配置
- en: 'Let''s start from scratch. We are going to create a Windows Server 2019 VM
    in this chapter. Version selection was made to keep in touch with the most recent
    release of Microsoft server operating systems on the market. Our goal will be
    to deploy a Windows Server 2019 VM template that we can use later for more deployments
    and `cloudbase-init`, and the tool of choice for this installation process is
    going to be `virt-install`. If you need to install an older version (2016 or 2012),
    you need to know two facts:'
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们从头开始。在本章中，我们将创建一个Windows Server 2019虚拟机。版本选择是为了与市场上最新发布的微软服务器操作系统保持联系。我们的目标是部署一个Windows
    Server 2019虚拟机模板，以便以后用于更多部署和`cloudbase-init`，而此安装过程的选择工具将是`virt-install`。如果您需要安装旧版本（2016或2012），您需要知道两个事实：
- en: They are supported on CentOS 8 out of the box.
  id: totrans-14
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它们在CentOS 8上得到了支持。
- en: The installation procedure is the same as it will be with our Windows Server
    2019 VM.
  id: totrans-15
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 安装过程与我们的Windows Server 2019虚拟机将是相同的。
- en: If you want to use Virtual Machine Manager to deploy Windows Server 2019, make
    sure that you configure the VM properly. That includes selecting the correct ISO
    file for the guest operating system installation, and connecting another virtual
    CD-ROM for `virtio-win` drivers so that you can install them during the installation
    process. Make sure that your VM has enough disk space on the local KVM host (60
    GB+ is recommended), and that it has enough horsepower to run. Start with two
    virtual CPUs and 4 GB of memory, as this can easily be changed later.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您想使用虚拟机管理器部署Windows Server 2019，请确保正确配置虚拟机。这包括为客户操作系统安装选择正确的ISO文件，并连接另一个虚拟CD-ROM以安装`virtio-win`驱动程序，以便您可以在安装过程中安装它们。确保您的虚拟机在本地KVM主机上有足够的磁盘空间（建议为60
    GB+），并且有足够的性能来运行。从两个虚拟CPU和4 GB内存开始，因为这很容易以后更改。
- en: The next step in our scenario is to create a Windows VM that we'll use throughout
    this chapter to customize via `cloudbase-init`. In a real production environment,
    we need to do as much configuration in it as possible – driver installation, Windows
    updates, commonly used applications, and so on. So, let's do that first.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 我们场景的下一步是创建一个Windows虚拟机，我们将在本章中使用`cloudbase-init`进行自定义。在真实的生产环境中，我们需要尽可能多地在其中进行配置-驱动程序安装、Windows更新、常用应用程序等。所以，让我们首先做这个。
- en: Creating Windows VMs using the virt-install utility
  id: totrans-18
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用`virt-install`实用程序创建Windows虚拟机
- en: 'The first thing that we need to do is to make sure we have the `virtio-win`
    drivers ready for installation – the VM will not work properly without them installed.
    So, let''s first install that and the `libguestfs` packages, in case you don''t
    have them already installed on your server:'
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 我们需要做的第一件事是确保我们已经准备好安装`virtio-win`驱动程序-如果没有安装，虚拟机将无法正常工作。因此，让我们首先安装`libguestfs`软件包和`virtio-win`软件包，以防您的服务器上尚未安装它们：
- en: '[PRE0]'
  id: totrans-20
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'Then, it''s time to start deploying our VM. Here are our settings:'
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，是时候开始部署我们的虚拟机了。以下是我们的设置：
- en: The Windows Server 2019 ISO is located at `/iso/windows-server-2019.iso`.
  id: totrans-22
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Windows Server 2019 ISO位于`/iso/windows-server-2019.iso`。
- en: The `virtio-win` ISO file is located in the default system folder, `/usr/share/virtio-win/virtio-win.iso`.
  id: totrans-23
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`virtio-win` ISO文件位于默认系统文件夹`/usr/share/virtio-win/virtio-win.iso`。'
- en: We are going to create a 60 GB virtual disk, located at the default system folder,
    `/var/lib/libvirt/images`.
  id: totrans-24
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 我们将创建一个位于默认系统文件夹`/var/lib/libvirt/images`的60 GB虚拟磁盘。
- en: 'Now, let''s start the installation process:'
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，让我们开始安装过程：
- en: '[PRE1]'
  id: totrans-26
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'When the installation process starts, we have to click `virtio-win` drivers.
    Make sure that you untick the **Hide drivers that aren''t compatible with this
    computer''s hardware** checkbox. Then, add the following drivers one by one, from
    a specified directory, and select them with your mouse:'
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 安装过程开始时，我们必须点击`virtio-win`驱动程序。确保取消选中**隐藏与此计算机硬件不兼容的驱动程序**复选框。然后，逐个添加以下驱动程序，从指定目录中选择并用鼠标选择它们：
- en: '`AMD64\2k19`: **Red Hat VirtIO SCSI controller**.'
  id: totrans-28
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`AMD64\2k19`：**Red Hat VirtIO SCSI控制器**。'
- en: '`Balloon\2k19\amd64`: **VirtIO balloon driver**.'
  id: totrans-29
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`Balloon\2k19\amd64`：**VirtIO气球驱动程序**。'
- en: '`NetKVM\2k19\AMD64`: **Red Hat VirtIO Ethernet adapter**.'
  id: totrans-30
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`NetKVM\2k19\AMD64`：**Red Hat VirtIO以太网适配器**。'
- en: '`qemufwcfg\2k19\amd64`: **QEMU FWCfg device**.'
  id: totrans-31
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`qemufwcfg\2k19\amd64`：**QEMU FWCfg设备**。'
- en: '`qemupciserial\2k19\amd64`: **QEMU Serial PCI card**.'
  id: totrans-32
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`qemupciserial\2k19\amd64`：**QEMU串行PCI卡**。'
- en: '`vioinput\2k19\amd64`: **VirtIO input driver** and **VirtIO input driver helper**;
    select both of them.'
  id: totrans-33
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`vioinput\2k19\amd64`：**VirtIO输入驱动程序**和**VirtIO输入驱动程序助手**；选择它们两个。'
- en: '`viorng\2k19\amd64`: **VirtIO RNG device**.'
  id: totrans-34
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`viorng\2k19\amd64`：**VirtIO RNG设备**。'
- en: '`vioscsi\2k19\amd64`: **Red Hat VirtIO SCSI pass-through controller**.'
  id: totrans-35
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`vioscsi\2k19\amd64`：**Red Hat VirtIO SCSI直通控制器**。'
- en: '`vioserial\2k19\amd64`: **VirtIO serial driver**.'
  id: totrans-36
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`vioserial\2k19\amd64`：**VirtIO串行驱动程序**。'
- en: '`viostor\2k19\amd64`: **Red Hat VirtIO SCSI controller**.'
  id: totrans-37
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`viostor\2k19\amd64`：**Red Hat VirtIO SCSI控制器**。'
- en: After that, click **Next** and wait for the installation process to finish.
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: 之后，点击**下一步**，等待安装过程完成。
- en: 'You might be asking yourself: *why did we micro-manage this so early in the
    installation process, when we could''ve done this later?* The answer is two-fold
    – if we did it later, we''d have the following problems:'
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 您可能会问自己：*为什么我们在安装过程的早期就这样微观管理，而不是稍后再做呢？*答案有两个方面-如果我们稍后再做，我们会遇到以下问题：
- en: There's a chance – at least for some operating systems – that we won't have
    all the necessary drivers loaded before the installation starts, which might mean
    that the installation will crash.
  id: totrans-40
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 有可能-至少对于某些操作系统-在安装开始之前我们不会加载所有必要的驱动程序，这可能意味着安装会崩溃。
- en: We'd have loads of yellow exclamation marks in **Device Manager**, which is
    usually annoying to people.
  id: totrans-41
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 我们会在**设备管理器**中看到大量的黄色感叹号，这通常会让人感到恼火。
- en: 'Being as it is after deployment, our device manager is happy and the installation
    was a success:'
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 部署后，我们的设备管理器很满意，安装成功了：
- en: '![Figure 10.1 – The operating system and all drivers installed from the get-go'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: '![图10.1-操作系统和所有驱动程序从一开始就安装'
- en: '](img/B14834_10_01.jpg)'
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B14834_10_01.jpg)'
- en: Figure 10.1 – The operating system and all drivers installed from the get-go
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.1-操作系统和所有驱动程序从一开始就安装
- en: The only thing that's highly recommended post installation is that we install
    the guest agent from `virtio-win.iso` after we boot our VM. You will find an `.exe`
    file on the virtual CD-ROM, in `guest-agent` directory, and you just need to click
    the **Next** button until the installation is complete.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 安装后唯一强烈建议的事情是，在启动VM后从`virtio-win.iso`安装客户代理。您会在虚拟CD-ROM中的`guest-agent`目录中找到一个`.exe`文件，只需点击**下一步**按钮，直到安装完成。
- en: Now that our VM is ready, we need to start thinking about customization. Specifically,
    large-scale customization, which is a normal usage model for VM deployments in
    the cloud. This is why we need to use `cloudbase-init`, which is our next step.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们的VM已经准备好，我们需要开始考虑定制。特别是大规模的定制，这是云中VM部署的正常使用模式。这就是为什么我们需要使用`cloudbase-init`，这是我们的下一步。
- en: Customizing Windows VMs using cloudbase-init
  id: totrans-48
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用cloudbase-init自定义Windows VM
- en: If you had the chance to go through [*Chapter 9*](B14834_09_Final_ASB_ePub.xhtml#_idTextAnchor165),
    *Customizing a Virtual Machine with cloud-init*, we discussed a tool called `cloud-init`.
    What we used it for was guest operating system customization, specifically for
    Linux machines. `cloud-init` is heavily used in Linux-based environments, specifically
    in Linux-based clouds, to perform initialization and configuration of cloud VMs.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您有机会阅读[*第9章*](B14834_09_Final_ASB_ePub.xhtml#_idTextAnchor165)，*使用cloud-init自定义虚拟机*，我们讨论了一个工具叫做`cloud-init`。我们使用它来进行客户操作系统定制，特别是针对Linux机器。`cloud-init`在基于Linux的环境中被广泛使用，特别是在基于Linux的云中，用于执行云VM的初始化和配置。
- en: The idea behind `cloudbase-init` is the same, but it's aimed at Windows guest
    operating systems. Its base services start up when we boot a Windows guest operating
    system instance, as well as read through the configuration information and configure/initialize
    it. We are going to show a couple of examples of `cloudbase-init` operations a
    bit later in this chapter.
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: '`cloudbase-init`的理念是一样的，但它针对的是Windows客户操作系统。它的基本服务在我们启动Windows客户操作系统实例时启动，然后阅读配置信息并进行配置/初始化。我们稍后将展示一些`cloudbase-init`操作的例子。'
- en: 'What can `cloudbase-init` do? The list of features is quite long, as `cloudbase-init`
    has a modular approach at its core, so it offers many plugins and interpreters,
    which can be used to further its reach:'
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: '`cloudbase-init`能做什么？功能列表相当长，因为`cloudbase-init`的核心是模块化的，所以它提供了许多插件和解释器，可以用于扩展其功能：'
- en: It can execute custom commands and scripts, most commonly coded in PowerShell,
    although regular CMD scripts are also supported.
  id: totrans-52
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它可以执行自定义命令和脚本，最常见的是用PowerShell编写，尽管也支持常规的CMD脚本。
- en: It can work with PowerShell remoting and the **Windows Remote Management** (**WinRM**)
    service.
  id: totrans-53
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它可以与PowerShell远程和**Windows远程管理**（**WinRM**）服务一起工作。
- en: It can manage and configure disks, for example, to do a volume expansion.
  id: totrans-54
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它可以管理和配置磁盘，例如进行卷扩展。
- en: 'It can do basic administration, including the following:'
  id: totrans-55
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它可以进行基本的管理，包括以下内容：
- en: a) Creating users and passwords
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: a) 创建用户和密码
- en: b) Setting up a hostname
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: b) 设置主机名
- en: c) Configuring static networking
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: c) 配置静态网络
- en: d) Configuring MTU size
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: d) 配置MTU大小
- en: e) Assigning a license
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: e) 分配许可证
- en: f) Working with public keys
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: f) 使用公钥
- en: g) Synchronizing clocks
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: g) 同步时钟
- en: 'We mentioned earlier that our Windows Server 2019 VM is going to be used for
    `cloudbase-init` customization, so that''s our next subject. Let''s prepare our
    VM for `cloudbase-init`. We are going to achieve that by downloading the `cloudbase-init`
    installer and installing it. We can find the `cloudbase-init` installer by pointing
    our internet browser at [https://cloudbase-init.readthedocs.io/en/latest/intro.html#download](https://cloudbase-init.readthedocs.io/en/latest/intro.html#download).
    The installation is simple enough, and it can work both in a regular, GUI fashion
    and silently. If you''re used to using Windows Server Core or prefer silent installation,
    you can use the MSI installer for silent installation by using the following command:'
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 我们之前提到过，我们的Windows Server 2019虚拟机将用于`cloudbase-init`定制，所以这是我们接下来要讨论的主题。让我们为`cloudbase-init`准备我们的虚拟机。我们将通过下载`cloudbase-init`安装程序并安装来实现这一点。我们可以通过将我们的互联网浏览器指向[https://cloudbase-init.readthedocs.io/en/latest/intro.html#download](https://cloudbase-init.readthedocs.io/en/latest/intro.html#download)来找到`cloudbase-init`安装程序。安装非常简单，可以以常规GUI方式或静默方式工作。如果您习惯使用Windows
    Server Core或更喜欢静默安装，可以使用MSI安装程序进行静默安装，方法是使用以下命令：
- en: '[PRE2]'
  id: totrans-64
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: Make sure that you check the `cloudbase-init` documentation for further configuration
    options as the installer supports additional runtime options. It's located at
    [https://cloudbase-init.readthedocs.io/en/latest/](https://cloudbase-init.readthedocs.io/en/latest/).
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 确保您检查`cloudbase-init`文档，以获取更多配置选项，因为安装程序支持额外的运行时选项。它位于[https://cloudbase-init.readthedocs.io/en/latest/](https://cloudbase-init.readthedocs.io/en/latest/)。
- en: 'Let''s stick with the GUI installer as it''s simpler to use, especially for
    a first-time user. First, the installer is going to ask about the license agreement
    and installation location – just the usual stuff. Then, we''re going to get the
    following options screen:'
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们使用GUI安装程序，因为它更简单易用，特别是对于第一次使用的用户。首先，安装程序将要求您同意许可协议和安装位置 – 就是通常的东西。然后，我们将得到以下选项屏幕：
- en: '![Figure 10.2 – Basic configuration screen'
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: '![图10.2 – 基本配置屏幕'
- en: '](img/B14834_10_02.jpg)'
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B14834_10_02.jpg)'
- en: Figure 10.2 – Basic configuration screen
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.2 – 基本配置屏幕
- en: 'What it''s asking us to do is to give permission to create the `cloudbase-init`
    configuration files (both `cloudbase-init-unattend.conf` and `cloudbase-init.conf`)
    with this specific future user in mind. This user will be a member of the local
    `Administrators` group and will be used for logging in when we start using the
    new image. This will be reflected in both of our configuration files, so if we
    select `Admin` here, that''s the user that''s going to get created. It''s also
    asking us whether we want the `cloudbase-init` service to be run as a `LocalSystem`
    service, which we selected to make the whole process easier. The reason is really
    simple – this is the highest level of permission that we can give to our `cloudbase-init`
    services so that they can execute its operations. Translation: the `cloudbase-init`
    service will then be run as a `LocalSystem` service account, which has unlimited
    access to all local system resources.'
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 它要求我们允许使用特定未来用户创建`cloudbase-init`配置文件（`cloudbase-init-unattend.conf`和`cloudbase-init.conf`）。这个用户将是本地`Administrators`组的成员，并且将在我们开始使用新镜像时用于登录。这将反映在我们的两个配置文件中，因此如果我们在这里选择`Admin`，那么将创建该用户。它还要求我们是否希望`cloudbase-init`服务作为`LocalSystem`服务运行，我们选择这样做是为了使整个过程更容易。原因非常简单
    – 这是我们可以给予`cloudbase-init`服务的最高权限级别，以便它可以执行其操作。翻译：`cloudbase-init`服务将作为`LocalSystem`服务账户运行，该账户对所有本地系统资源具有无限访问权限。
- en: 'The last configuration screen is going to ask us about running sysprep. Usually,
    we don''t check the `cloudbase-init` customization file and run sysprep after
    that. So, leave the following window open:'
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 最后一个配置屏幕将要求我们运行sysprep。通常，我们不会检查`cloudbase-init`定制文件并在此之后运行sysprep。因此，请保持以下窗口打开：
- en: '![Figure 10.3 – The cloudbase-init installation wizard finishing up'
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: '![图10.3 – 完成cloudbase-init安装向导'
- en: '](img/B14834_10_03.jpg)'
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B14834_10_03.jpg)'
- en: Figure 10.3 – The cloudbase-init installation wizard finishing up
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.3 – 完成cloudbase-init安装向导
- en: Now that the `cloudbase-init` services are installed and configured, let's create
    a customization file that's going to configure this VM by using `cloudbase-init`.
    Again, make sure that this configuration screen is left open (with the completed
    setup wizard) so that we can easily start the whole process when we finish creating
    our `cloudbase-init` configuration.
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 现在`cloudbase-init`服务已安装和配置好，让我们创建一个定制文件，通过使用`cloudbase-init`来配置这个虚拟机。同样，请确保保持此配置屏幕打开（完成设置向导），以便我们在完成创建`cloudbase-init`配置时可以轻松开始整个过程。
- en: cloudbase-init customization examples
  id: totrans-76
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: cloudbase-init定制示例
- en: 'After we finish the installation process, a directory with a set of files gets
    created in our installation location. For example, in our VM, a directory called
    `c:\Program Files\Cloudbase Solutions\Cloudbase-init\` was created, and it has
    the following set of subdirectories:'
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 安装过程完成后，在我们的安装位置将创建一个包含一组文件的目录。例如，在我们的虚拟机中，创建了一个名为`c:\Program Files\Cloudbase
    Solutions\Cloudbase-init\`的目录，它具有以下一组子目录：
- en: '`bin`: The location where some of the binary files are installed, such as `elevate`,
    `bsdtar`, `mcopy`, `mdir`, and so on.'
  id: totrans-78
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`bin`：一些二进制文件安装的位置，例如`elevate`，`bsdtar`，`mcopy`，`mdir`等。'
- en: '`conf`: The location of three main configuration files that we''re going to
    work with, which is discussed a bit later.'
  id: totrans-79
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`conf`：我们将要处理的三个主要配置文件的位置，稍后会讨论。'
- en: '`LocalScripts`: The default location for PowerShell and similar scripts that
    we want to run post-boot.'
  id: totrans-80
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`LocalScripts`：PowerShell和类似脚本的默认位置，我们希望在启动后运行。'
- en: '`Log`: The location where we''ll store the `cloudbase-init` log files by default
    so that we can debug any issues.'
  id: totrans-81
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`Log`：默认情况下，我们将存储`cloudbase-init`日志文件的位置，以便我们可以调试任何问题。'
- en: '`Python`: The location where local installation of Python is deployed so that
    we can also use Python for scripting.'
  id: totrans-82
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`Python`：本地安装Python的位置，以便我们也可以使用Python进行脚本编写。'
- en: 'Let''s focus on the `conf` directory, which contains our configuration files:'
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们专注于包含我们配置文件的`conf`目录：
- en: '`cloudbase-init.conf`'
  id: totrans-84
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`cloudbase-init.conf`'
- en: '`cloudbase-init-unattend.conf`'
  id: totrans-85
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`cloudbase-init-unattend.conf`'
- en: '`unattend.xml`'
  id: totrans-86
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`unattend.xml`'
- en: 'The way that `cloudbase-init` works is rather simple – it uses the `unattend.xml`
    file during the Windows sysprep phase to execute `cloudbase-init` with the `cloudbase-init-unattend.conf`
    configuration file. The default `cloudbase-init-unattend.conf` configuration file
    is easily readable, and we can use the example provided by the `cloudbase-init`
    project with the default configuration file explained step by step:'
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: '`cloudbase-init`的工作方式相当简单 - 它在Windows sysprep阶段使用`unattend.xml`文件来执行`cloudbase-init`，并使用`cloudbase-init-unattend.conf`配置文件。默认的`cloudbase-init-unattend.conf`配置文件非常易读，我们可以使用`cloudbase-init`项目提供的示例，逐步解释默认配置文件：'
- en: '[PRE3]'
  id: totrans-88
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'The next part of the config file is about devices – specifically, which devices
    to inspect for a possible configuration drive (metadata):'
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 配置文件的下一部分是关于设备 - 具体来说，是要检查哪些设备可能有配置驱动器（元数据）：
- en: '[PRE4]'
  id: totrans-90
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'We need to configure some settings for logging purposes as well:'
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 我们还需要配置一些日志记录的设置：
- en: '[PRE5]'
  id: totrans-92
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'The next part of the configuration file is about networking, so we''ll use
    DHCP to get all the networking settings in our example:'
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 配置文件的下一部分是关于网络的，因此我们将在我们的示例中使用DHCP获取所有网络设置：
- en: '[PRE6]'
  id: totrans-94
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'We need to configure the location where the scripts are residing, the same
    scripts that we can use as a part of the `cloudbase-init` process:'
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 我们需要配置脚本所在的位置，这些脚本可以作为`cloudbase-init`过程的一部分使用：
- en: '[PRE7]'
  id: totrans-96
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'The last part of the configuration file is about the services and plugins to
    be loaded, along with some global settings, such as whether to allow the `cloudbase-init`
    service to reboot the system or not and how we''re going to approach the `cloudbase-init`
    shutdown process (`false=graceful service shutdown`):'
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 配置文件的最后一部分是关于要加载的服务和插件，以及一些全局设置，例如是否允许`cloudbase-init`服务重新启动系统，以及我们将如何处理`cloudbase-init`关闭过程（`false=优雅服务关闭`）：
- en: '[PRE8]'
  id: totrans-98
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'Let''s just get a couple of things out of the way from the get-go. Default
    configuration files already contain some settings that were deprecated, as you''re
    going to find out soon enough. Specifically, settings such as `verbose`, `logdir`
    and `logfile` are already deprecated in this release, as you can see from the
    following screenshot, where `cloudbase-init` is complaining about those very options:'
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们从一开始就澄清一些事情。默认配置文件已经包含了一些已弃用的设置，您很快就会发现。特别是像`verbose`，`logdir`和`logfile`这样的设置在此版本中已经被弃用，您可以从以下截图中看到，`cloudbase-init`正在抱怨这些选项：
- en: '![Figure 10.4 – cloudbase-init complaining about its own default configuration
    file options'
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: '![图10.4 - cloudbase-init抱怨其自己的默认配置文件选项'
- en: '](img/B14834_10_04.jpg)'
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B14834_10_04.jpg)'
- en: Figure 10.4 – cloudbase-init complaining about its own default configuration
    file options
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.4 - cloudbase-init抱怨其自己的默认配置文件选项
- en: If we want to start sysprepping with `cloudbase-init` by using the default configuration
    files, we are actually going to get a pretty nicely configured VM – it's going
    to be sysprepped, it's going to reset the administrator password and ask us to
    change it with the first login, and remove the existing administrator user and
    its directories. So, before we do this, we need to make sure that we save all
    of our administrator user settings and data (documents, installers, downloads,
    and so on) someplace safe. Also, the default configuration files will not reboot
    the VM by default, which might confuse you. We need to do a manual restart of
    the VM so that the whole process can start.
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 如果我们想要使用默认配置文件启动`cloudbase-init`进行sysprep，实际上我们将得到一个非常好配置的虚拟机 - 它将被sysprep，它将重置管理员密码并要求我们在第一次登录时更改密码，并删除现有的管理员用户及其目录。因此，在执行此操作之前，我们需要确保将我们的管理员用户设置和数据（文档，安装程序，下载等）保存在安全的地方。此外，默认配置文件不会默认重新启动虚拟机，这可能会让您感到困惑。我们需要手动重新启动虚拟机，以便整个过程可以开始。
- en: 'The easiest way to work with both `cloud-init` and `cloudbase-init` is by writing
    down a scenario of what needs to be done to the VM as it gets through the initialization
    process. So, we''ll do just that – pick a load of settings that we want to be
    configured and create a customization file accordingly. Here are our settings:'
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 与`cloud-init`和`cloudbase-init`一起工作的最简单方法是写下一个需要在虚拟机初始化过程中完成的场景。因此，我们将这样做 - 选择我们想要配置的一大堆设置，并相应地创建一个自定义文件。以下是我们的设置：
- en: We want our VM to ask us to change the password post-sysprep and after the `cloudbase-init`
    process.
  id: totrans-105
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 我们希望我们的虚拟机在`cloudbase-init`过程后要求我们更改密码。
- en: We want our VM to take all of its network settings (the IP address, netmask,
    gateway, DNS servers, and NTP) from DHCP.
  id: totrans-106
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 我们希望我们的虚拟机从DHCP获取所有的网络设置（IP地址，子网掩码，网关，DNS服务器和NTP）。
- en: We want to sysprep the VM so that it's unique to each scenario and policy.
  id: totrans-107
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 我们希望对虚拟机进行sysprep，以使其对每个场景和策略都是唯一的。
- en: 'So, let''s create a `cloudbase-init-unattend.conf` config file that will do
    this for us. The first part of the configuration file was taken from the default
    config file:'
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，让我们创建一个`cloudbase-init-unattend.conf`配置文件来为我们执行此操作。配置文件的第一部分取自默认配置文件：
- en: '[PRE9]'
  id: totrans-109
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'As we decided to use PowerShell for all of the scripting, we created a separate
    directory for our PowerShell scripts:'
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 我们决定使用PowerShell进行所有脚本编写，因此我们为我们的PowerShell脚本创建了一个单独的目录：
- en: '[PRE10]'
  id: totrans-111
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'The rest of the file was also just copied from the default configuration file:'
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 文件的其余部分也只是从默认配置文件中复制过来的：
- en: '[PRE11]'
  id: totrans-113
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'As for the `cloudbase-init.conf` file, the only change that we made was selecting
    the correct local script path (reasons to be mentioned shortly), as we will use
    this path in our next example:'
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 至于`cloudbase-init.conf`文件，我们唯一做的更改是选择正确的本地脚本路径（稍后将提到的原因），因为我们将在下一个示例中使用此路径：
- en: '[PRE12]'
  id: totrans-115
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'Also, part of our default config file contained paths for `tar`, `mtools`,
    and debugging:'
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，我们默认的配置文件包含了`tar`，`mtools`和调试的路径：
- en: '[PRE13]'
  id: totrans-117
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: 'This part of the config file was also taken from the default config file, and
    we only changed `local_scripts_path` so that it''s set to the directory that we''re
    using to populate with PowerShell scripts:'
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 配置文件的这一部分也是从默认配置文件中获取的，我们只更改了`local_scripts_path`，以便将其设置为我们用于填充PowerShell脚本的目录：
- en: '[PRE14]'
  id: totrans-119
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: 'We can then go back to the `cloudbase-init` installation screen, check the
    sysprep option, and click **Finish**. After starting the sysprep process and going
    through with it, this is the end result:'
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，我们可以返回到`cloudbase-init`安装屏幕，选中sysprep选项，然后单击**完成**。启动sysprep过程并完成后，这就是最终结果：
- en: '![Figure 10.5 – When we press Sign in, we are going to be asked to change the
    administrator''s password'
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: '![图10.5 - 当我们按“登录”时，我们将被要求更改管理员密码'
- en: '](img/B14834_10_05.jpg)'
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B14834_10_05.jpg)'
- en: Figure 10.5 – When we press Sign in, we are going to be asked to change the
    administrator's password
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.5 - 当我们按“登录”时，我们将被要求更改管理员密码
- en: 'Now, let''s take this a step further and complicate things a bit. Let''s say
    that you want to do the same process, but with additional PowerShell code that
    should do some additional configuration. Consider the following example:'
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，让我们再进一步，稍微复杂一些。假设您想执行相同的过程，但还要添加一些额外的PowerShell代码来进行一些额外的配置。考虑以下示例：
- en: It should create another two local users called `packt1` and `packt2`, with
    a predefined password set to `Pa$$w0rd`.
  id: totrans-125
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它应该创建另外两个名为`packt1`和`packt2`的本地用户，预定义密码设置为`Pa$$w0rd`。
- en: It should create a new local group called `students`, and add `packt1` and `packt2`
    to this group as members.
  id: totrans-126
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它应该创建一个名为`students`的新本地组，并将`packt1`和`packt2`添加为成员。
- en: It should set the hostname to `Server1`.
  id: totrans-127
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它应该将主机名设置为`Server1`。
- en: 'The PowerShell code that enables us to do this should have the following content:'
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: 使我们能够执行此操作的PowerShell代码应具有以下内容：
- en: '[PRE15]'
  id: totrans-129
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'Taking a look at the script itself, this is what it does:'
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 看一下脚本本身，这就是它的作用：
- en: Sets the PowerShell execution policy to unrestricted so that our host doesn't
    stop our script execution, which it would do by default.
  id: totrans-131
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 将PowerShell执行策略设置为无限制，以便我们的主机不会停止我们的脚本执行，这是默认情况下会发生的。
- en: Creates a password variable from a plaintext string (`Pa$$w0rd`), which gets
    converted to a secure string that we can use with the `New-LocalUser` PowerShell
    cmdlet to create a local user.
  id: totrans-132
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 从纯文本字符串（`Pa$$w0rd`）创建一个密码变量，将其转换为安全字符串，我们可以将其与`New-LocalUser` PowerShell命令一起使用来创建本地用户。
- en: '`New-LocalUser` is a PowerShell cmdlet that creates a local user. Mandatory
    parameters include a username and password, which is why we created a secure string.'
  id: totrans-133
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`New-LocalUser`是一个PowerShell命令，用于创建本地用户。强制参数包括用户名和密码，这就是为什么我们创建了一个安全字符串。'
- en: '`New-LocalGroup` is a PowerShell cmdlet that creates a local group.'
  id: totrans-134
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`New-LocalGroup`是一个PowerShell命令，用于创建本地组。'
- en: '`Add-LocalGroupMember` is a PowerShell cmdlet that allows us to create a new
    local group and add members to it.'
  id: totrans-135
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`Add-LocalGroupMember`是一个PowerShell命令，允许我们创建一个新的本地组并向其中添加成员。'
- en: '`Rename-Computer` is a PowerShell cmdlet that changes the hostname of a Windows
    computer.'
  id: totrans-136
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`Rename-Computer`是一个PowerShell命令，用于更改Windows计算机的主机名。'
- en: 'We also need to call this code from `cloudbase-init` somehow, so we need to
    add this code as script. Most commonly, we''ll use a directory called `LocalScripts`
    in the `cloudbase-init` installation folder for that. Let''s call this script
    `userdata.ps1`, save the content mentioned previously to it in the folder, as
    defined in the `.conf` file (`c:\PS1`), and add a `cloudbase-init` parameter at
    the top of the file:'
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 我们还需要以某种方式从`cloudbase-init`中调用此代码，因此我们需要将此代码添加为脚本。最常见的是，在`cloudbase-init`安装文件夹中使用名为`LocalScripts`的目录。让我们将此脚本命名为`userdata.ps1`，将先前提到的内容保存到文件夹中，如`.conf`文件中定义的那样（`c:\PS1`），并在文件顶部添加一个`cloudbase-init`参数：
- en: '[PRE16]'
  id: totrans-138
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: 'After starting the `cloudbase-init` procedure again, which can be achieved
    by starting the `cloudbase-init` installation wizard and going through it as we
    did in the previous example, here''s the end result in terms of users:'
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: 再次启动`cloudbase-init`过程，可以通过启动`cloudbase-init`安装向导并按照之前的示例进行操作来实现，以下是用户方面的最终结果：
- en: '![Figure 10.6 – The packt1 and packt2 users were created, and added to the
    group created by our PowerShell script'
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: '![图10.6 - 创建了packt1和packt2用户，并将其添加到我们的PowerShell脚本创建的组中'
- en: '](img/B14834_10_06.jpg)'
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B14834_10_06.jpg)'
- en: Figure 10.6 – The packt1 and packt2 users were created, and added to the group
    created by our PowerShell script
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.6 - 创建了packt1和packt2用户，并将其添加到我们的PowerShell脚本创建的组中
- en: 'We can clearly see that the `packt1` and `packt2` users were created, along
    with a group called `Students`. We can then see that the `Students` group has
    two members – `packt1` and `packt2`. Also, in terms of setting the server name,
    we have the following:'
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以清楚地看到创建了`packt1`和`packt2`用户，以及一个名为`Students`的组。然后，我们可以看到`Students`组有两个成员
    - `packt1`和`packt2`。此外，在设置服务器名称方面，我们有以下内容：
- en: '![Figure 10.7 – Slika 1\. Changing the server name via PowerShell script also
    works'
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: '![图10.7 - Slika 1。通过PowerShell脚本更改服务器名称也有效'
- en: '](img/B14834_10_07.jpg)'
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B14834_10_07.jpg)'
- en: Figure 10.7 – Slika 1\. Changing the server name via PowerShell script also
    works
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.7 - Slika 1。通过PowerShell脚本更改服务器名称也有效
- en: Using `cloudbase-init` really isn't simple, and requires a bit of investment
    in terms of time and tinkering. But afterward, it will make our job much easier
    – not being forced to do pedestrian tasks such as these over and over again should
    be a reward enough, which is why we need to talk a little bit about troubleshooting.
    We're sure that you'll run into these issues as you ramp up your `cloudbase-init`
    usage.
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 使用`cloudbase-init`确实并不简单，需要在时间和摆弄方面进行一些投资。但之后，它将使我们的工作变得更加容易 - 不再被迫一遍又一遍地执行这些平凡的任务应该是一个足够的奖励，这就是为什么我们需要稍微谈谈故障排除。我们相信，随着您增加`cloudbase-init`的使用量，您一定会遇到这些问题。
- en: Troubleshooting common cloudbase-init customization issues
  id: totrans-148
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 排除常见的cloudbase-init自定义问题
- en: In all honesty, you can freely say that the `cloudbase-init` documentation is
    not all that good. Finding examples of how to execute PowerShell or Python code
    is difficult at best, while the official page doesn't really offer any help in
    that respect. So, let's discuss some of the most common errors that happen while
    using `cloudbase-init`.
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: 坦率地说，您可以自由地说`cloudbase-init`文档并不是那么好。找到如何执行PowerShell或Python代码的示例实际上是相当困难的，而官方页面在这方面并没有提供任何帮助。因此，让我们讨论一些在使用`cloudbase-init`时经常发生的常见错误。
- en: Although this seems counter-intuitive, we had much more success getting `cloudbase-init`
    to work with the latest development version instead of the latest stable one.
    We're not exactly sure what the problem is, but the latest development version
    (at the time of writing, this is version 0.9.12.dev125) worked for us right out
    of the gate. With version 0.9.11., we had massive issues with getting the PowerShell
    script to even start.
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管这似乎有些违反直觉，但我们在使用最新的开发版本而不是最新的稳定版本时取得了更大的成功。我们不太确定问题出在哪里，但最新的开发版本（在撰写本文时，这是版本0.9.12.dev125）对我们来说一开始就可以使用。使用版本0.9.11时，我们在启动PowerShell脚本时遇到了很大的问题。
- en: 'Apart from these issues, there are other issues that you will surely encounter
    as you get to know `cloudbase-init`. The first one is the reboot loop. This problem
    is really common, and it almost always happens because of two reasons:'
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 除了这些问题，当您开始了解`cloudbase-init`时，还会遇到其他问题。第一个是重启循环。这个问题非常常见，几乎总是因为两个原因：
- en: A mistake in the configuration file – a wrongly typed name of a module or an
    option, or something like that
  id: totrans-152
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 配置文件中的错误 - 模块或选项的名称错误输入，或类似的错误
- en: A mistake in some external file (location or syntax) that's being called as
    an external script to be executed in the `cloudbase-init` process
  id: totrans-153
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在`cloudbase-init`过程中调用的一些外部文件（位置或语法）出现错误
- en: 'Making a mistake in configuration files is something that happens often, which
    throws `cloudbase-init` into a weird state that ends up like this:'
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 在配置文件中犯错误是经常发生的事情，这会使`cloudbase-init`陷入一个奇怪的状态，最终会变成这样：
- en: '![Figure 10.8 – Error in configuration'
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: '![图10.8 - 配置错误'
- en: '](img/B14834_10_08.jpg)'
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B14834_10_08.jpg)'
- en: Figure 10.8 – Error in configuration
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.8 - 配置错误
- en: We've seen this situation multiple times. The real problem is the fact that
    sometimes it takes hours and hours of waiting, sometimes cycling through numerous
    reboots, but it's not just a regular reboot loop. It really seems that `cloudbase-init`
    is doing something – the CMD is started, you get no errors in it or on the screen,
    but it keeps doing something and then finishes like this.
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 我们已经多次看到这种情况。真正的问题在于有时需要等待数小时，有时需要循环多次重启，但这不仅仅是一个常规的重启循环。似乎`cloudbase-init`正在做某些事情
    - CMD已经启动，屏幕上没有错误，但它一直在做某些事情，然后以这种方式完成。
- en: Other issues that you might encounter are even more picky – for example, when
    `cloudbase-init` fails to reset the password during the sysprep/`cloudbase-init`
    process. This can happen if you manually change the account password that's being
    used by the `cloudbase-init` service (hence, why using `LocalSystem` is a better
    idea). That will lead to the failure of the whole `cloudbase-init` procedure,
    a part of which can be a failure to reset the password.
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: 您可能遇到的其他问题更加挑剔 - 例如，当`cloudbase-init`在sysprep/`cloudbase-init`过程中无法重置密码时。如果您手动更改了`cloudbase-init`服务使用的帐户密码（因此，使用`LocalSystem`是一个更好的主意），就会发生这种情况。这将导致整个`cloudbase-init`过程失败，其中的一部分可能是无法重置密码。
- en: There's an even more obscure reason why this might happen – sometimes we manually
    manage system services by using the `services.msc` console and we deliberately
    disable services that we don't immediately recognize. If you set the `cloudbase-init`
    service to be disabled, it will fail in its process, as well. These services need
    to have automatic startup priority and shouldn't be manually reconfigured to be
    disabled.
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: 还有一个更加隐晦的原因可能会导致这种情况发生 - 有时我们会使用`services.msc`控制台手动管理系统服务，并且会有意地禁用我们不立即识别的服务。如果将`cloudbase-init`服务设置为禁用，它将在其过程中失败。这些服务需要具有自动启动优先级，并且不应手动重新配置为禁用。
- en: A failure to reset the password can also happen because of some security policies
    – for example, if the password isn't complex enough. That's why we used a bit
    more of a complex password in our PowerShell script, as most of us system engineers
    learned that lesson a long time ago.
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: 重置密码失败也可能是因为某些安全策略 - 例如，如果密码不够复杂。这就是为什么我们在PowerShell脚本中使用了更复杂的密码，因为我们大多数系统工程师很早就学到了这个教训。
- en: Also, sometimes companies have different security policies in place, which can
    lead to a situation in which some management application that takes care of –
    for example, software inventory – stops the `cloudbase-init` service or completely
    uninstalls it.
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，有时公司会制定不同的安全策略，这可能导致某些管理应用程序（例如软件清单）停止`cloudbase-init`服务或完全卸载它。
- en: The most frustrating error that we can encounter is an error where the `cloudbase-init`
    process doesn't start scripts from its designated folder. After spending hours
    perfecting your Python, `bash`, cmd, or PowerShell script that needs to be added
    to the customization process, it's always maddening to see this happen. In order
    for us to be able to use these scripts, we need to use a specific plugin that
    is able to call the external script and execute it. That's why we usually use
    `UserDataPlugin` – both for executing and debugging reasons – as it can execute
    all of these script types and give us an error value, which we can then use for
    debugging purposes.
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可能遇到的最令人沮丧的错误是`cloudbase-init`进程无法从指定文件夹启动脚本。在花费数小时完善您的Python、bash、cmd或PowerShell脚本后，需要将其添加到定制过程中，看到这种情况发生总是令人发狂。为了能够使用这些脚本，我们需要使用一个能够调用外部脚本并执行它的特定插件。这就是为什么我们通常使用`UserDataPlugin`
    - 无论是出于执行还是调试的原因 - 因为它可以执行所有这些脚本类型并给我们一个错误值，然后我们可以用于调试目的。
- en: One last thing – make sure that you don't insert PowerShell code directly into
    the `cloudbase-init` configuration files in the `conf` folder. You'll only get
    a reboot loop as a reward, so be careful about that.
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: 最后一件事 - 确保不要直接将PowerShell代码插入到`conf`文件夹中的`cloudbase-init`配置文件中。你只会得到一个重启循环作为回报，所以要小心。
- en: Summary
  id: totrans-165
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 总结
- en: In this chapter, we worked with Windows VM customization, a topic that's equally
    as important as Linux VM customization. Maybe even more so, keeping in mind the
    market share numbers and the fact that a lot of people are using Windows in cloud
    environments, as well.
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们讨论了Windows VM的定制化，这是与Linux VM定制化同样重要的话题。甚至更重要，考虑到市场份额和许多人在云环境中使用Windows。
- en: Now that we have covered all the bases in terms of working with VMs, templating,
    and customization, it's time to introduce a different approach to additional customization
    that's complementary to `cloud-init` and `cloudbase-init`. So, the next chapter
    is about that approach, which is based around Ansible.
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经涵盖了与VM、模板化和定制化相关的所有基础知识，是时候介绍一种与`cloud-init`和`cloudbase-init`互补的附加定制化方法了。因此，下一章将介绍基于Ansible的方法。
- en: Questions
  id: totrans-168
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 问题
- en: Which drivers do we need to install onto Windows guest operating systems so
    that we can make a Windows template on the KVM hypervisor?
  id: totrans-169
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 我们需要安装哪些驱动程序到Windows客户操作系统中，以便在KVM虚拟化程序上创建Windows模板？
- en: Which agent do we need to install onto Windows guest operating systems to have
    better visibility into the VM's performance data?
  id: totrans-170
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 我们需要安装哪个代理程序到Windows客户操作系统中，以便更好地查看VM的性能数据？
- en: What is sysprep?
  id: totrans-171
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: sysprep是什么？
- en: What is `cloudbase-init` used for?
  id: totrans-172
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`cloudbase-init`用于什么？'
- en: What are the regular use cases for `cloudbase-init`?
  id: totrans-173
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`cloudbase-init`的常规用例是什么？'
- en: Further reading
  id: totrans-174
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 进一步阅读
- en: 'Please refer to the following links for more information:'
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: 请参考以下链接获取更多信息：
- en: 'Microsoft `LocalSystem` account documentation: [https://docs.microsoft.com/en-us/windows/win32/ad/the-localsystem-account](https://docs.microsoft.com/en-us/windows/win32/ad/the-localsystem-account)'
  id: totrans-176
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Microsoft `LocalSystem`账户文档：[https://docs.microsoft.com/en-us/windows/win32/ad/the-localsystem-account](https://docs.microsoft.com/en-us/windows/win32/ad/the-localsystem-account)
- en: '`cloudbase-init` documentation: [https://cloudbase-init.readthedocs.io/en/latest/intro.html](https://cloudbase-init.readthedocs.io/en/latest/intro.html)'
  id: totrans-177
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`cloudbase-init`文档：[https://cloudbase-init.readthedocs.io/en/latest/intro.html](https://cloudbase-init.readthedocs.io/en/latest/intro.html)'
- en: 'The `cloudbase-init` plugin documentation: [https://cloudbase-init.readthedocs.io/en/latest/plugins.html](https://cloudbase-init.readthedocs.io/en/latest/plugins.html)'
  id: totrans-178
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`cloudbase-init`插件文档：[https://cloudbase-init.readthedocs.io/en/latest/plugins.html](https://cloudbase-init.readthedocs.io/en/latest/plugins.html)'
- en: 'The `cloudbase-init` services documentation: [https://cloudbase-init.readthedocs.io/en/latest/services.html](https://cloudbase-init.readthedocs.io/en/latest/services.html)'
  id: totrans-179
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`cloudbase-init`服务文档：[https://cloudbase-init.readthedocs.io/en/latest/services.html](https://cloudbase-init.readthedocs.io/en/latest/services.html)'
