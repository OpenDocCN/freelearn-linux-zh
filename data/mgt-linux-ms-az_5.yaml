- en: 5\. Operating Linux on Azure
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 5\. 在Azure上操作Linux
- en: If you recall the migration roadmap we shared earlier, it was a four-stage process.
    In the last two chapters, we covered the *Assess* and *Migrate* milestones. In
    *Chapter 3*, *Assessment and migration planning*, we discussed the need for proper
    assessment and thorough planning of the migration, as they are an inevitable part
    of the process. We also discussed the tooling used to complete these milestones
    in our migration journey in *Chapter 4*, *Performing migration to Azure*, and
    we migrated two Linux servers from Hyper-V into Azure. The first server was an
    Ubuntu LTS, and the second was a MySQL server, which was converted into an Azure
    Database for MySQL service.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您回忆一下我们之前分享的迁移路线图，它是一个四阶段的过程。在前两章中，我们涵盖了*评估*和*迁移*的里程碑。在*第3章*，*评估和迁移规划*中，我们讨论了对迁移的正确评估和彻底规划的必要性，因为它们是过程中不可避免的一部分。我们还讨论了在我们的迁移旅程中完成这些里程碑所使用的工具，在*第4章*，*执行迁移到Azure*中，我们将两台Linux服务器从Hyper-V迁移到Azure。第一台服务器是Ubuntu
    LTS，第二台是一个MySQL服务器，它被转换成了Azure Database for MySQL服务。
- en: 'One thing to keep in mind is that the journey doesn''t stop there. In this
    chapter, we will focus primarily on the remaining stages: *Optimize* and *Manage
    & Secure*. We need to make sure that workloads are optimized, and that security
    is top-notch. In an on-premises environment, security is typically entirely handled
    by you. However, in the case of the cloud, you are deploying the workloads to
    the cloud provider''s datacenter. Here, security will be a major concern, but
    you need not worry. Azure provides a lot of services that can change the security
    landscape of your cloud deployments.'
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 要记住的一件事是旅程并不止步于此。在本章中，我们将主要关注剩余阶段：*优化*和*管理与安全*。我们需要确保工作负载得到优化，并且安全性是一流的。在本地环境中，安全性通常完全由您处理。然而，在云的情况下，您正在将工作负载部署到云提供商的数据中心。在这里，安全性将是一个主要关注点，但您不必担心。Azure提供了许多服务，可以改变您的云部署的安全格局。
- en: The *Optimize* stage mainly focuses on analyzing your costs, improving the infrastructure
    using recommendations, and reinvesting to achieve more. On the other hand, the
    *Manage & Secure* phase talks more about security, data protection, and finally
    monitoring.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: '*优化*阶段主要关注于分析您的成本，使用建议改进基础设施，并进行再投资以实现更多。另一方面，*管理与安全*阶段更多地涉及安全、数据保护和最终监控。'
- en: 'Some of the key takeaways from this chapter include:'
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 本章的一些关键要点包括：
- en: Optimizing costs on Azure
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在Azure上优化成本
- en: Working with Azure Linux agents and extensions
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用Azure Linux代理和扩展
- en: Linux patching on Azure
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Azure上的Linux打补丁
- en: Infrastructure monitoring
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 基础设施监控
- en: Let's continue our migration journey by moving on to the next milestone, *Optimize*,
    where we are going to learn about a number of cost optimization techniques in
    Azure.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们继续我们的迁移旅程，转向下一个里程碑*优化*，在那里我们将学习Azure中的许多成本优化技术。
- en: Optimize
  id: totrans-10
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 优化
- en: 'At this stage, you may have successfully migrated your services to the Azure
    cloud. As mentioned in the introduction to this chapter, however, the journey
    doesn''t end here. If you remember, during our migration, we had an option to
    choose the size of the virtual machines that need to be created in Azure. For
    demonstration purposes, we let Azure decide the size of the target virtual machines.
    A couple of questions will surface at this point, for example: *Is the sizing
    decision correct? Are the migrated workloads running efficiently?*'
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个阶段，您可能已经成功将您的服务迁移到Azure云。然而，正如本章介绍中所提到的，旅程并不会在此结束。如果您记得，在我们的迁移过程中，我们有选择在Azure中创建虚拟机的大小。为了演示目的，我们让Azure决定目标虚拟机的大小。在这一点上，会出现一些问题，例如：*大小决策是否正确？迁移的工作负载是否运行高效？*
- en: The answer to these questions is delivered in the *Optimize* phase. In this
    phase, we ensure that the migrated workloads are running efficiently from a cost
    standpoint as well as a performance standpoint. Let's go ahead and cover some
    of the tools that are used to optimize the workloads, mainly from a cost perspective.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 这些问题的答案在*优化*阶段中得到解答。在这个阶段，我们确保迁移的工作负载从成本和性能的角度高效运行。让我们继续讨论一些主要从成本角度优化工作负载的工具。
- en: In the previous chapters, we discussed the relevant tools that are used in the
    respective phases. Likewise, the *Optimize* phase also has a set of tools that
    can be leveraged by customers to optimize workloads. Let's take a look at these
    tools.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 在之前的章节中，我们讨论了各个阶段中使用的相关工具。同样，*优化*阶段也有一套工具，客户可以利用这些工具来优化工作负载。让我们看看这些工具。
- en: Azure Cost Management
  id: totrans-14
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: Azure成本管理
- en: '**Azure Cost Management** (**ACM**) is an amazing tool that can be used to
    analyze running costs at different management scopes, like billing accounts, management
    groups, subscriptions, resource groups, and even at the resource level. For instance,
    you can choose any subscriptions from the Azure portal, and clicking on the Cost
    analysis blade will give you a complete breakdown of the costs associated with
    all the resources in your subscription. *Figure 5.1* shows how the cost is visualized
    using different graphs in ACM:'
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: '**Azure成本管理**（**ACM**）是一个令人惊叹的工具，可用于分析不同管理范围的运行成本，如计费帐户、管理组、订阅、资源组，甚至在资源级别。例如，您可以从Azure门户中选择任何订阅，单击成本分析刀片将为您提供有关订阅中所有资源相关成本的完整分解。*图5.1*显示了ACM中使用不同图表可视化成本的方式：'
- en: '![A complete breakdown of the cost of all resources in your subscription by
    clicking into the Cost analysis blade](img/B17160_05_01.jpg)'
  id: totrans-16
  prefs: []
  type: TYPE_IMG
  zh: '![通过单击成本分析刀片，可以查看订阅中所有资源的成本的完整分解](img/B17160_05_01.jpg)'
- en: 'Figure 5.1: ACM view'
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 图5.1：ACM视图
- en: 'If you look closely at *Figure 5.1*, right next to ACTUAL COST (USD), you can
    see the forecasted cost under FORECAST: CHART VIEW ON. The forecast is done using
    resources that are currently deployed. Alongside this, ACM provides budgeting
    and alerting features so that you will be notified whenever you cross the threshold
    of your budget. Furthermore, you can integrate budgets with action groups and
    invoke Azure Functions or Azure Logic Apps to automatically shut down workloads
    when you are crossing the threshold.'
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您仔细观察*图5.1*，在实际成本（美元）旁边，您可以看到在“预测：图表视图”下的预测成本。预测是使用当前部署的资源进行的。除此之外，ACM提供预算和警报功能，这样当您超过预算阈值时，您将收到通知。此外，您可以将预算与操作组集成，并调用Azure
    Functions或Azure Logic Apps，在您超过阈值时自动关闭工作负载。
- en: 'In addition to the aforementioned features, ACM also offers the following advantages:'
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 除了上述功能之外，ACM还提供以下优势：
- en: You can monitor your AWS costs from ACM using the AWS connector.
  id: totrans-20
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 您可以使用AWS连接器从ACM监视您的AWS成本。
- en: ACM offers richer APIs that can be utilized to build dashboards in your favorite
    visualization tool.
  id: totrans-21
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: ACM提供更丰富的API，可用于在您喜欢的可视化工具中构建仪表板。
- en: ACM also has a Power BI connector that you can leverage to bring the data from
    Cost Management to Power BI. At the time of writing this book, the Power BI connector
    is only supported for **Enterprise Agreement** (**EA**) and **Microsoft Customer
    Agreement** (**MCA**) customers. **Pay-As-You-Go** (**PAYG**) customers have to
    use the APIs to create dashboards in Power BI.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: ACM还有一个Power BI连接器，您可以利用它将成本管理的数据带入Power BI。在撰写本书时，Power BI连接器仅支持**企业协议**（**EA**）和**微软客户协议**（**MCA**）客户。**按使用量付费**（**PAYG**）客户必须使用API在Power
    BI中创建仪表板。
- en: To conclude, ACM is very powerful in terms of the features it offers and the
    visibility it provides in terms of cloud spending. You can analyze the costs of
    the services or servers that you have migrated and verify whether they are within
    your projected budget. If not, you can think about resizing the server provided
    you are not compromising the performance of the application.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 总之，ACM在提供的功能和在云支出方面提供的可见性方面非常强大。您可以分析您迁移的服务或服务器的成本，并验证它们是否在您预期的预算范围内。如果不在，您可以考虑调整服务器的大小，前提是不会影响应用程序的性能。
- en: With that, we will move on to the next tool used in the *Optimize* phase—Azure
    Advisor.
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 有了这个，我们将继续介绍*优化*阶段中使用的下一个工具—Azure Advisor。
- en: Azure Advisor
  id: totrans-25
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: Azure Advisor
- en: Azure Advisor can give you recommendations to review and improve the optimization
    and efficiency of your workloads. Azure Advisor is now integrated into the ACM
    blade to provide recommendations on cost reduction. Recommendations from a cost
    reduction standpoint include suggestions for resizing underutilized Azure virtual
    machines, making use of additional discounts, and converting PAYG virtual machines
    to Azure Reserved Instances to get significant discounts on workloads that run
    24x7.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: Azure Advisor可以为您提供建议，以审查和改进工作负载的优化和效率。Azure Advisor现在已集成到ACM刀片中，以提供有关成本削减的建议。从成本削减的角度来看，建议包括调整未充分利用的Azure虚拟机的大小，利用额外的折扣，并将PAYG虚拟机转换为Azure保留实例，以获得运行24x7的工作负载的重大折扣。
- en: 'For underutilized resources, Azure Advisor recommends shutting down or resizing
    the instance based on the evaluation. The evaluation metrics can be found here:
    [https://docs.microsoft.com/azure/advisor/advisor-cost-recommendations](https://docs.microsoft.com/azure/advisor/advisor-cost-recommendations).'
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 对于未充分利用的资源，Azure Advisor建议根据评估关闭或调整实例。评估指标可以在这里找到：[https://docs.microsoft.com/azure/advisor/advisor-cost-recommendations](https://docs.microsoft.com/azure/advisor/advisor-cost-recommendations)。
- en: 'Recommendations from Advisor do not always involve costs—you will be able to
    see recommendations on Cost, Security, Reliability, Operational excellence, and
    Performance. *Figure 5.2* shows the view from the Advisor blade showing different
    recommendations. In this case, most of the recommendations have been completed,
    except the Reliability recommendations:'
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: Advisor的建议并不总是涉及成本—您将能够看到有关成本、安全性、可靠性、运营卓越和性能的建议。*图5.2*显示了Advisor blade的视图，显示了不同的建议。在这种情况下，大部分建议已经完成，除了可靠性建议：
- en: '![The view from the Advisor blade showing different Azure recommendations](img/B17160_05_02.jpg)'
  id: totrans-29
  prefs: []
  type: TYPE_IMG
  zh: '![Advisor blade的视图显示不同的Azure建议](img/B17160_05_02.jpg)'
- en: 'Figure 5.2: Azure Advisor recommendations'
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 图5.2：Azure Advisor建议
- en: These recommendations can be downloaded as CSV or PDF, which you can share with
    other stakeholders who play vital roles in business decision making.
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 这些建议可以下载为CSV或PDF，您可以与在业务决策中发挥重要作用的其他利益相关者分享。
- en: Analyzing costs using ACM and reviewing the recommendations made by Azure Advisor
    will help you optimize your workloads in Azure. Now, let's move on to the next
    phase of our journey, called *Manage & Secure*.
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 使用ACM分析成本并审查Azure Advisor提出的建议将帮助您优化Azure中的工作负载。现在，让我们继续我们的旅程的下一个阶段，称为*管理和安全*。
- en: Manage and Secure
  id: totrans-33
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 管理和安全
- en: In this stage, we will make sure that our migrated resources are secured, and
    that they are managed correctly. This phase is all about security and data protection
    and we are going to look at some of the tools that are used to achieve these.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个阶段，我们将确保我们迁移的资源是安全的，并且它们被正确管理。这个阶段关乎安全和数据保护，我们将看一些用于实现这些目标的工具。
- en: One of the most important pieces of Linux management in Azure is a small component
    called the **Linux Agent**.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 在Azure中，Linux管理中最重要的部分之一是一个名为**Linux Agent**的小组件。
- en: Linux Agent for Azure
  id: totrans-36
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: Azure的Linux Agent
- en: Linux provisioning and interaction between the Azure `waagent` or `WaLinuxAgent`.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: Azure `waagent`或`WaLinuxAgent`之间的Linux配置和交互。
- en: 'The following functionality of Linux on Azure deployments are managed by the
    Azure Linux Agent:'
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: Azure Linux Agent管理Azure部署上Linux的以下功能：
- en: Provisioning images
  id: totrans-39
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 镜像配置
- en: Network routing and interface naming
  id: totrans-40
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 网络路由和接口命名
- en: Kernel configuration
  id: totrans-41
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 内核配置
- en: Diagnostics configuration
  id: totrans-42
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 诊断配置
- en: Microsoft **System Center Virtual Machine Manager** (**SCVMM**) deployment
  id: totrans-43
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Microsoft **System Center Virtual Machine Manager** (**SCVMM**) 部署
- en: Virtual machine extensions
  id: totrans-44
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 虚拟机扩展
- en: The agent talks with Azure Service Fabric via two channels. During virtual machine
    deployment, the agent mounts an **Open Virtualization Format** (**OVF**)-compliant
    configuration file from a virtual DVD image that contains the required provisioning
    details. During runtime, communication takes place via the REST API provided by
    the agent, allowing Azure Fabric to push information and commands to the virtual
    machine.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 代理通过两个渠道与Azure Service Fabric进行通信。在虚拟机部署期间，代理会挂载一个符合**开放虚拟化格式**（**OVF**）的配置文件，该文件包含所需的配置细节。在运行时，通信是通过代理提供的REST
    API进行的，允许Azure Fabric向虚拟机推送信息和命令。
- en: 'When creating your own Linux images or modifying existing images, it is good
    to remember that the agent is not completely monolithic—it requires the following
    components from the underlying Linux system:'
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 在创建自己的Linux镜像或修改现有镜像时，要记住代理不是完全单片的——它需要来自底层Linux系统的以下组件：
- en: Python 2.6+
  id: totrans-47
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Python 2.6+
- en: OpenSSL 1.0+
  id: totrans-48
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: OpenSSL 1.0+
- en: OpenSSH 5.3+
  id: totrans-49
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: OpenSSH 5.3+
- en: 'Filesystem utilities: `sfdisk`, `fdisk`, `mkfs`, `parted`'
  id: totrans-50
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 文件系统工具：`sfdisk`，`fdisk`，`mkfs`，`parted`
- en: 'Password tools: `chpasswd`, `sudo`'
  id: totrans-51
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 密码工具：`chpasswd`，`sudo`
- en: 'Text processing tools: `sed`, `grep`'
  id: totrans-52
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 文本处理工具：`sed`，`grep`
- en: 'Network tools: `ip-route`'
  id: totrans-53
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 网络工具：`ip-route`
- en: Even if it is technically possible to run Linux on Azure without the agent,
    it is highly recommended to always have the agent installed and active in your
    virtual machine. Without the agent, you cannot run any remote commands to the
    virtual machine via Azure Fabric. Additionally, Azure would not get any status
    information about the virtual machine and wouldn't know whether the system was
    healthy.
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 即使在技术上可以在Azure上运行没有代理的Linux，也强烈建议始终在虚拟机中安装并激活代理。没有代理，您无法通过Azure Fabric运行任何远程命令到虚拟机。此外，Azure也无法获取有关虚拟机的状态信息，也无法知道系统是否健康。
- en: All endorsed Linux distributions on Azure come with the agent pre-installed.
    For your own images, you may install the agent from DEB and RPM packages, as well
    as using a Python-based installation script.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: Azure上所有认可的Linux发行版都预装了代理。对于您自己的镜像，您可以从DEB和RPM软件包安装代理，也可以使用基于Python的安装脚本。
- en: Note
  id: totrans-56
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 注意
- en: You should always use the version of the agent distributed with the virtual
    machine image by your Linux distribution vendor. Only install it manually if there
    is no official package available for your Linux flavor.
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 您应该始终使用由Linux发行版供应商提供的虚拟机镜像版本的代理。只有在您的Linux版本没有官方软件包可用时才手动安装它。
- en: 'Here are some useful commands for checking that the Azure Linux Agent is installed
    and updated to the latest version:'
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 以下是一些有用的命令，用于检查Azure Linux代理是否已安装并更新到最新版本：
- en: 'To check whether it is installed and to show the current version number on
    Ubuntu:'
  id: totrans-59
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 要检查Ubuntu上是否已安装并显示当前版本号：
- en: '[PRE0]'
  id: totrans-60
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: '![Checking Azure Linux Agent version number on Ubuntu by executing the apt
    list –installed | grep walinuxagent command](img/B17160_05_03.jpg)'
  id: totrans-61
  prefs: []
  type: TYPE_IMG
  zh: '![通过执行apt list –installed | grep walinuxagent命令来检查Ubuntu上的Azure Linux代理版本号](img/B17160_05_03.jpg)'
- en: 'Figure 5.3: Checking the Azure Linux Agent version number on Ubuntu'
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 图5.3：检查Ubuntu上Azure Linux代理版本号
- en: Alternatively, you can run `waagent --version`, which can be used on any distribution
    without needing to run any package manager-related commands.
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 或者，您可以运行`waagent --version`，这可以在任何发行版上使用，而无需运行任何与包管理器相关的命令。
- en: 'To update the agent or install it in the event that it is missing, run the
    following command:'
  id: totrans-64
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 要更新代理或在缺失时安装它，请运行以下命令：
- en: '[PRE1]'
  id: totrans-65
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: '![Updating the Linux agent on Ubuntu by executing the sudo apt-get install
    walinuxagent command](img/B17160_05_04.jpg)'
  id: totrans-66
  prefs: []
  type: TYPE_IMG
  zh: '![通过执行sudo apt-get install walinuxagent命令来更新Ubuntu上的Linux代理](img/B17160_05_04.jpg)'
- en: 'Figure 5.4: Updating the Linux agent on Ubuntu'
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: 图5.4：更新Ubuntu上的Linux代理
- en: In our example, the agent was already installed and on the latest version as
    well.
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们的示例中，代理已经安装并且也是最新版本。
- en: 'Azure Linux Agent has a built-in mechanism to update itself. It is good to
    ensure that it is enabled by editing its configuration file, `/etc/waagent.conf`:'
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: Azure Linux代理具有内置机制来更新自身。编辑其配置文件`/etc/waagent.conf`以确保其已启用是很好的做法：
- en: Note
  id: totrans-70
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 注意
- en: 'You can learn more about the technical details of the agent from GitHub as
    the agent is released as open source: [https://github.com/Azure/WALinuxAgent](https://github.com/Azure/WALinuxAgent).'
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以从GitHub了解有关代理的技术细节，因为代理是作为开源发布的：[https://github.com/Azure/WALinuxAgent](https://github.com/Azure/WALinuxAgent)。
- en: 'Documentation for using the agent can be found here: [https://docs.microsoft.com/azure/virtual-machines/extensions/agent-linux](https://docs.microsoft.com/azure/virtual-machines/extensions/agent-linux).'
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 有关使用代理的文档可以在这里找到：[https://docs.microsoft.com/azure/virtual-machines/extensions/agent-linux](https://docs.microsoft.com/azure/virtual-machines/extensions/agent-linux)。
- en: 'It is also good to be familiar with `cloud-init`, a very popular tool for customizing
    a Linux virtual machine as it boots for the first time. It can be considered an
    alternative to Azure Linux Agent. You can read more about it here: [https://docs.microsoft.com/azure/virtual-machines/linux/using-cloud-init](https://docs.microsoft.com/azure/virtual-machines/linux/using-cloud-init).
    `cloud-init` works across Linux distributions and does not depend on the package
    manager.'
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 熟悉`cloud-init`也是很好的，它是一个非常流行的工具，用于在Linux虚拟机首次启动时进行自定义。它可以被视为Azure Linux代理的替代品。您可以在这里阅读更多信息：[https://docs.microsoft.com/azure/virtual-machines/linux/using-cloud-init](https://docs.microsoft.com/azure/virtual-machines/linux/using-cloud-init)。`cloud-init`适用于各种Linux发行版，并且不依赖于包管理器。
- en: Extensions
  id: totrans-74
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 扩展
- en: Azure extensions are tiny helper applications that provide configuration and
    automation functionality for Azure virtual machines. These extensions can be used
    once the virtual machine and operating system have been deployed and started.
    They can also be used during virtual machine deployment using Azure Resource Manager
    templates.
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: Azure扩展是提供Azure虚拟机配置和自动化功能的小型辅助应用程序。这些扩展可以在虚拟机和操作系统部署并启动后使用。也可以在使用Azure资源管理器模板部署虚拟机时使用它们。
- en: Extensions are part of the Azure Linux Agent functionality set, but each extension
    has its own set of features and use cases.
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 扩展是Azure Linux代理功能集的一部分，但每个扩展都有自己的功能和用例。
- en: 'To list all the available extensions for Linux on Azure, you can run the following
    Azure CLI command:'
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 要列出Azure上Linux的所有可用扩展，可以运行以下Azure CLI命令：
- en: '[PRE2]'
  id: totrans-78
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: '![Listing all available extensions for Linux on Azure](img/B17160_05_05.jpg)'
  id: totrans-79
  prefs: []
  type: TYPE_IMG
  zh: '![列出Azure上Linux的所有可用扩展](img/B17160_05_05.jpg)'
- en: 'Figure 5.5: Listing all available extensions for Linux on Azure'
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 图5.5：列出Azure上Linux的所有可用扩展
- en: The list is quite long and contains extensions from Microsoft and third-party
    publishers. In this example, we have used Southeast Asia as a location. You should
    choose your nearest region unless you are working with a specific remote location.
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 列表非常长，包含来自Microsoft和第三方发布商的扩展。在此示例中，我们使用了东南亚作为位置。除非您正在使用特定的远程位置，否则应选择最近的区域。
- en: Note
  id: totrans-82
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 注意
- en: 'You can explore all the options of the extension image module here: [https://docs.microsoft.com/cli/azure/vm/extension/image?view=azure-cli-latest#az-vm-extension-image-list](https://docs.microsoft.com/cli/azure/vm/extension/image?view=azure-cli-latest#az-vm-extension-image-list).'
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以在这里探索扩展图像模块的所有选项：[https://docs.microsoft.com/cli/azure/vm/extension/image?view=azure-cli-latest#az-vm-extension-image-list](https://docs.microsoft.com/cli/azure/vm/extension/image?view=azure-cli-latest#az-vm-extension-image-list)。
- en: 'Virtual machine extensions can also be found in the Azure portal (see *Figure
    5.6*). You can choose Extensions under the virtual machine properties and add
    them using the installation wizard:'
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 虚拟机扩展也可以在Azure门户中找到（参见*图5.6*）。您可以在虚拟机属性下选择扩展，并使用安装向导添加它们：
- en: '![Extensions settings in the Azure portal](img/B17160_05_06.jpg)'
  id: totrans-85
  prefs: []
  type: TYPE_IMG
  zh: '![Azure门户中的扩展设置](img/B17160_05_06.jpg)'
- en: 'Figure 5.6: Extensions settings in the Azure portal'
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 图5.6：Azure门户中的扩展设置
- en: Extensions are very useful not only for deploying workloads and their configurations,
    but also during troubleshooting and debugging.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 扩展不仅在部署工作负载和其配置时非常有用，而且在故障排除和调试过程中也非常有用。
- en: Data protection
  id: totrans-88
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 数据保护
- en: 'In Azure, your data can be protected in multiple ways and in multiple layers.
    The encryption models supported by Azure are as follows:'
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 在Azure中，您的数据可以以多种方式和多个层次进行保护。Azure支持的加密模型如下：
- en: Client-side and server-side encryption
  id: totrans-90
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 客户端和服务器端加密
- en: Azure disks and Azure Storage Service Encryption
  id: totrans-91
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Azure磁盘和Azure存储服务加密
- en: Client-side encryption of Azure blobs
  id: totrans-92
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Azure Blob的客户端加密
- en: Various encryption methods for databases and database services
  id: totrans-93
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 数据库和数据库服务的各种加密方法
- en: Encryption of data in transit
  id: totrans-94
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 数据传输加密
- en: Key management with Key Vault
  id: totrans-95
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用密钥保管库进行密钥管理
- en: Depending on your migration workloads and their architecture, you may want to
    utilize one or more of these encryption features in your project.
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 根据您的迁移工作负载及其架构，您可能希望在项目中利用一个或多个这些加密功能。
- en: For example, if your source virtual machine is using encrypted filesystems,
    you could migrate it to Azure as-is. However, for performance reasons, it may
    make sense to turn off the filesystem encryption and to enable encryption on Azure
    Storage or Managed Disk.
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，如果您的源虚拟机使用加密文件系统，您可以将其迁移到Azure。但出于性能原因，关闭文件系统加密并在Azure存储或托管磁盘上启用加密可能是有意义的。
- en: If your entire on-premises storage system is encrypted, the most logical choice
    is to encrypt at the Azure Storage level as well.
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您的整个本地存储系统都加密了，最合乎逻辑的选择就是在Azure存储级别进行加密。
- en: Note
  id: totrans-99
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 注意
- en: 'You can read more about the various encryption functionalities in the encryption
    overview documentation: [https://docs.microsoft.com/azure/security/fundamentals/encryption-overview](https://docs.microsoft.com/azure/security/fundamentals/encryption-overview).'
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以在加密概述文档中阅读更多关于各种加密功能的信息：[https://docs.microsoft.com/azure/security/fundamentals/encryption-overview](https://docs.microsoft.com/azure/security/fundamentals/encryption-overview)。
- en: Let's take a closer look at the next feature.
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们更仔细地看看下一个功能。
- en: Azure Disk Encryption
  id: totrans-102
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: Azure磁盘加密
- en: 'Azure Disk Encryption for Linux virtual machines uses *DM-Crypt* to provide
    volume encryption for operating systems and data disks. It is integrated with
    *Azure Key Vault* to manage and control your encryption keys and secrets. There
    is also integration with Azure Security Center, which is able to alert you if
    you have not encrypted virtual machine disks:'
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 用于Linux虚拟机的Azure磁盘加密使用*DM-Crypt*提供操作系统和数据磁盘的卷加密。它与*Azure Key Vault*集成，用于管理和控制您的加密密钥和机密。还与Azure安全中心集成，能够在您未加密虚拟机磁盘时发出警报：
- en: '![Virtual machine recommendation – Azure Security Center](img/B17160_05_07.jpg)'
  id: totrans-104
  prefs: []
  type: TYPE_IMG
  zh: '![虚拟机推荐- Azure安全中心](img/B17160_05_07.jpg)'
- en: 'Figure 5.7: Azure Security Center'
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 图5.7：Azure安全中心
- en: 'There are certain recommendations and limitations when it comes to using Azure
    Disk Encryption with Linux virtual machines, and right now there is no direct
    way of removing encryption from the operating system disks on Linux virtual machines,
    making the troubleshooting process in the case of "no boot/no ssh" for ADE operating
    system-encrypted virtual machines quite time-consuming. Currently, the memory
    requirements shown in *Table 5.1* apply:'
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 在使用Linux虚拟机的Azure磁盘加密时，存在某些建议和限制，目前还没有直接的方法可以从Linux虚拟机的操作系统磁盘中移除加密，这使得在ADE操作系统加密的虚拟机出现“无启动/无ssh”情况时，故障排除过程相当耗时。目前，*表5.1*中显示的内存要求适用：
- en: '![VMs with memory requirements for smooth encryption](img/Table_5.1.jpg)'
  id: totrans-107
  prefs: []
  type: TYPE_IMG
  zh: '![用于平滑加密的具有内存要求的虚拟机](img/Table_5.1.jpg)'
- en: 'Table 5.1: Virtual machines with memory requirements'
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 表5.1：具有内存要求的虚拟机
- en: Note
  id: totrans-109
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 注意
- en: Once encryption is complete, you may reduce the virtual machine's memory size.
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦加密完成，您可以减少虚拟机的内存大小。
- en: Keep in mind that it is mandatory to have temporary disks enabled in order to
    use Azure Disk Encryption. On a practical level, this makes virtual machine types
    Dv4, Dsv4, Ev4, and Esv4 unable to use disk encryption.
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 请记住，为了使用Azure磁盘加密，必须启用临时磁盘。在实际操作中，这使得Dv4、Dsv4、Ev4和Esv4类型的虚拟机无法使用磁盘加密。
- en: 'Another limitation is that generation 2 virtual machines and Lsv2-series virtual
    machines are not supported currently. You can find all unsupported scenarios documented
    here: [https://docs.microsoft.com/azure/virtual-machines/linux/disk-encryption-linux#unsupported-scenarios](https://docs.microsoft.com/azure/virtual-machines/linux/disk-encryption-linux#unsupported-scenarios).'
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 另一个限制是目前不支持第2代虚拟机和Lsv2系列虚拟机。您可以在这里找到所有不受支持的场景的文档：[https://docs.microsoft.com/azure/virtual-machines/linux/disk-encryption-linux#unsupported-scenarios](https://docs.microsoft.com/azure/virtual-machines/linux/disk-encryption-linux#unsupported-scenarios)。
- en: 'The list of supported Linux distributions for Azure Disk Encryption is quite
    extensive, but it covers only a subset of all endorsed distributions. As the list
    is updated frequently, we won''t include it here, but you can find the up-to-date
    list in the Azure documentation: [https://docs.microsoft.com/azure/virtual-machines/linux/disk-encryption-overview#supported-operating-systems](https://docs.microsoft.com/azure/virtual-machines/linux/disk-encryption-overview#supported-operating-systems).'
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: Azure磁盘加密支持的Linux发行版列表非常广泛，但只涵盖了所有认可发行版的一个子集。由于列表经常更新，我们不会在这里包含它，但您可以在Azure文档中找到最新的列表：[https://docs.microsoft.com/azure/virtual-machines/linux/disk-encryption-overview#supported-operating-systems](https://docs.microsoft.com/azure/virtual-machines/linux/disk-encryption-overview#supported-operating-systems)。
- en: Next, let's take a look at how to keep up with updates and security patches
    for Linux on Azure.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，让我们看看如何跟上Azure上Linux的更新和安全补丁。
- en: Updating Linux on Azure
  id: totrans-115
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 在Azure上更新Linux
- en: Azure provides mechanisms to update all supported Linux distributions. For some
    distributions, Microsoft has its own update repository mirrored from the official
    upstream repository, while for others, the updates come directly from third-party
    vendors' repositories.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: Azure提供了更新所有支持的Linux发行版的机制。对于一些发行版，微软有自己的更新存储库，从官方上游存储库镜像而来，而对于其他发行版，更新直接来自第三方供应商的存储库。
- en: '**Red Hat Enterprise Linux** (**RHEL**) updates are available from Azure directly
    running Red Hat Update Infrastructure. This update repository is available for
    PAYG deployments of RHEL. For virtual machines deployed using the **Bring-Your-Own-Subscription**
    (**BYOS**) method, you need to use Red Hat''s own update servers or your own company''s
    Red Hat Satellite server to download updates.'
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: '**Red Hat Enterprise Linux** (**RHEL**) 更新可以直接从Azure运行的Red Hat Update Infrastructure获取。这个更新存储库适用于RHEL的PAYG部署。对于使用**Bring-Your-Own-Subscription**
    (**BYOS**)方法部署的虚拟机，您需要使用Red Hat自己的更新服务器或您自己公司的Red Hat Satellite服务器来下载更新。'
- en: 'Read more about RHEL on Azure updates and the Azure RHUI here: [https://docs.microsoft.com/azure/virtual-machines/workloads/redhat/redhat-rhui](https://docs.microsoft.com/azure/virtual-machines/workloads/redhat/redhat-rhui).'
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 阅读有关Azure上RHEL更新和Azure RHUI的更多信息：[https://docs.microsoft.com/azure/virtual-machines/workloads/redhat/redhat-rhui](https://docs.microsoft.com/azure/virtual-machines/workloads/redhat/redhat-rhui)。
- en: Note
  id: totrans-119
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 注意
- en: If you have a Red Hat Satellite server, you can continue to use it with RHEL
    on Azure for virtual machines that have been migrated from on-premises to Azure.
    Satellite can also be used with BYOS installations.
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您有Red Hat Satellite服务器，您可以继续在Azure上使用它来管理已从本地迁移到Azure的RHEL虚拟机。Satellite也可以与BYOS安装一起使用。
- en: You should not use Satellite with PAYG images as you would be consuming your
    RHEL client certificates as well as consuming your PAYG subscription and practically
    paying twice for the RHEL installation.
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 您不应该在PAYG镜像中使用Satellite，因为这样会消耗您的RHEL客户端证书，实际上为RHEL安装支付两次。
- en: '**SUSE Linux Enterprise Server** (**SLES**) has a slightly different architecture
    for the update servers: your SLES virtual machines will get updates directly from
    official SUSE-operated repositories. You can find more details on SLES and Azure
    updates from the SUSE documentation: [https://www.suse.com/c/?s=cloud-regionsrv-client](https://www.suse.com/c/?s=cloud-regionsrv-client).'
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: '**SUSE Linux Enterprise Server** (**SLES**) 的更新服务器架构略有不同：您的SLES虚拟机将直接从官方SUSE运营的存储库获取更新。您可以在SUSE文档中找到有关SLES和Azure更新的更多详细信息：[https://www.suse.com/c/?s=cloud-regionsrv-client](https://www.suse.com/c/?s=cloud-regionsrv-client)。'
- en: 'To update your Linux servers on Azure, you can do it the old-fashioned way
    by logging in to the servers via SSH and invoking `apt-get update` or `yum update`
    depending on your Linux distribution. Ubuntu on Azure can get also updates from
    mirrors hosted on Azure. The repository server alias configured by default on
    Ubuntu images on Azure is `azure.archive.ubuntu.com`. This host name is resolved
    to the actual server in the region of your resource group:'
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 要在Azure上更新您的Linux服务器，您可以通过SSH登录服务器并调用`apt-get update`或`yum update`来以传统方式进行。Azure上的Ubuntu也可以从托管在Azure上的镜像获取更新。在Azure上的Ubuntu镜像上默认配置的存储库服务器别名是`azure.archive.ubuntu.com`。这个主机名将解析为您资源组所在地区的实际服务器：
- en: '![Finding the update server address by executing the host azure.archive.ubuntu.com
    command](img/B17160_05_08.jpg)'
  id: totrans-124
  prefs: []
  type: TYPE_IMG
  zh: '![通过执行主机azure.archive.ubuntu.com命令找到更新服务器地址](img/B17160_05_08.jpg)'
- en: 'Figure 5.8: Finding the update server address'
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 图5.8：查找更新服务器地址
- en: In this example, you can see that the nearest Ubuntu update server for me was
    located in the Southeast Asia region and that its IP address was `20.195.37.151`.
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个例子中，您可以看到对我来说最近的Ubuntu更新服务器位于东南亚地区，其IP地址为`20.195.37.151`。
- en: Microsoft also provides Azure Update Management, which is an add-on mechanism
    assisting you in managing updates to Linux servers.
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: 微软还提供了Azure Update Management，这是一个辅助您管理Linux服务器更新的附加机制。
- en: Azure Update Management
  id: totrans-128
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: Azure Update Management
- en: To avoid manual repetitive work, you can update one or more servers simultaneously
    using the Azure Update Management service. This service is part of Azure Automation
    and supports both Linux and Windows operating systems.
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 为了避免手动重复的工作，您可以使用Azure更新管理服务同时更新一个或多个服务器。该服务是Azure自动化的一部分，支持Linux和Windows操作系统。
- en: Azure Update Management is not the only tool in Azure for update management.
    If you are already using Ansible for your update management and automation, Ansible
    Automation is also available on Azure.
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: Azure更新管理不是Azure中用于更新管理的唯一工具。如果您已经在Azure上使用Ansible进行更新管理和自动化，那么Ansible Automation也可用于Azure。
- en: 'Currently, only some Linux distributions are supported with Azure Update Management.
    Please refer to the documentation for an up-to-date list: [https://docs.microsoft.com/azure/automation/update-management/overview](https://docs.microsoft.com/azure/automation/update-management/overview).'
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: 目前，只有一些Linux发行版受到Azure更新管理的支持。请参考文档以获取最新列表：[https://docs.microsoft.com/azure/automation/update-management/overview](https://docs.microsoft.com/azure/automation/update-management/overview)。
- en: You can use the Azure Update Management service to list all available updates
    and manage the process of installing the required updates for servers. This service
    uses the Azure Linux Agent to communicate with virtual machines as described earlier
    in this chapter.
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以使用Azure更新管理服务列出所有可用的更新，并管理安装服务器所需更新的过程。该服务使用Azure Linux代理与虚拟机通信，如本章前面描述的那样。
- en: '*Figure 5.9* illustrates the architecture of the Azure Update Management service:'
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: '*图5.9*说明了Azure更新管理服务的架构：'
- en: '![Azure Update Management service architecture](img/B17160_05_09.jpg)'
  id: totrans-134
  prefs: []
  type: TYPE_IMG
  zh: '![Azure更新管理服务架构](img/B17160_05_09.jpg)'
- en: 'Figure 5.9: Azure Update Management architecture'
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: 图5.9：Azure更新管理架构
- en: Azure Update Management does not replace the normal update mechanism or package
    manager of a Linux distribution, but it issues requests to those to execute the
    required maintenance tasks. Practically, this means that, for example, the Ubuntu
    updates are still being installed by the `apt` tool and, for example, in RHEL,
    the updates are being managed by `yum`. The updates are fetched from the repository
    configured in the Linux installation.
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: Azure更新管理不会取代Linux发行版的正常更新机制或软件包管理器，但它会向这些发出请求以执行所需的维护任务。实际上，这意味着，例如，Ubuntu更新仍然由`apt`工具安装，例如，在RHEL中，更新由`yum`管理。更新是从Linux安装中配置的存储库中获取的。
- en: On Linux, the available updates are automatically polled once per hour by Azure
    Update Management.
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 在Linux上，可用的更新每小时由Azure更新管理自动轮询一次。
- en: Now, let's take a look at the next hands-on lab for managing Linux on Azure
    to guide you further in your cloud journey.
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，让我们看一下下一个在Azure上管理Linux的实践，以指导您在云旅程中更进一步。
- en: Hands-on managing Linux on Azure
  id: totrans-139
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 在Azure上管理Linux的实践
- en: Linux logs can be ingested into the Log Analytics workspace. In this hands-on
    exercise, we will see how we can ingest the syslog from our migrated Linux machine
    into the Log Analytics workspace and analyze it using **Kusto Query Language**
    (**KQL**).
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: Linux日志可以被摄入到日志分析工作区。在这个实践中，我们将看到如何将我们迁移的Linux机器的syslog摄入到日志分析工作区，并使用**Kusto查询语言**（**KQL**）进行分析。
- en: Syslog is an event logging protocol that is widely used in Linux. The messages
    sent by the applications may get stored on the local machine or delivered to a
    syslog collector. Using the Linux Log Analytics agent, we will configure the syslog
    daemon to forward these syslog entries to the agent, and the agent will then send
    the messages to the Log Analytics workspace, which is part of Azure Monitor. Here,
    we are using the Log Analytics agent to push the data to the Log Analytics workspace.
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: Syslog是广泛用于Linux的事件日志记录协议。应用程序发送的消息可能会存储在本地机器上或传递到syslog收集器。使用Linux日志分析代理，我们将配置syslog守护进程将这些syslog条目转发到代理，并代理将消息发送到作为Azure
    Monitor一部分的日志分析工作区。在这里，我们使用日志分析代理将数据推送到日志分析工作区。
- en: '*Figure 5.10* is a graphical representation of how data is sent to Azure Monitor
    from the Linux machine:'
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: '*图5.10*是数据从Linux机器发送到Azure Monitor的图形表示：'
- en: '![A graphical representation of the Linux machine sending Syslog messages to
    Azure Monitor](img/B17160_05_10.jpg)'
  id: totrans-143
  prefs: []
  type: TYPE_IMG
  zh: '![Linux机器将Syslog消息发送到Azure Monitor的图形表示](img/B17160_05_10.jpg)'
- en: 'Figure 5.10: Sending syslog messages to Azure Monitor'
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 图5.10：将syslog消息发送到Azure Monitor
- en: 'The syslog collector supports the following facilities:'
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: syslog收集器支持以下设施：
- en: '`kern`'
  id: totrans-146
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`kern`'
- en: '`user`'
  id: totrans-147
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`user`'
- en: '`mail`'
  id: totrans-148
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`mail`'
- en: '`daemon`'
  id: totrans-149
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 守护进程
- en: '`auth`'
  id: totrans-150
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 身份验证
- en: '`syslog`'
  id: totrans-151
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`syslog`'
- en: '`lpr`'
  id: totrans-152
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`lpr`'
- en: '`news`'
  id: totrans-153
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`news`'
- en: '`uucp`'
  id: totrans-154
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`uucp`'
- en: '`cron`'
  id: totrans-155
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`cron`'
- en: '`authpriv`'
  id: totrans-156
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`authpriv`'
- en: '`ftp`'
  id: totrans-157
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`ftp`'
- en: '`local0-local7`'
  id: totrans-158
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`local0-local7`'
- en: If you would like to collect any facility outside the list, then you may need
    to configure a custom data source in Azure Monitor. In our hands-on exercise,
    we will onboard the LAMP server, which we migrated in *Chapter 4*, *Performing
    migration to Azure*, to the Log Analytics workspace, and then we will configure
    it to collect the syslog.
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您想收集列表之外的任何设施，那么您可能需要在Azure Monitor中配置自定义数据源。在我们的实践中，我们将接入LAMP服务器，该服务器在*第4章*，*执行迁移到Azure*中迁移，到日志分析工作区，然后我们将配置它来收集syslog。
- en: The first step will be to onboard the virtual machine to send logs to the Log
    Analytics workspace.
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: 第一步将是接入虚拟机以将日志发送到日志分析工作区。
- en: Creating a Log Analytics workspace
  id: totrans-161
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 创建日志分析工作区
- en: 'The process is very simple—we need to create a Log Analytics workspace and
    connect our virtual machine to the workspace. You can follow the steps outlined
    here to onboard your virtual machine:'
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 这个过程非常简单 - 我们需要创建一个日志分析工作区，并将我们的虚拟机连接到工作区。您可以按照这里概述的步骤来接入您的虚拟机：
- en: Navigate to the Azure portal and search for Log Analytics workspaces and click
    on that. Once you are in the Log Analytics workspaces blade, click on the New
    button as shown in *Figure 5.11* to create a workspace:![Adding a new workspace
    by clicking on the +New button at the top right](img/B17160_05_11.jpg)
  id: totrans-163
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 导航到Azure门户并搜索日志分析工作区，然后单击它。一旦您进入日志分析工作区刀片，单击*图5.11*中显示的“新建”按钮来创建一个工作区：![通过单击右上角的+新建按钮添加新的工作区](img/B17160_05_11.jpg)
- en: 'Figure 5.11: Adding a new workspace'
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: 图5.11：添加新的工作区
- en: Clicking on New will redirect you to the wizard to create a workspace and the
    Basics tab requires basic information such as Subscription, Resource group, Name,
    and Region. You can complete these details as shown in *Figure 5.12* and proceed
    to Pricing tier:![Creating a Log Analytics workspace by clicking on the Review
    + Create button](img/B17160_05_12.jpg)
  id: totrans-165
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 单击“新建”将重定向您到创建工作区的向导，基本选项卡需要基本信息，如订阅、资源组、名称和区域。您可以按照*图5.12*中显示的方式填写这些细节，然后转到定价层：![通过单击“查看+创建”按钮创建日志分析工作区](img/B17160_05_12.jpg)
- en: 'Figure 5.12: Creating a Log Analytics workspace'
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: 图5.12：创建日志分析工作区
- en: 'For Pricing tier, you can keep the default value: `Pay-as-you-go (Per GB 2018)`.
    You can also reserve the capacity reservation if required; however, for this hands-on
    exercise, it is not required.'
  id: totrans-167
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 对于定价层，您可以保持默认值：“按使用量付费（每GB 2018）”。如果需要，您还可以预留容量；但是，对于这个实践，这是不需要的。
- en: Finally, you can click on Review + Create and the workspace will be created.
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，您可以单击“查看+创建”，工作区将被创建。
- en: Onboarding an Azure virtual machine
  id: totrans-169
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 登记Azure虚拟机
- en: 'Now that you''ve created the workspace to which the logs will get ingested,
    the next stage is the virtual machine onboarding. You need to open the workspace
    we created to onboard the virtual machine. You can search for Log Analytics workspace
    in the top search bar and you will be able to see the name of the workspace. Click
    on it and open the workspace. The onboarding steps are as follows:'
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 现在您已经创建了日志将被摄入的工作区，下一个阶段是虚拟机的登记。您需要打开我们创建的工作区来登记虚拟机。您可以在顶部搜索栏中搜索日志分析工作区，然后找到工作区的名称。单击它并打开工作区。登记步骤如下：
- en: Navigate to Virtual machines under Workspace Data Sources and you'll be able
    to see the virtual machine that we migrated from on-premises. Log Analytics Connection
    will be shown as Not connected, as seen in *Figure 5.13*:![Adding data sources
    to the workspace by navigating Virtual Machines under Workspace Data Sources](img/B17160_05_13.jpg)
  id: totrans-171
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 导航到工作区数据源下的虚拟机，您将能够看到我们从本地迁移的虚拟机。日志分析连接将显示为未连接，如*图5.13*中所示：![通过导航到工作区数据源下的虚拟机添加数据源](img/B17160_05_13.jpg)
- en: 'Figure 5.13: Adding data sources to the workspace'
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: 图5.13：向工作区添加数据源
- en: Click on the virtual machine name and you will be taken to a new page where
    you will be able to see the Connect option, as shown in *Figure 5.14*. Please
    note that in order for the connect operation to succeed, the virtual machine should
    be in the running state, otherwise it will fail. Also, make sure that `walinuxagent`
    is installed, as already recommended in the *Manage and Secure* section, and that
    the agent is listed as Ready under the Properties blade of the virtual machine.
    Click on Connect, after which the extension will be configured on the virtual
    machine:![Connecting lamp-server to Log Analytics](img/B17160_05_14.jpg)
  id: totrans-173
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 单击虚拟机名称，您将进入一个新页面，在那里您将能够看到“连接”选项，如*图5.14*所示。请注意，为了使连接操作成功，虚拟机应该处于运行状态，否则将失败。还要确保`walinuxagent`已安装，如*管理和安全*部分中已建议的，并且代理在虚拟机的属性刀片下列为“就绪”。单击“连接”，之后将在虚拟机上配置扩展：![将lamp-server连接到日志分析](img/B17160_05_14.jpg)
- en: 'Figure 5.14: Connecting to Log Analytics'
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: 图5.14：连接到日志分析
- en: If you navigate back to the previous Virtual machines blade, you will be able
    to see that the status has been changed to Connecting, as is visible in *Figure
    5.15*. This process will take some time and Log Analytics extensions will be configured
    on the selected virtual machine:![Verifying the connection status of lamp-server](img/B17160_05_15.jpg)
  id: totrans-175
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 如果您导航回到之前的虚拟机刀片，您将看到状态已更改为“连接”，如*图5.15*中所示。这个过程需要一些时间，并且日志分析扩展将在所选的虚拟机上配置：![验证lamp-server的连接状态](img/B17160_05_15.jpg)
- en: 'Figure 5.15: Verifying the connection status'
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: 图5.15：验证连接状态
- en: Once the extensions are installed, the virtual machine is onboarded to the Log
    Analytics workspace. You can confirm this by verifying that the status of the
    connection is Connected.
  id: totrans-177
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 一旦扩展安装完成，虚拟机就已经登记到了日志分析工作区。您可以通过验证连接状态为已连接来确认这一点。
- en: Onboarding is complete; however, we still haven't configured that Log Analytics
    workspace with instructions about what type of event data should be pulled from
    the virtual machine. In the next section, we will configure data collection.
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: 登记已完成；但是，我们还没有配置日志分析工作区，指定应从虚拟机中提取什么类型的事件数据的说明。在下一节中，我们将配置数据收集。
- en: Data collection
  id: totrans-179
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 数据收集
- en: 'We have onboarded our virtual machine, and the Log Analytics extension is ready
    to collect the data and ingest it into the Log Analytics workspace. However, we
    need to set up data collection, that is, we need to specify which datasets we
    need to pull from the virtual machine. We can configure the collection as follows:'
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: 我们已经登记了我们的虚拟机，并且日志分析扩展已准备好收集数据并将其摄入到日志分析工作区。但是，我们需要设置数据收集，也就是说，我们需要指定我们需要从虚拟机中提取哪些数据集。我们可以按照以下方式配置收集：
- en: Navigate back to the Log Analytics workspace we created and select Agents configuration,
    as shown in *Figure 5.16*:![Navigating to data collection by clicking on Agents
    configuration under the Settings blade](img/B17160_05_16.jpg)
  id: totrans-181
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 返回到我们创建的日志分析工作区，并选择代理配置，如*图5.16*所示：![通过在设置刀片下单击代理配置导航到数据收集](img/B17160_05_16.jpg)
- en: 'Figure 5.16: Navigating to the data collection configuration'
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: 图5.16：导航到数据收集配置
- en: Navigate to Linux performance counters and add the recommended counters. Azure
    will present you with a list of recommended performance counter names, as shown
    in *Figure 5.17*. If you require additional counters, you can click on Add performance
    counter and add it. Once done, click on Apply to save the configuration:![Configuring
    performance counters by navigating to Agents configuration | Linux Performance
    counters](img/B17160_05_17.jpg)
  id: totrans-183
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 导航到Linux性能计数器并添加推荐的计数器。Azure将向您显示推荐的性能计数器名称列表，如*图5.17*所示。如果您需要额外的计数器，可以单击“添加性能计数器”并添加。完成后，单击“应用”以保存配置：![通过导航到代理配置|Linux性能计数器配置性能计数器](img/B17160_05_17.jpg)
- en: 'Figure 5.17: Configuring performance counters'
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
  zh: 图5.17：配置性能计数器
- en: After configuring the performance counters, you can click on the Syslog tab.
    Clicking on Add facility will list all the facilities available to you, including
    auth, authpriv, and cron. Also, you can specify the logging level for each facility.
    You can add the following facilities as shown in *Figure 5.18*. Once added, click
    on Apply to save the configuration:![Sylog tab configuring syslog facilities](img/B17160_05_18.jpg)
  id: totrans-185
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 配置性能计数器后，您可以单击“Syslog”选项卡。单击“添加设施”将列出所有可用的设施，包括auth、authpriv和cron。此外，您可以为每个设施指定日志级别。您可以添加如下设施，如*图5.18*所示。添加后，单击“应用”以保存配置：![Sylog选项卡配置系统日志设施](img/B17160_05_18.jpg)
- en: 'Figure 5.18: Configuring syslog facilities'
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: 图5.18：配置系统日志设施
- en: With that, we have configured the data collection. Now we need to verify whether
    the data is getting ingested into the Log Analytics workspace, and ingestion will
    take some time after completing the onboarding. In the next section, we will run
    some sample queries and see whether we are getting results.
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
  zh: 有了这个，我们已经配置了数据收集。现在我们需要验证数据是否被摄入到日志分析工作区中，并且在完成登记后，摄入需要一些时间。在下一节中，我们将运行一些示例查询，看看我们是否获得了结果。
- en: Querying data
  id: totrans-188
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 查询数据
- en: In the previous section, we configured several performance counters and syslog
    facilities that need to be ingested into our Log Analytics workspace. Now, we
    will query these logs using KQL and verify whether we are getting the data ingested
    from the virtual machine.
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: 在上一节中，我们配置了几个性能计数器和需要被摄入到我们的日志分析工作区中的系统日志设施。现在，我们将使用KQL查询这些日志，并验证是否从虚拟机中摄入了数据。
- en: 'There will be different tables to store the performance, syslog, and other
    data. You can query the logs of the virtual machine by scoping your queries to
    the specific virtual machine. If you run the query from the workspace level, logs
    from all onboarded virtual machines will be returned. Nevertheless, you can change
    the scope from here, too. In our case, there is only one virtual machine onboarded
    to the workspace, so querying from the Virtual machines blade or the Log Analytics
    blade will be the same. However, let''s query from the Virtual machines blade
    to make sure that we are looking at the right scope:'
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
  zh: 将性能、系统日志和其他数据存储在不同的表中。您可以通过将查询范围限定到特定的虚拟机来查询虚拟机的日志。如果您从工作区级别运行查询，将返回所有已登记的虚拟机的日志。不过，您也可以从这里更改范围。在我们的情况下，只有一个虚拟机登记到工作区，因此从“虚拟机”刀片或“日志分析”刀片查询将是相同的。不过，让我们从“虚拟机”刀片查询，以确保我们正在查看正确的范围：
- en: Navigate to Virtual machines and open the virtual machine we migrated from on-premises
    in *Chapter 4*, *Performing migration to Azure*. From Monitoring, select Logs,
    as shown in *Figure 5.19*:![Navigating to Logs from the Virtual machine blade](img/B17160_05_19.jpg)
  id: totrans-191
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 导航到虚拟机，并打开我们在*第4章*“执行迁移到Azure”中从本地迁移的虚拟机。从“监视”中，选择“日志”，如*图5.19*所示：![从虚拟机刀片导航到日志](img/B17160_05_19.jpg)
- en: 'Figure 5.19: Navigating to Logs from the Virtual machines blade'
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
  zh: 图5.19：从虚拟机刀片导航到日志
- en: To list all the tables in the workspace, you can run a `search` `* | distinct
    $table`, in the query window and see the results in the Results window. An example
    is shown in *Figure 5.20*:![Listing all tables in the Log Analytics workspace](img/B17160_05_20.jpg)
  id: totrans-193
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 要列出工作区中的所有表，可以在查询窗口中运行`search` `* | distinct $table`，并在结果窗口中查看结果。示例显示在*图5.20*中：![列出日志分析工作区中的所有表](img/B17160_05_20.jpg)
- en: 'Figure 5.20: Listing all tables in the Log Analytics workspace'
  id: totrans-194
  prefs: []
  type: TYPE_NORMAL
  zh: 图5.20：列出日志分析工作区中的所有表
- en: In the results, you can see multiple tables, such as `Syslog`, `VMProcess`,
    `VMBoundPort`, `VMConnection`, and `Perf`. Let's query some tables and check the
    results. All the following scripts need to be run on the query window.
  id: totrans-195
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在结果中，您可以看到多个表，如`Syslog`、`VMProcess`、`VMBoundPort`、`VMConnection`和`Perf`。让我们查询一些表并检查结果。所有以下脚本都需要在查询窗口中运行。
- en: 'Return all informational logs where the `syslog` message contains `rsyslog`:'
  id: totrans-196
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 返回包含“rsyslog”消息的所有信息日志：
- en: '[PRE3]'
  id: totrans-197
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'Render a time chart for the `% Used Memory` performance counter:'
  id: totrans-198
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 为“% Used Memory”性能计数器呈现时间图表：
- en: '[PRE4]'
  id: totrans-199
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'Return all external connections made by processes, including the destination
    IP and port number:'
  id: totrans-200
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 返回由进程进行的所有外部连接，包括目标IP和端口号：
- en: '[PRE5]'
  id: totrans-201
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: You can run any sort of query using the available dataset. KQL is very powerful,
    and it can perform wonders on your dataset. With this exercise, we have reached
    the end of the hands-on lab. In this lab, we onboarded the on-premises virtual
    machine we migrated in *Chapter 4*, *Performing migration to Azure*, to the Log
    Analytics workspace and ingested the performance and syslog into the workspace.
    Furthermore, we queried the ingested data using KQL to obtain some results and
    time charts.
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以使用可用的数据集运行任何类型的查询。KQL非常强大，可以在数据集上发挥奇迹。通过这个练习，我们已经到达了实验的最后。在这个实验中，我们将迁移到了*第4章*“执行迁移到Azure”中迁移到的本地虚拟机登记到了日志分析工作区，并将性能和系统日志摄入到了工作区。此外，我们使用KQL查询摄入的数据以获得一些结果和时间图表。
- en: Summary
  id: totrans-203
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 摘要
- en: This chapter has covered various details about how to effectively operate Linux
    on Azure. First, we went through the *Optimize* phase, including the ACM and Azure
    Advisor tools. Then, we proceeded to the *Manage & Secure* phase, where we spent
    some time with the data protection functionality as well as the Azure Linux Agent.
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
  zh: 本章涵盖了如何有效地在Azure上操作Linux的各种细节。首先，我们经历了“优化”阶段，包括ACM和Azure Advisor工具。然后，我们进入了“管理和安全”阶段，在那里我们花了一些时间了解数据保护功能以及Azure
    Linux代理。
- en: Just before the hands-on lab, you also learned how Azure Update Management works
    in conjunction with various Linux distributions' update mechanisms.
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
  zh: 就在动手实验之前，您还了解了Azure更新管理如何与各种Linux发行版的更新机制配合工作。
- en: We have now covered all the topics regarding assessing, migrating, and operating
    Linux on Azure. What happens when something doesn't work as you expect? Let's
    find out in the next chapter, where we will guide you through troubleshooting
    Linux on Azure.
  id: totrans-206
  prefs: []
  type: TYPE_NORMAL
  zh: 我们现在已经涵盖了关于在Azure上评估、迁移和操作Linux的所有主题。当某些事情不如你所期望的那样工作时会发生什么？让我们在下一章中找出答案，我们将指导您如何在Azure上排除Linux的故障。
