# 第一章：Linux 和电子邮件基础知识

如果你是成千上万的系统管理员之一，负责管理中小型公司的网络和计算机，并且正在考虑托管自己的电子邮件服务，那么这本书就是为你准备的。

我们将从电子邮件系统的最基本组件开始。这些组件将允许你的用户向互联网上的任何人发送或接收邮件。这可能是你所需要的全部，但许多公司还希望为他们的用户提供一个可访问的网络邮件服务，人们可以在家里或在外出时使用。今天许多人不幸无法没有的另一个功能是有效防范通过电子邮件传播的病毒以及垃圾邮件的过滤。

我们还将涵盖安全性的最重要方面，以防止未经授权或恶意使用服务器。然后，我们将讨论如何保留服务器接收或发送的所有电子邮件的存档。最后，我们将描述一种备份和恢复服务器的过程，以保护所有消息免受数据丢失。

本书将介绍所讨论软件的主要特性，这将为你提供一个坚实的基础。

在本书结束时，你将拥有一个适合大多数小公司的运行良好的电子邮件服务器。

作为我们努力的技术平台，我们选择了 GNU/Linux 操作系统和一组经过验证的免费软件工具，这些工具将帮助我们实现为中小企业提供安全可靠的电子邮件服务器的目标。我们选择的工具是广为人知和使用的，由软件专业人员编写，并得到了大量用户的支持。

在本书的这一章中，我们将从你在开始处理服务器之前需要了解的内容开始。

+   我们讨论了运行自己的电子邮件服务器的优缺点。

+   我们提供了选择服务器所需的适当硬件和网络连接的指导。

+   我们对用于在互联网上交换邮件的协议进行了简要介绍，以及允许用户访问他们的电子邮件的主要协议。

+   为了正确路由电子邮件，我们讨论了连接到互联网的服务器上所需的配置选项。

+   最后，我们简要介绍备用电子邮件服务器。

在本章结束时，你将对运行电子邮件服务器所需的主要组件有基本的了解。

# 为什么要管理自己的电子邮件服务器

大多数互联网服务提供商（ISP）已经为客户提供了在他们的服务器上发送和接收电子邮件的能力，那么为什么我们要自己拥有和管理它呢？毕竟，你正在阅读这本书，你可能已经有了自己的理由，但让我们来探讨这个问题以及一些可能的答案。

托管和管理自己的电子邮件服务器最重要的原因是控制。对于许多组织来说，电子邮件是信息技术基础设施的重要组成部分。保持对你的电子邮件的控制有许多优点。

+   如果一家公司在多个地方设有办事处，你在选择如何连接它们时有完全的自由。办事处之间的虚拟专用网络，办事处之间的传输层安全（TLS）连接，所有办事处的单一服务器，每个办事处一个服务器，等等。

+   通过在内部保留自己的消息，你可以相互发送消息，而无需让它们在未加密的线路上往返于 ISP 之间。如果你的互联网连接失败，这也会为你提供更可靠的服务，并避免不必要的延迟。

+   你不依赖于提供商员工的能力。如果你管理自己的服务器并需要解决一个困难的问题或为某事实施自定义解决方案，你可以。或者在必要时，你可以雇佣顾问来帮助你。

+   如果提供商破产，你所有的数据都安全地存放在你的服务器房间和备份介质上。

+   您不受我们的提供商可能设置的限制，比如磁盘空间的使用或消息的最大大小。

+   您可以实施任何您选择的消息归档、反垃圾邮件或反病毒策略。

更多的控制需要更多的责任和知识，这就是本书的用武之地。

除了这些令人信服的论点之外，自己托管电子邮件服务器也有缺点。这是一项需要一定水平的知识和承诺的任务，因此不应该由每个人来承担。拥有自己的服务器，您不仅对提供给用户的服务负责，还对整个互联网社区负有责任。配置不良的电子邮件服务器可以帮助蠕虫和垃圾邮件传播，这不仅对社区是一种伤害，还可能使您的服务器被列入黑名单。即使一个正确设置的服务器可以长时间运行而不需要太多维护，您也必须保持自己合理更新，并准备应对可能出现的新威胁。这并不是要吓唬您，而是要在着手这个项目之前仔细考虑。

# 您需要托管电子邮件服务器的内容

您的服务器需要通过固定 IP 地址的永久互联网连接可用。理论上，可以使用非固定（动态）IP 地址运行电子邮件服务器，但当 IP 地址更改时，它将不可靠，并且您将面临丢失消息的风险。使用动态 IP 地址，您还将面临更大的风险，可能会被列入动态 IP 地址范围的黑名单之一。

如果您认真考虑运行电子邮件服务器，请获取一个体面的商业级互联网连接。如今这些相对便宜，投资其中将会在以后节省很多麻烦。电子邮件流量不依赖于高带宽，因此简单的 DSL 线路的容量应该是足够的。

即使您需要固定 IP 地址，也不一定需要专用于邮件服务器的公共 IP 地址。如果您的公司只有几个外部 IP 地址，并且在内部使用私有 RFC 1918 地址（`192.168.x.y`）并且使用**网络地址转换**（**NAT**）路由器，这不是问题。NAT 路由器将私有网络连接到世界其他地方，并且可以设置路由器以将电子邮件服务所需的端口转发到内部电子邮件服务器。

下表显示了最有可能用于此目的的 TCP 端口。

| 端口 | 服务 |
| --- | --- |
| `25` | 简单邮件传输协议（SMTP） |
| `110` | 邮局协议（POP） |
| `143` | 互联网消息访问协议（IMAP） |
| `993` | TLS 上的 IMAP |

如果员工想要从家里或外出时访问他们的消息，只需确保没有防火墙阻止访问所需的端口，并且 NAT 路由器（如果有）正确地转发这些端口即可。如果用户想通过电子邮件服务器发送消息，则需要一些额外的配置，以允许主机执行身份验证，以防止未注册用户发送电子邮件。

# 调整电子邮件服务器的硬件规模

选择一台计算机作为电子邮件服务器时，很多人对执行这项任务所需的硬件存在误解。计算机性能不断增加似乎让人们认为他们真的需要最新和最符合时髦词汇的东西，即使他们只想处理几千封邮件。

尽管评估组织的硬件需求需要一定的专业知识，但常识也很重要。对于拥有 100 个用户的公司，每天的消息数量的合理上限可能是 5,000 条。这将允许每个用户每天发送或接收 50 条消息。即使我们假设每条消息都是在工作日的八个小时内发送的，系统平均每分钟处理的消息数量也不会超过 10 条。现代计算机可以在不到六秒的时间内接收并处理一封电子邮件，通常每封邮件的大小只有几千字节。

这个简单的估算显然很粗糙，例如没有考虑到消息通常不是均匀分布在时间上，但这仍然是一个相当不错的估算方法。

现在让我们更深入地看一下在选择服务器时要考虑什么。对于一个不执行任何内容扫描（病毒、垃圾邮件等）的电子邮件服务器，性能通常不受 CPU 的限制，而是受 I/O 性能的限制，特别是硬盘的寻道时间和 I/O 控制器的质量和配置。增加 CPU 的性能对问题没有帮助。现代计算机在 CPU 方面的装备相对较好，因此投资于多个千兆赫多核 CPU 配置可能是没有用的。对于任何合理现代的 1 GHz 级 PC，每秒处理几条消息都不是问题。这个负载相当于每小时接近 20,000 条消息。

添加内容扫描可能会显著增加 CPU 负载，I/O 系统也需要更多的能力来跟上。但是，每秒一两条消息不应该对系统造成明显的负载。

到目前为止，我们讨论的只是电子邮件服务器。它所做的只是接收消息并将其传递给其他主机或本地邮箱。在选择服务器时，你不应忘记人们也会想要阅读他们的电子邮件。这项服务是由额外的服务器软件提供的。就像消息处理软件一样，关键要求是 I/O 而不是 CPU。系统用户的数量本身是一个无关紧要的数字；重要的是使用模式。用户多久会轮询他们的邮箱？如果 100 个用户平均每五分钟轮询一次邮箱，那么平均每三秒就会有一个用户。检查邮箱是否有新消息只需要一小部分时间，所以负担不会很大。

最后，也可以说是最难考虑的是磁盘存储。使用预期的流量数字，我们可以做一些粗略的估算。假设我们的消息中 80%小于 1 KB，15%带有 200 KB 的文档附件，其余是视频和其他 1 MB 的大文件。因此，使用一个 200 天的工作年，大约需要 80 GB 的存储空间。一个典型的 1 TB 硬盘驱动器可以容纳超过 12 年的消息，假设没有消息被删除。

这些指导可能看起来模糊而不具体，但是给出确切的数字是不可能的。从给定的硬件中期望的性能取决于很多因素，试图给出除了一般性指导之外的任何东西都会产生误导。使用常识和简单的估算；除非你确定真的需要，不要购买你能找到的最花哨的服务器，但也不要使用你能找到的任何旧的废弃台式机。即使旧台式机的性能可能足够，但组件可能已经过时，服务协议或保修可能已经过期。

# 主要的电子邮件协议：SMTP、POP 和 IMAP

为什么我们在这本书中讨论基本的网络通信协议？难道我们不是在运行高级软件吗？确实是，但了解协议的使用方式不仅可以帮助调试可能不工作的系统，还可以增加对邮件系统行为的理解。我们将从对协议的非技术概述开始，然后专注于协议的细节。

## 概述

在 UNIX 环境中，传统的邮件应用程序根本不使用任何网络协议。它们通过文件系统直接访问本地存储的邮箱文件。通常，每个用户的收件箱存储在`/var/mail`或`/var/spool/mail`目录中的单个文件中，文件名与用户的名称相同（例如，`/var/spool/mail/joe`）。本书的重点是讨论 Linux 基于的小型办公室的电子邮件解决方案，用户不希望使用终端应用程序登录到中央服务器以访问他们的邮件，因此本地邮件存储将只简要涵盖。

互联网邮件中最重要的协议是**简单邮件传输协议**（**SMTP**）。它的目的是在两个系统之间传输电子邮件消息。这两台计算机可以是服务器，也可以是用户运行邮件应用程序的客户端机器，如 Outlook、Thunderbird、Eudora 等。用户不使用 SMTP 来收集新消息。这就是**邮局协议**（**POP**）和**互联网消息访问协议**（**IMAP**）的用武之地。

一些专有系统，如 Microsoft Exchange 和 Lotus Notes，使用自己的协议来访问消息，我们在这里不讨论它们。

## POP 协议

POP 是这两种协议中更古老、更广泛使用的协议。它专注于让用户访问他们的收件箱，用户可以将新消息下载到本地计算机，然后从服务器上删除它们。POP 服务器不适用于永久存储消息。一些互联网服务提供商的 POP 服务甚至禁止用户在下载一次后将消息留在服务器上。POP 的主要缺点是它只提供一个中间存储介质，用户必须将他们的消息永久存储在其他地方（例如，他们的本地硬盘上）。这不仅对于想要从多个位置访问他们的电子邮件消息的用户来说是不切实际的，而且对于系统管理员来说也是一种麻烦，因为他们可能需要为用户在本地硬盘上的消息实施备份解决方案。POP 也没有提供为每个用户提供多个文件夹的概念；使用 POP，用户只能访问他/她的收件箱。

## IMAP 协议

IMAP 被设计为访问一流邮件存储的方法，即它旨在允许用户永久地将消息存储在服务器上。这解决了系统管理员的备份问题，并允许用户从世界上的任何地方访问所有消息（除了防火墙限制）。IMAP 还有更广泛的 TLS 安全连接实现，使得在敌对环境中使用 IMAP 更加安全。为了提高性能并允许用户在未连接到邮件服务器时使用他们的邮箱，大多数支持 IMAP 的邮件应用程序会在本地硬盘上缓存下载的邮箱和消息。

与 POP 不同，IMAP 支持多个文件夹，并在服务器上存储消息状态信息（消息是否已读、已回复或已删除）。这意味着用户可以从不同位置访问他们的消息存储，可能使用不同的电子邮件客户端，但仍会看到一致、最新的消息视图。IMAP 还支持服务器端搜索，因此客户端应用程序不需要下载所有消息来搜索电子邮件。

## SMTP 协议

SMTP 是一种基于行的文本协议，运行在 TCP 上，这使得解码 SMTP 传输并使用几乎任何计算机上找到的常规 telnet 客户端启动 SMTP 会话变得微不足道。 SMTP 客户端通过连接到 SMTP 服务器上的端口 25 开始会话。 服务器问候客户端后，客户端必须通过说 hello 或实际上是`HELO`或`EHLO`，然后是客户端的主机名来做出回应。 如果服务器接受了友好的问候，客户端可以开始第一次邮件事务。

SMTP 邮件事务由三部分组成-发件人、一个或多个收件人和实际消息内容。 发件人由`MAIL FROM`命令指定，每个收件人由`RCPT TO`命令指定，消息内容的开始由`DATA`命令指定。 如果服务器接受消息，客户端可以继续进行其他事务或发出`QUIT`命令来终止 SMTP 会话。

让我们少些抽象，看一个实际的 SMTP 会话来说明协议。 粗体打印表示客户端发送给服务器的内容。

```
220 mail.example.com ESMTP Postfix (2.12.6.2)
EHLO gw.example.net
250-mail.example.com
250-PIPELINING
250-SIZE
250-VRFY
250-ETRN
250 8BITMIME
250-STARTTLS
250-ENHANCEDSTATUSCODES
MAIL FROM:<jack@example.net> SIZE=112
250 Ok
RCPT TO:<jill@example.com>
250 Ok
RCPT TO:<jack@example.com>
250 Ok
RCPT TO:<joe@example.com>
550 <joe@example.com>: Recipient address rejected: User unknown in local recipient table
DATA
354 End data with <CR><LF>.<CR><LF>
Subject: Test mail
To: <root@example.com>
Date: Sun, 15 May 2009 20:23:22 +0200 (CEST)
This is a test message.
.
250 Ok: queued as B059D3C2B
QUIT
221 Bye

```

这个例子显示了一个自称为`gw.example.net`的主机连接到一个自称为`mail.example.com`的 SMTP 服务器。 因为服务器的第一个响应包含 ESMTP，客户端决定尝试**增强 SMTP**（**ESMTP**），并用`EHLO`而不是`HELO`向服务器打招呼。 服务器接受了这个问候，并用支持的 ESMTP 扩展列表做出了回应。

除了发件人地址，客户端还向服务器发送`SIZE`属性，以指示消息的大小。 这是允许的，因为服务器已经声明支持`SIZE`扩展。 如果客户端指定的大小超过服务器设置的消息大小限制，消息可以立即被拒绝，而不是在接收整个消息后再进行大小评估。

SMTP 消息显然可以有多个收件人。 这带来了一些必须在实施邮件系统和制定政策时记住的后果。 在前面的示例中，邮件服务器接受了前两个收件人，但拒绝了第三个收件人。 由于服务器已接受了两个收件人，客户端将尝试发送消息内容。 在这里，消息被服务器接受并排队等待传递（`250 Ok: queued as B059D3C2B`），这意味着 SMTP 服务器已经承担了将消息传递给接受的收件人的责任。 如果消息无法传递，服务器将向发件人发送一个非传递消息（弹回）。 服务器也可以选择拒绝整个消息。 如果是这样，它将拒绝所有收件人的消息，根本不传递。 换句话说，在消息内容的响应中，服务器必须要么拒绝所有收件人的消息，要么接受所有收件人的消息。

重要的是要理解信封和标题之间的区别。 一封邮件的信封由`MAIL FROM`和`RCPT TO`命令中给出的信息组成，即用于传递消息的发件人和收件人信息。 SMTP 服务器根本不关心`From, To`和`Cc`消息头。 在我们的示例中，`To`标题只包含一个地址，与实际收件人地址之间没有其他关系，但这只是一个巧合。 弹回消息始终发送到信封发件人地址，本例中为`jack@example.net`。 弹回消息的发件人地址是空发件人地址，通常称为空发件人。 无论有多大诱惑，都不应该阻止空发件人地址。

到目前为止，我们还没有评论服务器在每行开头给出的数字代码。 每个数字都有特定的含义，学习正确解释第一个数字是很重要的。

| 数字 | 含义 |
| --- | --- |
| `2` | 服务器已接受上一个命令，并正在等待您的下一个命令。 |
| `3` | 仅在响应`DATA`命令时使用，并表示服务器已准备好接受消息内容。 |
| `4` | 临时错误：请求目前无法执行，但可能稍后可以成功服务。 |
| 永久错误：请求将永远不会被接受。 |

在 SMTP 中，错误条件可以是临时的或永久的。`4`和`5`都用于表示错误。接收到由`4`指定的临时错误的客户端应断开连接，将消息保留在队列中，并在稍后重试。典型的临时错误条件包括完整的邮件队列磁盘，必须在消息可以被接受之前解决的服务器配置错误，或者临时的 DNS 查找错误。永久错误由第一个数字为`5`表示，意味着请求将永远不会被接受，因此客户端必须从队列中删除消息，并向发件人发送一个告诉他或她消息无法被送达的反弹。

SMTP 还有很多内容没有在这个简短的介绍中涵盖。有许多涵盖互联网相关主题的文档，称为**请求评论**（**RFC**）。RFC 是由**互联网工程任务组**（**IETF**）发布的备忘录，通常被采纳为标准。对于 SMTP，最重要的是**RFC 821**（简单邮件传输协议）和**RFC 822**（ARPA 互联网文本消息格式标准）。

# 电子邮件和 DNS

域名系统（DNS）在电子邮件中扮演着重要角色。DNS 被电子邮件客户端和电子邮件服务器使用。即使您不打算维护自己的 DNS 服务器，对 DNS 在电子邮件中的作用有一个深入的了解对于邮件服务器操作员来说是必要的。本节假定读者对 DNS 的一般工作原理有基本的了解。

## 电子邮件应用程序使用的 DNS 记录类型

在许多网络场景中，只使用两种 DNS 记录类型 - **A 记录**和**PTR 记录**。这些分别将主机名映射到 IP 地址和 IP 地址映射到主机名。这些记录类型也用于电子邮件，但还有第三种 DNS 记录类型专门用于电子邮件。

SMTP 服务器如何发现某个域的消息应该发送到哪个主机？收件人域通常作为一个或多个 DNS 查找中的键。首先进行的查找是邮件特定的 MX 记录 - 邮件交换器记录类型。MX 条目允许 DNS 操作员指定可以接收某个域邮件的服务器的主机名或主机名。例如，`MX`记录可用于指定发送给`example.com`的消息应该发送到`mail.example.com`。如果收件人域没有`MX`记录，则尝试查找收件人域的`A`记录。如果`A`记录查找成功，则邮件将被发送到主机。如果`MX`和`A`查找都没有返回任何结果，则消息被视为无法送达，并返回给发件人。

有两个很好的理由拥有`MX`记录：

+   首先，强制将域的`A`记录映射到邮件服务器可能并不理想。例如，公司 Inc.的 WWW 地址[`www.example.com/`](http://www.example.com/)希望允许访问者使用更短的[`example.com/`](http://example.com/) URL，但不希望在邮件服务器上运行 Web 服务器应用程序（或反之亦然）。

+   更重要的原因是 MX 查找的结果不仅包含主机名列表，而是包含（主机名，优先级）元组的列表。优先级字段是一个整数，描述了列表中主机名的优先级。优先级数的绝对大小并不重要，但它与其他主机名的优先级相关，以创建在投递消息时尝试的主机名的有序列表。列表按升序排列，因此优先级数最低的主机名将首先被联系。如果两个主机名具有相同的优先级，它们将以随机顺序尝试。

相同优先级的 MX 记录可以用作两个或多个服务器之间非常粗糙的负载平衡形式。这也可以通过映射到多个 IP 地址的 A 记录来实现。使用 MX 记录可以为域设置具有不同优先级的备份邮件服务器的层次结构，而这是无法通过 A 记录实现的。让我们看一个使用大量邮件服务器的组织的构造示例。

| 优先级 主机名 |
| --- |
| --- --- |
| 10 mx1.example.com |
| 10 mx2.example.com |
| 20 mx3.example.com |
| 30 mx4.example.com |

如果为域 example.com 设置了这个 DNS 配置，SMTP 服务器应该首先尝试将 example.com 的消息投递到 mx1.example.com 或 mx2.example.com。如果两个连接都失败，应该尝试 mx3.example.com，如果甚至该服务器没有及时响应，mx4.example.com 是最后的选择。如果那也失败了，消息将被保留，并在以后重试投递。

# 备份邮件服务器

拥有一个备份邮件服务器，如果主服务器不可用，可以接收消息听起来是一个非常好的主意，但是如今可靠的互联网连接以及垃圾邮件、蠕虫和其他垃圾大部分情况下使得备份邮件服务器不再必要，甚至经常是有害的。拥有备份服务器的理由是它可以在主服务器宕机时接收消息，然后在主服务器恢复正常时将其投递给主服务器。然而，这样做的优势非常小，因为所有的 SMTP 服务器都要求至少将无法投递的消息队列保存五天，然后再返回给发件人。当然，通过备份服务器可以将不可用消息保存更长时间，但是如果主 SMTP 服务器连续不可用超过五天，那么可能存在比丢失几条消息更大的问题。

因为备份邮件服务器通常没有与主服务器相同的垃圾邮件阻挡配置，所以垃圾邮件发送者通常会专门针对备份服务器，以绕过主服务器的更严格规则。

避免备份邮件服务器的另一个重要原因是它们通常不执行收件人验证。这意味着它们不知道哪些收件人地址对它们充当备份服务器的域是有效的。这要求备份服务器接受备份域的所有消息，并尝试将它们投递到主服务器。主服务器将拒绝无效的收件人，导致备份服务器将这样的消息反弹给发件人。这被称为回溯，有两个坏处：

+   发件人地址经常被伪造，因此反弹的消息可能会发送给无辜的旁观者。

+   它可能会填满邮件队列，因为无法将消息投递到接收服务器不可用。

一个繁忙的服务器，如果不执行收件人验证并且受到大量垃圾邮件攻击，可能会在队列中存放成千上万封无法投递的消息。

# 总结

在本章中，我们首先讨论了为什么您甚至应该考虑托管自己的电子邮件服务器。然后，我们看了一些在开始使用服务器之前需要回答的问题——网络连接类型、计算机性能和磁盘空间需求等。

要成功管理电子邮件服务器，了解所使用的网络通信协议是很重要的。我们概述了 POP 和 IMAP，并更深入地探讨了其中最重要的 SMTP。

最后，我们看了 DNS 在将消息路由到正确的服务器或备用服务器（如果有的话）中所起的关键作用。
