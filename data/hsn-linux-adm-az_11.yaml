- en: 'Chapter 11: Troubleshooting and Monitoring Your Workloads'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第11章：故障排除和监视工作负载
- en: Troubleshooting and logging are very much related; you start analyzing the Event,
    Service and System logs when you experience problems.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 故障排除和日志记录非常相关；当您遇到问题时，您开始分析事件、服务和系统日志。
- en: Troubleshooting problems and fixing the problems found in a cloud environment
    can be different from troubleshooting in more classic deployments. This chapter
    explains the differences, the challenges, and the new possibilities of troubleshooting
    Linux workloads in the Azure environment.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 在云环境中解决问题和修复问题可能与在更经典的部署中进行故障排除不同。本章解释了在Azure环境中故障排除Linux工作负载的差异、挑战和新可能性。
- en: 'By the end of this chapter, you''ll be able to:'
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章结束时，您将能够：
- en: Achieve performance analysis in a Linux system using different tools.
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用不同工具在Linux系统中进行性能分析。
- en: Monitor metrics such as CPU, memory, storage, and network details.
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 监视CPU、内存、存储和网络等指标的详细信息。
- en: Use Azure tooling to identify and fix problems.
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用Azure工具识别和解决问题。
- en: Use Linux tooling to identify and fix problems.
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用Linux工具识别和解决问题。
- en: Technical Requirements
  id: totrans-8
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 技术要求
- en: For this chapter, you'll need one or two VMs running a Linux distribution. You
    can use the smallest size if you want. The `audit` daemon must be installed and,
    for the purpose of having audit system logs to analyze and understand, it's a
    good idea to install Apache and a MySQL/MariaDB server.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 对于本章，您需要运行Linux发行版的一个或两个VM。如果您愿意，可以使用最小的大小。必须安装`audit`守护程序，并且为了具有要分析和理解的审计系统日志，最好安装Apache和MySQL/MariaDB服务器。
- en: 'Here is an example in CentOS:'
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 以下是CentOS的一个示例：
- en: '[PRE0]'
  id: totrans-11
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: '`auditd` gives in-depth details about your server performance and activity
    by using audit rules that can be modified based on your needs. To install `audit`
    daemon, use the following:'
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: '`auditd`通过使用可以根据您的需求进行修改的审计规则，提供关于服务器性能和活动的深入详细信息。要安装`audit`守护程序，请使用以下命令：'
- en: '[PRE1]'
  id: totrans-13
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'On executing the preceding command, you''ll get the following output:'
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 执行上述命令后，您将获得以下输出：
- en: '![Installing the audit daemon](img/B15455_11_01.jpg)'
  id: totrans-15
  prefs: []
  type: TYPE_IMG
  zh: '![安装审计守护程序](img/B15455_11_01.jpg)'
- en: 'Figure 11.1: Installing the audit daemon'
  id: totrans-16
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.1：安装审计守护程序
- en: 'If you can see the list of installed audit packages as shown previously, then
    it''s installed already; if not, then run the following command:'
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您可以看到如前所示的已安装的审计软件包列表，则已经安装了；如果没有，则运行以下命令：
- en: '[PRE2]'
  id: totrans-18
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'After installing `auditd` successfully, you need to start the `auditd` service
    to start collecting audit logs and then store the logs:'
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 成功安装`auditd`后，您需要启动`auditd`服务以开始收集审计日志，然后存储日志：
- en: '[PRE3]'
  id: totrans-20
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'If you want to start `auditd` at boot time, then you have to use the following
    command:'
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您想在启动时启动`auditd`，那么您必须使用以下命令：
- en: '[PRE4]'
  id: totrans-22
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'Now let''s verify whether `auditd` is successfully installed and has started
    collecting logs using the following command:'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 现在让我们验证`auditd`是否已成功安装并开始使用以下命令收集日志：
- en: '[PRE5]'
  id: totrans-24
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: '![Verifying of an installation of auditd and collection of logs](img/B15455_11_02.jpg)'
  id: totrans-25
  prefs: []
  type: TYPE_IMG
  zh: '![验证auditd的安装和日志收集](img/B15455_11_02.jpg)'
- en: 'Figure 11.2: Verifying the successful installation of auditd and collection
    of logs'
  id: totrans-26
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.2：验证成功安装auditd并收集日志
- en: In this chapter, we will cover general Azure management and Azure Monitor. The
    Log Analytics agent for Linux, which is needed to collect information from the
    VM, is not supported in every Linux distribution; please visit [https://docs.microsoft.com/en-us/azure/virtual-machines/extensions/oms-linux](https://docs.microsoft.com/en-us/azure/virtual-machines/extensions/oms-linux)
    before making a decision about which distribution you want to use in this chapter.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们将涵盖一般的Azure管理和Azure Monitor。Linux的Log Analytics代理，用于从VM收集信息，不受每个Linux发行版的支持；在决定要在本章中使用哪个发行版之前，请访问[https://docs.microsoft.com/en-us/azure/virtual-machines/extensions/oms-linux](https://docs.microsoft.com/en-us/azure/virtual-machines/extensions/oms-linux)。
- en: Note
  id: totrans-28
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 注意
- en: '**Operations Management Suite** (**OMS**) in general was retired and transitioned
    to Azure and the name ''''OMS'''' is not used anywhere anymore, except in some
    variable names. It is now known as Azure Monitor. For more information on naming
    and terminology changes, please refer to [https://docs.microsoft.com/en-gb/azure/azure-monitor/terminology](https://docs.microsoft.com/en-gb/azure/azure-monitor/terminology),
    or you can also get detailed information about the transition at [https://docs.microsoft.com/en-us/azure/azure-monitor/platform/oms-portal-transition](https://docs.microsoft.com/en-us/azure/azure-monitor/platform/oms-portal-transition).'
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: '**运营管理套件**（**OMS**）通常已停用，并过渡到Azure，名称“OMS”不再在任何地方使用，除了一些变量名称。现在它被称为Azure Monitor。有关命名和术语更改的更多信息，请参阅[https://docs.microsoft.com/en-gb/azure/azure-monitor/terminology](https://docs.microsoft.com/en-gb/azure/azure-monitor/terminology)，或者您也可以在[https://docs.microsoft.com/en-us/azure/azure-monitor/platform/oms-portal-transition](https://docs.microsoft.com/en-us/azure/azure-monitor/platform/oms-portal-transition)获取有关过渡的详细信息。'
- en: Accessing Your System
  id: totrans-30
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 访问您的系统
- en: Learning to troubleshoot your workloads will help you in your daily job. Troubleshooting
    in Azure is not different from doing so in other environments. In this section,
    we are going to see some tips and tricks that will help you in your daily job.
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 学会排除工作负载将有助于您的日常工作。在Azure中进行故障排除与在其他环境中进行故障排除并无不同。在本节中，我们将看到一些技巧和窍门，这些将有助于您的日常工作。
- en: No Remote Access
  id: totrans-32
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 无远程访问
- en: When you don't have access to your Azure VM via SSH, you can run commands via
    the Azure portal.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 当您无法通过SSH访问Azure VM时，可以通过Azure门户运行命令。
- en: 'To run a command on your Azure VM from the Azure portal, log in to your Azure
    portal, navigate to your VM and select **Run Command**:'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 要在Azure门户上的Azure VM上运行命令，请登录到Azure门户，导航到您的VM并选择**运行命令**：
- en: '![A list of commands to navigate to the VM section within the Azure portal](img/B15455_11_03.jpg)'
  id: totrans-35
  prefs: []
  type: TYPE_IMG
  zh: '![导航到Azure门户中的VM部分的命令列表](img/B15455_11_03.jpg)'
- en: 'Figure 11.3: Navigating to the VM section within the Azure portal'
  id: totrans-36
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.3：导航到Azure门户中的VM部分
- en: 'Alternatively, you can use the command line, as follows:'
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 或者，您可以使用命令行，如下所示：
- en: '[PRE6]'
  id: totrans-38
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: The `az vm run` command can be used to run shell scripts in your VM for general
    machine or application management and to diagnose issues.
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: '`az vm run`命令可用于在VM中运行shell脚本，用于一般机器或应用程序管理以及诊断问题。'
- en: Whether you are doing it via the command line or via the Azure portal, the `az
    vm` command only works if the Microsoft Azure Linux agent is still running and
    reachable.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 无论是通过命令行还是通过Azure门户，只有在Microsoft Azure Linux代理仍在运行并可访问时，`az vm`命令才能正常工作。
- en: Note
  id: totrans-41
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 注意
- en: You can get the latest Microsoft Azure PowerShell repository at [https://github.com/Azure/azure-powershell](https://github.com/Azure/azure-powershell),
    which has the installation steps and its usage. `az` is replacing AzureRM and
    all the new Azure PowerShell features will be available only in `az` going forward.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以在[https://github.com/Azure/azure-powershell](https://github.com/Azure/azure-powershell)获取最新的Microsoft
    Azure PowerShell存储库，其中包含安装步骤及其用法。`az`正在取代AzureRM，所有新的Azure PowerShell功能将只在`az`中提供。
- en: 'As per the security best practice, you need to change the password by logging
    in to your Azure account and using `az vm user` to reset the password as follows:'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 根据安全最佳实践，您需要通过登录到Azure帐户并使用`az vm user`来重置密码来更改密码如下：
- en: '[PRE7]'
  id: totrans-44
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'This only works if you have a user that is configured with a password. If you
    deployed your VM with SSH keys, then you are lucky: the **Reset password** option
    in the same section will do the job.'
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 只有当您配置了具有密码的用户时才有效。如果您使用SSH密钥部署了VM，那么您很幸运：同一部分中的**重置密码**选项将完成工作。
- en: This option uses the VMAccess extension ([https://github.com/Azure/azure-linux-extensions/tree/master/VMAccess](https://github.com/Azure/azure-linux-extensions/tree/master/VMAccess)).
    Like the **Run command** option discussed earlier, it needs the Azure VM Agent.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 此选项使用VMAccess扩展（[https://github.com/Azure/azure-linux-extensions/tree/master/VMAccess](https://github.com/Azure/azure-linux-extensions/tree/master/VMAccess)）。与前面讨论的**运行命令**选项一样，它需要Azure
    VM代理。
- en: Working on the Port
  id: totrans-47
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 处理端口
- en: The reason that you don't have remote access may be network-related. In *Chapter
    5*, *Advanced Linux Administration*, the `ip` command was briefly introduced in
    the *Networking* section. You can use this command to verify the IP address and
    the route table.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 您无法远程访问的原因可能与网络有关。在*第5章*，*高级Linux管理*中，`ip`命令在*网络*部分中被简要介绍。您可以使用此命令验证IP地址和路由表。
- en: 'On the Azure site, the network and the network security groups must be checked,
    as covered in *Chapter 3*, *Basic Linux Administration*. In the VM, you can use
    the `ss` command, such as `ip`, which is a part of the `iproute2` package to list
    the UPD (`-u`) and TCP (`p`) ports in a listening state, together with the process
    ID (`-p`) that opened the port:'
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 在Azure站点上，必须检查网络和网络安全组，如*第3章*，*基本Linux管理*中所述。在VM中，您可以使用`ss`命令，例如`ip`，它是`iproute2`软件包的一部分，用于列出处于监听状态的UPD（`-u`）和TCP（`p`）端口，以及打开端口的进程ID（`-p`）：
- en: '![Using the ss -tulpn command to check the ports details](img/B15455_11_04.jpg)'
  id: totrans-50
  prefs: []
  type: TYPE_IMG
  zh: '![使用ss -tulpn命令检查端口详细信息](img/B15455_11_04.jpg)'
- en: 'Figure 11.4: Using the ss -tulpn command to check the ports'
  id: totrans-51
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.4：使用ss -tulpn命令检查端口
- en: 'A quick check on the firewall rules can be done with `firewall-cmd --list-all
    --zone=public`; if you have multiple zones and interfaces, you need to execute
    this for every zone. To include the rules created by Azure Service Fabric, `iptables-save`
    can help:'
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 可以使用`firewall-cmd --list-all --zone=public`快速检查防火墙规则；如果有多个区域和接口，您需要为每个区域执行此操作。要包括Azure
    Service Fabric创建的规则，可以使用`iptables-save`：
- en: '![iptables-save command to include the rules created by Azure Service Fabric](img/B15455_11_05.jpg)'
  id: totrans-53
  prefs: []
  type: TYPE_IMG
  zh: '![使用iptables-save命令包括Azure Service Fabric创建的规则](img/B15455_11_05.jpg)'
- en: 'Figure 11.5: Including the rules created by Azure Service Fabric'
  id: totrans-54
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.5：包括Azure Service Fabric创建的规则
- en: Unfortunately, there is no comment available to see all the access rules configured
    at the `systemd` unit level. Don't forget to verify them, as discussed in *Chapter
    6*, *Managing Linux Security and Identities*.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 不幸的是，在`systemd`单元级别没有可用的注释来查看所有访问规则的配置。不要忘记验证它们，如*第6章*，*管理Linux安全和身份*中所讨论的那样。
- en: Using nftables
  id: totrans-56
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用nftables
- en: '`nftables` is easier to use than `iptables` and it combines the whole `iptables`
    framework with a simple syntax. `nftables` is built on a kernel `netfilter` subsystem
    that can be used to create grouped, complex filtering rules. nftables has many
    advantages over `iptables`. For instance, it allows you to perform multiple actions
    using a single rule. It uses the `nft` command-line tool, which can be used in
    interactive mode as well by using the `nft -i` command:'
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: '`nftables`比`iptables`更容易使用，并且它将整个`iptables`框架与简单的语法结合在一起。`nftables`建立在一个内核`netfilter`子系统上，可用于创建分组的复杂过滤规则。nftables比`iptables`具有许多优点。例如，它允许您使用单个规则执行多个操作。它使用`nft`命令行工具，也可以使用`nft
    -i`命令以交互模式使用：'
- en: 'Install `nftables` using the following command:'
  id: totrans-58
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用以下命令安装`nftables`：
- en: '[PRE8]'
  id: totrans-59
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'Then install `compat`, which loads the compatibility with the `nftables` kernel
    subsystem:'
  id: totrans-60
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 然后安装`compat`，加载与`nftables`内核子系统的兼容性：
- en: '[PRE9]'
  id: totrans-61
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'Finally, enable the `nftables` service using the following command:'
  id: totrans-62
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 最后，使用以下命令启用`nftables`服务：
- en: '[PRE10]'
  id: totrans-63
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'You can view the current `nft` configuration using this:'
  id: totrans-64
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 您可以使用以下命令查看当前的`nft`配置：
- en: '[PRE11]'
  id: totrans-65
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'Also, you can log into `nft` interactive mode using the following command:'
  id: totrans-66
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 此外，您可以使用以下命令登录到`nft`交互模式：
- en: '[PRE12]'
  id: totrans-67
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'Now you can list the existing ruleset by using the following `list` command:'
  id: totrans-68
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在，您可以使用以下`list`命令列出现有的规则集：
- en: '[PRE13]'
  id: totrans-69
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: 'Let''s create a new table, `rule_table1`:'
  id: totrans-70
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 让我们创建一个新表，`rule_table1`：
- en: '[PRE14]'
  id: totrans-71
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: 'Now we will need to add the chain command to accept inbound/outbound traffic
    as follows:'
  id: totrans-72
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在，我们需要添加接受入站/出站流量的链命令如下：
- en: '[PRE15]'
  id: totrans-73
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'You can use the following command to add rules to accept TCP (Transmission
    Control Protocol) ports:'
  id: totrans-74
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 您可以使用以下命令添加规则以接受TCP（传输控制协议）端口：
- en: '[PRE16]'
  id: totrans-75
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: 'Here is the output of our new `nftables` configuration:'
  id: totrans-76
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 这是我们新的`nftables`配置的输出：
- en: '[PRE17]'
  id: totrans-77
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: Boot Diagnostics
  id: totrans-78
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 引导诊断
- en: Let's say you've created your VM, probably orchestrated, and most likely it's
    your own VM, but it doesn't boot.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 假设您已经创建了您的VM，可能是经过编排的，并且很可能是您自己的VM，但它无法启动。
- en: Before enabling the boot diagnostics on your VMs, you'll need a storage account
    to be able to store the data. You can list the storage accounts that are already
    available with the `az storage account list` and, if needed, you can create one
    with the `az storage account create` command.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 在启用 VM 的引导诊断之前，您需要一个存储账户来存储数据。您可以使用 `az storage account list` 列出已经可用的存储账户，如果需要，可以使用
    `az storage account create` 命令创建一个存储账户。
- en: 'Now let''s enable the boot diagnostics by entering the following command in
    the Azure CLI:'
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 现在让我们通过在 Azure CLI 中输入以下命令来启用引导诊断：
- en: '[PRE18]'
  id: totrans-82
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: The difference is that you don't need the name of the storage account, but the
    name of the storage blob, which can be found with the `az storage account list`
    command as a property of the storage account.
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 区别在于您不需要存储账户的名称，而是需要存储 blob 的名称，可以通过 `az storage account list` 命令作为存储账户的属性找到。
- en: 'Execute the following in the Azure CLI to receive the boot log:'
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 在 Azure CLI 中执行以下命令以接收引导日志：
- en: '[PRE19]'
  id: totrans-85
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: The output is also automatically stored in a file; in the Azure CLI, it's a
    good idea to pipe it through `less` or redirect it to a file.
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 输出也会自动存储在一个文件中；在 Azure CLI 中，最好通过 `less` 进行管道处理或将其重定向到文件中。
- en: Logging in Linux
  id: totrans-87
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: Linux 日志
- en: Many processes, services, and applications run on typical Linux systems, which
    produce different logs, such as application, event, service, and system logs,
    that can be used for auditing and troubleshooting. In earlier chapters, we encountered
    the `journalctl` command, which is used for querying and displaying logs. In this
    chapter, we'll discuss this command in much more detail and look at how you can
    slice and dice your logs using the `journalctl` utility.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 典型的 Linux 系统上运行着许多进程、服务和应用程序，它们产生不同的日志，如应用程序、事件、服务和系统日志，可用于审计和故障排除。在早期的章节中，我们遇到了
    `journalctl` 命令，用于查询和显示日志。在本章中，我们将更详细地讨论这个命令，并看看如何使用 `journalctl` 实用程序来切割和处理日志。
- en: In Linux distributions, such as the latest versions of RHEL/CentOS, Debian,
    Ubuntu, and SUSE, which use systemd as their `init` system, the `systemd-journald`
    daemon is used for logging. This daemon collects the standard output of a unit,
    a syslog message, and (if the application supports it) directs messages from the
    application to systemd.
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 在使用 systemd 作为其 `init` 系统的 Linux 发行版中，如 RHEL/CentOS、Debian、Ubuntu 和 SUSE 的最新版本中，使用
    `systemd-journald` 守护程序进行日志记录。该守护程序收集单元的标准输出、syslog 消息，并且（如果应用程序支持）将应用程序的消息传递给
    systemd。
- en: The logs are collected in a database that can be queried with `journalctl`.
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 日志被收集在一个数据库中，可以使用 `journalctl` 进行查询。
- en: '**Working with journalctl**'
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: '**使用 journalctl**'
- en: 'If you execute `systemctl status <unit>`, you can see the last entries of the
    log. To see the full log, `journalctl` is the tool that you need. There is a difference
    with `systemctl`: you can view the status on other hosts using the `-H` parameter.
    You can''t use `journalctl` to connect to other hosts. Both utilities have the
    `–M` parameter to connect to the `systemd-nspawn` and `Rkt` containers.'
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您执行 `systemctl status <unit>`，您可以看到日志的最后条目。要查看完整的日志，`journalctl` 是您需要的工具。与
    `systemctl` 不同的是：您可以使用 `-H` 参数在其他主机上查看状态。您不能使用 `journalctl` 连接到其他主机。这两个实用程序都有
    `–M` 参数，用于连接到 `systemd-nspawn` 和 `Rkt` 容器。
- en: 'To view the entries in the journal database, execute this:'
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 要查看日志数据库中的条目，请执行以下操作：
- en: '[PRE20]'
  id: totrans-94
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: '![Viewing the entries in the journal database using journalctl --unit <unit>
    command](img/B15455_11_06.jpg)'
  id: totrans-95
  prefs: []
  type: TYPE_IMG
  zh: '![使用 journalctl --unit <unit> 命令查看日志数据库中的条目](img/B15455_11_06.jpg)'
- en: 'Figure 11.6: Viewing the entries in the journal database'
  id: totrans-96
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 11.6：查看日志数据库中的条目
- en: 'By default, the log is paged with `less`. If you want another pager, such as
    `more`, then you can configure it via the `/etc/environment` file. Add the following
    line:'
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 默认情况下，日志使用 `less` 进行分页。如果您想要另一个分页器，比如 `more`，那么您可以通过 `/etc/environment` 文件进行配置。添加以下行：
- en: '[PRE21]'
  id: totrans-98
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: 'Here is an example of the output:'
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 以下是输出的示例：
- en: '![Using the journalctl command to get the log entries of the processes](img/B15455_11_07.jpg)'
  id: totrans-100
  prefs: []
  type: TYPE_IMG
  zh: '![使用 journalctl 命令获取进程的日志条目](img/B15455_11_07.jpg)'
- en: 'Figure 11.7: Using the journalctl command to get the log entries of the processes'
  id: totrans-101
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 11.7：使用 journalctl 命令获取进程的日志条目
- en: 'Let''s examine the output:'
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们来看一下输出：
- en: 'The first column is the timestamp. In the database, it''s defined in EPOCH
    time, so if you change your time zone, no problem: it will be translated.'
  id: totrans-103
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 第一列是时间戳。在数据库中，它是以 EPOCH 时间定义的，因此如果您更改时区，没有问题：它会被转换。
- en: The second column is the hostname, as shown by the `hostnamectl` command.
  id: totrans-104
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 第二列是主机名，由 `hostnamectl` 命令显示。
- en: The third column contains an identifier and the process ID.
  id: totrans-105
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 第三列包含标识符和进程 ID。
- en: The fourth column is the message.
  id: totrans-106
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 第四列是消息。
- en: 'You can add the following parameters to filter the logs:'
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以添加以下参数来过滤日志：
- en: '`--dmesg`: Kernel messages, a replacement for the old `dmesg` command'
  id: totrans-108
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`--dmesg`：内核消息，替代了旧的 `dmesg` 命令'
- en: '`--identifier`: Identifier string'
  id: totrans-109
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`--identifier`：标识符字符串'
- en: '`--boot`: Messages during the current boot process; you can also select previous
    boots if the database is persistent across reboots'
  id: totrans-110
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`--boot`：当前引导过程中的消息；如果数据库在重启后是持久的，还可以选择以前的引导'
- en: '**Filters**'
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: '**过滤器**'
- en: 'Of course, you can `grep` on the standard output, but `journalctl` has some
    parameters that really help to filter out the information you want:'
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 当然，您可以在标准输出上使用 `grep`，但 `journalctl` 有一些参数，可以帮助您过滤出所需的信息：
- en: '`--priority`: Filter on `alert`, `crit`, `debug`, `emerg`, `err`, `info`, `notice`,
    and `warning`. The classification of these priorities is the same as in the syslog
    protocol specification.'
  id: totrans-113
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`--priority`：按 `alert`、`crit`、`debug`、`emerg`、`err`、`info`、`notice` 和 `warning`
    进行过滤。这些优先级的分类与 syslog 协议规范中的相同。'
- en: '`--since` and `--until`: Filter on timestamp. Refer to `man systemd.time` to
    see all the possibilities.'
  id: totrans-114
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`--since` 和 `--until`：按时间戳过滤。参考 `man systemd.time` 查看所有可能性。'
- en: '`--lines`: Number of lines, similar to `tail`.'
  id: totrans-115
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`--lines`：行数，类似于 `tail`。'
- en: '`--follow`: Similar behavior to `tail -f`.'
  id: totrans-116
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`--follow`：类似于 `tail -f` 的行为。'
- en: '`--reverse`: Puts the last line first.'
  id: totrans-117
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`--reverse`：将最后一行放在第一行。'
- en: '`--output`: Changes the output format to formats such as JSON, or adds more
    verbosity to the output.'
  id: totrans-118
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`--output`：将输出格式更改为JSON等格式，或者向输出添加更多详细信息。'
- en: '`--catalog`: Adds an explanation of the message if one is available.'
  id: totrans-119
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`--catalog`：如果有消息的解释，则添加消息的解释。'
- en: 'All the filters can be combined, as here:'
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 所有过滤器都可以组合，就像这里一样：
- en: '[PRE22]'
  id: totrans-121
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: '![Filtering the log entries by using multiple parameters with journalctl](img/B15455_11_08.jpg)'
  id: totrans-122
  prefs: []
  type: TYPE_IMG
  zh: '![使用journalctl使用多个参数过滤日志条目](img/B15455_11_08.jpg)'
- en: 'Figure 11.8: Filtering the log entries by using multiple filters with journalctl'
  id: totrans-123
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.8：使用journalctl使用多个过滤器过滤日志条目
- en: '**Filtering Based on Fields**'
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: '**基于字段的过滤**'
- en: 'We can also filter on fields. Type this:'
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 我们还可以根据字段进行过滤。键入此命令：
- en: '[PRE23]'
  id: totrans-126
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: 'Now press *Ctrl* + *I* twice; you''ll see all the available fields. The same
    principle applies to these filters; that is, you can combine them:'
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: 现在按两次*Ctrl* + *I*；您将看到所有可用字段。这些过滤器也适用于相同的原则；也就是说，您可以将它们组合起来：
- en: '[PRE24]'
  id: totrans-128
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: 'You can even combine them with normal filters:'
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 您甚至可以将它们与普通过滤器组合使用：
- en: '[PRE25]'
  id: totrans-130
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: '**Database Persistence**'
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: '**数据库持久性**'
- en: Now you may need to store the logs for a certain period of time for compliance
    reasons or audit requirements. So, you can use an Azure Log Analytics agent to
    collect logs from different sources. By default, the logging database is not persistent.
    To make it persistent, for any audit- or compliance-related reason (though it
    is not a best practice to store the logs in localhost), you have to edit the configuration
    file, `/etc/systemd/journald.conf`.
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，您可能需要出于合规原因或审计要求存储日志一段时间。因此，您可以使用Azure Log Analytics代理从不同来源收集日志。默认情况下，日志数据库不是持久的。为了使其持久化，出于审计或合规原因（尽管最佳做法不是将日志存储在本地主机），您必须编辑配置文件`/etc/systemd/journald.conf`。
- en: 'Change the `#Storage=auto` line to this:'
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: 将`#Storage=auto`行更改为此：
- en: '[PRE26]'
  id: totrans-134
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: 'Restart the `systemd-journald` daemon with `force`:'
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: 使用`force`重新启动`systemd-journald`守护程序：
- en: '[PRE27]'
  id: totrans-136
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: 'Use this to view the recorded boots:'
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 使用此查看记录的引导：
- en: '[PRE28]'
  id: totrans-138
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: '![Viewing the recorded boots using --list-boots command](img/B15455_11_09.jpg)'
  id: totrans-139
  prefs: []
  type: TYPE_IMG
  zh: '![使用--list-boots命令查看记录的引导](img/B15455_11_09.jpg)'
- en: 'Figure 11.9: Viewing the recorded boots'
  id: totrans-140
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.9：查看记录的引导
- en: 'You can add the boot ID as a filter using the `--boot` parameter:'
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以使用`--boot`参数将引导ID作为过滤器添加：
- en: '[PRE29]'
  id: totrans-142
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: By this means, the output of `hostnamectl` shows the current boot ID.
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 通过这种方式，`hostnamectl`的输出显示当前的引导ID。
- en: The journal database is not dependent on the daemon. You can view it using the
    `--directory` and `--file` parameters.
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 日志数据库不依赖于守护程序。您可以使用`--directory`和`--file`参数查看它。
- en: '**Syslog Protocol**'
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: '**Syslog协议**'
- en: Logging in Linux and other members of the Unix family was enabled during the
    implementation of the syslog protocol. It is still used to send logging to remote
    services.
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: 在实施syslog协议期间，Linux和Unix家族的其他成员启用了日志记录。它仍然用于将日志发送到远程服务。
- en: It is important to understand that this protocol uses facilities and severity.
    Both are standardized in RFC 5424 ([https://tools.ietf.org/html/rfc5424](https://tools.ietf.org/html/rfc5424)).
    Here, a facility specifies the type of program that is logging the message; for
    instance, the kernel or cron. The severity label is there to describe the impact,
    such as informational or critical.
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 重要的是要理解该协议使用设施和严重性。这两者在RFC 5424（[https://tools.ietf.org/html/rfc5424](https://tools.ietf.org/html/rfc5424)）中标准化。在这里，设施指定记录消息的程序类型；例如，内核或cron。严重性标签用于描述影响，例如信息或关键。
- en: The programmers' man page for syslog (`journald` is able to get everything regarding
    the output of a program.
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: 程序员的syslog手册（`journald`能够获取有关程序输出的所有内容。
- en: '**Adding Log Entries**'
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: '**添加日志条目**'
- en: 'You can manually add entries to a log. For syslog, the `logger` command is
    available:'
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以手动向日志添加条目。对于syslog，`logger`命令可用：
- en: '[PRE30]'
  id: totrans-151
  prefs: []
  type: TYPE_PRE
  zh: '[PRE30]'
- en: 'For `journald`, there is `systemd-cat`:'
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: 对于`journald`，有`systemd-cat`：
- en: '[PRE31]'
  id: totrans-153
  prefs: []
  type: TYPE_PRE
  zh: '[PRE31]'
- en: 'Let''s look at an example:'
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们看一个例子：
- en: '[PRE32]'
  id: totrans-155
  prefs: []
  type: TYPE_PRE
  zh: '[PRE32]'
- en: 'As an identifier, you can use free strings or syslog facilities. Both `logger`
    and `systemd-cat` can be used to generate entries in your log. You can use this
    if the application doesn''t have syslog support; for instance, in an Apache configuration,
    you can use this directive:'
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: 作为标识符，您可以使用自由字符串或syslog设施。`logger`和`systemd-cat`都可以用于在日志中生成条目。如果应用程序不支持syslog，则可以使用此功能；例如，在Apache配置中，您可以使用此指令：
- en: '[PRE33]'
  id: totrans-157
  prefs: []
  type: TYPE_PRE
  zh: '[PRE33]'
- en: You can also use this as a part of change management.
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 您还可以将其作为变更管理的一部分使用。
- en: '**Integrating journald with RSYSLOG**'
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: '**将journald与RSYSLOG集成**'
- en: 'To collect your data for your own monitoring service, your monitoring service
    needs syslog support. Good examples of these monitoring services are available
    as a ready-to-go VM in Azure: **Splunk** and the **Elastic Stack**.'
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: 为了为您自己的监控服务收集数据，您的监控服务需要syslog支持。这些监控服务的良好示例作为Azure中的现成VM提供：**Splunk**和**Elastic
    Stack**。
- en: RSYSLOG is the most commonly used syslog protocol implementation nowadays. It's
    already installed by default in Ubuntu-, SUSE-, and Red Hat–based distributions.
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: RSYSLOG是当今最常用的syslog协议实现。它已经默认安装在Ubuntu、SUSE和Red Hat等发行版中。
- en: 'RSYSLOG can work very well together with the journal database using the `imjournal`
    module. In SUSE- and Red Hat–based distributions, this is already configured;
    in Ubuntu, you have to make a modification to the `/etc/rsyslog.conf` file:'
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: RSYSLOG可以使用`imjournal`模块与日志数据库很好地配合。在SUSE和Red Hat等发行版中，这已经配置好；在Ubuntu中，您必须对`/etc/rsyslog.conf`文件进行修改：
- en: '[PRE34]'
  id: totrans-163
  prefs: []
  type: TYPE_PRE
  zh: '[PRE34]'
- en: 'After the modification, restart RSYSLOG:'
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: 修改后，重新启动RSYSLOG：
- en: '[PRE35]'
  id: totrans-165
  prefs: []
  type: TYPE_PRE
  zh: '[PRE35]'
- en: Using the settings in `/etc/rsyslog.d/50-default.conf`, it logs to plain text
    files.
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: 使用`/etc/rsyslog.d/50-default.conf`中的设置，它记录到纯文本文件中。
- en: 'To send everything coming from the local syslog to a remote syslog server,
    you have to add the following to this file:'
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: 要将来自本地syslog的所有内容发送到远程syslog服务器，您必须将以下内容添加到此文件中：
- en: '[PRE36]'
  id: totrans-168
  prefs: []
  type: TYPE_PRE
  zh: '[PRE36]'
- en: Note
  id: totrans-169
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 注意
- en: This is the name of the file in Ubuntu. In other distributions, use `/etc/rsyslog.conf`.
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 这是Ubuntu中的文件名。在其他发行版中，请使用`/etc/rsyslog.conf`。
- en: Use `@@` if you want TCP instead of the UDP protocol.
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: 如果要使用TCP协议而不是UDP协议，请使用`@@`。
- en: '**Other Log Files**'
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: '**其他日志文件**'
- en: You can find log files of applications that don't support syslog or `systemd-journald`
    in the `/var/log` directory structure. One important file to notice is the `/var/log/waagent.log`
    file, which contains the logging from the Azure Linux VM agent. There is also
    the `/var/log/azure` directory, which contains logging from other Azure agents
    (such as Azure Monitor) and VM extensions.
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以在`/var/log`目录结构中找到不支持syslog或`systemd-journald`的应用程序的日志文件。要注意的一个重要文件是`/var/log/waagent.log`文件，其中包含来自Azure
    Linux VM代理的日志记录。还有`/var/log/azure`目录，其中包含来自其他Azure代理（如Azure Monitor）和VM扩展的日志记录。
- en: Azure Log Analytics
  id: totrans-174
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Azure Log Analytics
- en: 'Azure Log Analytics is a part of Azure Monitor that collects and analyzes log
    data and takes the appropriate actions. It is a service in Azure that collects
    log data from multiple systems in a single data store in a central place. It consists
    of two important components:'
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: Azure Log Analytics是Azure Monitor的一部分，它收集和分析日志数据并采取适当的操作。它是Azure中的一个服务，可以从多个系统中收集日志数据并将其存储在一个中心位置的单个数据存储中。它由两个重要组件组成：
- en: The Azure Log Analytics portal, with alerts, reports, and analysis features
  id: totrans-176
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Azure Log Analytics门户，具有警报、报告和分析功能
- en: The Azure Monitor agent, which needs to be installed on a VM
  id: totrans-177
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 需要在VM上安装的Azure Monitor代理
- en: There is also a mobile app available (in the iOS and Android store, you can
    find it under the name *Microsoft Azure*) if you want to view the state of your
    workloads while you are on the go.
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: 还有一个移动应用程序（在iOS和Android商店中，您可以在*Microsoft Azure*下找到它），如果您想在外出时查看工作负载的状态。
- en: Configuring the Log Analytics Service
  id: totrans-179
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 配置Log Analytics服务
- en: In the Azure portal, select **All Services** from the left-hand bar and search
    for **Log Analytics**. Select **Add** and create a new Log Analytics workspace.
    At the time of writing, it is not available in all regions. Using the service
    is not limited to the region; if a VM is in another region, you can still monitor
    it.
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: 在Azure门户中，从左侧栏选择**所有服务**，并搜索**Log Analytics**。选择**添加**并创建新的Log Analytics工作区。在撰写本文时，它并不是在所有地区都可用。使用该服务并不受地区限制；如果VM位于另一个地区，您仍然可以监视它。
- en: Note
  id: totrans-181
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 注意
- en: There is no upfront cost for this service and you pay for what you use! Read
    [http://aka.ms/PricingTierWarning](http://aka.ms/PricingTierWarning) for more
    details.
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: 此服务没有预付费用，您按使用量付费！阅读[http://aka.ms/PricingTierWarning](http://aka.ms/PricingTierWarning)获取更多详细信息。
- en: 'Another way to create the service is with the Azure CLI:'
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: 另一种创建服务的方法是使用Azure CLI：
- en: '[PRE37]'
  id: totrans-184
  prefs: []
  type: TYPE_PRE
  zh: '[PRE37]'
- en: After the creation of the service, there is a pop-up that allows you to navigate
    to the newly created resource. Alternatively, you can search again in **All Services**.
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
  zh: 创建服务后，会弹出一个窗口，允许您导航到新创建的资源。或者，您可以在**所有服务**中再次搜索。
- en: Please note, at the top-right of the resource pane, Azure Monitor and the workspace
    ID; you'll need this information later on. Navigate to **Advanced settings** to
    find the workspace key.
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: 请注意，在资源窗格的右上角，Azure Monitor和工作区ID；您以后会需要这些信息。转到**高级设置**以找到工作区密钥。
- en: 'In the Azure CLI, you can collect this information using the following:'
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
  zh: 在Azure CLI中，您可以使用以下命令收集此信息：
- en: '[PRE38]'
  id: totrans-188
  prefs: []
  type: TYPE_PRE
  zh: '[PRE38]'
- en: 'To list all the workspaces of your Azure subscription, you can use the following
    Azure CLI command:'
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: 要列出Azure订阅的所有工作区，可以使用以下Azure CLI命令：
- en: '[PRE39]'
  id: totrans-190
  prefs: []
  type: TYPE_PRE
  zh: '[PRE39]'
- en: 'You can get detailed information about a workspace in JSON format using the
    following Azure CLI command:'
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以使用以下Azure CLI命令以JSON格式获取有关工作区的详细信息：
- en: '[PRE40]'
  id: totrans-192
  prefs: []
  type: TYPE_PRE
  zh: '[PRE40]'
- en: Installing the Azure Log Analytics Agent
  id: totrans-193
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 安装Azure Log Analytics代理
- en: Before installing the Azure Monitor agent, make sure that the `audit` package
    (in `auditd`) is installed.
  id: totrans-194
  prefs: []
  type: TYPE_NORMAL
  zh: 在安装Azure Monitor代理之前，请确保已安装`audit`包（在`auditd`中）。
- en: 'To install the Azure Monitor agent in a Linux VM, you have two possibilities:
    enable the VM extension `OMSAgentforLinux`, or download and install the Log Analytics
    Agent in Linux.'
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
  zh: 要在Linux VM中安装Azure Monitor代理，您有两种可能性：启用VM扩展`OMSAgentforLinux`，或在Linux中下载并安装Log
    Analytics代理。
- en: 'First, set some variables to make the scripting easier:'
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，设置一些变量以使脚本编写更容易：
- en: '[PRE41]'
  id: totrans-197
  prefs: []
  type: TYPE_PRE
  zh: '[PRE41]'
- en: 'You need the workspace ID and key. The `Set-AzureVMExtension` cmdlet needs
    the keys in JSON format, so a conversion is needed:'
  id: totrans-198
  prefs: []
  type: TYPE_NORMAL
  zh: 您需要工作区ID和密钥。`Set-AzureVMExtension` cmdlet需要以JSON格式的密钥，因此需要进行转换：
- en: '[PRE42]'
  id: totrans-199
  prefs: []
  type: TYPE_PRE
  zh: '[PRE42]'
- en: 'Now you can add the extension to the VM:'
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
  zh: 现在您可以将扩展添加到虚拟机：
- en: '[PRE43]'
  id: totrans-201
  prefs: []
  type: TYPE_PRE
  zh: '[PRE43]'
- en: 'The previous procedure is pretty complex and takes a while. The download method
    is easier, but you have to log in to your VM via SSH as a guest. Of course, both
    methods can be automated/orchestrated:'
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: 上述过程相当复杂并且需要一段时间。下载方法更简单，但您必须以访客身份通过SSH登录到VM。当然，这两种方法都可以自动化/编排：
- en: '[PRE44]'
  id: totrans-203
  prefs: []
  type: TYPE_PRE
  zh: '[PRE44]'
- en: If you have problems during the installation of the agent, look in the `/var/log/waagent.log`
    and `/var/log/azure/Microsoft.EnterpriseCloud.Monitoring.OmsAgentForLinux/*/extension.log`
    configuration files.
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
  zh: 如果在安装代理时遇到问题，请查看`/var/log/waagent.log`和`/var/log/azure/Microsoft.EnterpriseCloud.Monitoring.OmsAgentForLinux/*/extension.log`配置文件。
- en: 'The installation of the extensions also creates a configuration file for `rsyslog,/etc/rsyslogd.d/95-omsagent.conf`:'
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
  zh: 扩展的安装还会创建一个配置文件`rsyslog,/etc/rsyslogd.d/95-omsagent.conf`：
- en: '[PRE45]'
  id: totrans-206
  prefs: []
  type: TYPE_PRE
  zh: '[PRE45]'
- en: It basically means that the syslog messages (`facility.priority`) are sent to
    the Azure Monitor agent.
  id: totrans-207
  prefs: []
  type: TYPE_NORMAL
  zh: 基本上意味着syslog消息（`facility.priority`）被发送到Azure Monitor代理。
- en: 'At the bottom pane of the new resource, there is a section entitled **Get started
    with Log Analytics**:'
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
  zh: 在新资源的底部窗格中，有一个名为**开始使用Log Analytics**的部分：
- en: '![Get started with Log Analytics section in Azure Portal](img/B15455_11_10.jpg)'
  id: totrans-209
  prefs: []
  type: TYPE_IMG
  zh: '![在Azure门户中开始使用Log Analytics部分](img/B15455_11_10.jpg)'
- en: 'Figure 11.10: Get started with Log Analytics section in Azure Portal'
  id: totrans-210
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.10：在Azure门户中开始使用Log Analytics部分
- en: 'Click on **Azure virtual machines (VMs)**. You''ll see the VMs that are available
    in this workspace:'
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
  zh: 单击**Azure虚拟机（VMs）**。您将看到此工作区中可用的虚拟机：
- en: '![Available VMs in the workspace](img/B15455_11_11.jpg)'
  id: totrans-212
  prefs: []
  type: TYPE_IMG
  zh: '![工作区中可用的虚拟机](img/B15455_11_11.jpg)'
- en: 'Figure 11.11: Available VMs in the workspace'
  id: totrans-213
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.11：工作区中可用的虚拟机
- en: The preceding screenshot represents the available VMs in the workspace. It also
    shows that we have connected to the data source.
  id: totrans-214
  prefs: []
  type: TYPE_NORMAL
  zh: 上述屏幕截图表示工作区中可用的虚拟机。它还显示我们已连接到数据源。
- en: Getting the Data
  id: totrans-215
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 获取数据
- en: In the **Advanced settings** section of this resource, you can add performance
    and syslog data sources. You can access all the data via the log search using
    a special query language. If you are new to this language, you should visit [https://docs.loganalytics.io/docs/Learn/Getting-Started/Getting-started-with-queries](https://docs.loganalytics.io/docs/Learn/Getting-Started/Getting-started-with-queries)
    and [https://docs.loganalytics.io/index](https://docs.loganalytics.io/index).
  id: totrans-216
  prefs: []
  type: TYPE_NORMAL
  zh: 在此资源的**高级设置**部分，您可以添加性能和syslog数据源。您可以使用特殊的查询语言通过日志搜索访问所有数据。如果您对这种语言不熟悉，您应该访问[https://docs.loganalytics.io/docs/Learn/Getting-Started/Getting-started-with-queries](https://docs.loganalytics.io/docs/Learn/Getting-Started/Getting-started-with-queries)和[https://docs.loganalytics.io/index](https://docs.loganalytics.io/index)。
- en: 'For now, just execute this query:'
  id: totrans-217
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，只需执行此查询：
- en: '[PRE46]'
  id: totrans-218
  prefs: []
  type: TYPE_PRE
  zh: '[PRE46]'
- en: 'To see whether there is data available, limit the search to one VM:'
  id: totrans-219
  prefs: []
  type: TYPE_NORMAL
  zh: 为了查看是否有可用的数据，将搜索限制为一个VM：
- en: '[PRE47]'
  id: totrans-220
  prefs: []
  type: TYPE_PRE
  zh: '[PRE47]'
- en: 'Alternatively, to get all the syslog messages, as a test, you can reboot your
    VM, or play with this:'
  id: totrans-221
  prefs: []
  type: TYPE_NORMAL
  zh: 或者，为了获取所有的syslog消息，作为一个测试，您可以重新启动您的VM，或者尝试这个：
- en: '[PRE48]'
  id: totrans-222
  prefs: []
  type: TYPE_PRE
  zh: '[PRE48]'
- en: 'Execute the following query in syslog to view the results:'
  id: totrans-223
  prefs: []
  type: TYPE_NORMAL
  zh: 在syslog中执行以下查询以查看结果：
- en: '[PRE49]'
  id: totrans-224
  prefs: []
  type: TYPE_PRE
  zh: '[PRE49]'
- en: There are also many examples available if you click on the **Saved searches**
    button.
  id: totrans-225
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您点击**保存的搜索**按钮，还有许多示例可用。
- en: 'Monitoring solutions provide a very interesting add-on to make this process
    even easier. In the **Resource** pane, click on **View solutions**:'
  id: totrans-226
  prefs: []
  type: TYPE_NORMAL
  zh: 监控解决方案提供了一个非常有趣的附加功能，使这个过程变得更加容易。在**资源**窗格中，点击**查看解决方案**：
- en: '![Navigating to the View solutions option in VM](img/B15455_11_12.jpg)'
  id: totrans-227
  prefs: []
  type: TYPE_IMG
  zh: '![导航到VM中的查看解决方案选项](img/B15455_11_12.jpg)'
- en: 'Figure 11.12: Navigating to the monitoring solutions option'
  id: totrans-228
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.12：导航到监控解决方案选项
- en: 'Select the desired option and click on **Add**:'
  id: totrans-229
  prefs: []
  type: TYPE_NORMAL
  zh: 选择所需的选项，然后点击**添加**：
- en: '![Management Solutions within Log Analytics](img/B15455_11_13.jpg)'
  id: totrans-230
  prefs: []
  type: TYPE_IMG
  zh: '![日志分析中的管理解决方案](img/B15455_11_13.jpg)'
- en: 'Figure 11.13: Management Solutions within Log Analytics'
  id: totrans-231
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.13：日志分析中的管理解决方案
- en: '**Service Map** is an important service. It gives a great overview of your
    resources and provides an easy interface for logs, performance counters, and so
    on. After installing **Service Map**, you have to install an agent in the Linux
    machine, or you can log in to the portal and navigate to the VM, which will install
    the agent automatically for you:'
  id: totrans-232
  prefs: []
  type: TYPE_NORMAL
  zh: '**服务地图**是一个重要的服务。它为您的资源提供了很好的概述，并提供了一个易于使用的界面，用于日志、性能计数器等。安装**服务地图**后，您必须在Linux机器上安装代理，或者您可以登录到门户并导航到VM，它将自动为您安装代理：'
- en: '[PRE50]'
  id: totrans-233
  prefs: []
  type: TYPE_PRE
  zh: '[PRE50]'
- en: After the installation, select **Virtual Machines** > **Monitoring** > **Insights**
    > **Service Map**.
  id: totrans-234
  prefs: []
  type: TYPE_NORMAL
  zh: 安装后，选择**虚拟机** > **监视** > **洞察** > **服务地图**。
- en: 'Now, click on **Summary**:'
  id: totrans-235
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，点击**摘要**：
- en: '![The Summary section in Service Map](img/B15455_11_14.jpg)'
  id: totrans-236
  prefs: []
  type: TYPE_IMG
  zh: '![服务地图中的摘要部分](img/B15455_11_14.jpg)'
- en: 'Figure 11.14: The Summary section of the Service Map'
  id: totrans-237
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.14：服务地图摘要部分
- en: 'You can monitor your applications, view the log files, and so on:'
  id: totrans-238
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以监视您的应用程序，查看日志文件等：
- en: '![Check log files to moniter the application](img/B15455_11_15.jpg)'
  id: totrans-239
  prefs: []
  type: TYPE_IMG
  zh: '![检查日志文件以监视应用程序](img/B15455_11_15.jpg)'
- en: 'Figure 11.15: Service Map overview'
  id: totrans-240
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.15：服务地图概述
- en: Log Analytics and Kubernetes
  id: totrans-241
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 日志分析和Kubernetes
- en: In order to manage your containers, you need detailed insights into CPU, memory,
    storage, and network usage and performance information. Azure Monitor can be used
    to view Kubernetes logs, events, and metrics, allowing for container monitoring
    from a single location. You can enable Azure Monitor for containers for your new
    or existing AKS deployments using the Azure CLI, Azure PowerShell, the Azure portal,
    or Terraform.
  id: totrans-242
  prefs: []
  type: TYPE_NORMAL
  zh: 为了管理您的容器，您需要对CPU、内存、存储和网络使用情况以及性能信息有详细的了解。Azure监视可以用于查看Kubernetes日志、事件和指标，允许从一个位置监视容器。您可以使用Azure
    CLI、Azure PowerShell、Azure门户或Terraform为您的新或现有的AKS部署启用Azure监视。
- en: 'To create a new `az aks create` command:'
  id: totrans-243
  prefs: []
  type: TYPE_NORMAL
  zh: 创建一个新的`az aks create`命令：
- en: '[PRE51]'
  id: totrans-244
  prefs: []
  type: TYPE_PRE
  zh: '[PRE51]'
- en: 'To enable Azure Monitor for your existing AKS cluster, use the `az aks` command
    with this modification:'
  id: totrans-245
  prefs: []
  type: TYPE_NORMAL
  zh: 要为现有的AKS集群启用Azure监视，使用`az aks`命令进行修改：
- en: '[PRE52]'
  id: totrans-246
  prefs: []
  type: TYPE_PRE
  zh: '[PRE52]'
- en: 'You can enable monitoring for your AKS cluster from the Azure portal by selecting
    **Monitor** and then selecting **Containers**. Here, select the **Non-monitored
    clusters**, then choose the container and click **Enable**:'
  id: totrans-247
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以从Azure门户为您的AKS集群启用监视，选择**监视**，然后选择**容器**。在这里，选择**未监视的集群**，然后选择容器，点击**启用**：
- en: '![Monitoring AKS cluster from the Azure portal](img/B15455_11_16.jpg)'
  id: totrans-248
  prefs: []
  type: TYPE_IMG
  zh: '![从Azure门户监视AKS集群](img/B15455_11_16.jpg)'
- en: 'Figure 11.16: Monitoring AKS cluster from the Azure portal'
  id: totrans-249
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.16：从Azure门户监视AKS集群
- en: Log Analytics for Your Network
  id: totrans-250
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 您网络的日志分析
- en: Another solution in Azure Log Analytics is Traffic Analytics. It visualizes
    network traffic to and from your workloads, including open ports. It is able to
    generate alerts for security threats, for instance, if an application tries to
    reach a network that it's not allowed to access. Also, it provides detailed monitoring
    options with log export options.
  id: totrans-251
  prefs: []
  type: TYPE_NORMAL
  zh: Azure Log Analytics中的另一个解决方案是Traffic Analytics。它可视化工作负载的网络流量，包括开放端口。它能够为安全威胁生成警报，例如，如果应用程序尝试访问其不允许访问的网络。此外，它提供了具有日志导出选项的详细监控选项。
- en: 'If you want to use Traffic Analytics, first you have to create a network watcher
    for every region you want to analyze:'
  id: totrans-252
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您想使用Traffic Analytics，首先您必须为您想要分析的每个区域创建一个网络监视器：
- en: '[PRE53]'
  id: totrans-253
  prefs: []
  type: TYPE_PRE
  zh: '[PRE53]'
- en: 'After that, you have to reregister the network provider and add Microsoft Insights
    so the network watcher can hook into it:'
  id: totrans-254
  prefs: []
  type: TYPE_NORMAL
  zh: 之后，您必须重新注册网络提供程序并添加Microsoft Insights，以便网络监视器可以连接到它：
- en: '[PRE54]'
  id: totrans-255
  prefs: []
  type: TYPE_PRE
  zh: '[PRE54]'
- en: You can't use this solution with other providers, such as `Microsoft.ClassicNetwork`.
  id: totrans-256
  prefs: []
  type: TYPE_NORMAL
  zh: 不能使用这个解决方案与其他提供商，如`Microsoft.ClassicNetwork`。
- en: The next step involves using **network security group** **(NSG)**, which controls
    the flow of logging by allowing or denying the incoming traffic. At the time of
    writing, this is only possible using the Azure portal. In the left-hand bar of
    the Azure portal, select **Monitor**>**Network watcher** and then select **NSG
    flow logs**. Now you are able to select the NSG that you want to enable an **NSG
    flow log** for.
  id: totrans-257
  prefs: []
  type: TYPE_NORMAL
  zh: 下一步涉及使用“网络安全组（NSG）”，它通过允许或拒绝传入流量来控制日志流量的流动。在撰写本文时，这只能在Azure门户中实现。在Azure门户的左侧栏中，选择“监视”>“网络观察程序”，然后选择“NSG流日志”。现在你可以选择要为其启用“NSG流日志”的NSG。
- en: Enable it, select a storage account, and select your Log Analytics workspace.
  id: totrans-258
  prefs: []
  type: TYPE_NORMAL
  zh: 启用它，选择一个存储账户，并选择你的Log Analytics工作空间。
- en: 'It will take some time before the information comes in and is collected. After
    about 30 minutes, the first information should be visible. Select **Monitor**
    in the left-hand bar of the Azure portal, go to **Network watcher**, and then
    **Traffic Analytics**. Alternatively, start from your Log Analytics workspace:'
  id: totrans-259
  prefs: []
  type: TYPE_NORMAL
  zh: 信息收集需要一些时间。大约30分钟后，第一批信息应该可见。在Azure门户的左侧栏中选择“监视”，转到“网络观察程序”，然后选择“Traffic Analytics”。或者，从你的Log
    Analytics工作空间开始：
- en: '![Checking Traffic Analytics tab from the Azure portal to view the network
    traffic flow distribution](img/B15455_11_17.jpg)'
  id: totrans-260
  prefs: []
  type: TYPE_IMG
  zh: '![从Azure门户检查Traffic Analytics选项，查看网络流量分布](img/B15455_11_17.jpg)'
- en: 'Figure 11.17: Viewing the network traffic flow distribution with Traffic Analytics'
  id: totrans-261
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.17：使用Traffic Analytics查看网络流量分布
- en: Performance Monitoring
  id: totrans-262
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 性能监控
- en: In Azure Monitor, there are many options available for monitoring. For instance,
    performance counters give you a lot of insight into your workload. There are also
    application-specific options.
  id: totrans-263
  prefs: []
  type: TYPE_NORMAL
  zh: 在Azure Monitor中，有许多可用于监控的选项。例如，性能计数器可以让你深入了解你的工作负载。还有一些特定于应用程序的选项。
- en: 'Even if you don''t use Azure Monitor, Azure can provide all kinds of metrics
    for each VM, but not in one central place. Just navigate to your VM. In the **Overview**
    pane, you can see performance data for CPU, memory, and storage. Detailed information
    is available in the **Metrics** section, under **Monitoring**. All kinds of data
    are available, such as CPU, storage, and networking data:'
  id: totrans-264
  prefs: []
  type: TYPE_NORMAL
  zh: 即使你不使用Azure Monitor，Azure也可以为每个VM提供各种指标，但不在一个中心位置。只需导航到你的VM。在“概述”窗格中，你可以查看CPU、内存和存储的性能数据。详细信息可在“监视”下的“指标”部分中找到。各种数据都可以获得，如CPU、存储和网络数据：
- en: '![Using Overview pane the Azure portal to view the performance data for the
    VM](img/B15455_11_18.jpg)'
  id: totrans-265
  prefs: []
  type: TYPE_IMG
  zh: '![使用Azure门户的概述窗格查看VM的性能数据](img/B15455_11_18.jpg)'
- en: 'Figure 11.18: Viewing the performance data of the VM'
  id: totrans-266
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.18：查看VM的性能数据
- en: The problem with many of these solutions is that they are application-specific,
    or you are looking at the end result without knowing what the cause is. If you
    need information about the general performance of the resources utilized by the
    virtual machine(s), use the information provided by Azure. If you need information
    on the web server or database you're running, look and see whether there is an
    Azure solution. But in many scenarios, it is very helpful if you can do performance
    troubleshooting in the VM as well. In a way, we're going to start where the *Process
    management* section in *Chapter 3*, *Basic Linux Administration*, left off.
  id: totrans-267
  prefs: []
  type: TYPE_NORMAL
  zh: 许多解决方案的问题在于它们是特定于应用程序的，或者你只是看到了最终结果，却不知道原因是什么。如果你需要了解虚拟机所使用资源的一般性能信息，可以使用Azure提供的信息。如果你需要了解你正在运行的Web服务器或数据库的信息，可以看看是否有Azure解决方案。但在许多情况下，如果你也能在VM中进行性能故障排除，那将非常有帮助。在某种程度上，我们将从第3章《基本Linux管理》中的“进程管理”部分开始。
- en: Before we start, there are multiple methods and ways of doing performance troubleshooting.
    Can this book provide the only method you should use, or tell you the one tool
    you'll need? No, unfortunately not! But what it can do is make you aware of the
    tools that are available and cover at least their basic usage. For more specific
    needs, you can always dive into the man pages. In this section, we're especially
    looking into what the load is and what is causing it.
  id: totrans-268
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们开始之前，有多种方法和方式可以进行性能故障排除。这本书能提供你唯一应该使用的方法，或者告诉你唯一需要的工具吗？不，不幸的是！但它可以让你意识到可用的工具，并至少涵盖它们的基本用法。对于更具体的需求，你总是可以深入研究man页面。在这一部分，我们特别关注负载是什么，以及是什么导致了负载。
- en: 'And one last thing: this section is called *Performance monitoring*, but that
    may not be the perfect title. It''s balancing monitoring, troubleshooting, and
    analysis. However, isn''t that often the case in the daily life of every system
    engineer?'
  id: totrans-269
  prefs: []
  type: TYPE_NORMAL
  zh: 最后一点：这一部分被称为“性能监控”，但这可能不是完美的标题。它是平衡监控、故障排除和分析。然而，在每个系统工程师的日常生活中，这种情况经常发生，不是吗？
- en: 'Not all the tools mentioned are available by default in the Red Hat/CentOS
    repository. You''ll need to configure the `epel` repository: `yum install epel-release`.'
  id: totrans-270
  prefs: []
  type: TYPE_NORMAL
  zh: 并非所有提到的工具都默认在Red Hat/CentOS存储库中可用。你需要配置`epel`存储库：`yum install epel-release`。
- en: Displaying Linux processes with top
  id: totrans-271
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用top显示Linux进程
- en: If you look into a topic such as performance monitoring and Linux, `top` is
    always mentioned. It is the number-one command to use to quickly get an idea of
    what is running on a system.
  id: totrans-272
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你研究性能监控和Linux等主题，`top`总是被提到。它是用来快速了解系统上正在运行的内容的头号命令。
- en: 'You can display many things with `top`, and it comes with a good man page explaining
    all the options. Let''s focus on the most important ones, starting at the top
    of the screen:'
  id: totrans-273
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以用`top`显示很多东西，它带有一个很好的man页面，解释了所有的选项。让我们从屏幕顶部开始关注最重要的部分：
- en: '![Displaying Linux processes with top command](img/B15455_11_19.jpg)'
  id: totrans-274
  prefs: []
  type: TYPE_IMG
  zh: '![使用top命令显示Linux进程](img/B15455_11_19.jpg)'
- en: 'Figure 11.19: Displaying resource usage using the top command'
  id: totrans-275
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.19：使用top命令显示资源使用情况
- en: 'Let''s take a look at the options mentioned in the preceding screenshot:'
  id: totrans-276
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们看看前面截图中提到的选项：
- en: '`wa`): If this value is continuously above 10%, this means that the underlying
    storage is slowing down the server. This parameter shows the CPU waiting time
    for I/O processes. Azure VMs use HDDs instead of SSDs, and using multiple HDDs
    in a RAID configuration can help, but it''s better to migrate to SSDs. If that
    is not enough, there are premium SSD solutions available as well.'
  id: totrans-277
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`wa`): 如果此值持续超过10%，这意味着底层存储正在减慢服务器。此参数显示CPU等待I/O进程的时间。Azure VM使用HDD而不是SSD，使用多个HDD在RAID配置中可能有所帮助，但最好迁移到SSD。如果这还不够，也有高级SSD解决方案可用。'
- en: '`us`): CPU utilization by applications; please note that the CPU utilization
    is totaled across all CPUs.'
  id: totrans-278
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`us`): 应用程序的CPU利用率；请注意，CPU利用率是跨所有CPU总计的。'
- en: '`sy`): The amount of time the CPU spends on kernel tasks.'
  id: totrans-279
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`sy`): CPU在内核任务上花费的时间。'
- en: '**Swap**: Memory paged out caused by having not enough memory for your applications.
    It should be zero most of the time.'
  id: totrans-280
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Swap**：由于应用程序没有足够的内存而导致的内存分页。大部分时间应该为零。'
- en: 'The bottom of the `top` screen also has some interesting columns:'
  id: totrans-281
  prefs: []
  type: TYPE_NORMAL
  zh: '`top` 屏幕底部还有一些有趣的列：'
- en: '![The bottom entries of the output obtained from the top command](img/B15455_11_20.jpg)'
  id: totrans-282
  prefs: []
  type: TYPE_IMG
  zh: '![从top命令获取的输出的底部条目](img/B15455_11_20.jpg)'
- en: 'Figure 11.20: The bottom entries of the output obtained from the top command'
  id: totrans-283
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.20：从top命令获取的输出的底部条目
- en: 'Personally, we wouldn''t advise worrying about the priority and nice values
    for now. The effect on the performance is minimal. The first interesting field
    is `VIRT` (virtual memory). This refers to the amount of memory the program can
    access at present. It includes memory shared with other applications, video memory,
    files that are read into memory by the application, and more. It also includes
    idle memory, swapped memory, and residential memory. Residential memory is memory
    that is physically in use by this process. `SHR` is the amount of memory that
    is shared between applications. This information can give you an idea of the amount
    of `swap` you should configure on your system: take the top five processes, add
    up `VIRT`, and subtract `RES` and `SHR`. It''s not perfect, but it''s a good indicator.'
  id: totrans-284
  prefs: []
  type: TYPE_NORMAL
  zh: 就个人而言，我们不建议现在担心优先级和nice值。对性能的影响很小。第一个有趣的字段是 `VIRT`（虚拟内存）。这指的是程序目前可以访问的内存量。它包括与其他应用程序共享的内存、视频内存、应用程序读入内存的文件等。它还包括空闲内存、交换内存和常驻内存。常驻内存是此进程实际使用的内存。`SHR`
    是应用程序之间共享的内存量。这些信息可以让您对系统上应配置多少`swap`有一个概念：取前五个进程，加上 `VIRT`，然后减去 `RES` 和 `SHR`。这并不完美，但是是一个很好的指标。
- en: 'The **S** column in the preceding screenshot is the status of the machine:'
  id: totrans-285
  prefs: []
  type: TYPE_NORMAL
  zh: 在前面截图中的 **S** 列是机器的状态：
- en: '`D` is uninterruptible sleep, most of the time caused by waiting on storage
    or network I/O.'
  id: totrans-286
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`D` 是不可中断的睡眠，大多数情况是由于等待存储或网络I/O。'
- en: '`R` is running—consuming CPU.'
  id: totrans-287
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`R` 正在运行—消耗CPU。'
- en: '`S` is sleeping—waiting on I/O, no CPU usage. Waiting for a trigger by a user
    or another process.'
  id: totrans-288
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`S` 正在休眠—等待I/O，没有CPU使用。等待用户或其他进程触发。'
- en: '`T` is stopped by the job control signal, most of the time because the user
    pressed *Ctrl* + *Z*.'
  id: totrans-289
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`T` 被作业控制信号停止，大多数情况是因为用户按下 *Ctrl* + *Z*。'
- en: '`Z` is zombie—the parent process has died. It''s labeled as a zombie by the
    kernel while the kernel is busy cleaning up. On physical machines, it can also
    be an indication of failing CPUs (caused by temperature or shoddy bios); in that
    scenario, you may see many zombies. In Azure, this won''t happen. Zombies don''t
    hurt, so don''t kill them; the kernel takes care of them.'
  id: totrans-290
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`Z` 是僵尸—父进程已经死亡。在内核忙于清理时，它被内核标记为僵尸。在物理机器上，这也可能是CPU故障的迹象（由温度或糟糕的BIOS引起）；在这种情况下，您可能会看到许多僵尸。在Azure中，这不会发生。僵尸不会造成伤害，所以不要杀死它们；内核会处理它们。'
- en: Top Alternatives
  id: totrans-291
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: top替代方案
- en: There are many utilities similar to `top`, such as `htop`, which looks fancier
    and is easier to configure.
  id: totrans-292
  prefs: []
  type: TYPE_NORMAL
  zh: 有许多类似于 `top` 的实用程序，例如 `htop`，它看起来更漂亮，更容易配置。
- en: Very similar but even more interesting is `atop`. It contains all the processes
    and their resource usage, even for processes that died between screen updates
    of `atop`. This comprehensive accounting is very helpful for understanding problems
    with individual short-lived processes. `atop` is also able to gather information
    about running containers, networking, and storage.
  id: totrans-293
  prefs: []
  type: TYPE_NORMAL
  zh: 非常相似但更有趣的是 `atop`。它包含所有进程及其资源使用情况，甚至包括在 `atop` 屏幕更新之间死亡的进程。这种全面的记账对于理解个别短暂进程的问题非常有帮助。`atop`
    还能够收集有关运行容器、网络和存储的信息。
- en: 'Another one is `nmon`, which is similar to `atop`, but is more focused on statistics
    and gives more detailed information, especially for memory and storage:'
  id: totrans-294
  prefs: []
  type: TYPE_NORMAL
  zh: 另一个是 `nmon`，它类似于 `atop`，但更专注于统计数据，并提供更详细的信息，特别是内存和存储方面的信息：
- en: '![Using nmon command to get Performance details of memory, CPU and storage](img/B15455_11_21.jpg)'
  id: totrans-295
  prefs: []
  type: TYPE_IMG
  zh: '![使用nmon命令获取内存、CPU和存储性能详细信息](img/B15455_11_21.jpg)'
- en: 'Figure 11.21: Performance details of memory, CPU and storage'
  id: totrans-296
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.21：内存、CPU和存储性能详细信息
- en: '`nmon` can also be used to collect data:'
  id: totrans-297
  prefs: []
  type: TYPE_NORMAL
  zh: '`nmon` 也可以用来收集数据：'
- en: '[PRE55]'
  id: totrans-298
  prefs: []
  type: TYPE_PRE
  zh: '[PRE55]'
- en: The preceding command collects 30 rounds of information every minute in a comma-separated
    file format that is easy to parse in a spreadsheet. On the IBM's developers website,
    [http://nmon.sourceforge.net/pmwiki.php?n=Site.Nmon-Analyser](http://nmon.sourceforge.net/pmwiki.php?n=Site.Nmon-Analyser),
    you can find an Excel spreadsheet that makes this a very easy job. It even offers
    some extra data-analyzing options.
  id: totrans-299
  prefs: []
  type: TYPE_NORMAL
  zh: 上述命令每分钟收集30轮信息，以逗号分隔的文件格式，易于在电子表格中解析。在IBM的开发者网站 [http://nmon.sourceforge.net/pmwiki.php?n=Site.Nmon-Analyser](http://nmon.sourceforge.net/pmwiki.php?n=Site.Nmon-Analyser)
    上，您可以找到一个Excel电子表格，使这变得非常容易。它甚至提供了一些额外的数据分析选项。
- en: '`glances` is also gaining a lot of popularity lately. It is Python-based and
    provides current information about the system, uptime, CPU, memory, swap, network,
    and storage (disk I/O and file):'
  id: totrans-300
  prefs: []
  type: TYPE_NORMAL
  zh: '`glances` 最近也变得非常受欢迎。它基于Python，并提供有关系统、正常运行时间、CPU、内存、交换、网络和存储（磁盘I/O和文件）的当前信息：'
- en: '![Using the glances utility to view the performance](img/B15455_11_22.jpg)'
  id: totrans-301
  prefs: []
  type: TYPE_IMG
  zh: '![使用glances实用程序查看性能](img/B15455_11_22.jpg)'
- en: 'Figure 11.22: Using the glances utility to view the performance'
  id: totrans-302
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.22：使用glances实用程序查看性能
- en: '`glances` is the most advanced alternative to `top`. It offers all the features
    of the alternatives, and, on top of that, you can use it remotely. You need to
    provide the username and password of your server to launch `glances`:'
  id: totrans-303
  prefs: []
  type: TYPE_NORMAL
  zh: '`glances`是`top`的最先进的替代品。它提供了所有替代品的功能，而且，您还可以远程使用它。您需要提供服务器的用户名和密码来启动`glances`：'
- en: '[PRE56]'
  id: totrans-304
  prefs: []
  type: TYPE_PRE
  zh: '[PRE56]'
- en: 'Execute the following on the client too:'
  id: totrans-305
  prefs: []
  type: TYPE_NORMAL
  zh: 在客户端上也执行以下操作：
- en: '[PRE57]'
  id: totrans-306
  prefs: []
  type: TYPE_PRE
  zh: '[PRE57]'
- en: By default, port `61209` is used. If you use the `–webserver` parameter instead
    of `--server`, you don't even need a client. A complete web interface is available
    on port `61208`!
  id: totrans-307
  prefs: []
  type: TYPE_NORMAL
  zh: 默认情况下，使用端口`61209`。如果使用`--webserver`参数而不是`--server`，甚至不需要客户端。端口`61208`上提供完整的Web界面！
- en: '`glances` is able to export logs in many formats and can be queried using an
    API. Experimental support for the **SNMP** (**Simple Network Management Protocol**)
    protocol is on the way as well.'
  id: totrans-308
  prefs: []
  type: TYPE_NORMAL
  zh: '`glances`能够以多种格式导出日志，并且可以使用API进行查询。对**SNMP**（简单网络管理协议）协议的实验性支持也正在进行中。'
- en: Sysstat – a Collection of Performance-Monitoring Tools
  id: totrans-309
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: Sysstat-一组性能监控工具
- en: The `sysstat` package contains utilities for performance monitoring. The most
    important ones in Azure are `sar`, `iostat`, and `pidstat`. If you are also using
    Azure Files, `cifsiostat` can be very handy as well.
  id: totrans-310
  prefs: []
  type: TYPE_NORMAL
  zh: '`sysstat`软件包包含性能监控实用程序。在Azure中最重要的是`sar`、`iostat`和`pidstat`。如果还使用Azure Files，`cifsiostat`也很方便。'
- en: '`sar` is the main utility. The main syntax is this:'
  id: totrans-311
  prefs: []
  type: TYPE_NORMAL
  zh: '`sar`是主要实用程序。主要语法是：'
- en: '[PRE58]'
  id: totrans-312
  prefs: []
  type: TYPE_PRE
  zh: '[PRE58]'
- en: 'For instance, use this command to report CPU statistics 5 times with an interval
    of 1 second:'
  id: totrans-313
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，使用以下命令报告CPU统计信息5次，间隔为1秒：
- en: '[PRE59]'
  id: totrans-314
  prefs: []
  type: TYPE_PRE
  zh: '[PRE59]'
- en: 'To monitor cores `1` and `2`, use this:'
  id: totrans-315
  prefs: []
  type: TYPE_NORMAL
  zh: 要监视核心`1`和`2`，请使用此命令：
- en: '[PRE60]'
  id: totrans-316
  prefs: []
  type: TYPE_PRE
  zh: '[PRE60]'
- en: (If you want to monitor all the cores individually, you can use the `ALL` keyword.)
  id: totrans-317
  prefs: []
  type: TYPE_NORMAL
  zh: （如果要单独监视所有核心，可以使用`ALL`关键字。）
- en: 'Here are some other important resources:'
  id: totrans-318
  prefs: []
  type: TYPE_NORMAL
  zh: 以下是一些其他重要资源：
- en: '`-r`: Memory'
  id: totrans-319
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`-r`：内存'
- en: '`-S`: Swap'
  id: totrans-320
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`-S`：交换'
- en: '`-d`: Disk'
  id: totrans-321
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`-d`：磁盘'
- en: '`-n <type>`: Network types, such as these:'
  id: totrans-322
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`-n <type>`：网络类型，例如：'
- en: '`DEV`: Displays network devices statistics'
  id: totrans-323
  prefs: []
  type: TYPE_NORMAL
  zh: '`DEV`：显示网络设备统计'
- en: '`EDEV`: Displays network devices failure (error) statistics'
  id: totrans-324
  prefs: []
  type: TYPE_NORMAL
  zh: '`EDEV`：显示网络设备故障（错误）统计'
- en: '`NFS`: Displays `SOCK`: Displays sockets in use for IPv4'
  id: totrans-325
  prefs: []
  type: TYPE_NORMAL
  zh: '`NFS`：显示`SOCK`：显示IPv4中正在使用的套接字'
- en: '`IP`: Displays IPv4 network traffic'
  id: totrans-326
  prefs: []
  type: TYPE_NORMAL
  zh: '`IP`：显示IPv4网络流量'
- en: '`TCP`: Displays TCPv4 network traffic'
  id: totrans-327
  prefs: []
  type: TYPE_NORMAL
  zh: '`TCP`：显示TCPv4网络流量'
- en: '`UDP`: Displays UDPv4 network traffic'
  id: totrans-328
  prefs: []
  type: TYPE_NORMAL
  zh: '`UDP`：显示UDPv4网络流量'
- en: '`ALL`: Displays all of the preceding information'
  id: totrans-329
  prefs: []
  type: TYPE_NORMAL
  zh: '`ALL`：显示所有前述信息'
- en: '`pidstat` can collect CPU data from a specific process by its process ID. In
    the next screenshot, you can see that 2 samples are shown every 5 seconds. `pidstat`
    can do the same for memory and disk:'
  id: totrans-330
  prefs: []
  type: TYPE_NORMAL
  zh: '`pidstat`可以通过其进程ID从特定进程收集CPU数据。在下一个截图中，您可以看到每5秒显示2个样本。`pidstat`也可以对内存和磁盘执行相同的操作：'
- en: '![Using pidstat command to get the performance on CPU data from a specific
    process](img/B15455_11_23.jpg)'
  id: totrans-331
  prefs: []
  type: TYPE_IMG
  zh: '![使用pidstat命令获取特定进程的CPU数据性能](img/B15455_11_23.jpg)'
- en: 'Figure 11.23: Displaying CPU statistics using pidstat'
  id: totrans-332
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.23：使用pidstat显示CPU统计信息
- en: '`iostat` is a utility, as the name suggests, that can measure I/O, but it also
    creates reports for CPU usage:'
  id: totrans-333
  prefs: []
  type: TYPE_NORMAL
  zh: '`iostat`是一个实用程序，顾名思义，它可以测量I/O，但也可以创建CPU使用情况报告：'
- en: '![Using iostat command to get the performance statistics for I/O](img/B15455_11_24.jpg)'
  id: totrans-334
  prefs: []
  type: TYPE_IMG
  zh: '![使用iostat命令获取I/O性能统计](img/B15455_11_24.jpg)'
- en: 'Figure 11.24: Getting the CPU and Device report and statistics using iostat'
  id: totrans-335
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.24：使用iostat获取CPU和设备报告和统计信息
- en: '`tps` means the number of transfers per second issued to the device. `kb_read/s`
    and `kB_wrtn/s` are the numbers of kilobytes measured during 1 second; the `avg-cpu`
    column in the preceding screenshot is the total number of statistics since the
    time of your Linux system startup.'
  id: totrans-336
  prefs: []
  type: TYPE_NORMAL
  zh: '`tps`表示每秒向设备发出的传输次数。`kb_read/s`和`kB_wrtn/s`是在1秒内测得的千字节数；前面截图中的`avg-cpu`列是自Linux系统启动以来的统计总数。'
- en: During the installation of the `sysstat` package, a cron job was installed in
    the `/etc/cron.d/sysstat` file.
  id: totrans-337
  prefs: []
  type: TYPE_NORMAL
  zh: 在安装`sysstat`软件包时，在`/etc/cron.d/sysstat`文件中安装了一个cron作业。
- en: Note
  id: totrans-338
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 注意
- en: In modern Linux systems, both `systemd-timers` and the old method using `cron`
    are available. `sysstat` still uses `cron`. To check whether `cron` is available
    and running, go to `systemctl | grep cron`.
  id: totrans-339
  prefs: []
  type: TYPE_NORMAL
  zh: 在现代Linux系统中，`systemd-timers`和使用`cron`的旧方法都可用。`sysstat`仍然使用`cron`。要检查`cron`是否可用并正在运行，请转到`systemctl
    | grep cron`。
- en: '`cron` runs the `sa1` command every 10 minutes. It collects system activity
    and stores it in a binary database. Once a day, the `sa2` command is executed
    to generate a report. The data is stored in the `/var/log/sa` directory. You can
    query that database with `sadf`:'
  id: totrans-340
  prefs: []
  type: TYPE_NORMAL
  zh: '`cron`每10分钟运行一次`sa1`命令。它收集系统活动并将其存储在二进制数据库中。每天一次，执行`sa2`命令生成报告。数据存储在`/var/log/sa`目录中。您可以使用`sadf`查询该数据库：'
- en: '![Using sadf command to query the database for system activity](img/B15455_11_25.jpg)'
  id: totrans-341
  prefs: []
  type: TYPE_IMG
  zh: '![使用sadf命令查询系统活动的数据库](img/B15455_11_25.jpg)'
- en: 'Figure 11.25: Querying the database with sadf for system activity'
  id: totrans-342
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.25：使用sadf查询系统活动的数据库
- en: 'This screenshot shows the data from November 6, between `09:00:00` and `10:10:00`.
    By default, it''s displaying CPU statistics, but you can customize it using the
    same parameters as `sar`:'
  id: totrans-343
  prefs: []
  type: TYPE_NORMAL
  zh: 此截图显示了11月6日`09:00:00`至`10:10:00`之间的数据。默认情况下，它显示CPU统计信息，但您可以使用与`sar`相同的参数进行自定义：
- en: '[PRE61]'
  id: totrans-344
  prefs: []
  type: TYPE_PRE
  zh: '[PRE61]'
- en: This displays the network stats of every network interface on November 6.
  id: totrans-345
  prefs: []
  type: TYPE_NORMAL
  zh: 这显示了11月6日每个网络接口的网络统计信息。
- en: dstat
  id: totrans-346
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: dstat
- en: '`sysstat` is available for historical reports, while `dstat` is for real-time
    reports. While `top` is the monitoring version of `ps`, it''s `dstat` that is
    the monitoring version of `sar`:'
  id: totrans-347
  prefs: []
  type: TYPE_NORMAL
  zh: '`sysstat`用于历史报告，而`dstat`用于实时报告。虽然`top`是`ps`的监视版本，但`dstat`是`sar`的监视版本：'
- en: '![Getting real-time reports with dstat command](img/B15455_11_26.jpg)'
  id: totrans-348
  prefs: []
  type: TYPE_IMG
  zh: '![使用dstat命令获取实时报告](img/B15455_11_26.jpg)'
- en: 'Figure 11.26: Getting real-time reports with dstat'
  id: totrans-349
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.26：使用dstat获取实时报告
- en: 'If you don''t want to see it all at once, you can use the following parameters:'
  id: totrans-350
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您不想一次看到所有内容，可以使用以下参数：
- en: '`c`: CPU'
  id: totrans-351
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`c`：CPU'
- en: '`d`: Disk'
  id: totrans-352
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`d`：磁盘'
- en: '`n`: Network'
  id: totrans-353
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`n`：网络'
- en: '`g`: Paging'
  id: totrans-354
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`g`：分页'
- en: '`s`: Swap'
  id: totrans-355
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`s`：交换'
- en: '`m`: Memory'
  id: totrans-356
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`m`：内存'
- en: Network stats with iproute2
  id: totrans-357
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用iproute2进行网络统计
- en: 'Earlier in this chapter, we talked about `ip`. This command also provides an
    option to get statistics for the network interface:'
  id: totrans-358
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章的前面，我们谈到了`ip`。这个命令还提供了一个选项，用于获取网络接口的统计信息：
- en: '[PRE62]'
  id: totrans-359
  prefs: []
  type: TYPE_PRE
  zh: '[PRE62]'
- en: '![Getting the statistics for the network interface using ip -s link show dev
    eth0 command](img/B15455_11_27.jpg)'
  id: totrans-360
  prefs: []
  type: TYPE_IMG
  zh: '![使用ip -s link show dev eth0命令获取网络接口的统计信息](img/B15455_11_27.jpg)'
- en: 'Figure 11.27: Getting the statistics for the network interface'
  id: totrans-361
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.27：获取网络接口的统计信息
- en: 'It parses information from the `/proc/net` directory. Another utility that
    can parse this information is `ss`. A simple summary can be requested with this:'
  id: totrans-362
  prefs: []
  type: TYPE_NORMAL
  zh: 它解析来自`/proc/net`目录的信息。另一个可以解析此信息的实用程序是`ss`。可以使用以下命令请求简单摘要：
- en: '[PRE63]'
  id: totrans-363
  prefs: []
  type: TYPE_PRE
  zh: '[PRE63]'
- en: Using the `-t` parameter not only shows you the ports in a listening state but
    also the incoming and outgoing traffic on this specific interface.
  id: totrans-364
  prefs: []
  type: TYPE_NORMAL
  zh: 使用`-t`参数不仅可以显示处于监听状态的端口，还可以显示特定接口上的传入和传出流量。
- en: 'If you need more details, the `iproute2` package provides another utility:
    `nstat`. Using the `–d` parameter, you can even run it in interval mode:'
  id: totrans-365
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您需要更多详细信息，`iproute2`软件包提供了另一个实用程序：`nstat`。使用`-d`参数，甚至可以在间隔模式下运行它：
- en: '![Getting a detailed report about the ports in a listening state using nstat
    utility](img/B15455_11_28.jpg)'
  id: totrans-366
  prefs: []
  type: TYPE_IMG
  zh: '![使用nstat实用程序获取处于监听状态的端口的详细报告](img/B15455_11_28.jpg)'
- en: 'Figure 11.28: Getting a detailed report about the ports in a listening state'
  id: totrans-367
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.28：获取有关处于监听状态的端口的详细报告
- en: 'That''s already much more than a simple summary of `ss`. But the `iproute2`
    package has more to offer: `lnstat`.'
  id: totrans-368
  prefs: []
  type: TYPE_NORMAL
  zh: 这已经比`ss`的简单摘要要多得多。但是`iproute2`软件包还有更多提供：`lnstat`。
- en: 'This is the command that provides network statistics such as routing cache
    statistics:'
  id: totrans-369
  prefs: []
  type: TYPE_NORMAL
  zh: 这是提供网络统计信息的命令，如路由缓存统计：
- en: '[PRE64]'
  id: totrans-370
  prefs: []
  type: TYPE_PRE
  zh: '[PRE64]'
- en: '![Getting the network statistics with lnstat––d command](img/B15455_11_29.jpg)'
  id: totrans-371
  prefs: []
  type: TYPE_IMG
  zh: '![使用lnstat-d命令获取网络统计信息](img/B15455_11_29.jpg)'
- en: 'Figure 11.29: Getting the network statistics with lnstat -d'
  id: totrans-372
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.29：使用lnstat -d获取网络统计信息
- en: This shows you everything it can display or monitor. It's pretty low-level,
    but we've solved some firewall performance-related issues using `lnstat -f/proc/net/stat/nf_conntrack`,
    while monitoring the `drops` counter.
  id: totrans-373
  prefs: []
  type: TYPE_NORMAL
  zh: 这显示了它可以显示或监视的所有内容。这相当低级，但我们使用`lnstat -f/proc/net/stat/nf_conntrack`解决了一些与防火墙性能相关的问题，同时监视`drops`计数器。
- en: Network Monitoring with IPTraf-NG
  id: totrans-374
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用IPTraf-NG进行网络监控
- en: You can get network details from tools such as `nmon`, but if you want more
    details, then IPTraf-NG is a very nice tool for a real-time console-based network
    monitoring solution. It is a console-based network-monitoring utility that collects
    all the network IP, TCP, UDP, and ICMP data and is able to break down the information
    according to the size of the TCP/UDP. A few basic filters are included as well.
  id: totrans-375
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以从`nmon`等工具获取网络详细信息，但如果您想要更多详细信息，那么IPTraf-NG是一个非常好的实时基于控制台的网络监控解决方案。它是一个基于控制台的网络监控实用程序，可以收集所有网络IP、TCP、UDP和ICMP数据，并能够根据TCP/UDP的大小来分解信息。还包括一些基本过滤器。
- en: 'Everything is in a menu-driven interface, so there are no parameters that you
    have to remember:'
  id: totrans-376
  prefs: []
  type: TYPE_NORMAL
  zh: 一切都在一个菜单驱动的界面中，所以没有必须记住的参数：
- en: '![Menu window of IPTraf-NG](img/B15455_11_30.jpg)'
  id: totrans-377
  prefs: []
  type: TYPE_IMG
  zh: '![IPTraf-NG的菜单窗口](img/B15455_11_30.jpg)'
- en: 'Figure 11.30: Menu window of IPTraf-NG'
  id: totrans-378
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图11.30：IPTraf-NG的菜单窗口
- en: tcpdump
  id: totrans-379
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: tcpdump
- en: Of course, `tcpdump` is not a performance-monitoring solution. This utility
    is a great tool for monitoring, capturing, and analyzing network traffic.
  id: totrans-380
  prefs: []
  type: TYPE_NORMAL
  zh: 当然，`tcpdump`不是性能监控解决方案。这个实用程序是监视、捕获和分析网络流量的好工具。
- en: 'To view network traffic on all the network interfaces, execute the following:'
  id: totrans-381
  prefs: []
  type: TYPE_NORMAL
  zh: 要查看所有网络接口上的网络流量，请执行以下操作：
- en: '[PRE65]'
  id: totrans-382
  prefs: []
  type: TYPE_PRE
  zh: '[PRE65]'
- en: 'For a specific interface, try this:'
  id: totrans-383
  prefs: []
  type: TYPE_NORMAL
  zh: 对于特定接口，请尝试这个：
- en: '[PRE66]'
  id: totrans-384
  prefs: []
  type: TYPE_PRE
  zh: '[PRE66]'
- en: 'In general, it''s a good idea not to resolve the hostnames:'
  id: totrans-385
  prefs: []
  type: TYPE_NORMAL
  zh: 一般来说，最好不要解析主机名：
- en: '[PRE67]'
  id: totrans-386
  prefs: []
  type: TYPE_PRE
  zh: '[PRE67]'
- en: 'You can add different levels of verbosity by repeating the `v` parameter up
    to a maximum verbosity level of three:'
  id: totrans-387
  prefs: []
  type: TYPE_NORMAL
  zh: 通过重复`v`参数，可以添加不同级别的详细程度，最大详细程度为三：
- en: '[PRE68]'
  id: totrans-388
  prefs: []
  type: TYPE_PRE
  zh: '[PRE68]'
- en: 'You can filter the traffic based on the host:'
  id: totrans-389
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以基于主机筛选流量：
- en: '[PRE69]'
  id: totrans-390
  prefs: []
  type: TYPE_PRE
  zh: '[PRE69]'
- en: 'Alternatively, you can filter based on the source or destination IP:'
  id: totrans-391
  prefs: []
  type: TYPE_NORMAL
  zh: 或者，您可以基于源或目标IP进行筛选：
- en: '[PRE70]'
  id: totrans-392
  prefs: []
  type: TYPE_PRE
  zh: '[PRE70]'
- en: 'Filtering on a specific port is also possible:'
  id: totrans-393
  prefs: []
  type: TYPE_NORMAL
  zh: 还可以根据特定端口进行筛选：
- en: '[PRE71]'
  id: totrans-394
  prefs: []
  type: TYPE_PRE
  zh: '[PRE71]'
- en: 'All the parameters can be combined:'
  id: totrans-395
  prefs: []
  type: TYPE_NORMAL
  zh: 所有参数都可以组合使用：
- en: '[PRE72]'
  id: totrans-396
  prefs: []
  type: TYPE_PRE
  zh: '[PRE72]'
- en: 'The `–c` parameter was added, so only five packets were captured. You can save
    the captured data to a file:'
  id: totrans-397
  prefs: []
  type: TYPE_NORMAL
  zh: 添加了`-c`参数，因此只捕获了五个数据包。您可以将捕获的数据保存到文件中：
- en: '[PRE73]'
  id: totrans-398
  prefs: []
  type: TYPE_PRE
  zh: '[PRE73]'
- en: 'Two parameters were added to increase the compatibility with other analyzers
    that can read the format of `tcpdump`:'
  id: totrans-399
  prefs: []
  type: TYPE_NORMAL
  zh: 添加了两个参数，以增加与其他可以读取`tcpdump`格式的分析器的兼容性：
- en: '`-XX`: Prints the data of each packet in hex and ASCII format'
  id: totrans-400
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`-XX`：以十六进制和ASCII格式打印每个数据包的数据'
- en: '`-x`: Adds headers to every packet'
  id: totrans-401
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`-x`：为每个数据包添加标题'
- en: 'To read the data with a complete timestamp in human-readable format, use this
    command:'
  id: totrans-402
  prefs: []
  type: TYPE_NORMAL
  zh: 要以人类可读的完整时间戳格式读取数据，请使用此命令：
- en: '[PRE74]'
  id: totrans-403
  prefs: []
  type: TYPE_PRE
  zh: '[PRE74]'
- en: Note
  id: totrans-404
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 注意
- en: Another great network analyzer is Wireshark. It's a graphical tool that's available
    for many operating systems. This analyzer can import captured data from `tcpdump`.
    It comes with a great search filter and analyzing tools for many different network
    protocols and services.
  id: totrans-405
  prefs: []
  type: TYPE_NORMAL
  zh: 另一个很棒的网络分析器是Wireshark。这是一个图形工具，适用于许多操作系统。该分析器可以导入从`tcpdump`捕获的数据。它配备了一个很棒的搜索过滤器和分析工具，适用于许多不同的网络协议和服务。
- en: It makes sense to make the capture in your VM and download it to your workstation
    in order to analyze the data further in Wireshark.
  id: totrans-406
  prefs: []
  type: TYPE_NORMAL
  zh: 在虚拟机中进行捕获并将其下载到工作站以便在Wireshark中进一步分析数据是有意义的。
- en: We're sure that you will now be able to achieve good performance analysis in
    a Linux system using different tools to monitor metrics such as CPU, memory, storage,
    and network details.
  id: totrans-407
  prefs: []
  type: TYPE_NORMAL
  zh: 我们相信您现在可以使用不同的工具在Linux系统中实现良好的性能分析，以监视CPU、内存、存储和网络详细信息。
- en: Summary
  id: totrans-408
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 摘要
- en: In this chapter, we covered several topics regarding troubleshooting, logging,
    monitoring, and even analyzing. Starting with getting access to a VM, we investigated
    logging in Linux both locally and remotely.
  id: totrans-409
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们涵盖了有关故障排除、日志记录、监控甚至分析的几个主题。从获取对虚拟机的访问开始，我们研究了在Linux中本地和远程进行日志记录。
- en: There is a thin line between performance monitoring and performance troubleshooting.
    There are many, many different utilities available to find out the cause of your
    performance issues. Each has a different goal, but there is also a great deal
    of overlap. We have covered the most popular utilities in Linux and some of the
    options available.
  id: totrans-410
  prefs: []
  type: TYPE_NORMAL
  zh: 性能监控和性能故障排除之间有一条细微的界限。有许多不同的实用工具可用于找出性能问题的原因。每个工具都有不同的目标，但也有很多重叠之处。我们已经介绍了Linux中最流行的实用工具以及一些可用的选项。
- en: In the first chapter, we saw that Azure is a very open source–friendly environment
    and that Microsoft has made a great effort to make Azure an open, standard cloud
    solution with interoperability in mind. In this chapter, we saw that Microsoft
    has not only put a lot of effort into supporting Linux while deploying your application
    but also into supporting it in Azure Monitor.
  id: totrans-411
  prefs: []
  type: TYPE_NORMAL
  zh: 在第一章中，我们看到Azure是一个非常开放源代码友好的环境，微软已经付出了很大的努力，使Azure成为一个开放的、标准的云解决方案，并考虑了互操作性。在本章中，我们看到微软不仅在部署应用程序时支持Linux，而且在Azure
    Monitor中也支持它。
- en: Questions
  id: totrans-412
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 问题
- en: Why should you have at least one user with a password in a VM?
  id: totrans-413
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 为什么在虚拟机中至少应该有一个带密码的用户？
- en: What is the purpose of the `systemd-journald` daemon?
  id: totrans-414
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`systemd-journald`守护进程的目的是什么？'
- en: What are syslog facilities?
  id: totrans-415
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: syslog设施是什么？
- en: What priorities are available in syslog?
  id: totrans-416
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: syslog中有哪些可用的优先级？
- en: How can you add entries to a log, and why should you do that?
  id: totrans-417
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 你如何向日志添加条目，以及为什么要这样做？
- en: What services are available to view metrics in Azure?
  id: totrans-418
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在Azure中有哪些服务可用于查看指标？
- en: Why is `top` only useful to have a first look into performance-related problems,
    and what utility or utilities can fix that?
  id: totrans-419
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 为什么`top`只能用于初步查看与性能相关的问题，以及哪个实用工具可以解决这个问题？
- en: What is the difference between the `sysstat` and `dstat` utilities?
  id: totrans-420
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`sysstat`和`dstat`实用程序之间有什么区别？'
- en: Why should you install Wireshark on your workstation?
  id: totrans-421
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 为什么应该在工作站上安装Wireshark？
- en: Further Reading
  id: totrans-422
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 进一步阅读
- en: 'A big source of information is the website of Brendan D Gregg ([http://www.brendangregg.com](http://www.brendangregg.com)),
    where he shares an unbelievably long list of Linux performance documentation,
    slides, videos, and more. On top of that, there are some nice utilities! He was
    the one who taught me, in 2015, that it is important to identify a problem correctly:'
  id: totrans-423
  prefs: []
  type: TYPE_NORMAL
  zh: 一个重要的信息来源是Brendan D Gregg的网站（[http://www.brendangregg.com](http://www.brendangregg.com)），他在那里分享了一份令人难以置信的长长的Linux性能文档、幻灯片、视频等清单。除此之外，还有一些不错的实用工具！他是2015年教会我的人，正确识别问题是很重要的。
- en: What makes you think that there is a problem?
  id: totrans-424
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 是什么让你觉得有问题？
- en: Was there a time that there wasn't a problem?
  id: totrans-425
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 曾经有没有出现过问题？
- en: Has something changed recently?
  id: totrans-426
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 最近有什么变化吗？
- en: Try to find technical descriptions, such as latency, runtime errors, and so
    on.
  id: totrans-427
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 尝试寻找技术描述，比如延迟、运行时错误等。
- en: Is it only the application, or are other resources affected as well?
  id: totrans-428
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 只有应用程序受影响，还是其他资源也受到影响？
- en: Come up with an exact description of the environment.
  id: totrans-429
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 提出一个关于环境的确切描述。
- en: 'You also have to consider the following:'
  id: totrans-430
  prefs: []
  type: TYPE_NORMAL
  zh: 你还需要考虑以下几点：
- en: What is causing the load (which process, IP address, and so on)?
  id: totrans-431
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 是什么导致负载（哪个进程、IP地址等）？
- en: Why was the load called?
  id: totrans-432
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 为什么称之为负载？
- en: What resource(s) is/are used by the load?
  id: totrans-433
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 负载使用了哪些资源？
- en: Does the load change? If so, how is it changing over time?
  id: totrans-434
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 负载是否发生变化？如果是，它是如何随时间变化的？
- en: Last, but not least, there's *Red Hat Enterprise Linux Troubleshooting Guide*
    by Benjamin Cane. I know, some parts of the book are outdated, as it was printed
    in 2015\. And, for sure, I definitely hope for a second edition, but, especially
    if you are new to Linux, buy this book.
  id: totrans-435
  prefs: []
  type: TYPE_NORMAL
  zh: 最后但同样重要的是，本书作者是Benjamin Cane的《Red Hat Enterprise Linux故障排除指南》。我知道，这本书的一些部分已经过时，因为它是在2015年印刷的。当然，我希望有第二版，但是，特别是如果你是Linux的新手，买这本书。
