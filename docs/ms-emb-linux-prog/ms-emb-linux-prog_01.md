# 第一章：起步

你即将开始你的下一个项目，这一次它将运行 Linux。在你动手之前，你应该考虑些什么？让我们从一个高层次来看嵌入式 Linux，看看为什么它如此受欢迎，开源许可证的影响是什么，以及你需要什么样的硬件来运行 Linux。

Linux 在 1999 年左右首次成为嵌入式设备的可行选择。那时 Axis（www.axis.com）发布了他们的第一款 Linux 动力网络摄像头，而 TiVo（www.tivo.com）发布了他们的第一款数字视频录像机（DVR）。自 1999 年以来，Linux 变得越来越受欢迎，以至于今天它是许多产品类别的首选操作系统。在撰写本文时，即 2015 年，有大约 20 亿台设备运行 Linux。其中包括大量运行 Android 的智能手机，Android 使用了 Linux 内核，以及数亿台机顶盒、智能电视和 Wi-Fi 路由器，更不用说一系列体积较小的设备，如车辆诊断、称重秤、工业设备和医疗监测单元。

那么，为什么你的电视运行 Linux？乍一看，电视的功能很简单：它必须在屏幕上显示视频流。为什么像 Linux 这样复杂的类 Unix 操作系统是必要的？

简单的答案是摩尔定律：英特尔的联合创始人戈登·摩尔在 1965 年观察到，芯片上的组件密度大约每两年翻一番。这适用于我们设计和使用的日常生活中的设备，就像它适用于台式机、笔记本电脑和服务器一样。大多数嵌入式设备的核心是一个高度集成的芯片，其中包含一个或多个处理器核心，并与主存储器、大容量存储和多种类型的外围设备进行接口。这被称为片上系统，或 SoC，它们随着摩尔定律的增长而变得越来越复杂。典型的 SoC 有一个技术参考手册，长达数千页。你的电视不仅仅是像旧模拟电视一样显示视频流。

视频流是数字的，可能是加密的，需要处理才能创建图像。你的电视（或很快将会）连接到互联网。它可以接收来自智能手机、平板电脑和家庭媒体服务器的内容。它可以（或很快将会）用于玩游戏。等等。你需要一个完整的操作系统来管理这种复杂程度。

以下是一些推动 Linux 采用的要点：

+   Linux 具有必要的功能。它有一个良好的调度程序，一个良好的网络堆栈，支持 USB、Wi-Fi、蓝牙，许多种存储介质，对多媒体设备的良好支持等等。它满足了所有要求。

+   Linux 已经移植到了各种处理器架构，包括一些在 SoC 设计中非常常见的架构——ARM、MIPS、x86 和 PowerPC。

+   Linux 是开源的，所以你有自由获取源代码并修改以满足你的需求。你或者代表你工作的人可以为你特定的 SoC 板或设备创建一个板支持包。你可以添加可能在主线源代码中缺失的协议、功能和技术。你可以删除你不需要的功能以减少内存和存储需求。Linux 是灵活的。

+   Linux 有一个活跃的社区；在 Linux 内核的情况下，非常活跃。内核每 10 到 12 周发布一个新版本，每个版本都包含来自大约 1000 名开发人员的代码。活跃的社区意味着 Linux 是最新的，并支持当前的硬件、协议和标准。

+   开源许可证保证你可以访问源代码。没有供应商的约束。

因此，Linux 是复杂设备的理想选择。但我在这里应该提到一些注意事项。复杂性使得理解变得更加困难。再加上快速发展的开发过程和开源的分散结构，您必须付出一些努力来学习如何使用它，并随着其变化而不断重新学习。我希望本书能在这个过程中有所帮助。

# 选择合适的操作系统

Linux 是否适合您的项目？Linux 在解决问题的复杂性得到合理解释的情况下效果很好。在需要连接性、稳健性和复杂用户界面的情况下尤其有效。但它无法解决所有问题，因此在您着手之前需要考虑以下一些事项：

+   您的硬件是否能胜任？与传统的实时操作系统（RTOS）如 VxWorks 相比，Linux 需要更多的资源。它至少需要一个 32 位处理器，以及更多的内存。我将在典型硬件要求部分详细介绍。

+   您是否具备正确的技能？项目的早期阶段，即板卡调试，需要对 Linux 及其与硬件的关系有详细的了解。同样，在调试和优化应用程序时，您需要能够解释结果。如果您内部没有这些技能，您可能需要外包一些工作。当然，阅读本书会有所帮助！

+   您的系统是否实时？Linux 可以处理许多实时活动，只要您注意一些细节，我将在《第十四章》中详细介绍，*实时编程*。

仔细考虑这些要点。成功的最佳指标可能是寻找运行 Linux 的类似产品，并看看它们是如何做到的；遵循最佳实践。

# 参与者

开源软件是从哪里来的？谁写的？特别是，这与嵌入式开发的关键组件 - 工具链、引导加载程序、内核和根文件系统中的基本实用程序有何关系？

主要参与者是：

+   开源社区。毕竟，这是生成您将要使用的软件的引擎。社区是一群开发人员的松散联盟，其中许多人以某种方式获得资助，可能是通过非营利组织、学术机构或商业公司。他们共同努力以推进各种项目的目标。其中有许多项目，有些小，有些大。我们在本书的其余部分将使用的一些项目是 Linux 本身、U-Boot、BusyBox、Buildroot、Yocto 项目以及 GNU 组织下的许多项目。

+   CPU 架构师 - 这些是设计我们使用的 CPU 的组织。这里的重要组织包括 ARM/Linaro（基于 ARM 的 SoC）、英特尔（x86 和 x86_64）、想象科技（MIPS）和 Freescale/IBM（PowerPC）。他们实现或者至少影响对基本 CPU 架构的支持。

+   SoC 供应商（Atmel、Broadcom、Freescale、英特尔、高通、TI 等）- 他们从 CPU 架构师那里获取内核和工具链，并对其进行修改以支持他们的芯片。他们还创建参考板：这些设计被下一级用来创建开发板和实际产品。

+   板卖家和 OEM - 这些人从 SoC 供应商那里获取参考设计，并将其构建到特定产品中，例如机顶盒或摄像头，或创建更通用的开发板，例如 Avantech 和 Kontron 的开发板。一个重要的类别是廉价的开发板，如 BeagleBoard/BeagleBone 和 Raspberry Pi，它们已经创建了自己的软件和硬件附加组件生态系统。

这些构成了一个链条，您的项目通常位于末端，这意味着您不能自由选择组件。您不能简单地从[kernel.org](http:// kernel.org)获取最新的内核，除非在极少数情况下，因为它不支持您正在使用的芯片或板。

这是嵌入式开发的一个持续问题。理想情况下，每个环节的开发者都会将他们的变更推送到上游，但他们没有这样做。发现一个内核有成千上万个未合并到上游的补丁并不罕见。此外，SoC 供应商倾向于只为他们最新的芯片积极开发开源组件，这意味着对于任何超过几年的芯片，支持将被冻结，不会收到任何更新。

其结果是，大多数嵌入式设计都基于旧版本的软件。它们不会接收安全修复、性能增强或新版本中的功能。像 Heartbleed（OpenSSL 库中的一个漏洞）和 Shellshock（bash shell 中的一个漏洞）这样的问题得不到修复。我将在本章后面的安全主题下更多地谈论这个问题。

你能做些什么？首先，向你的供应商提问：他们的更新政策是什么，他们多久修订一次内核版本，当前的内核版本是什么，之前的是什么？他们的政策是如何将变更合并到上游的？一些供应商在这方面取得了巨大进展。你应该偏好他们的芯片。

其次，你可以采取措施使自己更加自给自足。本书旨在更详细地解释依赖关系，并向你展示在哪些方面你可以自助。不要盲目接受 SoC 或板卡供应商提供的软件包，而不考虑其他选择。

# 项目生命周期

这本书分为四个部分，反映了项目的各个阶段。这些阶段不一定是顺序的。通常它们会重叠，你需要回头去重新审视之前完成的事情。然而，它们代表了开发者在项目进展过程中的关注点：

+   嵌入式 Linux 的要素（第 1 至 6 章）将帮助你建立开发环境，并为后续阶段创建一个工作平台。它通常被称为“板卡引导”阶段。

+   系统架构和设计选择（第 7 至 9 章）将帮助你审视一些关于程序和数据存储、如何在内核设备驱动程序和应用程序之间划分工作，以及如何初始化系统的设计决策。

+   编写嵌入式应用程序（第 10 和 11 章）展示了如何有效利用 Linux 进程和线程模型，以及如何在资源受限的设备中管理内存。

+   调试和优化性能（第 12 和 13 章）描述了如何在应用程序和内核中跟踪、分析和调试代码。

关于实时（第十四章, *实时编程*）的第五部分有些独立，因为它是嵌入式系统的一个小但重要的类别。为实现实时行为而设计对四个主要阶段都有影响。

## 嵌入式 Linux 的四个要素

每个项目都始于获取、定制和部署这四个要素：工具链、引导加载程序、内核和根文件系统。这是本书第一部分的主题：

+   **工具链**：这包括为目标设备创建代码所需的编译器和其他工具。其他一切都依赖于工具链。

+   **引导加载程序**：这是必要的，用于初始化板卡并加载和启动 Linux 内核。

+   **内核**：这是系统的核心，管理系统资源并与硬件进行接口。

+   **根文件系统**：这包含了在内核完成初始化后运行的库和程序。

当然，这里还有第五个要素，没有在这里提到。那就是专门针对你的嵌入式应用程序的程序集合，使设备能够完成其预定任务，无论是称重杂货、播放电影、控制机器人还是驾驶无人机。

通常情况下，当你购买 SoC 或板卡时，可能会作为一个包的一部分或全部提供这些元素。但是，出于前面段落提到的原因，它们可能不是最好的选择。我将在前六章中为您提供背景，以便做出正确的选择，并向您介绍两个自动化整个过程的工具：Buildroot 和 Yocto Project。

# 开源

嵌入式 Linux 的组件是开源的，所以现在是考虑这意味着什么，为什么开源工作方式以及这如何影响您将从中创建的通常是专有的嵌入式设备的好时机。

## 许可证

谈到开源时，经常使用“免费”这个词。对于这个主题的新手来说，他们通常认为这意味着无需支付任何费用，而开源软件许可确实保证您可以免费使用软件开发和部署系统。然而，这里更重要的意义是自由，因为您可以自由获取源代码并以任何您认为合适的方式进行修改，并在其他系统中重新部署。这些许可证赋予了您这个权利。与允许您免费复制二进制文件但不提供源代码的共享软件许可证，或者允许您在某些情况下免费使用软件（例如个人使用但不允许商业使用）的其他许可证相比，这些都不是开源。

我将提供以下评论，以帮助您了解使用开源许可证的影响，但我想指出，我是一名工程师，而不是律师。以下是我对许可证及其解释方式的理解。

开源许可证大致分为两类：来自自由软件基金会的**GPL**（**General Public License**）和来自**BSD**（**Berkeley Software Distribution**）、Apache 基金会和其他组织的宽松许可证。

宽松许可证基本上表示，您可以修改源代码并在自己选择的系统中使用它，只要您不以任何方式修改许可证条款。换句话说，在这个限制下，您可以按照自己的意愿使用它，包括将其构建到可能是专有系统中。

GPL 许可证相似，但有条款强制您将获取和修改软件的权利传递给最终用户。换句话说，您分享您的源代码。其中一个选项是通过将其放在公共服务器上使其完全公开。另一个选项是通过书面提供代码的要约，仅向最终用户提供。GPL 进一步规定，您不能将 GPL 代码合并到专有程序中。任何尝试这样做的行为都会使 GPL 适用于整个程序。换句话说，您不能在一个程序中将 GPL 和专有代码结合在一起。

那么，图书馆呢？如果它们使用 GPL 许可证，任何与它们链接的程序也会成为 GPL。然而，大多数图书馆都是根据**Lesser General Public License** (**LGPL**)许可。如果是这种情况，你可以允许从专有程序中链接它们。

前面的描述都是针对 GPL v2 和 LGPL v2.1 的。我应该提到最新版本的 GPL v3 和 LGPL v3。这些是有争议的，我承认我并不完全理解其影响。然而，意图是确保系统中的 GPLv3 和 LGPL v3 组件可以被最终用户替换，这符合开源软件的精神。但这确实会带来一些问题。一些 Linux 设备用于根据订阅级别或其他限制获取信息，替换软件的关键部分可能会影响这一点。机顶盒属于这一类。还存在安全问题。如果设备的所有者可以访问系统代码，那么不受欢迎的入侵者也可能会访问。通常的防御措施是拥有由权威（供应商）签名的内核映像，以防止未经授权的更新。这是否侵犯了我修改设备的权利？意见不一。

### 注意

TiVo 机顶盒是这场辩论的重要组成部分。它使用 Linux 内核，该内核根据 GPL v2 许可。TiVo 发布了他们版本的内核源代码，因此符合许可证。TiVo 还有一个只会加载由他们签名的内核二进制文件的引导加载程序。因此，你可以为 TiVo 盒构建修改后的内核，但无法在硬件上加载它。自由软件基金会认为这不符合开源软件的精神，并将此过程称为“Tivoization”。GPL v3 和 LGPL v3 是明确防止这种情况发生的。一些项目，特别是 Linux 内核，一直不愿采用第三版许可证，因为它会对设备制造商施加限制。

# 嵌入式 Linux 的硬件

如果你正在为嵌入式 Linux 项目设计或选择硬件，你需要注意什么？

首先，CPU 架构必须得到内核支持，除非你当然打算自己添加一个新的架构！查看 Linux 4.1 的源代码，有 30 种架构，每种都在`arch/`目录下有一个子目录表示。它们都是 32 位或 64 位架构，大多数带有内存管理单元（MMU），但也有一些没有。在嵌入式设备中最常见的是 ARM、MIPS、PowerPC 和 X86，每种都有 32 位和 64 位变体，并且都有内存管理单元。

本书的大部分内容是针对这类处理器编写的。还有另一类没有 MMU 的处理器，运行一个名为微控制器 Linux 或 uClinux 的 Linux 子集。这些处理器架构包括 ARC、Blackfin、Microblaze 和 Nios。我会不时提到 uClinux，但不会详细介绍，因为这是一个相当专业的话题。

其次，你需要合理数量的 RAM。16 MiB 是一个不错的最低值，尽管使用一半的 RAM 也完全可以运行 Linux。如果你愿意对系统的每个部分进行优化，甚至可以使用 4 MiB 运行 Linux。甚至可能更低，但是有一个临界点，那时它就不再是 Linux 了。

第三，通常是闪存这样的非易失性存储。8 MiB 对于简单设备如网络摄像头或简单路由器已经足够了。与 RAM 一样，如果你真的愿意，你可以使用更少的存储创建一个可行的 Linux 系统，但是越低，就越困难。Linux 对闪存设备有广泛的支持，包括原始 NOR 和 NAND 闪存芯片以及 SD 卡、eMMC 芯片、USB 闪存等形式的受控闪存。

第四，调试端口非常有用，最常见的是 RS-232 串行端口。它不一定要安装在生产板上，但可以使板子的启动、调试和开发更加容易。

第五，您需要一些手段在从头开始时加载软件。几年前，板子会配备 JTAG 接口，但现代 SoC 有能力直接从可移动介质加载引导代码，特别是 SD 和 micro SD 卡，或者串行接口，如 RS-232 或 USB。

除了这些基础知识外，还有与设备需要完成工作的特定硬件位的接口。主线 Linux 配备了成千上万种不同设备的开源驱动程序，SoC 制造商和第三方芯片的 OEM 提供了质量不等的驱动程序，但请记住我对一些制造商的承诺和能力的评论。作为嵌入式设备的开发人员，您会发现自己花费了相当多的时间来评估和调整第三方代码，如果有的话，或者与制造商联系，如果没有的话。最后，您将不得不为设备的任何独特接口编写设备支持，或者找人替您完成。

# 本书中使用的硬件

本书中的示例旨在是通用的，但为了使它们相关且易于遵循，我不得不选择一个特定的设备作为示例。我使用了两个示例设备：BeagleBone Black 和 QEMU。第一个是广泛可用且便宜的开发板，可用于严肃的嵌入式硬件。第二个是一个机器模拟器，可用于创建典型的嵌入式硬件系统。诱人的是只使用 QEMU，但是像所有模拟一样，它与真实情况并不完全相同。使用 BeagleBone，您可以满足与真实硬件交互并看到真正的 LED 闪烁的满足感。诱人的是选择比 BeagleBone Black 更为时尚的板子，但我相信它的流行度使其具有一定的长寿性，并意味着它将在未来几年内继续可用。

无论如何，我鼓励您尝试使用这两个平台中的任何一个或者您手头上可能有的任何嵌入式硬件来尝试尽可能多的示例。

## BeagleBone Black

BeagleBone 和后来的 BeagleBone Black 是由 Circuitco LLC 生产的一款小型信用卡大小的开放硬件设计的开发板。主要信息库位于[www.beagleboard.org](http://www.beagleboard.org)。规格的主要要点是：

+   TI AM335x 1GHz ARM® Cortex-A8 Sitara SoC

+   512 MiB DDR3 RAM

+   2 或 4 GiB 8 位 eMMC 板载闪存

+   用于调试和开发的串行端口

+   可用作引导设备的 MicroSD 连接器

+   迷你 USB OTG 客户端/主机端口，也可用于为板子供电

+   全尺寸 USB 2.0 主机端口

+   10/100 以太网端口

+   HDMI 用于视频和音频输出

此外，还有两个 46 针扩展头，有许多不同的子板，称为披风，可以使板子适应许多不同的功能。但是，在本书的示例中，您不需要安装任何披风。

除了板子本身，您还需要：

+   一根迷你 USB 到全尺寸 USB 电缆（随板子提供）以提供电源，除非您拥有此列表上的最后一项。

+   一个 RS-232 电缆，可以与板子提供的 6 针 3.3 伏 TTL 电平信号进行接口。Beagleboard 网站上有兼容电缆的链接。

+   一个 microSD 卡和一种从开发 PC 或笔记本电脑上写入软件到板子上所需的手段。

+   一根以太网电缆，因为一些示例需要网络连接。

+   可选，但建议使用，能够提供 1A 或更多电流的 5V 电源适配器。

## QEMU

QEMU 是一个机器模拟器。它有许多不同的版本，每个版本都可以模拟处理器架构和使用该架构构建的许多板子。例如，我们有以下内容：

+   **qemu-system-arm**：ARM

+   **qemu-system-mips**：MIPS

+   **qemu-system-ppc**：PowerPC

+   **qemu-system-x86**：x86 和 x86_64

对于每种架构，QEMU 模拟了一系列硬件，您可以通过使用选项`-machine help`来查看。每台机器模拟了通常在该板上找到的大部分硬件。有选项可以将硬件链接到本地资源，例如使用本地文件作为模拟磁盘驱动器。以下是一个具体的例子：

```
$ qemu-system-arm -machine vexpress-a9 -m 256M -drive file=rootfs.ext4,sd -net nic -net use -kernel zImage -dtb vexpress-v2p-ca9.dtb -append "console=ttyAMA0,115200 root=/dev/mmcblk0" -serial stdio -net nic,model=lan9118 -net tap,ifname=tap0

```

前面命令行中使用的选项是：

+   -machine vexpress-a9：创建一个 ARM Versatile Express 开发板的模拟，配备 Cortex A-9 处理器

+   -m 256M：为其分配 256 MiB 的 RAM

+   -drive file=rootfs.ext4,sd：将`sd`接口连接到本地文件`rootfs.ext4`（其中包含文件系统镜像）

+   -kernel zImage：从名为`zImage`的本地文件加载 Linux 内核

+   -dtb vexpress-v2p-ca9.dtb：从本地文件`vexpress-v2p-ca9.dtb`加载设备树

+   -append "..."：将此字符串作为内核命令行提供

+   -serial stdio：将串行端口连接到启动 QEMU 的终端，通常用于通过串行控制台登录到模拟机器

+   -net nic,model=lan9118：创建一个网络接口

+   -net tap,ifname=tap0：将网络接口连接到虚拟网络接口`tap0`

要配置网络的主机端，您需要来自**用户模式 Linux**（**UML**）项目的`tunctl`命令；在 Debian 和 Ubuntu 上，该软件包的名称为`uml-utilities`。您可以使用以下命令创建一个虚拟网络：

```
$ sudo tunctl -u $(whoami) -t tap0

```

这将创建一个名为`tap0`的网络接口，它连接到模拟的 QEMU 机器中的网络控制器。您可以像配置任何其他接口一样配置`tap0`。

所有这些选项在接下来的章节中都有详细描述。我将在大多数示例中使用 Versatile Express，但使用不同的机器或架构应该也很容易。

# 本书中使用的软件

我只使用了开源软件来开发工具和目标操作系统和应用程序。我假设您将在开发系统上使用 Linux。我使用 Ubuntu 14.04 测试了所有主机命令，因此对该特定版本有一些偏见，但任何现代 Linux 发行版都可能运行良好。

# 摘要

嵌入式硬件将继续变得更加复杂，遵循摩尔定律所设定的轨迹。Linux 具有利用硬件的能力和灵活性。

Linux 只是开源软件中的一个组件，您需要创建一个可工作产品所需的许多组件。代码是免费提供的，这意味着许多不同层次的人和组织都可以做出贡献。然而，嵌入式平台的多样性和快速发展的步伐导致了软件的孤立池，它们的共享效率不如预期高。在许多情况下，您将依赖于这些软件，特别是由 SoC 或板卡供应商提供的 Linux 内核，以及较小程度上的工具链。一些 SoC 制造商正在更好地推动他们的变更上游，并且这些变更的维护变得更加容易。

幸运的是，有一些强大的工具可以帮助您创建和维护设备的软件。例如，Buildroot 非常适合小型系统，Yocto Project 适合更大的系统。

在我描述这些构建工具之前，我将描述嵌入式 Linux 的四个元素，您可以将其应用于所有嵌入式 Linux 项目，无论它们是如何创建的。下一章将全面介绍这些元素中的第一个，即工具链，您需要用它来为目标平台编译代码。
