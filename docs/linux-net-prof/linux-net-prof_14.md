# 第十一章：Linux 中的数据包捕获和分析

在本章中，我们将讨论在 Linux 中使用数据包捕获。在许多方面，数据包是数据中心中最接近*真相*的东西；经常引用的谚语是*数据包不会说谎*。无论主机或防火墙上存在什么样的策略或复杂的配置，主机和应用程序数据包始终会反映发生的情况。这使得数据包捕获，更重要的是对这些数据包进行分析成为网络管理员工具箱中的关键问题解决和故障排除技能。

特别是，我们将涵盖以下主题：

+   数据包捕获简介-寻找正确的地方

+   在进行捕获时的性能考虑

+   捕获工具

+   过滤捕获的流量

+   解决应用程序问题-捕获 VoIP 电话呼叫

让我们开始吧！

# 技术要求

在本章中，我们将捕获数据包。初始设置和数据包捕获使用了一个您可能无法访问的物理交换机。不过，一旦我们开始查看数据包本身，所有捕获文件都可以下载。由于本章的大部分内容都是关于分析和解释捕获的数据包，我们现有的 Linux 主机应该可以很好地完成工作，而不需要进行过多的修改。这也是我们确保当您按照本章的示例进行操作时，您的显示与我们描述的内容匹配的好方法。

当然，您可以在实验室中构建数据包捕获，或者更好地集成到您的工作环境中。这是一个非常有价值的工具，可以用来排除故障，或者更好地了解我们每天使用的各种协议和应用程序！

本章引用的捕获文件可以在本书的 GitHub 存储库的`C11`文件夹中找到：[`github.com/PacktPublishing/Linux-for-Networking-Professionals/tree/main/C11`](https://github.com/PacktPublishing/Linux-for-Networking-Professionals/tree/main/C11)。

# 数据包捕获简介-寻找正确的地方

有多种方法可以在两个主机之间拦截和捕获数据包，以及在通信路径中进行捕获的多个位置。让我们讨论一些更受欢迎的选择。

## 从任一端进行捕获

这绝对是最简单的选择，因为一切正常时，对话的两端主机都将接收或发送所有数据包。不过，这也有一些缺点：

+   您可能无法访问任一端。根据情况，其中一个端点主机可能根本不在您的组织中。

+   即使有，您可能无法在您的环境中对主机（或主机）进行管理访问。特别是在企业环境中，常见的情况是，网络团队和/或安全团队可能无法在服务器上进行管理访问（或任何访问）。

+   安装新的系统软件通常不是大多数组织可以随意进行的事情。大多数公司对可能影响工作站或服务器操作的任何事物都需要严格的变更控制程序。

+   即使安装数据包捕获应用的变更请求得到批准，像这样的奇怪应用程序在安装后可能会成为数月甚至数年的争议焦点，服务器上出现的任何奇怪情况都可能被归咎于“网络团队在服务器上安装的那个奇怪的应用程序”。

+   如果您正在解决问题，您可能无法从您可以访问的端点看到问题。例如，如果一些或所有数据包未到达服务器（或客户端），那么在问题站点进行捕获可能无法帮助您解决问题-除了确认这些数据包未到达之外。

因此，通常更倾向于在路径的某个中间点捕获数据包。一个受欢迎的选择是配置交换机端口来*镜像*或*监视*流量。

## 切换监控端口

常见情况是，我们需要捕获发送到或从主机的数据包，但我们无法访问任何主机，无法中断服务，或无法获得安装数据包捕获软件所需的权限。由于这些情况非常普遍，交换机供应商已经实施了一些功能来帮助我们。大多数交换机都有将流量镜像或监视到或从端口的功能。这通常被称为**交换端口分析器**（**SPAN**）配置。从交换机上，我们只需配置要监视的端口，我们是要发送（Tx）、接收（Rx）还是双向流量，以及我们要将数据发送到哪个端口。

例如，在思科交换机上，在这种配置中，我们正在监视`GigabitEthernet 1/0/1`端口（发送和接收），我们的数据包捕获主机位于`GigabitEthernet 1/0/5`端口上：

```
monitor session 1 source g1/0/1 both
monitor session 1 destination g1/0/5
```

正如您所看到的，这些都是为`monitor session 1`定义的，这意味着是的，大多数交换机将支持同时进行多个监视会话。这可以通过监视整个 VLAN（因此源可能是 VLAN 7）或将数据包捕获发送到远程目的地，称为**远程交换端口分析器**（**RSPAN**）目的地来扩展。

如果混合中有防火墙或负载均衡器，请注意您定义的源端口 - 例如，如果在 NAT 之前或之后捕获数据包，您的数据包捕获数据将有很大不同。

在哪里还可以查找特定对话中的数据包？网络设备在这里也是一个受欢迎的选择。

## 中间的内联主机

在这种情况下，中间主机，如路由器、交换机或防火墙，可以捕获流量。特别是防火墙非常方便，因为在许多情况下，您可以在 NAT 之前和之后捕获流量。如果您正在解决一个明确定义的问题，这种方法非常合理。但是，必须考虑以下问题：

+   网络设备通常具有有限的存储空间，因此您需要将数据包的总体量保持在捕获设备的存储容量范围内。在某些设备上，您可以实时将捕获发送到远程目的地，以解决这个问题，但这也会带来其他问题。

+   无论哪种情况，数据包速率都应该很低。在许多情况下，这些设备上的本地存储相对较慢，如果数据包速率很高，实时将数据包捕获发送到网络目的地可能会导致捕获中丢失数据包。

+   捕获数据包会对捕获设备的 CPU 产生不利影响。在考虑在此设备上增加数据包捕获负载之前，请确保您的整体 CPU 利用率较低。

+   如果您将捕获的数据包发送到远程目的地，请确保有足够的带宽来做到这一点 - 如果超出端口的带宽，您将在捕获端或发送端丢失数据包。

+   总之，在许多情况下，您正在寻找流中非常特定的数据包以排除问题，以便制作一个*过滤器*来仅收集该流量。

有关使用思科路由器作为数据包*收集器*的更完整描述，请参阅：https://isc.sans.edu/forums/diary/Using+a+Cisco+Router+as+a +Remote+Collector+for+tcpdump+or+Wireshark/7609/。

其他平台的数据包捕获设施通常非常相似 - 它们创建一个*列表*来定义感兴趣的流量，然后开始捕获过程。无论您的设备是什么，您的供应商都会比我们在这里提到的更全面地记录这一点。

最后，我们将看看“纯粹”的方法；也就是使用网络监听器。

## 网络监听器

tap 是一种硬件设备，插入到流量中，允许在任一方向或两个方向进行全面监控。因为它传统上是一个电气/硬件解决方案，所以没有关于数据包容量的争论；任何方向上的每一位都简单地被电气地复制到监听站。然而，tap 需要花钱，并且需要您在现场。您还必须断开相关的以太网电缆以将 tap 放在线。因此，tap 仍然是非常方便的，但通常不再经常使用。

Michael Ossmann 的 Typical low-end tap（`10`或`10/100`）是以太网“Throwing Star”，可以在[`greatscottgadgets.com/throwingstar/`](https://greatscottgadgets.com/throwingstar/)找到。以下图表显示了这样一个典型的低端（`10/100`）的 tap 是如何操作的。请注意，有两种构建 tap 的方法 - 如下图所示，您可以构建一个具有两个端口的仅监听 tap，每个端口只“监听”一个方向的流量：

![图 11.1 - 两个 tap 端口，每个方向一个](img/B16336_11_001.jpg)

图 11.1 - 两个 tap 端口，每个方向一个

您还可以使用更传统的 tap，它将在单个端口上“听到”两个方向的流量：

![图 11.2 - 一个 tap 端口看到所有流量（只有引脚）](img/B16336_11_002.jpg)

图 11.2 - 一个 tap 端口看到所有流量（只有引脚）

这一切都是有效的，直到 1GB 以太网出现，此时像这样的 tap 的信号损失成为了一个问题。10Gbps 甚至更复杂，因为实际的第 1 层信号不再匹配标准以太网。因此，在 10Gbps 或以上的情况下，tap 是主动设备，更像是具有一个或多个 SPAN 端口的交换机，而不是被动设备。信号仍然完全复制到目标端口，但背后有更多的电路来确保发送到实际源、目的地和捕获主机的信号仍然可以被所有方可靠地读取。

我们仍然可以看到 tap 在一些特定的安全设置中使用，其中需要捕获 1G、10G 或更快的流量，但我们也需要电气隔离来防止任何传输。

在某种程度上，tap 仍然是一种方便的故障排除设备，可以放在您的笔记本电脑包中，以备需要时使用，但正如前面所述，它们在普通数据包捕获中不经常使用。

到目前为止，我们已经描述了各种合法的捕获数据包的方法，但是犯罪分子和他们的恶意软件是如何完成这项工作的呢？

## 恶意数据包捕获方法

到目前为止，我们已经考虑了如何合法地捕获数据包。然而，如果你考虑恶意意图，你如何防御可能使用其他方法的攻击者？为了做到这一点，让我们像攻击者一样思考，看看他们可能如何在没有对任何东西进行管理访问的情况下建立一个数据包捕获站。

第一种方法在*第七章*中已经涵盖过，*Linux 上的 DHCP 服务*。攻击者可以挂载一个恶意的 DHCP 服务器，并将他们的主机设置为目标计算机的默认网关或代理服务器（使用 WPAD 方法）。在任何一种方法中，受害者的数据包都会通过攻击者的主机并被捕获。如果协议是明文的（例如，使用 HTTP，TFTP，FTP 或 SIP，正如我们将在本章的*故障排除* *应用程序 - 捕获 VoIP 电话呼叫*部分中看到的那样），这些数据包可以被存储以供以后分析，甚至可以实时修改。我们可以通过保护 DHCP 服务来防御这种类型的攻击（正如我们在*第七章*中讨论的那样，*Linux 上的 DHCP 服务*）。

类似地，攻击者可以劫持路由协议来捕获特定子网或主机的流量。我们偶尔在互联网上看到这种情况，其中一个子网可能会被劫持，利用 BGP 路由协议的信任性质。在这些情况下，我们经常看到信用卡门户被重定向到意想不到的国家，人们的凭据在他们登录到那里准备好的假网站时被收集。在这种情况下，受害者如何保护自己？实际上，这比你想象的要简单和不可靠。如果受害者收到无效证书的警告，他们应该关闭该会话，不要继续。不幸的是，虽然这确实是一个简单的解决方案（警告屏幕几乎是整页的，而且有很多红色），但它也不是很可靠，因为许多人会简单地点击任何可以解除警告并继续访问网站的按钮。

攻击者可以使用的另一种常见方法是 ARP 缓存中毒来捕获数据包。要理解这一点，您可能需要复习一下 ARP 的工作原理（*第三章*，*使用 Linux 和 Linux 工具进行网络诊断*）。在高层次上，攻击者使用 ARP 数据包向每个受害者“说谎” - 这在下图中很容易看出：

![图 11.3 - ARP 缓存中毒](img/B16336_11_003.jpg)

图 11.3 - ARP 缓存中毒

在这个图中，两个受害者是`3333.3333.3333`，并告诉`3333.3333.3333`。交换机并没有看到任何这些；它只是路由各种数据包，因为它们在技术上都是有效的。现在，当`3333.3333.3333`。

如果**受害者 2**恰好是子网的默认网关，攻击者可以扩展到脱网捕获。

这似乎有些复杂，但多年来已经实现了自动化 - 这种类型攻击的第一个工具是*Dug Song*在 2000 年编写的*dSniff*。一个更现代的工具，使用图形界面，允许您图形化选择各种受害者的工具是 Ettercap。Ettercap 及其后继者 Bettercap 的优势在于，它们一旦发现“感兴趣的痕迹”，如凭据或密码哈希，它们将自动收集这些信息。

过程完成后，当 Ettercap 关闭时，它会优雅地重新填充所有受害者站点的 ARP 表，以正确的值。这意味着如果 Ettercap 以非优雅的方式关闭（例如，被踢出网络或被过多的流量“淹没”），受害站点将被“困”在错误的 ARP 条目中，通常持续到每个工作站的 ARP 计时器到期。如果攻击者站点在其列表中有子网的默认网关，这种情况将隔离整个子网，持续时间为网关的 ARP 计时器（最长可达 4 小时）。

我们如何保护自己免受这种攻击？日志记录是一个很好的起点。大多数现代交换机和路由器在看到两个不同的 MAC 地址声称拥有相同的 IP 地址时会记录`重复 IP 地址`错误。对这种类型的日志条目进行警报（参见*第十二章*，*使用 Linux 进行网络监控*）可以帮助启动积极的事件响应计划。

我们还能做些更“积极”的事情吗？大多数交换机都有一个名为**动态 ARP 检查**（**DAI**）的功能，可以查找这种类型的攻击。当发现攻击时，攻击者的以太网端口将被禁用。不过，要注意实施这个功能的位置 - 不要在具有下游交换机或无线接入点的交换机端口上配置 DAI；否则，当他们的端口被禁用时，攻击者将带走许多无辜的旁观者。通常会将具有下游交换机或 AP 的端口配置为“受信任”，期望下游设备将处理其自己连接的站点的检查。

DAI 看起来与 DHCP 检查和信任配置非常相似：

```
ip arp inspection vlan <number>
ip arp inspection log-buffer entries <some number, try 1024 to start>
ip arp inspection log-buffer logs 1024 interval 10
```

正如我们之前提到的，在具有下游交换机、AP 等的交换机端口上，你可以使用以下方法禁用 DAI：

```
int g1/0/x
  ip arp inspection trust
```

要将 DAI ARP 阈值从默认的每秒 15 个数据包降低到更低的值（例如 10），可以执行以下操作：

```
int g 1/0/x
  ip arp inspection limit 10
```

如果在攻击中启用了 ARP 检查，使用 Ettercap 等工具，该工具通常会向受害者发送一系列稳定的 ARP 数据包，以确保他们的 ARP 缓存保持被感染状态。在这种情况下，受影响的交换机将生成`DAI-4-"DHCP_SNOOPING_DENY" "Invalid ARPs"`错误消息，因为端口阈值已超过。端口还将创建`ERR-DISABLE`状态，完全使攻击者下线。

然而，在当今不断增长的网络速度世界中，你可能会发现你所捕获的数据超出了你工作站的容量 - 但不要放弃，有一些优化可以帮助你！

# 在捕获时的性能考虑

正如我们在前一节中提到的，一旦数据速率开始上升，即使是高端 Linux 主机或虚拟机，捕获数据包也会对主机产生影响。在设置数据包捕获时，还有一些网络决策需要考虑。

需要考虑的因素包括：

+   如果你使用 SPAN 或监视端口，根据交换机型号，你的目的地端口（你的嗅探器站插入的端口）可能不在网络上 - 它可能只能看到源端口的来往流量。这意味着通常情况下，你必须使用你最快的内置网卡进行数据包捕获，然后如果该主机需要同时在网络上活动（例如，如果你远程连接到它），则使用性能较低的 USB 网卡。

+   在所有情况下，确保你的网卡足够快，可以真正“看到”所有目标数据包。特别是在监视端口设置中，你可以配置一个 10 Gbps 的源和一个 1 Gbps 的目的地。这样做是可以的，直到你开始看到流量超过 1 Gbps。在那时，交换机将开始排队和/或丢弃数据包，这取决于交换机型号。换句话说，你的结果可能是不可预测的（或可预测的糟糕）。

+   一旦在网卡上，确保网卡的上行能够处理流量。例如，如果你在笔记本上使用了一个 10 Gbps 的雷电适配器，请确保它插入了一个雷电端口（而不是 USB-C 端口），并且你有足够的带宽来添加这个新的带宽。例如，如果你在同一台笔记本上有两个 4K 屏幕，很可能你的雷电上行没有剩余的 10 Gbps 来进行高速数据包捕获。

+   向上移动，确保你的硬盘既有足够的速度又有足够的容量。如果你要捕获 10 Gbps，你可能会想要选择 NVME 固态硬盘进行存储。你可能还希望它是内置的，而不是插在你的网络适配器上的同一个雷电或 USB-C 适配器上。另外，如果你要使用服务器进行捕获，可以查看 RAID 或 SAN 的吞吐量。特别是如果存储是 iSCSI，确保你的数据包捕获不会“饿死”其他 iSCSI 客户端的对 SAN 的带宽。

+   考虑您的环形缓冲区的大小 - 特别是 tcpdump 在这方面具有很好的灵活性。环形缓冲区是捕获的数据包存储在内存中的临时区域，在发送到磁盘或捕获应用程序的内存之前。在大多数 Linux 系统上，默认值为 2 MB，通常是足够的。但是，如果您发现捕获会话似乎丢失了数据包，增加这个值可能会解决这个问题。在 tcpdump 中，可以使用`-B`参数轻松调整这个值 - 这使得 tcpdump 成为在您知道或怀疑可能会推动数据包捕获极限时使用的理想工具。请注意，tcpdump 没有记录此的默认大小; 2 MB 默认值只是通常看到的。

+   考虑到您需要整个数据包。如果您只需要数据包头来排除故障（换句话说，您不需要实际有效载荷），您可以调整`snaplen` - 每个数据包中要捕获的字节数。例如，将此值从`1500`减少到`64`可以大大增加适合环形缓冲区的数据包数量。您将希望确保`snaplen`值足够大，以捕获所有数据包头信息。

+   最后，如果您作为授权的安全演练（如渗透测试）中的攻击者工作，还有一些事情需要牢记。如果您在参与中使用 ARP 缓存中毒，请注意此攻击存在一定的风险。确保您的工作站具有足够的接口带宽、CPU 和内存容量，以便成功进行此类攻击 - 如果**中间人**（**MiTM**）流量超过您的工作站的容量，您的机器可能会下线。对受害者（可能是整个 VLAN）的影响是，他们将留下无效的 ARP 缓存，并且基本上在其 ARP 计时器的持续时间内被困住（在某些平台上长达 4 小时）。

在我们讨论的理论之后，我们将使用哪些工具来捕获和分析数据包？

# 捕获工具

许多不同的工具可以用于从网络中捕获数据包，并直接分析数据包数据，或将它们存储在`pcap`文件中。甚至有更多的工具可以使用这些`pcap`文件，并允许您对其进行进一步的离线分析。

## tcpdump

我们已经多次提到了 tcpdump。这是一个命令行数据包捕获工具，这意味着它可以在没有图形用户界面的系统上使用，或者如果您正在使用非图形用户界面，如 SSH。因为它不涉及任何图形，并且不会为您查看（例如告诉您任何协议的具体信息）预处理数据包，所以它是您在数据包捕获中找到的性能最高、影响最小的工具之一。

tcpdump 使用**Berkely Packet Filter**（**BPF**）语法来决定要捕获哪些数据包。这可以用于按 IP 地址、MAC 地址、协议甚至 TCP 数据包中的特定标志进行过滤。

## Wireshark

Wireshark 是更常用的数据包捕获工具之一。它有一个图形用户界面，每个数据包都被分类、颜色编码和处理，以便尽可能显示更多信息。与 tcpdump 类似，Wireshark 使用 BPF 语法在捕获期间过滤数据包。它使用不同的过滤语法来过滤显示的数据包。

## TShark

TShark 与 Wireshark 应用程序捆绑在一起，本质上是 Wireshark 的命令行/文本版本。如果您在 SSH 会话中并且想要比 tcpdump 更灵活的东西，那么拥有 TShark 会非常方便。

## 其他 PCAP 工具

有数百甚至数千种工具可用于捕获数据包或分析数据包捕获。在攻击者方面，我们已经讨论过 Ettercap、Bettercap 和 dsniff 作为中间人攻击工具。像 NetworkMiner 这样的工具非常适合捕获数据包或处理现有的数据包捕获。这样的工具可以帮助您节省分析可能迅速变得非常庞大的数据包捕获文件所需的时间。NetworkMiner 将从`pcap`文件中提取有价值的工件，如凭据、凭据哈希、证书和在捕获会话期间传输的数据文件。

我们将讨论更多使用数据包捕获的高级工具，即**入侵检测系统**（**IDS**）、**入侵防御系统**（**IPS**）和被动流量监控，在接下来的章节中（*第十三章*，*Linux 上的入侵防御系统*，和*第十四章*，*Linux 上的蜜罐服务*）。

您可能会发现，您进行数据包捕获的原因是为了解决问题。让我们讨论如何捕获或查看只与您正在解决的问题相关的数据包。

# 过滤捕获的流量

使用数据包捕获工具时，您将注意到显示屏上出现的数据包数量之多。由于数据包捕获通常是为了故障排除目的而进行的，通常希望将数据包限制在需要解决的问题上。为此，您通常要么在捕获过程中“过滤”这些数据包，要么在捕获后过滤这些数据包的显示。让我们讨论这两种情况。

## Wireshark 捕获过滤器（捕获您的家庭网络流量）

在没有特定的交换配置的情况下，在您的家庭网络上进行数据包捕获将发现比您想象的更多。如今，许多家庭都有一小群连接到网络的基于 Linux 的设备-如果连接的话，您的电视、恒温器、门铃、跑步机和冰箱很可能都是 Linux 主机。这些通常被称为**物联网**（**IoT**）设备。几乎所有物联网主机都可能在有线和无线网络上广播和多播一系列不断的“发现”数据包，它们这样做是为了找到可能想要与它们交谈甚至控制它们的控制器和中心。

让我们快速看一下-我们将使用 Wireshark 工具进行此操作。

启动工具并选择连接到您的网络的网络适配器。

在点击**开始**之前，让我们添加一个捕获过滤器。我们将排除我们的地址，并且还将排除 ARP 数据包的捕获。请注意，您的 IP 地址将不同：

![图 11.4-向 Wireshark 添加捕获过滤器](img/B16336_11_004.jpg)

图 11.4-向 Wireshark 添加捕获过滤器

现在，点击**开始捕获**按钮，位于左上角的蓝色*鲨鱼鳍*图标，或选择**捕获/开始**。

在典型的家庭网络上，您应该在几秒内就能探索到数十个数据包-以下屏幕截图显示了我家网络上 10 秒后的数据包。您可能会看到广播和多播流量的混合-根据定义，这些流量是发送到所有站点的。虽然这可能被视为有限的捕获，但您可以用它来开始对您的网络上的内容进行清点：

![图 11.5-典型家庭网络捕获](img/B16336_11_005.jpg)

图 11.5-典型家庭网络捕获

即使不探索数据包的内容，也有一些关键事项需要注意前面的屏幕截图：

+   一些 IPv4 设备正在`169.254.0.0/16`范围内运行（自动私有 IP 地址范围）。这些地址无法路由到您的网络之外，但对于诸如电视遥控器或门铃与本地网络上的控制器通信等事情来说，这是完全可以的。

+   您可能会在本地交换机上看到生成树流量，如果等待足够长的时间，您可能会看到**链路层发现协议** (**LLDP**) 或**Cisco 发现协议** (**CDP**) 数据包（我们稍后在本节中将看到一个示例）。

+   您还很可能会看到 IPv6 流量 – 在这个捕获中，我们可以看到`DHCPv6`和`ICMPv6`数据包。

所有这些来自 10 秒的收听！有趣的是，深入研究您的家庭网络，甚至简单地查看您看到的 MAC 地址，并使用其 OUI 标识每个供应商。

让我们从数据包的角度深入研究一组特定设备 – **Voice over IP** (**VoIP**) 电话。

## tcpdump 捕获过滤器 – VoIP 电话和 DHCP

让我们通过查看典型 VoIP 电话的启动序列来探索 tcpdump 和 Wireshark 中的捕获过滤器。我们的网络非常简单；有四个站点和两个 VLAN：

![图 11.6 – 数据包捕获的实验室设置](img/B16336_11_006.jpg)

图 11.6 – 数据包捕获的实验室设置

请注意，我们设置了一个监视会话，其中端口`5`接收端口`1`的所有数据包。

VoIP 电话启动和通信涉及的站点总结如下：

![](img/B16336_11_Table_01.jpg)

请注意，当我们从表的左侧向右侧移动时，我们正在沿着 ISO 模型表示的“堆栈”向下移动 – 扩展在应用层表示，IP 地址是第 4 层，MAC 地址和 VLAN 是第 2 层，最后是接口本身。

首先，让我们使用 tcpdump 在 DHCP 服务器上捕获 DHCP 序列。使用这个主机很方便，因为 DHCP 服务器是 DHCP“对话”的一端，所以如果一切正常，它应该能看到双向的所有数据包。

此外，使用 tcpdump 意味着我们不依赖于任何 GUI – 如果您正在从 SSH 会话中操作，您仍然得到充分的支持。tcpdump 几乎被普遍支持。tcpdump 默认安装在几乎每个 Linux 发行版上，此外，您可以在大多数防火墙、路由器和交换机上调用 tcpdump（使用一种或另一种语法） – 这并不奇怪，考虑到这些平台中有多少是基于 Linux 或 BSD Unix 的。

让我们继续捕获。因为源站点尚未具有 IP 地址，所以我们需要根据电话的 MAC 地址和 DHCP 使用的两个 UDP 端口`67/udp`（bootps）和`68/udp`（bootpc）来指定流量。我们将捕获完整的数据包并将它们写入文件 – 请注意，实际捕获需要*sudo*权限。

首先，列出接口，以便我们正确获取源：

```
$ tcpdump -D
1.ens33 [Up, Running]
2.lo [Up, Running, Loopback]
3.any (Pseudo-device that captures on all interfaces) [Up, Running]
4.bluetooth-monitor (Bluetooth Linux Monitor) [none]
5.nflog (Linux netfilter log (NFLOG) interface) [none]
6.nfqueue (Linux netfilter queue (NFQUEUE) interface) [none]
7.bluetooth0 (Bluetooth adapter number 0) [none]
```

现在，让我们捕获一些数据包！

```
$ sudo tcpdump -s0 -l -i ens33 udp portrange 67-68
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on ens33, link-type EN10MB (Ethernet), capture size 262144 bytes
08:57:17.383672 IP 192.168.123.1.bootps > 192.168.122.113.bootps: BOOTP/DHCP, Request from 80:5e:c0:57:bc:91 (oui Unknown), length 548
08:57:18.384983 IP 192.168.122.113.bootps > 192.168.123.1.bootps: BOOTP/DHCP, Reply, length 332
```

我们的论点包括以下内容：

![](img/B16336_11_Table_02.jpg)

在输出中，我们可以看到交换中的前几个数据包 – 我们想要将其写入文件，因此让我们添加`-w`：

```
$ sudo tcpdump -s0 -l -i ens33 udp portrange 67-68 -w DHCPDora-Phone.pcap
```

现在，假设我们无法访问 DHCP 服务器。或者，如果 DHCP 工作不正常，我们可能希望从*网络视角*来交换，也许看看为什么服务器或客户端没有接收或发送 DHCP 数据包。在这种情况下，请记住客户端是电话，因此虽然它很可能是基于 Linux 的，但供应商可能没有让它轻松地通过 SSH 到该平台运行 tcpdump。

在这种情况下，典型的解决方案是设置一个 SPAN 端口，也称为`监视`或`镜像`端口（取决于交换机供应商）。在这种情况下，我们的数据包捕获主机位于端口`5`，因此将成为监视会话目的地。电话位于端口`1`，因此将成为我们的监视会话源。在 Cisco 交换机上，此设置语法如下：

```
monitor session 1 source interface Gi1/0/1
monitor session 1 destination interface Gi1/0/5
```

要查看正在进行的各种监视会话，`show`命令如下：

```
rvlabsw01#sho monitor
Session 1
---------
Type                   : Local Session
Source Ports           :
    Both               : Gi1/0/1
Destination Ports      : Gi1/0/5
    Encapsulation      : Native
          Ingress      : Disabled
```

让我们在 Wireshark 中设置这个。这对我们有很多优势 - 它不仅会对我们的过滤器进行语法检查（注意当它有效时会变成绿色），而且我们还可以以图形方式选择我们的网络适配器，并且在捕获过程中以图形方式显示数据包。同样，在选择捕获接口后，过滤器将如下所示：

![图 11.7 - 在 Wireshark 中定义捕获过滤器](img/B16336_11_007.jpg)

图 11.7 - 在 Wireshark 中定义捕获过滤器

请注意，捕获过滤器的语法与 Wireshark 和 tcpdump 相同；它使用所谓的 BPF 语法。在这个例子中，我们在过滤器中添加了`ether host`，以仅捕获发送到或从该 MAC 地址的 DHCP 数据包。按下**开始捕获**按钮（窗口左上角的蓝色*鲨鱼鳍*图标）；我们将看到电话启动时的 DHCP 序列：

![图 11.8 - 捕获的完整 DHCP“DORA”序列](img/B16336_11_008.jpg)

图 11.8 - 捕获的完整 DHCP“DORA”序列

如果您没有设置实验室，您可以从我们的 GitHub 页面收集这个`pcap`文件（[`github.com/PacktPublishing/Linux-for-Networking-Professionals/tree/main/C11`](https://github.com/PacktPublishing/Linux-for-Networking-Professionals/tree/main/C11)）；文件名为`DHCP DORA Example.pcapng`。

我们可以简单地展开数据包中的各种数据字段，以显示各种诊断值。展开第一个帧的 DHCP 部分：

![图 11.9 - 探索 DHCP“Discover”数据包](img/B16336_11_009.jpg)

图 11.9 - 探索 DHCP“Discover”数据包

向下滚动并展开一些 DHCP `Option`字段 - 特别是`Parameter Request List`： 

![图 11.10 - “Discover”数据包中的 DHCP 选项](img/B16336_11_010.jpg)

图 11.10 - “Discover”数据包中的 DHCP 选项

请注意电话的*请求列表*中有多少项目。这为攻击者提供了一些很好的选项。特别是，如果恶意的 DHCP 服务器可以响应并给电话一个不同的 TFTP 服务器和 Bootfile 名称，那么 TFTP 服务器上的文件将包含电话的整个配置，包括其分机和呼叫者 ID - 几乎所有内容。

此外，像这样的配置服务器几乎总是 TFTP 或 HTTP 服务器。对于攻击者来说，这意味着如果他们可以在客户端和服务器之间获得 MiTM 位置（使用 Ettercap、Bettercap 或类似工具），他们不仅可以收集配置数据以供以后在攻击中使用 - 他们还可以在电话下载数据时实时修改这些数据。

这强调了保护 DHCP 服务和 VoIP 配置服务的重要性！让我们来看一个更通用的协议，我们可以用于善良和邪恶 - LLDP 和 CDP。

## 更多的捕获过滤器 - LLDP 和 CDP

当一个站点启动时，我们还能看到什么？CDP 和 LLDP 是大多数环境中会看到的主要二层发现协议。这些协议将为我们提供各种有用的信息，用于故障排除或自动记录我们的网络和站点。它们还会为攻击者提供相同的信息，这意味着在您可以的地方，您将希望限制这些协议，通常是在连接到其他公司的任何通信链路上。

LLDP 几乎对所有 VoIP 实现都是必需的 - 这是电话知道大多数情况下应该在哪个 VLAN 上的方法（除非 VLAN 在 DHCP 中设置），这也是大多数电话协商它们的**PoE**（**Power over Ethernet**）功率级别的方法。没有 LLDP，所有电话将接收完整的 15 瓦电力，这意味着任何给定的交换机都需要提供比它所需的电力多 6-7 倍（大多数电话的功率范围在 2-4-6 瓦之间）。

让我们来看看 CDP（它以`01:00:0c:cc:cc:cc`的二层地址进行多播）和 LLDP（它以`01:80:C2:00:00:0E`进行多播，并且以`0x88cc`的以太网协议）。在这种情况下，我们的捕获过滤器将如下所示：

```
ether host 01:00:0c:cc:cc:cc or ether proto 0x88cc
```

或者，它将如下所示：

```
ether host 01:00:0c:cc:cc:cc or ether host 01:80:C2:00:00:0E
```

结果捕获显示 LLDP 和 CDP 都在起作用，但我们可以从电话发送的 LLDP 数据包中看到什么？

我们正在寻找的信息都在 Wireshark 显示的应用程序部分（此捕获的示例文件同时包括 LLDP 和 CDP - `Phone Example.pcapng`）。打开文件并突出显示 LLDP 数据包的**链路层发现协议**部分。请注意，以下数据包含许多十六进制字符，但有足够的 ASCII 转换内容，您已经可以看到一些有用的数据！

![图 11.11 - 捕获的 LLDP 帧](img/B16336_11_011.jpg)

图 11.11 - 捕获的 LLDP 帧

现在，展开 LLDP 选项卡，以便我们可以查看该部分的一些详细信息：

![图 11.12 - 更详细查看 LLDP 数据包](img/B16336_11_012.jpg)

图 11.12 - 更详细查看 LLDP 数据包

电话已设置为自动速度和双工，并协商到 100/全双工。

电话是 Yealink，型号 T21P-E2，序列号为`805ec086ac2c`。它运行的固件版本是 52.84.0.15。

它在未标记的（本地）VLAN 中（VLAN ID 为`0`），并且没有`0`，所以是 L2 优先级）。

请随时从捕获文件中的 CDP 数据包中收集相同的信息 - 请记住我们过滤了 CDP 和 LLDP。

这可能看起来像一个简单的例子，但是网络往往是多年来“有机”地组合在一起的，几乎没有文档记录。在某个时候，网络将变得足够复杂，或者知道如何连接所有内容的人将离开公司 - 在那时，记录网络将变得重要。如果启用了 CDP 或 LLDP，这将为您提供一个重要的工具，以获取所有 IP 地址，型号，固件和连接端口的良好起点。

从攻击者的角度来看，这些信息可以用来识别可能适合利用的主机。您可以使用相同的方法来收集这些数据，寻找具有已知漏洞的固件版本的基础设施。然后，这个设备可以成为攻击者将要转移到的下一个平台，使用该主机收集更多信息，以在下一次攻击中使用。这种方法可以轻松地用于将他们的攻击延伸到下一个连接的组织，也许是针对我们 ISP 在我们的互联网或 MPLS 上行链路上的路由器或交换机。

现在，让我们看一下从数据包捕获中提取特定工件，比如文件。

## 从数据包捕获中收集文件

如果您正在处理一组捕获的数据包，或者正在进行数据包捕获，如果看到文件传输，您有哪些选项？如果它使用任何 TCP 协议或众所周知的 UDP 协议（如 TFTP 或 RTP），那就太容易了！

在这里，我们可以看到一个数据包捕获（在我们的 GitHub 存储库中的`file-transfer-example.pcapng`）。Wireshark 正确识别这是一个 TFTP 文件传输：

![图 11.13 - 包含文件传输的数据包捕获](img/B16336_11_013.jpg)

图 11.13 - 包含文件传输的数据包捕获

知道这个网络上有 VoIP 电话，我们怀疑这些可能是配置文件 - 在启动/初始化过程中传输到电话的配置文件。让我们仔细看一下。

从第一行开始，我们可以看到对名为`SIPDefault.cnf`的文件的读取请求。这确实是一个高价值目标，因为它为 Cisco SIP 电话提供了默认设置，如果它们是集中配置的。突出显示标记为**数据包**的第一个数据包（数据包 3）。右键单击它，然后选择**跟随| UDP 流**。正如您所记得的，UDP 协议中没有会话数据，但是 Wireshark 内置了许多协议的解码，TFTP 只是其中之一：

![图 11.14 - 从 PCAP 中收集传输文件 - 步骤 1](img/B16336_11_014.jpg)

图 11.14 - 从 PCAP 中收集传输文件 - 步骤 1

太棒了！我们找到了我们要找的文件！选择**另存为...**以“收集”此文件。现在，让我们看看还有什么：

![图 11.15 - 从 PCAP 中收集转移文件 - 步骤 2](img/B16336_11_015.jpg)

图 11.15 - 从 PCAP 中收集转移文件 - 步骤 2

关闭此窗口并清除 Wireshark 中的显示过滤器行，以便我们可以再次看到整个捕获（清除文本，显示`udp stream eq 1`）。

在数据包 15 下面，我们看到对第二个名为`SIP0023049B48F1.cnf`的文件的请求。重复我们之前对此文件的处理过程 - 传输从数据包 17 开始，因此跟随从那里开始的 UDP 流。有了这个文件，我们现在拥有了 MAC 地址为`0023.049B.48F1`的电话的 SIP 配置。查看此文件，我们可以看到这是分机`1412`的配置文件，呼叫者 ID 为`Helpdesk Extension 2`。该文件包含该电话的整个配置，包括 SIP 密码。有了这些信息，攻击者可以轻松冒充帮助台分机，并通过社会工程学从打电话给帮助台的人那里收集机密信息 - 这确实是一条宝贵的信息！

现在，让我们深入研究我们的电话系统，并捕获实际 VoIP 电话呼叫的音频。

# 故障排除应用程序 - 捕获 VoIP 电话呼叫

为此，我将保持我们相同的捕获设置，并从客户端电话的端口`G1/0/1`拨打到`G1/0/2`的帮助台呼叫。捕获`G1/0/1`进出的所有数据包应该得到我们需要的内容 - 在此间隔内，进出`G1/0/2`的流量应与`G1/0/1`完全相同（只是方向相反）。

为了捕获我们的文本，我们将简单地进行全面捕获；在这种情况下不需要过滤器。我们开始了捕获，确保捕获了通话的开始和结束（因此我们在拨号之前开始捕获，并在挂断后结束）。

捕获完成后，我们可以在 Wireshark 中查看我们的 PCAP - 本实验室的示例文件是`HelpDesk Telephone Call.pcapng`，位于我们的 GitHub 存储库中[`github.com/PacktPublishing/Linux-for-Networking-Professionals/tree/main/C11`](https://github.com/PacktPublishing/Linux-for-Networking-Professionals/tree/main/C11)。

让我们看一下标记为`Ringing`的数据包 6。探索此数据包中的应用程序数据说明了在许多情况下理解这些数据是多么容易 - 特别是 SIP（在呼叫设置中使用时）遵循了您可能期望从电子邮件中使用的内容：

![图 11.16 - 探索 SIP“响铃/邀请”数据包](img/B16336_11_016.jpg)

图 11.16 - 探索 SIP“响铃/邀请”数据包

看一下其他几个 SIP 数据包，并探索每个应用程序数据中的一些字段。

接下来，我们将查看通话本身。请注意，在数据包 15 上，协议从 SIP（在`5060/udp`上）更改为`IP`部分，然后展开`46`已设置：

![图 11.17 - RTP（语音）数据包中的 DSCP 位](img/B16336_11_017.jpg)

图 11.17 - RTP（语音）数据包中的 DSCP 位

DSCP 是数据包中的一个 6 位字段，告诉中间网络设备如何对该数据包进行优先处理。在这种情况下，该值设置为`46`或**Expedited Forwarding**，简称**EF**。这告诉交换机，如果有几个数据包排队等待，这个（以及其他具有相同标记的数据包）应该优先处理。事实上，EF 标记是独特的，因为它告诉网络设备尽量不要排队处理这个数据包。

EF 标记是独特的，因为它不排队，而是首先转发以保持语音流的完整性，并防止出现“回声”等现象。它还是独特的，因为如果缓冲区填满到必须排队此数据包的程度，通常，中间的网络设备会丢弃其中的一些数据包，而不是延迟它们。这是因为人耳对于一些数据包被丢弃的 VoIP 呼叫更宽容，而不是这些相同的数据包被延迟。

如果您检查设置呼叫时使用的 SIP 数据包之一，这些数据包的 DSCP 值都为 26（有保证的转发）-换句话说，并非加速，但它被标记为一种重要的 UDP 数据包。这些标记请求，如果接口或路径拥塞，那么这个数据包应该被缓冲而不是丢弃。

接下来，让我们再次深入研究此 RTP 数据包中的应用数据：

![图 11.18–RTP 应用数据](img/B16336_11_018.jpg)

图 11.18–RTP 应用数据

请注意，这些数据要简单得多。在大多数情况下，有一些引导数据，用于标识此数据包是正在进行的电话呼叫的一部分。这是呼叫的数据包（和帧）4。编解码器被识别，以便远端设备知道如何解码数据。数据包的大部分内容在`Payload`字段中，这是语音数据。

您可以通过突出显示呼叫中的一个 RTP 数据包，右键单击它，然后选择**跟踪 UDP 数据流**来“跟踪”此流。这样可以提取呼叫中的所有 RTP/语音数据，以便进行分析。在其他协议中，您可能会选择**跟踪 TCP 数据流**或**跟踪 UDP 数据流**，然后能够恢复整个文件（例如从 FTP 或 TFTP 会话中）。

要恢复语音对话，Wireshark 已经添加了一个特殊的处理程序。打开此 PCAP 文件后，选择`R`（右）正在拨打电话，而`L`（左）正在接听电话。如果选择**播放**按钮，可以回放整个对话：

![图 11.19–回放捕获的 VoIP 对话](img/B16336_11_019.jpg)

图 11.19–回放捕获的 VoIP 对话

或者，选择任何 RTP 数据包，并选择**电话| RTP|流分析**。现在，选择**保存**并选择任何同步选项（例如-0），**非同步前向**和**反向音频**。这将文件保存为“AU”（Sun 音频）文件，可以由大多数媒体播放器播放，或者转换为所需的任何其他音频格式：

![图 11.20–将 VoIP 对话保存为可播放的媒体文件](img/B16336_11_020.jpg)

图 11.20–将 VoIP 对话保存为可播放的媒体文件

这对于运行 VoIP 解决方案的任何人都有一些明显的影响。默认情况下，大多数 VoIP 配置不会加密语音流量。这是为了消除加密/解密作为延迟或抖动的来源，这是语音质量下降的两个主要原因。这意味着在这些情况下，语音数据不能被视为“安全”。

另外，注意在我们的求助台呼叫中，求助台人员使用来电显示来验证来电者的身份。这在一切正常时可能有效，但我们已经描述了一种可能被破坏的方法。甚至更简单的方法是攻击者使用数据包捕获来识别 VoIP 基础设施的工作原理，然后在他们的计算机上建立一个“软电话”。在这种情况下，攻击者可以为来电者 ID 定义任何他们想要的内容；这是一个简单的文本字段。通常，来电者 ID 是由手柄提供而不是 PBX，所以在这种情况下，求助台被欺骗执行密码重置。

通常，电话启动序列使用基于 TFTP 或 HTTP 的配置服务。这将根据电话机的“名称”下载一个配置文件。在许多情况下，电话机的“名称”是单词`SIP`，后跟电话机的 MAC 地址 - 您还可以在电话机的 LLDP 广告中看到这些名称。这种约定会因不同的电话机供应商而异，但几乎总是一个简单的文本字符串，结合电话机的 MAC 地址。攻击者只需在配置/提供服务器和电话机之间进行中间人攻击，就可以破坏电话机的配置。加上配置文件的明文性质，使得攻击者可以在文件下载时修改关键字段。

## Wireshark 显示过滤器 - 在捕获中分离特定数据

继续使用我们的帮助台呼叫文件，我们可以轻松地将此文件过滤为仅显示特定流量。例如，在故障排除时，通常需要仅查看 SIP 流量 - SIP 网关经常属于云提供商，他们经常设置错误，导致 SIP 认证问题甚至 ACL 设置错误，因此登录甚至初始连接失败。您可以在数据包中看到所有这些问题，因此让我们过滤 SIP 协议：

![图 11.21 - 仅过滤 SIP 流量（呼叫设置/拆除）](img/B16336_11_021.jpg)

图 11.21 - 仅过滤 SIP 流量（呼叫设置/拆除）

这显示了整个呼叫设置，响铃，接听和最终挂断（`BYE`数据包在底部的第二行处于`7848`）。我们还可以通过指定`udp.port==5060`来进行过滤。与数据包捕获过滤器相比，显示过滤器使用不同的语法，这最终更加灵活。通常，您会使用一个过滤器进行捕获以获取所需的内容，然后在 Wireshark 中再次进行过滤，从而允许您使用多个过滤器串联在一起，深入挖掘以获取确切所需的内容。

请注意`14`和`5896`之间缺少的`5882`个数据包；那就是对话本身。让我们只过滤这个：

![图 11.22 - 过滤 RTP 流量（语音对话）](img/B16336_11_022.jpg)

图 11.22 - 过滤 RTP 流量（语音对话）

通常只通过协议名称过滤 RTP，因为 RTP 端口会因呼叫而异，在 SIP 设置期间进行协商。通过深入研究 RTP 数据包，我们可以看到端口为`12200`的`192.168.123.55`和端口为`12830`的`192.168.123.53`（您可以从 SIP 数据包中获取名称和扩展名）：

![图 11.23 - 用于此对话的 RTP 端口](img/B16336_11_023.jpg)

图 11.23 - 用于此对话的 RTP 端口

这两个端口是在哪里协商的？这些是在 SIP 交换的一部分 SDP 中设置的。第一个 SDP 数据包在数据包 4 中，x1234 处的呼叫者标识其 RTP 端口。展开此数据包，然后滚动到**会话初始协议（INVITE）|消息正文|会话描述协议|媒体描述**部分：

![图 11.24 - 呼叫者设置其 RTP 端口](img/B16336_11_024.jpg)

图 11.24 - 呼叫者设置其 RTP 端口

SDP 回复在数据包 13 中，当远端的电话被接听时。这是接收方（扩展`1411`在`192.168.123.53`）回复其端口的地方；即`12830`：

![图 11.25 - 通话接收方设置其 RTP 端口](img/B16336_11_025.jpg)

图 11.25 - 通话接收方设置其 RTP 端口

您可以通过查找`SIP 和 SDP`作为显示过滤器（数据包 4 和 15）来仅过滤 SDP 数据包：

![图 11.26 - 仅过滤 SIP/SDP 数据包](img/B16336_11_026.jpg)

图 11.26 - 仅过滤 SIP/SDP 数据包

请注意，如果您查看第一个数据包，它是一个失败的邀请。如果您感兴趣，可以深入了解失败的原因！

希望您可以将您在本节中学到的分析各种 VoIP 协议的方法应用到生产环境中的具体问题解决中。

# 总结

到目前为止，我们已经介绍了如何使用数据包捕获工具，无论是从合法的故障排除角度还是从攻击者的角度。特别是，我们已经介绍了如何定位和配置以便捕获数据包，使用什么工具，以及如何将“消防栓”式的信息过滤到您需要解决问题的内容。过滤特别有用，这就是为什么 Wireshark 中有一个两阶段的过滤方法（在捕获时和在显示数据包时）。

我们已经深入介绍了 VoIP 呼叫的操作，从启动电话到拨打电话，再到捕获和收听呼叫的音频回放。到目前为止，您应该对这些工具为网络、系统和应用程序管理员提供的功能深有体会。您应该已经做好了将这种体会转化为真正掌握的准备——只需记住，学习 Wireshark 或 tcpdump 等工具的最佳方法是使用它来解决问题，或者至少使用它来学习其他东西（比如 DHCP 的工作原理，或者电话呼叫在网络上的工作原理）。

在下一章中，我们将讨论网络监控，其中将包括使用 SNMP 的日志记录、使用 NetFlow 和其他基于流的协议来监控和故障排除网络。

# 问题

在我们结束时，这里有一些问题供您测试对本章材料的了解。您将在*附录*的*评估*部分找到答案：

1.  为什么您会使用端点主机，而不是 SPAN 端口上的中间设备进行数据包捕获？

1.  在什么情况下您会使用 tcpdump 而不是 Wireshark？

1.  RTP 使用的端口是多少，用于 VoIP 通话？

# 进一步阅读

要了解本章涵盖的内容，请参考以下参考资料：

+   Wireshark 用户指南：[`www.wireshark.org/docs/wsug_html_chunked/`](https://www.wireshark.org/docs/wsug_html_chunked/)

+   tcpdump 手册页面：[`www.tcpdump.org/manpages/tcpdump.1.html`](https://www.tcpdump.org/manpages/tcpdump.1.html)

+   SANS（2019 年 1 月）TCPIP 和 tcpdump 备忘单：[`www.sans.org/security-resources/tcpip.pdf`](https://www.sans.org/security-resources/tcpip.pdf)

+   Wireshark 显示过滤器备忘单：[`packetlife.net/media/library/13/Wireshark_Display_Filters.pdf`](https://packetlife.net/media/library/13/Wireshark_Display_Filters.pdf)

+   *Green, T.（2012 年 11 月 16 日）。使用基本 Linux 工具分析网络流量*：[`www.sans.org/reading-room/whitepapers/protocols/paper/34037`](https://www.sans.org/reading-room/whitepapers/protocols/paper/34037)

+   *Cheok, R.（2014 年 7 月 3 日）。Wireshark：彩色数据包指南*：[`www.sans.org/reading-room/whitepapers/detection/paper/35272`](https://www.sans.org/reading-room/whitepapers/detection/paper/35272)

+   *VandenBrink R（2009 年 11 月 18 日），使用 Cisco 路由器作为 tcpdump 或 Wireshark 的远程收集器*：https://isc.sans.edu/forums/diary/Using+a+Cisco+Router+as+a+Remote+Collector+for+tcpdump +or+Wireshark/7609/
