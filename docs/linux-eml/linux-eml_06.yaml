- en: Chapter 6. Getting Started with Procmail
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第6章。开始使用Procmail
- en: Procmail is a versatile e-mail filter that is typically used to process messages
    before they are delivered to a user's inbox.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: Procmail是一种多功能的电子邮件过滤器，通常用于在将消息传递到用户收件箱之前处理消息。
- en: 'This chapter includes the following topics:'
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 本章包括以下主题：
- en: A brief introduction to Procmail
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Procmail的简要介绍
- en: The typical filtering tasks that can be performed by Procmail
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Procmail可以执行的典型过滤任务
- en: How a mail filtering system can be installed and set up on the server to handle
    the repetitive sorting and storing tasks that you would rather not spend your
    time on every day
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如何在服务器上安装和设置邮件过滤系统，以处理您每天不愿意花时间处理的重复分类和存储任务
- en: The basic structure of the rules and actions within a Procmail recipe
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Procmail食谱中规则和操作的基本结构
- en: How to create and test the rules within our recipe
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如何在我们的食谱中创建和测试规则
- en: Finally, some example recipes to perform filtering
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 最后，一些执行过滤的示例食谱
- en: By the end of the chapter, you will understand the basics of the filtering process
    how to set up the system to perform filtering and how to perform a number of very
    simple but extremely useful filtering operations on your own mail. All of which
    will help you keep on top of all the mail you have already or will soon be receiving.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 通过本章结束时，您将了解过滤过程的基础知识，如何设置系统执行过滤以及如何对自己的邮件执行许多非常简单但极其有用的过滤操作。所有这些都将帮助您掌握已经或即将收到的所有邮件。
- en: Introduction to Procmail
  id: totrans-10
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 介绍Procmail
- en: Procmail is a mail filter that is executed after messages have arrived on the
    mail server but before final delivery to the intended recipient. The behavior
    of Procmail is controlled by a number of user written recipes (or scripts). Each
    recipe can contain a number of pattern matching rules to select messages based
    on at least, the recipient, the subject, and the message content. If the match
    criteria in a rule selects the message as a candidate, the recipe may perform
    a number of actions to move the message to a folder, reply to the sender, or even
    discard the message before delivery. As with the rules, actions are user written
    in the recipe and can perform almost any operation on a message.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: Procmail是一个邮件过滤器，它在邮件到达邮件服务器后但在最终交付给收件人之前执行。Procmail的行为由许多用户编写的食谱（或脚本）控制。每个食谱可以包含许多模式匹配规则，以至少基于收件人、主题和消息内容选择消息。如果规则中的匹配条件选择消息作为候选项，食谱可以执行许多操作，将消息移动到文件夹，回复发件人，甚至在交付之前丢弃消息。与规则一样，操作是用户在食谱中编写的，可以对消息执行几乎任何操作。
- en: The Procmail home page is located at [http://www.procmail.org.](http://www.procmail.org.)
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: Procmail的主页位于[http://www.procmail.org.](http://www.procmail.org.)
- en: Who wrote it and when
  id: totrans-13
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 谁写的以及何时写的
- en: Version 1.0 was released in the late 1990's and has evolved to represent one
    of the best and most commonly used mail filtering solutions for UNIX-based mail
    systems. Procmail was originally designed and developed by Stephen R. van den
    Berg (`<[srb@cuci.nl](mailto:srb@cuci.nl)>`). In the fall of 1998, recognizing
    that he didn't have the time to maintain Procmail on his own, Stephen created
    a mailing list for discussion of future development and deputized Philip Guenther
    (`<[guenther@sendmail.com](mailto:guenther@sendmail.com)>`) as a maintainer.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 1.0版本于20世纪90年代末发布，并发展成为基于UNIX的邮件系统中最好和最常用的邮件过滤解决方案之一。Procmail最初由Stephen R. van
    den Berg（`<srb@cuci.nl>`）设计和开发。1998年秋，他意识到自己没有时间独自维护Procmail，于是创建了一个用于讨论未来发展的邮件列表，并委任Philip
    Guenther（`<guenther@sendmail.com>`）为维护者。
- en: Procmail has been stable since Version 3.22, which was released in September
    2001, so most recent installations will have this latest version installed, and
    this is the version we will be using throughout this book.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 自2001年9月发布的3.22版本以来，Procmail一直很稳定，因此大多数最近的安装将安装此最新版本，这也是我们在整本书中将使用的版本。
- en: How can a filtering system help me?
  id: totrans-16
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 过滤系统如何帮助我？
- en: By now you should have an e-mail system up and running, and sending and receiving
    e-mails. You have probably registered with a number of useful mailing lists with
    messages arriving at varying intervals. You should also be receiving messages
    informing you of the status of the system. All this extra, low priority information
    can easily distract and get in the way of the important e-mails that you need
    to read ahead of others.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 到目前为止，您应该已经建立并运行了一个电子邮件系统，并发送和接收电子邮件。您可能已经注册了一些有用的邮件列表，消息以不同的间隔到达。您还应该收到通知您系统状态的消息。所有这些额外的、低优先级的信息很容易分散注意力，妨碍您阅读其他重要的电子邮件。
- en: How you organize your mail is up to your own personal taste; if you are very
    organized you may have already set up some folders in your e-mail client and move
    messages into appropriate locations when you have read them. Nevertheless, one
    thing you have probably realized is that it would be very useful to be able to
    have some messages stored automatically by the system in a different location
    than your important e-mail.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 如何组织您的邮件取决于您个人的口味；如果您非常有条理，您可能已经在电子邮件客户端中设置了一些文件夹，并在阅读后将消息移动到适当的位置。尽管如此，您可能已经意识到，能够让系统自动将一些消息存储在与您重要电子邮件不同的位置将非常有用。
- en: What you will need to think about while setting up an automatic process, is
    how you identify what the mail item is about. The most important indicators are
    to whom it was sent, the title or subject line, and also the sender details. If
    you take a few minutes now to make a few notes on how you already handle your
    mail, the types of messages that arrive and what you do with them, you will have
    a clearer idea of what automatic processes you may want to set up.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 在设置自动流程时，您需要考虑的是如何识别邮件项目的内容。最重要的指标是发送给谁，标题或主题行，以及发件人详细信息。如果您现在花几分钟时间记录一下您已经处理邮件的方式，到达的消息类型以及您对它们的处理方式，您将更清楚地了解您可能想要设置的自动流程。
- en: In general terms there are several different classes of messages that you might
    receive.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 一般来说，您可能会收到几种不同类别的消息。
- en: '**Membership of mailing lists:** Mail arriving from a mail group, or mailing
    list, is normally easy to identify from the sender information or possibly from
    the subject line. A number of groups send messages every few minutes while others
    may only send a couple of messages a month. Typically different mail group items
    are identified by different pieces of information. For example, some groups send
    messages with the "From" address being that of the real sender while others add
    a fake or system-generated "From" address. Some groups may, for example, automatically
    add a prefix to the "Subject" field.'
  id: totrans-21
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**邮件列表成员资格：**来自邮件组或邮件列表的邮件通常很容易通过发件人信息或主题行进行识别。一些组每隔几分钟发送一封消息，而其他组可能每个月只发送几封消息。通常，不同的邮件组项目由不同的信息片段进行识别。例如，一些组发送的消息的“发件人”地址是真实发件人的地址，而其他组会添加一个虚假或系统生成的“发件人”地址。例如，一些组可能会自动向“主题”字段添加前缀。'
- en: '**Automated system messages:** Your server generates a number of messages each
    day. Although normally they are sent only to the system administrator or root
    user, one of the first things to do is to make sure that you receive a copy of
    the mail so that you are kept informed of the system status and events. This you
    would do by editing the default destinations in the `/etc/mail/aliases` or `/etc/aliases`
    file depending on how your system is set up. These system-generated messages are
    nearly always identifiable as originating from a small number of specific system
    user IDs. These are typically `root` and `cron.`'
  id: totrans-22
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**自动系统消息：**您的服务器每天会生成大量消息。尽管通常只发送给系统管理员或root用户，但首先要做的一件事是确保您收到邮件的副本，以便及时了解系统状态和事件。您可以通过编辑`/etc/mail/aliases`或`/etc/aliases`文件（取决于系统设置）来做到这一点。这些系统生成的消息几乎总是可以识别出来自少数特定系统用户ID。这些通常是`root`和`cron`。'
- en: '**Unsolicited bulk e-mail:** Messages identified as spam would normally be
    considered unimportant. As such you may choose to move these items to a separate
    folder for later review or even discard them completely. Discarding spam automatically
    is not advised, as any mail misidentified would be lost forever.'
  id: totrans-23
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**未经请求的大量电子邮件：**被识别为垃圾邮件的消息通常被认为不重要。因此，您可以选择将这些项目移动到一个单独的文件夹以供稍后查看，甚至完全丢弃它们。不建议自动丢弃垃圾邮件，因为任何误识别的邮件将永远丢失。'
- en: '**Individual messages:** Mail arriving from clients, colleagues, or friends
    would generally be considered as important. As such it would normally be delivered
    to your Inbox giving you the opportunity to provide a more timely response. Individual
    messages are more difficult to identify with a filter, especially those from new
    clients or colleagues, so messages that do not fit into one of the categories
    just discussed should be delivered normally.'
  id: totrans-24
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**个人消息：**来自客户、同事或朋友的邮件通常被认为是重要的。因此，通常会将其投递到收件箱，让您有机会提供更及时的回复。个人消息更难以通过过滤器识别，尤其是来自新客户或同事的消息，因此不属于前述任何一类的消息应该正常投递。'
- en: After completing the work in this chapter, you should have the tools and knowledge
    to start to examining mail in more detail and set up some basic filtering operations.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 完成本章的工作后，您应该具备工具和知识，可以开始更详细地检查邮件并设置一些基本的过滤操作。
- en: Potential uses of mail filtering
  id: totrans-26
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 邮件过滤的潜在用途
- en: The basic mail system you have already set up has some inbuilt abilities of
    its own to process incoming mail according to a user setup. The default operation
    would be for messages to go to your Inbox; other options are to automatically
    forward all your mail to another user. Consider you have multiple mail accounts
    on different systems and want all your mail to end up in one particular mail account.
    You can then have that mail sent to a particular file, or have it passed to a
    program or application to allow it to do its own work.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 您已经设置的基本邮件系统具有其自己的内置能力，可以根据用户设置处理传入的邮件。默认操作是将消息发送到收件箱；其他选项是自动将所有邮件转发给另一个用户。假设您在不同系统上有多个邮件帐户，并且希望所有邮件最终都发送到一个特定的邮件帐户。然后，您可以将该邮件发送到特定文件，或者将其传递给程序或应用程序，以便让其自行处理。
- en: The downside of this setup is that all your mail has to follow one particular
    route, so over time a number of options have been created to intelligently filter
    mail. One of the most powerful and popular of these is Procmail.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 这种设置的缺点是所有邮件必须遵循一个特定的路线，因此随着时间的推移，已经创建了许多智能过滤邮件的选项。其中最强大和最受欢迎的之一是Procmail。
- en: Filtering and sorting mail
  id: totrans-29
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 过滤和分类邮件
- en: Procmail is designed to handle a wide variety of processing and filtering tasks
    on mail being received by users within the system. Filtering only applies to users
    who have an account on the system—not to virtual users—and may be applied system
    wide to all users or individual users may add their own filters.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: Procmail旨在处理系统内用户接收的邮件的各种处理和过滤任务。过滤仅适用于在系统上拥有帐户的用户，而不适用于虚拟用户，并且可以应用于所有用户或个别用户可以添加自己的过滤器。
- en: For system administrators, Procmail offers a range of facilities for applying
    rules and operations to all the mail being received by users of the system. Such
    actions may include making a copy of all mail for historical purposes or in businesses
    where the content of e-mail messages may be used in some form of legal or business
    situation.
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 对于系统管理员，Procmail提供了一系列设施，用于对系统用户接收的所有邮件应用规则和操作。这些操作可能包括为了历史目的而复制所有邮件，或者在邮件内容可能在某种法律或商业情况下使用的企业中使用。
- en: Elsewhere in this book, we will be discussing ways of identifying e-mail-borne
    viruses and spam. Procmail can take the information provided by these processes
    and perform actions based on the information added by these processes, such as
    storing all mail items containing a virus in a secure mail folder that is checked
    by system administrators.
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 在本书的其他地方，我们将讨论识别电子邮件病毒和垃圾邮件的方法。Procmail可以利用这些过程提供的信息，并根据这些过程添加的信息执行操作，例如将包含病毒的所有邮件存储在系统管理员检查的安全邮件文件夹中。
- en: 'For a system user, the most common operation to perform on incoming mail is
    to sort it into some organized layout so that you can easily find the items you
    are looking for, based on the topic area that you are interested in. A typical
    organizational layout could be a hierarchical one similar to the following:'
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 对于系统用户来说，对收件箱中的邮件进行的最常见操作是将其分类整理，以便根据您感兴趣的主题区域轻松找到所需的项目。典型的组织布局可能是一个分层的布局，类似于以下内容：
- en: '[PRE0]'
  id: totrans-34
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: If you plan on keeping mail in store for long periods of time for historical
    reference, it may be worth adding an extra layer or two to separate the mail into
    years and months. This makes it easier in the future to archive or purge older
    e-mail, and it also means that searching and sorting will be quicker.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您计划长时间保留邮件以供历史参考，可能值得增加一两层来将邮件分隔成年份和月份。这样将来存档或清除旧邮件会更容易，同时搜索和排序也会更快。
- en: Forwarding mail
  id: totrans-36
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 转发邮件
- en: Sometimes you may get lots of e-mail that is easily identified as needing to
    be sent to another user at another e-mail address. In this case, rather than storing
    the file on the system, you may set up a rule that will forward the e-mail to
    one or more other e-mail addresses. Of course you need to be careful to make sure
    that the forwarding does not end up coming back to you, creating a never-ending
    loop.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 有时您可能会收到很多很容易识别需要发送到另一个用户的另一个电子邮件地址的电子邮件。在这种情况下，您可以设置一个规则，将电子邮件转发到一个或多个其他电子邮件地址，而不是将文件存储在系统上。当然，您需要小心确保转发不会最终回到您，从而创建一个永无止境的循环。
- en: Forwarding of mail in this way has a big advantage over the manual forwarding
    of mail from within your mail client software, quite apart from not needing any
    manual intervention. Mail forwarded by Procmail is transparent, it appears to
    the recipient as if the mail has arrived directly from the original sender. Whereas,
    if it was forwarded using a mail client, it would appear as though it had been
    sent by the person or account doing the forwarding.
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: 以这种方式转发邮件比在邮件客户端软件内手动转发邮件具有很大的优势，除了不需要任何手动干预之外。通过Procmail转发的邮件是透明的，对收件人来说，它看起来就像邮件直接从原始发件人那里到达一样。而如果使用邮件客户端转发，它看起来就好像是由进行转发的人或帐户发送的。
- en: Where all mail items for a single address need forwarding to a single other
    address, a more efficient way to achieve this is using the aliasing mechanism
    of the Postfix mailing system. Procmail should only be used where an intelligent
    filtering of the mail is required dependent upon factors that can only be determined
    at the time of receipt of the message.
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 如果需要将单个地址的所有邮件转发到单个其他地址，更有效的方法是使用Postfix邮件系统的别名机制。只有在需要根据在接收消息时才能确定的因素进行智能过滤邮件时，才应该使用Procmail。
- en: Processing the mail in an application
  id: totrans-40
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 在应用程序中处理邮件
- en: Some mail items could be suitable for passing through to an application where
    the application program does some work on the e-mail. Perhaps it could read the
    contents and then store the information in a bug-tracking database or update the
    company history log for a client activity. These are more advanced topics that
    are briefly covered in the following chapter.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 有些邮件可能适合传递到一个应用程序，应用程序可以对电子邮件进行一些处理。也许它可以阅读内容，然后将信息存储在错误跟踪数据库中，或者更新客户活动的公司历史记录。这些是在下一章中简要介绍的更高级的主题。
- en: Acknowledgements and out of office/vacation replies
  id: totrans-42
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 确认和离职/度假回复
- en: If you wanted to send an automatic reply to certain messages, a filter or rule
    could be set up to send such a message. When you are away from the office for
    a prolonged period of time on holiday, vacation, or perhaps illness, it is possible
    to set up a reply service to inform the sender that it will be some time before
    you are able to respond to their mail and perhaps give them alternative contact
    details or ask them to contact another person.
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您想要对某些消息发送自动回复，可以设置一个过滤器或规则来发送这样的消息。当您长时间离开办公室度假、休假或者生病时，可以设置一个自动回复服务，通知发件人在您能够回复他们的邮件之前需要一些时间，并可能提供其他联系方式或要求他们联系其他人。
- en: It is important that you organize such a feature carefully. You shouldn't send
    such a reply to a mailing group or keep sending repeated replies to people who
    already know that you are away but need to send you information for after your
    return. This requires that a log of the addresses that the message is sent to
    is kept to avoid repeat messages being sent. We will investigate the setting up
    of such a service in the next chapter.
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 重要的是要仔细组织这样的功能。您不应该向邮件组发送这样的回复，也不应该向已经知道您离开但需要在您回来后发送信息的人重复发送回复。这需要保留发送消息的地址日志，以避免重复发送消息。我们将在下一章中探讨设置这样一个服务。
- en: File locking and integrity
  id: totrans-45
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 文件锁定和完整性
- en: An important concept to keep in mind during all your work with Procmail is that
    it is always possible for multiple mail messages to be arriving at the same time,
    all vying to be processed. Therefore, it is quite possible that two or more messages
    are going to be stored in the same location at the same time—a recipe for disaster
    exists. Assume the simple example of two items arriving at the same time. The
    first mail opens the storage location and starts to write the contents of the
    message, and then the second process does the same. A variety of possible results
    could occur from this, ranging from one message being lost totally through, to
    both messages being stored intertwined and totally illegible.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 在您使用Procmail的所有工作中要牢记的一个重要概念是，总是可能有多封邮件同时到达，争相处理。因此，很可能会有两封或更多邮件同时存储在同一位置，这是灾难的开始。假设有两封邮件同时到达的简单例子。第一封邮件打开存储位置并开始写入邮件内容，然后第二个进程也这样做。从中可能产生各种可能的结果，从完全丢失一封邮件，到两封邮件交织存储且完全无法阅读。
- en: To make sure that this doesn't happen, a strict locking protocol needs to be
    observed to ensure that only one process can write at a time and all other applications
    need to wait patiently for their turn. Procmail itself has the ability to enforce
    a locking protocol appropriate to the type of process being applied and will,
    by default, lock the physical file in which a mail is being stored.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 为了确保这种情况不会发生，需要遵守严格的锁定协议，以确保只有一个进程可以同时写入，所有其他应用程序都需要耐心等待轮到它们。Procmail本身具有强制执行适用于所应用的进程类型的锁定协议的能力，并且默认情况下会锁定存储邮件的物理文件。
- en: In some cases, the mail is being processed by an application and Procmail can
    be instructed by the use of flags within the rule to use an appropriate locking
    mechanism. This is covered more completely in Chapter 7.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 在一些情况下，邮件正在被应用程序处理，可以通过规则中的标志指示Procmail使用适当的锁定机制。这将在第7章中更全面地介绍。
- en: What Procmail is not suitable for
  id: totrans-49
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Procmail不适用于哪些情况
- en: There are some very specific mail filtering and processing requirements for
    which Procmail may be considered to be suitable. In most cases, it is flexible
    and capable enough to perform the task at least at a rudimentary level. Such tasks
    could be filtering of spam-related e-mails or filtering out viruses or running
    a mailing list operation. For each of these, there are a number of solutions available
    that go beyond the capabilities of using just Procmail filters. We will be looking
    at SpamAssassin for performing spam filtering and a virus filtering solution later
    in Chapter 8.
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: Procmail可能被认为适用于一些非常特定的邮件过滤和处理需求。在大多数情况下，它足够灵活和能干，至少可以在基本水平上执行任务。这些任务可能包括过滤与垃圾邮件相关的电子邮件，过滤病毒或运行邮件列表操作。对于每一个任务，都有一些超出仅使用Procmail过滤器能力的解决方案可用。我们将在第8章后面讨论使用SpamAssassin进行垃圾邮件过滤以及病毒过滤解决方案。
- en: We have already mentioned that Procmail is suitable only for users having accounts
    on the system that Procmail runs on. Nevertheless, it is worth reinforcing that
    Procmail is unable to process mail that is being delivered to a virtual user and
    such mails will end up on another system. If it is necessary to process mail for
    such a user, it is possible to create a real user account on the system and then
    use Procmail to perform the final forwarding as part of its filtering processes.
    This is not an ideal use as the Postfix system is much more efficient if it is
    allowed to do this work rather than using Procmail.
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 我们已经提到Procmail只适用于在Procmail运行的系统上拥有账户的用户。尽管如此，值得强调的是，Procmail无法处理发送到虚拟用户的邮件，这些邮件最终会被发送到另一个系统上。如果需要处理这样的用户的邮件，可以在系统上创建一个真实的用户账户，然后使用Procmail作为其过滤过程的一部分来执行最终的转发。这并不是一个理想的用法，因为如果允许Postfix系统执行这项工作，它会比使用Procmail更有效率。
- en: Downloading and installing Procmail
  id: totrans-52
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 下载和安装Procmail
- en: As the software is now reasonably mature, Procmail is usually available for
    installation on most Linux distributions and can be installed by using the package
    manager. This is the recommended way to install Procmail. If it is not available
    via a package manager in your Linux distribution, it can also be installed from
    the source code.
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 由于软件现在已经相当成熟，Procmail通常可以在大多数Linux发行版上安装，并且可以通过软件包管理器安装。这是安装Procmail的推荐方法。如果您的Linux发行版的软件包管理器中没有Procmail，也可以从源代码安装。
- en: Installing via a package manager
  id: totrans-54
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 通过软件包管理器安装
- en: 'For Fedora users, the simple way to install Procmail if it isn''t already installed
    is to use the `yum` command as follows:'
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 对于Fedora用户，如果尚未安装Procmail，可以使用以下`yum`命令简单安装：
- en: '[PRE1]'
  id: totrans-56
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'For Debian-based users you could use the following command:'
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 对于基于Debian的用户，可以使用以下命令：
- en: '[PRE2]'
  id: totrans-58
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: This will ensure that the binary of Procmail is correctly installed on your
    system and you can then decide how you want it to integrate into your Postfix
    system.
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 这将确保Procmail的二进制文件正确安装在您的系统上，然后您可以决定如何将其集成到您的Postfix系统中。
- en: Installing from source
  id: totrans-60
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 从源代码安装
- en: Procmail may be obtained from a number of sources but the official distribution
    is maintained and available from [www.procmail.org](http://www.procmail.org).
    There you will find links to a number of mirror services from which you can download
    the source files. The version used in this book can be downloaded from [http://www.procmail.org/procmail-3.22.tar.gz](http://www.procmail.org/procmail-3.22.tar.gz).
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: Procmail可以从多个来源获取，但官方发布的版本由[www.procmail.org](http://www.procmail.org)维护和提供。在那里，您会找到一些镜像服务的链接，可以从中下载源文件。本书中使用的版本可以从[http://www.procmail.org/procmail-3.22.tar.gz](http://www.procmail.org/procmail-3.22.tar.gz)下载。
- en: 'It can be downloaded by using the `wget` command as follows:'
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 可以使用`wget`命令下载如下：
- en: '[PRE3]'
  id: totrans-63
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: Once you have downloaded and unpacked the archive, `cd` to the directory, example
    `procmail-3.22`. Before starting to build and install the software, it is well
    worthwhile reading through the `INSTALL` and `README` documents.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 下载并解压缩存档后，`cd`到目录，例如`procmail-3.22`。在开始构建和安装软件之前，值得阅读`INSTALL`和`README`文档。
- en: 'For most Linux systems, the simplest installation method can be reduced by
    following the steps listed here:'
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 对于大多数Linux系统，最简单的安装方法可以通过按照这里列出的步骤来简化：
- en: 'Run the `configure` utility to create the right build environment by running
    the `configure` command:'
  id: totrans-66
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 运行`configure`命令来创建正确的构建环境：
- en: '[PRE4]'
  id: totrans-67
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'After the configuration script is completed, you can run the `make` command
    to build the software executables:'
  id: totrans-68
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 配置脚本完成后，您可以运行`make`命令来构建软件可执行文件：
- en: '[PRE5]'
  id: totrans-69
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'The final step, as `root`, is to copy the executables into the correct position
    for operation on the system:'
  id: totrans-70
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 最后一步，作为`root`，是将可执行文件复制到系统上的正确位置以进行操作：
- en: '[PRE6]'
  id: totrans-71
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: In the last step, the software is installed into the `/usr/local` directory.
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 在最后一步，软件被安装到`/usr/local`目录中。
- en: At all stages, you should check the processes output for any significant errors
    or warnings.
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 在所有阶段，您应该检查进程输出是否有任何重要的错误或警告。
- en: Installation options/considerations
  id: totrans-74
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 安装选项/注意事项
- en: For most people following the instructions, throughout this book you will be
    the system administrator of the machine or machines you are managing and will
    probably be applying the installation to process all mail for all users on the
    system. If you are not an administrator, or you wish only a limited number of
    people on the system to take advantage of the features of Procmail, you can install
    Procmail for individual users.
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 对于本书中的大多数人，您将是您正在管理的机器或机器的系统管理员，并且可能会应用安装以处理系统上所有用户的所有邮件。如果您不是管理员，或者您希望系统上只有有限数量的人利用Procmail的功能，您可以为单个用户安装Procmail。
- en: Individual installation
  id: totrans-76
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 个别安装
- en: If you are installing Procmail for your own use or for only a few people on
    your server, the most common method is to call the Procmail program directly from
    the `.forward` file in your home directory on the server (this file needs to be
    world-readable).
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您为自己使用或仅为服务器上的少数人安装Procmail，则最常见的方法是在服务器上的家目录中直接从`.forward`文件中调用Procmail程序（此文件需要是可全局读取的）。
- en: 'The entry in `.forward` when using Postfix as an MTA should be like this:'
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: 在使用Postfix作为MTA时，`.forward`中的条目应该是这样的：
- en: '[PRE7]'
  id: totrans-79
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: The quotes are required and the username should be substituted for your username.
    The syntax for other MTAs may be different so consult the MTA documentation.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 引号是必需的，用户名应该替换为您的用户名。其他MTA的语法可能不同，因此请查阅MTA文档。
- en: You will also need to install a `.procmailrc` file in the home directory—this
    is the file that holds the rules that Procmail will use to filter and deliver
    your e-mail.
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 您还需要在主目录中安装一个`.procmailrc`文件—这个文件保存了Procmail将用来过滤和传递电子邮件的规则。
- en: System-wide installation
  id: totrans-82
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 系统范围的安装
- en: If you are a system administrator, you can decide to install Procmail globally.
    This has the advantage that users do not need to have a `.forward` file anymore.
    Simply having a `.procmailrc` file in each user's `HOME` directory will suffice.
    The operation is transparent in this case—if no `.procmailrc` file is present
    in the `HOME` directory, the mail will be delivered as usual.
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您是系统管理员，可以决定全局安装Procmail。这样做的好处是用户不再需要拥有`.forward`文件。只需在每个用户的`HOME`目录中有一个`.procmailrc`文件就足够了。在这种情况下，操作是透明的—如果`HOME`目录中没有`.procmailrc`文件，邮件将像往常一样传递。
- en: A global `.procmailrc` file can be created that takes effect before the user's
    own file. In this case, you need to be careful to ensure that the configuration
    has the following instruction included so that messages are stored with the end
    user's privileges rather than the root user's privileges.
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 可以创建一个全局的`.procmailrc`文件，该文件在用户自己的文件之前生效。在这种情况下，您需要小心确保配置包含以下指令，以便消息以最终用户的权限而不是root用户的权限存储。
- en: '[PRE8]'
  id: totrans-85
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: This also helps protect against weaknesses in your system security. This file
    is normally stored in the `/etc` directory as `/etc/procmailrc` where it is intended
    to provide a default set of personal rules for all users as they are added to
    the system. It will be worth configuring a `.procmailrc` file in the skeleton
    account that is used by the `add user` capabilities of your system. Consult your
    Linux documentation for information on how this can be set up.
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 这也有助于保护系统安全性的弱点。该文件通常存储在`/etc`目录中，如`/etc/procmailrc`，旨在为添加到系统的所有用户提供一组默认的个人规则。值得配置一个`.procmailrc`文件在用于系统的`add
    user`功能的骨架帐户中。请查阅Linux文档，了解如何设置这一点。
- en: Integration with Postfix for system-wide delivery
  id: totrans-87
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 与Postfix集成以进行系统范围的传递
- en: To integrate Procmail into the Postfix system is simple but, as with any other
    configuration change, care must be taken. Postfix runs all external commands such
    as Procmail with the user ID of nobody. So it would be unable to deliver mail
    to the user `root`. To ensure that important system messages are still received,
    you should make sure that an alias is configured so that all mail intended for
    the root user is forwarded to a real user who will read the mailbox.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 将Procmail集成到Postfix系统中很简单，但是，与任何其他配置更改一样，必须小心。Postfix以nobody用户ID运行所有外部命令，例如Procmail。因此，它将无法将邮件传递给用户`root`。为了确保重要的系统消息仍然可以收到，您应该确保配置了别名，以便将所有发送给root用户的邮件转发到一个真实的用户，该用户将读取邮箱。
- en: Creating an alias for system accounts
  id: totrans-89
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 为系统帐户创建别名
- en: To create an alias for the root user, you must edit the appropriate `alias`
    file, normally found in `/etc/aliases or /etc/mail/aliases`.
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 要为root用户创建别名，您必须编辑适当的`alias`文件，通常位于`/etc/aliases`或`/etc/mail/aliases`中。
- en: 'If you are unable to find the file, use the following command:'
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 如果找不到文件，请使用以下命令：
- en: '[PRE9]'
  id: totrans-92
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'The entry in the alias file should be as follows with just a single tab character
    between the colon (:) and the start of the e-mail address and no trailing spaces:'
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 别名文件中的条目应该如下所示，冒号（：）和电子邮件地址的开头之间只有一个制表符，并且没有尾随空格：
- en: '[PRE10]'
  id: totrans-94
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: After creating the text entry, you should run the `newaliases` command to convert
    the text file into a database file ready for Postfix to read.
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 创建文本条目后，您应该运行`newaliases`命令，将文本文件转换为数据库文件，以便供Postfix读取。
- en: 'It is worthwhile to add additional aliases for any other system accounts that
    may receive mail. For example you may end up with an `aliases` file similar to
    the following:'
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 值得为可能接收邮件的任何其他系统帐户添加额外的别名。例如，您可能最终会得到类似以下的`aliases`文件：
- en: '[PRE11]'
  id: totrans-97
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: Adding Procmail to the Postfix configuration
  id: totrans-98
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 将Procmail添加到Postfix配置
- en: For system-wide delivery of mail by Procmail, it is necessary to modify the
    Postfix `main.cf` file to specify the application that will be responsible for
    the actual delivery.
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 对于由Procmail进行系统范围的邮件投递，需要修改Postfix的`main.cf`文件，以指定将负责实际投递的应用程序。
- en: 'Edit the `/etc/postfix/main.cf` file and add the following line:'
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 编辑`/etc/postfix/main.cf`文件并添加以下行：
- en: '[PRE12]'
  id: totrans-101
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'When the change has been made, you need to instruct Postfix that the file has
    changed using the following command:'
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 进行更改后，您需要使用以下命令指示Postfix文件已更改：
- en: '[PRE13]'
  id: totrans-103
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: Postfix-provided environment variables
  id: totrans-104
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 由Postfix提供的环境变量
- en: 'Postfix exports information regarding the mail package by use of a number of
    environment variables. The variables are modified to avoid any shell expansion
    issues by replacing all characters that may have special meaning to the shell,
    including whitespace with the underscore character. The following is a list of
    variables that are exported and their meaning:'
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: Postfix通过使用多个环境变量导出有关邮件包的信息。这些变量被修改以避免任何shell扩展问题，方法是用下划线字符替换所有可能对shell具有特殊含义的字符，包括空格。以下是导出的变量及其含义的列表：
- en: '| Variable | Meaning |'
  id: totrans-106
  prefs: []
  type: TYPE_TB
  zh: '| 变量 | 含义 |'
- en: '| --- | --- |'
  id: totrans-107
  prefs: []
  type: TYPE_TB
  zh: '| --- | --- |'
- en: '| `DOMAIN` | The text to the right-hand side of the `@` in the recipient address
    |'
  id: totrans-108
  prefs: []
  type: TYPE_TB
  zh: '| `DOMAIN` | 收件人地址中`@`右侧的文本 |'
- en: '| `EXTENSION` | Optional address-extension part |'
  id: totrans-109
  prefs: []
  type: TYPE_TB
  zh: '| `EXTENSION` | 可选的地址扩展部分 |'
- en: '| `HOME` | The recipient''s home directory |'
  id: totrans-110
  prefs: []
  type: TYPE_TB
  zh: '| `HOME` | 收件人的主目录 |'
- en: '| `LOCAL` | The text to the left-hand side of the `@` in the recipient address,
    for example, `$USER+$EXTENSION` |'
  id: totrans-111
  prefs: []
  type: TYPE_TB
  zh: '| `LOCAL` | 收件人地址中`@`左侧的文本，例如，`$USER+$EXTENSION` |'
- en: '| `LOGNAME` | The recipient username |'
  id: totrans-112
  prefs: []
  type: TYPE_TB
  zh: '| `LOGNAME` | 收件人用户名 |'
- en: '| `RECIPIENT` | The entire recipient address, `$LOCAL@$DOMAIN` |'
  id: totrans-113
  prefs: []
  type: TYPE_TB
  zh: '| `RECIPIENT` | 整个收件人地址，`$LOCAL@$DOMAIN` |'
- en: '| `SENDER` | The complete sender address |'
  id: totrans-114
  prefs: []
  type: TYPE_TB
  zh: '| `SENDER` | 完整的发件人地址 |'
- en: '| `SHELL` | The recipient''s login shell |'
  id: totrans-115
  prefs: []
  type: TYPE_TB
  zh: '| `SHELL` | 收件人的登录shell |'
- en: Basic operations
  id: totrans-116
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 基本操作
- en: When a mail item arrives and is passed to the Procmail program, the sequence
    of operations follows a set format. It starts by loading the various configuration
    files to obtain the rules that have been set up for that particular user. The
    message is then tested by each of these rules in turn and when a suitable match
    is made, the rule is applied. Some rules terminate when they have completed, while
    others return control so that the message can be assessed against remaining rules
    for potential processing.
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 当邮件到达并传递给Procmail程序时，操作的顺序遵循一组固定的格式。它从加载各种配置文件开始，以获取为特定用户设置的规则。然后依次通过每个规则测试消息，当找到合适的匹配时，应用规则。一些规则在完成后终止，而其他规则返回控制，以便对消息进行潜在处理的剩余规则进行评估。
- en: Configuration file
  id: totrans-118
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 配置文件
- en: The system-wide configuration is normally made in `/etc/procmailrc`, while personal
    configuration files are normally stored in the user's home directory and called
    `.procmailrc`. Individual rules can be stored in separate files or grouped together
    into a number of files and then included as part of the mail filtering process
    by the main `.procmailrc` file. Typically these files would be stored in the `Procmail`
    subdirectory of your home directory.
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 通常在`/etc/procmailrc`中进行系统范围的配置，而个人配置文件通常存储在用户的主目录中，称为`.procmailrc`。个别规则可以存储在单独的文件中，或者分组存储在多个文件中，然后作为主`.procmailrc`文件的一部分包含在邮件过滤过程中。通常，这些文件将存储在主目录的`Procmail`子目录中。
- en: File format
  id: totrans-120
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 文件格式
- en: Entries in the configuration file are made in a simple text format according
    to a basic layout. Comments are allowed and are formed by the text following a
    `#` character; empty lines are simply ignored. Rules themselves do not have to
    be laid out in any particular format, though for ease of maintenance and readability,
    it is well worth writing the rules in a consistent and simple format.
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 配置文件中的条目以简单的文本格式按照基本布局进行。允许注释，并且由`#`字符后的文本组成；空行将被简单地忽略。规则本身不必按任何特定格式布局，但为了便于维护和可读性，值得以一致和简单的格式编写规则。
- en: Configuration file dissection
  id: totrans-122
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 配置文件解剖
- en: 'The Procmail configuration file contents can be classified into three main
    sections:'
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: Procmail配置文件内容可以分为三个主要部分：
- en: '**Variables:** Information necessary for Procmail to do its work may be assigned
    to variables within the configuration file in a manner similar to how they are
    used in shell programming. Some of the variables are obtained from the shell environment
    that Procmail is running in, others are created by Procmail itself for use within
    the scripts, while other variables can be assigned within the script itself. An
    additional use for variables is to set flags as to how Procmail itself should
    operate.'
  id: totrans-124
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 变量：Procmail需要执行其工作所需的信息可以被分配到配置文件中的变量中，类似于它们在shell编程中的使用方式。一些变量是从Procmail正在运行的shell环境中获取的，另一些是由Procmail自己创建的，用于脚本内部使用，而其他变量可以在脚本内部分配。变量的另一个用途是设置Procmail本身的操作方式的标志。
- en: 'A few useful variables can be set in most scripts:'
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 大多数脚本中可以设置一些有用的变量：
- en: '[PRE14]'
  id: totrans-126
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: The `VERBOSE` variable is used to affect the level of logging that is performed,
    while the `NEWLINE` embedded in the `LOG` variable is deliberate and intended
    to make log files easier to read.
  id: totrans-127
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`VERBOSE`变量用于影响执行的日志级别，而`LOG`变量中嵌入的`NEWLINE`是故意的，旨在使日志文件更易于阅读。'
- en: Chapter 7 also includes a short script that displays all the variables assigned
    within Procmail.
  id: totrans-128
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 第7章还包括一个简短的脚本，显示了在Procmail中分配的所有变量。
- en: '**Comments:** A `#` character and all the following characters up to a `NEWLINE`
    are ignored. This does not apply to condition lines that cannot be commented.
    Blank lines are ignored and may be used in conjunction with comments to document
    your configuration and to aid readability. You should comment your rules as what
    makes obvious sense today as you are writing your rules may well defy explanation
    in six months time without checking the manual.'
  id: totrans-129
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**注释：** `#`字符和后续的所有字符直到`NEWLINE`都将被忽略。这不适用于无法被注释的条件行。空行将被忽略，并且可以与注释一起用于记录您的配置并提高可读性。您应该注释您的规则，因为今天写规则时显而易见的东西，也许在六个月后不查看手册就无法解释了。'
- en: '**Rules or recipes:** Recipe is a common name for rules we create. A line starting
    with a colon (:) marks the beginning of a recipe. A recipe has the following format:'
  id: totrans-130
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**规则或配方：** 配方是我们创建的规则的常见名称。以冒号（：）开头的行标志着配方的开始。配方的格式如下：'
- en: '[PRE15]'
  id: totrans-131
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: The `:0` is a hangover from earlier versions of Procmail. The number following
    the `:` was originally intended to indicate the number of actions contained within
    the rule, this is now calculated automatically by the Procmail parser. However,
    the `:0` is required for compatibility purposes.
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: '`：0`是Procmail早期版本的遗留物。冒号后面的数字最初是用来指示规则中包含的动作数量，现在由Procmail解析器自动计算。然而，为了兼容性，仍然需要`：0`。'
- en: Analyzing a simple rule
  id: totrans-133
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 分析一个简单的规则
- en: Let us assume that we are receiving large amounts of mail from a particular
    mail group that we subscribed to. The mail is interesting, but isn't important
    and we would prefer to read it at our leisure. The subject is "mythical monsters"
    and all e-mail arriving from this mailing list has a "To" address of `<[mythical@monsters.com](mailto:mythical@monsters.com)>`.
    We have decided that we will create a special folder just for these items of mail,
    and copy all the mail into this folder. This is a simple rule that you will be
    able to easily copy and modify to process your own mail in the future.
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 假设我们从一个特定的邮件组收到大量邮件，我们订阅了这个邮件组。这些邮件很有趣，但不重要，我们更愿意在闲暇时阅读它们。主题是“神话怪兽”，来自这个邮件列表的所有电子邮件都有一个“To”地址`<[mythical@monsters.com](mailto:mythical@monsters.com)>`。我们决定创建一个专门的文件夹来存放这些邮件，并将所有邮件复制到这个文件夹中。这是一个简单的规则，您将能够轻松复制和修改以处理将来的邮件。
- en: The rule structure
  id: totrans-135
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 规则结构
- en: The following is an example copy of a very simple `.procmail` file taken from
    a user's home directory and is intended to explain some of the basic features
    of a Procmail configuration. The rule itself is designed to store all mail sent
    to a certain e-mail address, `<[mythical@monsters.com](mailto:mythical@monsters.com)>`,
    in a special folder called `monsters`. Most mail will be sent to multiple people
    including yourself and the "To" address can hold a useful indication of the mail
    contents. For example, mail may be sent to a distribution list at `info@yourcompany.com`
    and you need to prioritize this e-mail.
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 以下是一个非常简单的`.procmail`文件的示例副本，取自用户的主目录，并旨在解释Procmail配置的一些基本特性。规则本身旨在将发送到特定电子邮件地址`<[mythical@monsters.com](mailto:mythical@monsters.com)>`的所有邮件存储在一个名为`monsters`的特殊文件夹中。大多数邮件将发送给多个人，包括您自己，而“To”地址可以提供有用的邮件内容指示。例如，邮件可能发送到`info@yourcompany.com`的分发列表，您需要对这封邮件进行优先处理。
- en: Take a few moments to read the contents of the file and then we will break down
    each section in turn and analyze what its function is.
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 花点时间阅读文件的内容，然后我们将依次分解并分析每个部分的功能。
- en: '[PRE16]'
  id: totrans-138
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: Variable analysis
  id: totrans-139
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 变量分析
- en: To examine this file in detail, we can start with the definition statements
    where the variables are assigned with specific values. These values will override
    any values that Procmail has already assigned. By doing this manual assignment,
    we can ensure that paths are optimized for the script operation and that we are
    certain of what values are being used rather than assuming the values that Procmail
    may assign.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 要详细检查这个文件，我们可以从定义语句开始，其中变量被赋予特定值。这些值将覆盖Procmail已经分配的任何值。通过进行手动赋值，我们可以确保路径针对脚本操作进行了优化，并且我们确定使用的值而不是假设Procmail可能分配的值。
- en: '[PRE17]'
  id: totrans-141
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: 'These set up instructions to Procmail to define some basic parameters:'
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 这些设置指令用于定义一些基本参数：
- en: The `PATH` instruction specifies where Procmail can find any programs it may
    need to execute as part of the processing.
  id: totrans-143
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`PATH`指令指定了Procmail可以找到任何可能需要执行的程序的位置。'
- en: '`MAILDIR` specifies the directory that all the mail items will be stored in.
    This directory should exist.'
  id: totrans-144
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`MAILDIR`指定了所有邮件项目将存储的目录。这个目录应该存在。'
- en: '`DEFAULT` defines where mail will be stored if a specific location is not defined
    for the individual rule. Following the recommendation in the chapter on Postfix
    about selecting the mailbox format, the trailing / (slash) indicates to Procmail
    that it should deliver mail in Maildir format.'
  id: totrans-145
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`DEFAULT`定义了如果为单独的规则定义了特定位置，则邮件将存储在哪里。根据Postfix章节中关于选择邮箱格式的建议，尾部的/（斜杠）表示Procmail应以Maildir格式传递邮件。'
- en: '`LOGFILE` is the file where all tracking information will be stored so that
    we can see what is happening.'
  id: totrans-146
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`LOGFILE`是存储所有跟踪信息的文件，以便我们可以看到发生了什么。'
- en: Rule analysis
  id: totrans-147
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 规则分析
- en: 'Next we have the recipe instructions beginning with `:0`. The second `:` instructs
    Procmail to create a lock file to ensure only one mail message is written to the
    file at a time, in order to avoid corruption of the message store. The single
    line rule may be broken down as follows:'
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来是以`:0`开头的配方说明。第二个`:`指示Procmail创建一个锁定文件，以确保一次只写入一个邮件消息到文件中，以避免消息存储的损坏。单行规则可以分解如下：
- en: '`*:` All rule lines begin with an `*`. This is the way Procmail knows that
    they are rules. There may be one or more rules per recipe.'
  id: totrans-149
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`*：`所有规则行都以`*`开头。这是Procmail知道它们是规则的方式。每个配方可能有一个或多个规则。'
- en: '`^TO_:` This is a special Procmail built-in macro that searches most headers
    that can carry your address in them, such as `To:, Apparently-To:, Cc:, Resent-To:`,
    and so on, and will match if it finds the address `<[mythical@monsters.com.](mailto:mythical@monsters.com.)>`'
  id: totrans-150
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`^TO_：`这是一个特殊的Procmail内置宏，用于搜索大多数可能携带您地址的标题，例如`To：，Apparently-To：，Cc：，Resent-To：`等等，如果找到地址`<mythical@monsters.com.>`，则会匹配。'
- en: The final line is the action line and by default specifies a mail folder in
    the directory specified by the `MAILDIR` variable.
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 最后一行是操作行，默认情况下指定了`MAILDIR`变量指定的目录中的邮件文件夹。
- en: Tip
  id: totrans-152
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 提示
- en: The trailing slash is required on folder names for Maildir format mailboxes,
    otherwise mail is delivered in unix mbox format which is not supported by Courier-IMAP.
    If you are using IMAP, folder names should also be prefixed with a . (period)
    because the period character is designated as a hierarchy separator.
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: 对于Maildir格式邮箱，文件夹名称末尾的斜杠是必需的，否则邮件将以不受Courier-IMAP支持的unix mbox格式传递。如果您正在使用IMAP，文件夹名称还应以`.`（句号）为前缀，因为句号字符被指定为层次分隔符。
- en: Creating and testing a rule
  id: totrans-154
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 创建和测试规则
- en: Procmail allows you to organize your rules and recipes into multiple files and
    then process each file in turn. This makes it much easier to manage the rules
    and also to switch rules on and off as the needs change. For this first test case,
    we will create a special rule set for testing and organize all our rules in a
    subdirectory of our home directory. Typically, the subdirectory is called `Procmail`
    but you are free to use your own name.
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: Procmail允许您将规则和配方组织成多个文件，然后依次处理每个文件。这样可以更容易地管理规则，并根据需要打开或关闭规则。对于这个第一个测试案例，我们将创建一个特殊的规则集进行测试，并将所有规则组织在我们的主目录的子目录中。通常，子目录称为`Procmail`，但您可以自由使用自己的名称。
- en: We will start off by looking at a simple personal rule and testing it for a
    single user. Later in the chapter, when we have covered all of the basics and
    you are comfortable with the process of creating and setting up rules, we will
    show how to start applying rules to all system users.
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将从查看一个简单的个人规则并为单个用户进行测试开始。在本章后面，当我们涵盖了所有基础知识并且您对创建和设置规则的过程感到满意时，我们将展示如何开始将规则应用于所有系统用户。
- en: A "hello world" example
  id: totrans-157
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 一个“hello world”示例
- en: Almost all books on programming start off with a very simple "hello world" example
    to show the basics of the programming language. In this case, we will create a
    simple personal rule that processes all e-mails received by a user and checks
    to see if the subject contains the words "hello world". If the mail subject contains
    these particular words, the mail message will be stored in a special folder. If
    it does not contain these magic words, the mail will be stored in the user's normal
    inbox.
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 几乎所有关于编程的书都以非常简单的“hello world”示例开始，以展示编程语言的基础知识。在这种情况下，我们将创建一个简单的个人规则，处理用户收到的所有电子邮件，并检查主题是否包含“hello
    world”这几个词。如果邮件主题包含这些特定词，邮件消息将存储在一个特殊的文件夹中。如果不包含这些魔术词，邮件将存储在用户的正常收件箱中。
- en: Creating rc.testing
  id: totrans-159
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 创建rc.testing
- en: 'When you are working in a production environment, it is important to make sure
    that the rules being written and tested do not interfere with your normal day-to-day
    mail activities. One way of controlling this is to create a special file specifically
    for testing new rules and only include it in the Procmail processing when you
    are actually doing the testing work. When you are happy with the rule operation,
    you can move it to a specific file of its own, or add it to other similar or related
    rules. In this example, we will create a new file for testing rules called `rc.testing`.
    In the `$HOME/Procmail` directory, use your favorite editor to create the file
    `rc.testing` and enter the following lines:'
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: 在生产环境中工作时，重要的是要确保编写和测试的规则不会干扰您的日常邮件活动。控制这一点的一种方法是创建一个专门用于测试新规则的特殊文件，并且只在实际进行测试工作时将其包含在Procmail处理中。当您对规则操作满意时，可以将其移动到自己的特定文件中，或者将其添加到其他类似或相关的规则中。在这个例子中，我们将创建一个用于测试规则的新文件`rc.testing`。在`$HOME/Procmail`目录中，使用您喜欢的编辑器创建文件`rc.testing`并输入以下行：
- en: '[PRE18]'
  id: totrans-161
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: By now, you are hopefully beginning to recognize the structure of the rules.
    This one is broken down as follows.
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 到目前为止，您可能已经开始认识到规则的结构。这个规则可以分解如下。
- en: The first few lines set up variables that are applicable to our testing environment.
    As they are assigned within the testing script, they will only apply while the
    script is being included in the processing. As soon as we exclude the test script,
    the testing settings will, of course, not be applied.
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: 前几行设置了适用于我们测试环境的变量。由于它们是在测试脚本中分配的，因此它们只适用于脚本被包含在处理中的时候。一旦我们排除了测试脚本，测试设置当然就不适用了。
- en: Match all lines that begin (^) with the string `Subject:` and containing the
    string `hello world`. We have deliberately not used a string such as `test`, as
    a small number of systems can strip out messages that appear to be test messages.
    Remember that default operation of Procmail is to be case independent so we don't
    need to test for all variations such as `Hello World.`
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: 匹配所有以`Subject：`开头并包含字符串`hello world`的行。我们故意没有使用诸如`test`之类的字符串，因为少数系统可能会剥离看起来是测试消息的消息。请记住，Procmail的默认操作是不区分大小写的，因此我们不需要测试所有变体，例如`Hello
    World.`
- en: The last line directs Procmail to store the output in the `TEST-HelloWorld`
    file.
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 最后一行指示Procmail将输出存储在`TEST-HelloWorld`文件中。
- en: 'Create `testmail.txt` in the `$HOME/Procmail` directory, use your favorite
    editor to create the file `testmail.txt` and enter the following lines:'
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: 在`$HOME/Procmail`目录中创建`testmail.txt`，使用您喜欢的编辑器创建文件`testmail.txt`并输入以下行：
- en: '[PRE19]'
  id: totrans-167
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: The subject line is mixed case compared to our rule in `rc.testing` that contains
    the candidate string in order to demonstrate case-insensitive matching.
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: 主题行与`rc.testing`中的规则不一致，该规则包含了候选字符串，以演示不区分大小写的匹配。
- en: Performing static testing of the script
  id: totrans-169
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 对脚本进行静态测试
- en: 'Running the following command from the `Procmail` directory will generate the
    debugging output:'
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 从`Procmail`目录运行以下命令将生成调试输出：
- en: '[PRE20]'
  id: totrans-171
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: Note
  id: totrans-172
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: During static testing, we have defined the variable `PMDIR` in the previous
    command to be our current directory.
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: 在静态测试期间，我们已经在上一个命令中定义了变量`PMDIR`为我们当前的目录。
- en: After running the command, you can look at the log file for error messages.
    If everything worked fine, you would see the creation of the file `TEST-HelloWorld`
    with the contents of `testmail.txt` and following output in the log.
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: 运行命令后，您可以查看错误消息的日志文件。如果一切正常，您将看到文件`TEST-HelloWorld`的创建，其中包含`testmail.txt`的内容以及日志中的以下输出。
- en: '[PRE21]'
  id: totrans-175
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: 'If the `Subject` line had not contained the relevant matching phrase, you might
    have seen the following output in the log:'
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: 如果`Subject`行没有包含相关的匹配短语，您可能会在日志中看到以下输出：
- en: '[PRE22]'
  id: totrans-177
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: Configuring Procmail to process rc.testing
  id: totrans-178
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 配置Procmail以处理rc.testing
- en: 'You will need to edit your `.procmailrc` configuration file. There may well
    be some entries in there already, so it is worth making a backup of the file before
    you make any changes. Ensure that the following lines are included in the file:'
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: 您需要编辑`.procmailrc`配置文件。可能已经有一些条目在里面，所以在进行任何更改之前最好备份文件。确保文件中包含以下行：
- en: '[PRE23]'
  id: totrans-180
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: Some lines are deliberately commented out using `#`. These may be required if
    we need to do some more detailed debugging later.
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
  zh: 有些行使用`#`进行了故意注释。如果以后需要进行更详细的调试，可能需要这些行。
- en: Testing the setup
  id: totrans-182
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 测试设置
- en: 'Using the following command, send yourself two messages:'
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: 使用以下命令，给自己发送两条消息：
- en: '[PRE24]'
  id: totrans-184
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: One should include the string `hello world` in the subject line and one should
    not include this particular string.
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
  zh: 主题行应包含字符串`hello world`，而另一条消息则不应包含此特定字符串。
- en: When you check your mail, you should find that the message with the key word
    in the subject has been stored in the `TEST-HelloWorld` mail folder, while the
    other message was left in the normal mail inbox.
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: 当您检查邮件时，您应该发现主题中包含关键字的消息已存储在`TEST-HelloWorld`邮件文件夹中，而另一条消息则留在了正常的邮件收件箱中。
- en: Configuration debugging
  id: totrans-187
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 配置调试
- en: If this has all worked correctly—congratulations! You are well on the way to
    organizing your mail.
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: 如果一切正常——恭喜！您已经在组织您的邮件的道路上取得了很大进展。
- en: If it didn't quite work as expected, there are a number of simple things we
    can do to find out what the problem is.
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: 如果结果不如预期，我们可以做一些简单的事情来找出问题所在。
- en: Checking for typos in the scripts
  id: totrans-190
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 检查脚本中的拼写错误
- en: As with any programming process, if at first it doesn't work, check the code
    to make sure that there were no obvious typos introduced during the editing phase.
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: 与任何编程过程一样，如果一开始不起作用，请检查代码，确保在编辑阶段没有引入明显的拼写错误。
- en: Looking at the log file for error messages
  id: totrans-192
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 查看错误消息的日志文件
- en: 'If that doesn''t highlight anything, you can look at the log file created by
    Procmail. In this case, the log file is called `pmlog` in the `~/Procmail` directory.
    To look at just the last few lines, use the following command:'
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: 如果这没有显示任何问题，您可以查看Procmail创建的日志文件。在这种情况下，日志文件称为`~/Procmail`目录中的`pmlog`。要查看最后几行，请使用以下命令：
- en: '[PRE25]'
  id: totrans-194
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: 'In the following example there is a missing `:0` so that the rule lines are
    being skipped:'
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
  zh: 在以下示例中，缺少`:0`，因此规则行被跳过：
- en: '[PRE26]'
  id: totrans-196
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: 'This would give the following errors:'
  id: totrans-197
  prefs: []
  type: TYPE_NORMAL
  zh: 这将导致以下错误：
- en: '[PRE27]'
  id: totrans-198
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: Here there is no storage instruction to follow the rule `:0:`
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里没有存储指令来遵循规则`:0:`
- en: '[PRE28]'
  id: totrans-200
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: 'This would give the following errors:'
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
  zh: 这将导致以下错误：
- en: '[PRE29]'
  id: totrans-202
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: Checking file and directory permissions
  id: totrans-203
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 检查文件和目录权限
- en: 'Use the `ls` command to check the permissions on the `~/.procmailrc` and `~/Procmail/*`
    files and the `~/ home` directory. The rules files should be writable by users
    other than the owner and should have permissions similar to the following:'
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
  zh: 使用`ls`命令检查`~/.procmailrc`和`~/Procmail/*`文件以及`~/ home`目录的权限。规则文件应该可以被除所有者以外的用户写入，并且应该具有类似以下的权限：
- en: '[PRE30]'
  id: totrans-205
  prefs: []
  type: TYPE_PRE
  zh: '[PRE30]'
- en: 'The home directory should have permissions such as the following where the
    `?` may be either `r` or :'
  id: totrans-206
  prefs: []
  type: TYPE_NORMAL
  zh: 主目录应具有以下权限，其中`?`可以是`r`或：
- en: '[PRE31]'
  id: totrans-207
  prefs: []
  type: TYPE_PRE
  zh: '[PRE31]'
- en: Turning on Full Logging
  id: totrans-208
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 打开完整日志记录
- en: 'When you are creating more complex rules, or if you still have a problem, you
    need to enable the **Full Logging** capability of Procmail. To do this, you need
    to remove the comment `#` from the lines in the `~/.procmailrc` file so that they
    are enabled as follows:'
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
  zh: 当您创建更复杂的规则，或者仍然遇到问题时，您需要启用Procmail的**完整日志记录**功能。为此，您需要从`~/.procmailrc`文件中删除`#`注释，以便启用它们，如下所示：
- en: '[PRE32]'
  id: totrans-210
  prefs: []
  type: TYPE_PRE
  zh: '[PRE32]'
- en: Now resend the two sample messages and check the log file for the output information.
    The log file should indicate some areas of problems for you to investigate.
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
  zh: 现在重新发送两条示例消息，并检查输出信息的日志文件。日志文件应指示一些问题区域供您调查。
- en: Taking steps to avoid disasters
  id: totrans-212
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 采取措施避免灾难
- en: The following recipe inserted early in the `.procmailrc` file will ensure that
    the last 32 messages received are each stored in the `backup` directory, ensuring
    that valuable mail is not lost in cases where a recipe contains a fault or has
    an unexpected side effect.
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
  zh: 在`.procmailrc`文件的开头插入以下配方将确保最近接收的32条消息都存储在`backup`目录中，确保在配方包含错误或产生意外副作用的情况下不会丢失宝贵的邮件。
- en: '[PRE33]'
  id: totrans-214
  prefs: []
  type: TYPE_PRE
  zh: '[PRE33]'
- en: For now we will assume that this works, and in the next chapter we will analyze
    the recipe in detail to see how exactly it works and what it does.
  id: totrans-215
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们将假设这个工作，并在下一章中详细分析这个规则，看看它是如何工作的以及它的作用。
- en: Understanding e-mail structure
  id: totrans-216
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 了解电子邮件结构
- en: In order to make full use of the capabilities of Procmail, it is worth taking
    some time to understand the basic structure of a typical e-mail message. Over
    time, the structure has grown in complexity, but it can still be broken down into
    two discrete blocks.
  id: totrans-217
  prefs: []
  type: TYPE_NORMAL
  zh: 为了充分利用Procmail的功能，值得花一些时间了解典型电子邮件消息的基本结构。 随着时间的推移，结构变得越来越复杂，但仍然可以分解为两个离散的块。
- en: Message body
  id: totrans-218
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 消息正文
- en: The message body is separated from the headers by a single blank line (all the
    headers must be on consecutive lines, as any headers following a blank line will
    be assumed to be part of the message body).
  id: totrans-219
  prefs: []
  type: TYPE_NORMAL
  zh: 消息正文与标题之间由一个空白行分隔（所有标题必须连续出现，因为在空白行之后的任何标题都将被假定为消息正文的一部分）。
- en: The message body itself may be either a simple text message composed normally
    of simple ASCII characters or it may be a complex combination of parts encoded
    using something known as **MIME**. This has allowed e-mail to be able to transfer
    all forms of data ranging from simple text, HTML, or other formatted pages, and
    to include information such as attachments or embedded objects such as images.
    Discussion of MIME encoding is beyond the scope of this book, and is not necessary
    for most processes that you are likely to come across in mail filtering.
  id: totrans-220
  prefs: []
  type: TYPE_NORMAL
  zh: 消息正文本身可以是一个由简单ASCII字符组成的简单文本消息，也可以是使用称为**MIME**的东西编码的部分的复杂组合。 这使得电子邮件能够传输从简单文本，HTML或其他格式化页面到包括附件或嵌入对象（如图像）在内的各种形式的数据。
    MIME编码的讨论超出了本书的范围，并且对于您可能在邮件过滤中遇到的大多数过程来说并不是必要的。
- en: If you decide to try to process the data held in the message body, it is important
    to remember that what you see as the output of the mail program, may be very different
    from the actual data transmitted in the raw mail message.
  id: totrans-221
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您决定尝试处理消息正文中保存的数据，重要的是要记住，您在邮件程序的输出中看到的内容可能与原始邮件消息中传输的实际数据非常不同。
- en: E-mail headers
  id: totrans-222
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 电子邮件标题
- en: The headers are the tags that an e-mail contains that permit the various mailing
    components to send and process messages. The typical format of a mail header is
    a simple two-part construction composed of a keyword terminated by a `:` and followed
    by the information assigned to the keyword. The headers provide a lot of information
    about how the e-mail was created, what form of mail program created the message,
    from whom it came, to whom it should go, and how it reached your mailbox.
  id: totrans-223
  prefs: []
  type: TYPE_NORMAL
  zh: 标题是电子邮件包含的标签，允许各种邮件组件发送和处理消息。 电子邮件标题的典型格式是由一个关键字组成的简单两部分结构，由`:`终止，并跟随关键字分配的信息。
    标题提供了有关电子邮件是如何创建的，什么形式的邮件程序创建了消息，消息来自谁，应该发送给谁，以及它如何到达您的邮箱的大量信息。
- en: The following mail headers relate to an e-mail received from one of a number
    of mailing lists at `freelancers.net`. The most useful identifying feature of
    the e-mail is the subject line as most of the other mail groups use the same values
    for the other headers discussed.
  id: totrans-224
  prefs: []
  type: TYPE_NORMAL
  zh: 以下邮件头与从`freelancers.net`的多个邮件列表中收到的一封电子邮件相关。 电子邮件最有用的识别特征是主题行，因为大多数其他邮件组使用了讨论的其他邮件头的相同值。
- en: '![E-mail headers](img/8648_06_01.jpg)'
  id: totrans-225
  prefs: []
  type: TYPE_IMG
  zh: '![电子邮件标题](img/8648_06_01.jpg)'
- en: Header structure
  id: totrans-226
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 标题结构
- en: The previous example contains a large number of headers inserted by a number
    of processes that the mail has been through on its journey from sender to recipient.
    There is, however, a small number of key headers that are very useful for processing
    e-mail and are used in a significant number of recipes.
  id: totrans-227
  prefs: []
  type: TYPE_NORMAL
  zh: 先前的示例包含了大量的标题，这些标题是由邮件在从发件人到收件人的过程中经历的一系列过程插入的。 但是，有一小部分关键标题非常有用，用于处理电子邮件，并且在大量的规则中使用。
- en: Official definitions for headers
  id: totrans-228
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 标题的官方定义
- en: All headers that do not begin with `X-` are assigned specific functions by the
    relevant standards authority. More information about them may be found in the
    **RFC (Request for Comment) Document 822** at [http://www.ietf.org/rfc/rfc0822.txt](http://www.ietf.org/rfc/rfc0822.txt).
  id: totrans-229
  prefs: []
  type: TYPE_NORMAL
  zh: 所有不以`X-`开头的标题都由相关标准机构分配特定功能。 关于它们的更多信息可以在**RFC（请求评论）文档822**中找到，网址为[http://www.ietf.org/rfc/rfc0822.txt](http://www.ietf.org/rfc/rfc0822.txt)。
- en: Headers beginning with `X-` are user defined and are applicable to a specific
    application only. However, some applications may use the same header tag as other
    applications, but for different reasons and with a different format for the information
    provided.
  id: totrans-230
  prefs: []
  type: TYPE_NORMAL
  zh: 以`X-`开头的标题是用户定义的，并且仅适用于特定应用程序。 但是，一些应用程序可能使用与其他应用程序相同的标题标记，但出于不同的原因，并且提供的信息格式也不同。
- en: Example rule sets
  id: totrans-231
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 示例规则集
- en: In order to help you understand the way Procmail rules work, we will go through
    the design and setup of several simple but very useful rule sets. This should
    help to get you into the swing of designing your own rule sets as you find more
    specific needs to filter your incoming mail items.
  id: totrans-232
  prefs: []
  type: TYPE_NORMAL
  zh: 为了帮助您理解Procmail规则的工作方式，我们将介绍几个简单但非常有用的规则集的设计和设置。 这应该有助于让您开始设计自己的规则集，以满足更具体的需要来过滤您的传入邮件项目。
- en: All these examples are based on the mail messages received from the Freelancers
    Mailing List from which the previous example headers were taken. They all achieve
    the same result and once again prove that there is no one correct solution to
    a programming problem.
  id: totrans-233
  prefs: []
  type: TYPE_NORMAL
  zh: 所有这些示例都是基于从Freelancers邮件列表收到的邮件消息，先前示例标题取自其中。 它们都实现了相同的结果，并再次证明编程问题没有一个正确的解决方案。
- en: From header
  id: totrans-234
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 来自标题
- en: This header explains who the originator of the e-mail was. There are a variety
    of formats that may be used and are formed of various combinations of human-readable
    and computer-readable items of information. When you have looked at a few e-mails,
    you will begin to see the various patterns that can be used by differing mail
    systems and software. The actual formatting of this header is not necessarily
    important, as you are looking to generate rules to match specific e-mails.
  id: totrans-235
  prefs: []
  type: TYPE_NORMAL
  zh: 此标头解释了电子邮件的发起者是谁。可以使用各种格式，并由各种人类可读和计算机可读的信息项的各种组合组成。当您查看了一些电子邮件后，您将开始看到不同邮件系统和软件可以使用的各种模式。实际的标头格式并不一定重要，因为您要生成规则以匹配特定的电子邮件。
- en: '[PRE34]'
  id: totrans-236
  prefs: []
  type: TYPE_PRE
  zh: '[PRE34]'
- en: Return-Path Header
  id: totrans-237
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Return-Path标头
- en: This field is added by the final transport system that delivers the message
    to its recipient. The field is intended to contain definitive information about
    the address and route back to the message's originator.
  id: totrans-238
  prefs: []
  type: TYPE_NORMAL
  zh: 此字段由最终传输系统添加到将消息传递给其接收者的消息中。该字段旨在包含有关消息的发件人地址和路由的确切信息。
- en: '[PRE35]'
  id: totrans-239
  prefs: []
  type: TYPE_PRE
  zh: '[PRE35]'
- en: Filtering by Return-Path
  id: totrans-240
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 通过Return-Path进行过滤
- en: 'The majority of mailing lists use the `Return-Path` header:'
  id: totrans-241
  prefs: []
  type: TYPE_NORMAL
  zh: 大多数邮件列表使用`Return-Path`标头：
- en: '[PRE36]'
  id: totrans-242
  prefs: []
  type: TYPE_PRE
  zh: '[PRE36]'
- en: This is a useful way of easily filtering mailing list items. Here, the `^` character
    performs a special function that instructs Procmail to start the match process
    at the beginning of a new line. This means that lines that contain the phrase
    embedded in the middle of the line are not matched. The default operation for
    Procmail is to return a match if the string is found anywhere within the header
    or anywhere within the mail body, depending on where the script has been set to
    search.
  id: totrans-243
  prefs: []
  type: TYPE_NORMAL
  zh: 这是一个方便地过滤邮件列表项的方法。在这里，“^”字符执行一个特殊功能，指示Procmail在新行的开头开始匹配过程。这意味着包含短语的行不会被匹配。Procmail的默认操作是，如果在标头或邮件正文的任何位置找到字符串，就返回匹配，具体取决于脚本设置的搜索位置。
- en: To and Cc headers
  id: totrans-244
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: To和Cc标头
- en: 'Messages are normally sent to one or more people who are listed in the To:
    or Cc: headers of the e-mail. Like the From: header, these addresses may be formatted
    in several ways. These headers are visible to all mail recipients and allow you
    to see all the public recipients listed.'
  id: totrans-245
  prefs: []
  type: TYPE_NORMAL
  zh: 邮件通常发送给一个或多个列在电子邮件的To:或Cc:标头中的人。与From:标头一样，这些地址可能以多种方式格式化。这些标头对所有邮件接收者可见，并允许您查看所有列出的公共接收者。
- en: '[PRE37]'
  id: totrans-246
  prefs: []
  type: TYPE_PRE
  zh: '[PRE37]'
- en: 'There is a third recipient header that is not quite as common as the To: and
    Cc: but is used quite a lot in bulk mailings. This is the Bcc: (Blind Carbon Copy).
    Unfortunately, as the name implies, this is a blind header and so the information
    is not included in the actual header information and hence not available for processing.'
  id: totrans-247
  prefs: []
  type: TYPE_NORMAL
  zh: 有一个第三个接收者标头，不像To:和Cc:那样常见，但在大量邮件中经常使用。这是Bcc:（暗送）。不幸的是，正如名称所暗示的那样，这是一个盲标头，因此信息不包含在实际的标头信息中，因此无法用于处理。
- en: Filtering by To or Cc
  id: totrans-248
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 通过To或Cc进行过滤
- en: Procmail has a number of special built-in macros that can be used to identify
    mail items. The special rule `^TO_` is intended to search all the destination
    headers available. The rule must be written as exactly four characters with no
    spaces and with both `T` and `O` in capitals. The phrase being matched must follow
    immediately after the `_` again without a space.
  id: totrans-249
  prefs: []
  type: TYPE_NORMAL
  zh: Procmail有许多特殊的内置宏，可用于识别邮件项。特殊规则“^TO_”旨在搜索所有可用的目标标头。规则必须写成四个字符，没有空格，并且T和O都是大写。匹配的短语必须紧跟在“_”后面，再次没有空格。
- en: '[PRE38]'
  id: totrans-250
  prefs: []
  type: TYPE_PRE
  zh: '[PRE38]'
- en: Subject header
  id: totrans-251
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 主题头
- en: The subject line is usually included in the e-mail headers unless the sender
    has decided not to include a subject line at all.
  id: totrans-252
  prefs: []
  type: TYPE_NORMAL
  zh: 主题行通常包含在电子邮件头中，除非发件人决定根本不包括主题行。
- en: '**Subject: FN-PROJECTS Freelance Web Designers**'
  id: totrans-253
  prefs: []
  type: TYPE_NORMAL
  zh: '**主题：FN-PROJECTS 自由职业网页设计师**'
- en: In this example, all the mail items sent to this particular list start with
    the phrase "FN-PROJECTS" and so are sometimes suitable for filtering.
  id: totrans-254
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个例子中，发送到这个特定列表的所有邮件都以短语“FN-PROJECTS”开头，因此有时适合过滤。
- en: Filtering by subject
  id: totrans-255
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 通过主题进行过滤
- en: 'When mailing lists add a prefix to subject lines, this prefix may be suitable
    for filtering:'
  id: totrans-256
  prefs: []
  type: TYPE_NORMAL
  zh: 当邮件列表在主题行中添加前缀时，此前缀可能适用于过滤：
- en: '[PRE39]'
  id: totrans-257
  prefs: []
  type: TYPE_PRE
  zh: '[PRE39]'
- en: System-wide rules
  id: totrans-258
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 系统范围的规则
- en: Now that we have covered all the basics of setting up rules, analyzing e-mails,
    and generally seeing how all of the processing operations interact, we will look
    through a couple of examples for system-wide filtering, testing, and operations.
  id: totrans-259
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经涵盖了设置规则、分析电子邮件以及通常看到所有处理操作如何交互的所有基础知识，我们将浏览一些系统范围的过滤、测试和操作的示例。
- en: Removing executables
  id: totrans-260
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 删除可执行文件
- en: In Chapter 9, we will see how to integrate a complete virus checking system
    into the Postfix mail architecture. This will perform accurate virus signature
    recognition and add suitable flags to the mail headers to indicate if a virus
    is present in the mail. However, if it is not possible to set up such a system,
    this rule will provide an alternative but more brutal approach to block all e-mails
    with executable attachments.
  id: totrans-261
  prefs: []
  type: TYPE_NORMAL
  zh: 在第9章中，我们将看到如何将完整的病毒检查系统集成到Postfix邮件架构中。这将执行准确的病毒签名识别，并向邮件头添加适当的标志以指示邮件中是否存在病毒。但是，如果不可能设置这样的系统，这条规则将提供一种替代但更残酷的方法来阻止所有带有可执行附件的电子邮件。
- en: If you place the following in `/etc/procmailrc`, it will affect all mail traveling
    through the system that contains certain types of documents as attachments.
  id: totrans-262
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您将以下内容放入`/etc/procmailrc`，它将影响通过系统传输的所有包含特定类型文档附件的邮件。
- en: '[PRE40]'
  id: totrans-263
  prefs: []
  type: TYPE_PRE
  zh: '[PRE40]'
- en: The rule starts with the customary `:0` instruction.
  id: totrans-264
  prefs: []
  type: TYPE_NORMAL
  zh: 规则以惯例的`:0`指令开始。
- en: 'The conditions are applied as follows:'
  id: totrans-265
  prefs: []
  type: TYPE_NORMAL
  zh: 条件适用如下：
- en: Firstly, ensure that we are only going to filter messages less than 256 KB in
    size. This is primarily for efficiency and most spam is smaller than this size.
    You could obviously increase it if you are getting viruses that are bigger, but
    there could be a higher load on your system.
  id: totrans-266
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，确保我们只过滤大小小于256 KB的邮件。这主要是为了效率，大多数垃圾邮件都比这个大小小。如果您收到的病毒更大，您可以显然增加它，但是您的系统可能会负载更高。
- en: The next line says that we also only look at those messages that are MIME types
    (that is, not plain text), as attachments, by definition, cannot be included in
    a plain text message.
  id: totrans-267
  prefs: []
  type: TYPE_NORMAL
  zh: 下一行表示我们也只查看那些是MIME类型的消息（即不是纯文本），因为附件根据定义不能包含在纯文本消息中。
- en: We have a subfilter between the curly braces. The `:0B` says we are processing
    the body of the message, rather than the headers. We have to do this because attachments
    come in the body, not the headers. We then look for lines that have the signature
    of being a MIME heading for an executable file. You can amend the filename extensions
    if you wish; these are simply the ones that are commonly used to transmit viruses.
  id: totrans-268
  prefs: []
  type: TYPE_NORMAL
  zh: 我们在花括号之间有一个子过滤器。`:0B`表示我们正在处理消息的正文，而不是标题。我们必须这样做，因为附件出现在正文中，而不是标题中。然后我们寻找具有可执行文件MIME标题特征的行。如果需要，您可以修改文件扩展名；这些只是常用于传输病毒的扩展名。
- en: The action in this case is to send this message to `/dev/null` if it matches.
    Note that this means no message bounce or error message to the sender; the message
    is simply dropped, never to be seen again. You may of course store the messages
    in a secure location and nominate someone to monitor the account for valid messages
    that do not contain viruses. For a more elegant solution to this problem, remember
    to check [Chapter 9](ch09.html "Chapter 9. Antivirus Protection").
  id: totrans-269
  prefs: []
  type: TYPE_NORMAL
  zh: 在这种情况下的操作是，如果匹配，则将此消息发送到`/dev/null`。请注意，这意味着不会向发件人发送任何消息反弹或错误消息；消息只是被丢弃，永远不会再次被看到。当然，您可以将消息存储在安全位置，并指定某人监视不包含病毒的有效消息的帐户。对于这个问题的更优雅的解决方案，请记得查看[第9章](ch09.html
    "第9章。防病毒保护")。
- en: Large e-mails
  id: totrans-270
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 大邮件
- en: With the ever increasing use of high speed, always-on Internet connections,
    people are starting to send larger and larger e-mail messages. Once upon a time,
    it was considered rude to have more than four lines in your signature file, nowadays
    people happily include images and wallpapers, and send both HTML and text versions
    of the e-mail all without realizing the size of message they are sending.
  id: totrans-271
  prefs: []
  type: TYPE_NORMAL
  zh: 随着高速、始终在线的互联网连接的日益增加，人们开始发送越来越大的电子邮件。曾经，一个签名文件超过四行被认为是粗鲁的，而如今人们愉快地包含图像和壁纸，并发送电子邮件的HTML和文本版本，而不意识到他们发送的邮件大小。
- en: Storing such large messages in your Inbox adds considerably to the processing
    overhead to search through your mail messages. One simple solution is to move
    all messages over a certain size into an oversize folder. This can be achieved
    very simply by using the following rule that looks for messages over 100,000 bytes
    in size and stores them in the `largemail` folder.
  id: totrans-272
  prefs: []
  type: TYPE_NORMAL
  zh: 将这样大的消息存储在收件箱中会大大增加搜索邮件消息的处理开销。一个简单的解决方案是将所有超过一定大小的消息移动到一个超大文件夹中。通过使用以下规则，可以非常简单地实现这一点，该规则查找大小超过100,000字节的消息，并将它们存储在“largemail”文件夹中。
- en: '[PRE41]'
  id: totrans-273
  prefs: []
  type: TYPE_PRE
  zh: '[PRE41]'
- en: The downside of this rule is that your users need to remember to check on a
    regular basis both their Inbox and the `largemail` folder. A more elegant solution
    will allow you to copy the first few lines of the message together with the headers
    and subject line, and store that in the Inbox and inform you that the complete
    version needs to be checked for. Such a solution can be seen in the examples at
    the end of the next chapter.
  id: totrans-274
  prefs: []
  type: TYPE_NORMAL
  zh: 这条规则的缺点是你的用户需要记住定期检查他们的收件箱和“largemail”文件夹。更优雅的解决方案将允许你复制消息的前几行以及标题和主题行，并将其存储在收件箱中，并通知你需要检查完整版本。这样的解决方案可以在下一章末尾的示例中看到。
- en: Summary
  id: totrans-275
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 总结
- en: In this chapter, we have discovered some of the basics of Procmail. By now you
    should be familiar with the various files that Procmail uses to load recipes,
    the core principles of filtering, and the options available. We have also analyzed
    e-mails, set up individual and system wide filters, and looked at some of the
    simple testing, logging, and debugging options that will help us manage a company's
    mail more effectively.
  id: totrans-276
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们已经了解了Procmail的一些基础知识。到目前为止，你应该熟悉Procmail用于加载配方的各种文件，过滤的核心原则以及可用的选项。我们还分析了电子邮件，设置了个人和系统范围的过滤器，并查看了一些简单的测试、日志记录和调试选项，这些选项将帮助我们更有效地管理公司的邮件。
- en: We have just scratched the surface of what is possible, but hopefully this little
    taste has already provided you with a whole load of ideas about how you could
    go about processing and filtering your daily overload of e-mail. It may well have
    given you ideas for more advanced filters and the next chapter will provide more
    advice and explanations of how to go about setting these up.
  id: totrans-277
  prefs: []
  type: TYPE_NORMAL
  zh: 我们只是刚刚触及了可能性的表面，但希望这点小小的尝试已经给你提供了大量关于如何处理和过滤你每天过载的电子邮件的想法。这可能已经给你提供了更高级过滤器的想法，下一章将提供更多关于如何设置这些过滤器的建议和解释。
