- en: Chapter 10. Backing Up Your System
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第10章。备份您的系统
- en: In order to recover from catastrophic loss of service in case of a major hardware
    or software malfunction, it is absolutely essential to have a backup. The backup
    is supposed to let you restore the software (or rather the software's configuration)
    and other data that you need to reestablish your service. This includes the users'
    mails, the system's mail queue, and their authentication data among other things.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 为了从重大硬件或软件故障中的灾难性服务丢失中恢复，绝对必须有备份。备份应该让您恢复软件（或者软件的配置）和其他需要重新建立服务的数据。这包括用户的邮件，系统的邮件队列以及它们的认证数据等。
- en: 'This chapter will guide you through the steps necessary to safeguard your system
    from failure and, if failure occurs, how to recover from it. After reading through
    this chapter you will know:'
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 本章将指导您完成必要的步骤，以防止系统故障，并在发生故障时如何从中恢复。阅读完本章后，您将了解：
- en: What backup options are available
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 可用的备份选项
- en: What data we need to back up
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 我们需要备份哪些数据
- en: The storage considerations for our backup media
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 我们备份介质的存储考虑
- en: How to perform incremental and full backups for the mailboxes
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如何为邮箱执行增量和完整备份
- en: The steps required for a complete file system restore
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 完成文件系统恢复所需的步骤
- en: How to restore an individual e-mail
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如何恢复单个电子邮件
- en: How to backup our server configuration
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如何备份我们的服务器配置
- en: Setting up automated backup schedules
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 设置自动备份计划
- en: Backup options
  id: totrans-11
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 备份选项
- en: Choosing the most appropriate backup option is always a trade-off. You have
    to juggle the cost of downtime to a business, the price and availability of backup
    media and hardware, the value of user data (in our case, users' e-mails), and
    the staffing costs to manage the backup operations.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 选择最合适的备份选项总是一个权衡。您必须权衡业务停机成本，备份媒体和硬件的价格和可用性，用户数据的价值（在我们的情况下，用户的电子邮件），以及管理备份操作的人员成本。
- en: For our small office e-mail server, we are going to present a simple but reliable
    solution, using tried and trusted techniques and tools employed by numerous administrators
    over many years.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 对于我们的小型办公室电子邮件服务器，我们将提出一个简单但可靠的解决方案，使用多年来许多管理员采用的经过验证的技术和工具。
- en: Any backups we take need to be stored on backup media. The most convenient solution
    is to have a spare Linux machine, with a number of hard drives, networked to our
    e-mail server, preferably located in another building. Storing backups off site
    is essential if we want to protect ourselves from a catastrophic event such as
    fire.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 我们采取的任何备份都需要存储在备份介质上。最方便的解决方案是拥有一个备用的Linux机器，配备多个硬盘，与我们的电子邮件服务器相连，最好位于另一栋建筑物中。如果我们想要保护自己免受火灾等灾难性事件的影响，将备份存储在离站位置是必不可少的。
- en: If a remote server is not available, an alternative could be some hot-swappable
    external hard drives connected to the server, or even, in a pinch, a DVD burner.
    Magnetic tape drives are also an option, but often the cost of the tape drive
    and media is greater than the server. If removable media is the only option then
    don't leave the backups stacked on top of the server or in a desk drawer, move
    them to a safe off site location. It may be convenient to retain a local copy
    of the latest backup media on site to respond more quickly to urgent recovery
    situations.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 如果远程服务器不可用，另一种选择可能是连接到服务器的一些热插拔外部硬盘，甚至在紧急情况下使用DVD刻录机。磁带驱动器也是一个选择，但通常磁带驱动器和介质的成本大于服务器。如果可移动介质是唯一的选择，那么不要把备份堆叠在服务器顶部或桌子抽屉里，将它们移动到一个安全的离站位置。保留最新备份介质的本地副本以更快地应对紧急恢复情况可能更方便。
- en: RAID
  id: totrans-16
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: RAID
- en: '**RAID** is an acronym for a **Redundant Array** of **Inexpensive** (or **Independent**)**Disks**.
    By using multiple disks in a RAID setup, data is spread across the disks, but
    the array is viewed by the operating system as a single device. By replicating
    and dividing the data throughout the array, the tolerance to disk failure can
    be reduced significantly, increasing data reliability and possibly I/O performance.
    If a hard disk fails in the array, the old disk can be swapped out and replaced
    with a new disk. The RAID controller, either a hardware or software controller,
    then reconstructs the data. For more information on RAID and the various configuration
    options available, visit [http://en.wikipedia.org/wiki/RAID](http://en.wikipedia.org/wiki/RAID).'
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: RAID是“冗余磁盘阵列”的缩写。通过在RAID设置中使用多个磁盘，数据分布在磁盘上，但操作系统将该阵列视为单个设备。通过在整个阵列中复制和分割数据，可以显著减少磁盘故障的容忍度，提高数据可靠性，可能提高I/O性能。如果阵列中的硬盘故障，旧硬盘可以被更换为新硬盘。然后，RAID控制器（无论是硬件控制器还是软件控制器）会重建数据。有关RAID和可用的各种配置选项的更多信息，请访问[http://en.wikipedia.org/wiki/RAID](http://en.wikipedia.org/wiki/RAID)。
- en: However, RAID, by itself, is not a backup solution. A file or e-mail that has
    been deleted, whether accidentally or maliciously, cannot be recovered. RAID does
    not protect from user error or serious hardware failure such as a power surge
    that fries the server or even fire damage.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，单独使用RAID并不是一个备份解决方案。已删除的文件或电子邮件，无论是意外还是恶意删除，都无法恢复。RAID无法保护用户错误或严重的硬件故障，例如使服务器烧毁的电涌甚至火灾。
- en: Increasing data availability using RAID is a good thing, but is not an alternative
    to a proper backup and recovery strategy.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 使用RAID增加数据可用性是一件好事，但并不是适当备份和恢复策略的替代品。
- en: Image backups
  id: totrans-20
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 镜像备份
- en: A disk image backup program will copy data from a hard disk, sector by sector
    with no regard to any files or structure on the disk. The backup is an exact image
    of the disk—the master boot record, partition tables, and all data.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 磁盘镜像备份程序将从硬盘逐扇区地复制数据，而不考虑硬盘上的任何文件或结构。备份是硬盘的精确镜像——主引导记录，分区表和所有数据。
- en: 'In the event of a major hardware failure, the steps to restore a system are
    as follows:'
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 在发生重大硬件故障的情况下，恢复系统的步骤如下：
- en: Replace or repair failed hardware.
  id: totrans-23
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 更换或修复故障的硬件。
- en: Boot a Linux live CD containing the disk image restore program.
  id: totrans-24
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 引导Linux光盘，其中包含磁盘镜像恢复程序。
- en: Write the image of each disk from the backup.
  id: totrans-25
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将每个磁盘的映像写入备份。
- en: Reboot.
  id: totrans-26
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 重新启动。
- en: Superficially, this looks like an attractive and quick approach to restore service
    quickly and easily. However, there are number of problems inherent in using disk
    images for backup.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 表面上看，这似乎是一种快速恢复服务的吸引人且快速的方法。然而，使用磁盘映像进行备份存在一些问题。
- en: Restoring a disk image to a new disk of a different size or geometry is often
    not possible.
  id: totrans-28
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 通常无法将磁盘映像恢复到大小或几何不同的新磁盘上。
- en: The new hardware will almost certainly be of a different configuration (motherboard,
    network card, disk controllers, and so on.), and the restored Linux kernel may
    not have the necessary drivers to boot successfully.
  id: totrans-29
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 新硬件几乎肯定会有不同的配置（主板、网络卡、磁盘控制器等），并且恢复的Linux内核可能没有必要的驱动程序来成功引导。
- en: Disk images are big. The image is the total size of the disk, not just the size
    of the data stored on it. The space requirements of multiple disk images soon
    adds up.
  id: totrans-30
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 磁盘映像很大。映像是磁盘的总大小，而不仅仅是存储在其中的数据大小。多个磁盘映像的空间需求很快就会累积起来。
- en: Recovery of an individual user file is quite cumbersome. The disk image would
    need to be restored to a spare disk, mounted on a running system and, once found,
    copied to the desired location.
  id: totrans-31
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 恢复单个用户文件非常麻烦。需要将磁盘映像恢复到备用磁盘上，挂载到运行中的系统上，然后找到后，复制到所需的位置。
- en: Total system failures happen rarely and the perceived convenience and speed
    of an image restore is often outweighed by the flexibility of file system backups.
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 总体系统故障很少发生，映像恢复的感觉上便利和快速通常被文件系统备份的灵活性所抵消。
- en: File system backups
  id: totrans-33
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 文件系统备份
- en: Unlike image backups, file system backups understand the structure of the file
    system and consequently the data on the hard disk. Therefore, only the allocated
    portions of the disk are copied and the free space is not copied. The backup is
    for all files in the file system rather than sector by sector.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 与映像备份不同，文件系统备份了解文件系统的结构，因此也了解硬盘上的数据。因此，只复制分配的磁盘部分，而不复制空闲空间。备份是针对文件系统中的所有文件而不是按扇区复制。
- en: Because file system backups are done this way, it means that it is possible
    to copy only the files that have changed since the last backup, resulting in smaller
    subsequent backup files.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 因为文件系统备份是这样完成的，这意味着可以仅复制自上次备份以来发生更改的文件，从而产生较小的后续备份文件。
- en: 'In the event of a major hardware failure, the steps to restore a system are
    as follows:'
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 在发生重大硬件故障时，恢复系统的步骤如下：
- en: Replace or repair failed hardware.
  id: totrans-37
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 更换或修复故障的硬件。
- en: Install the Linux distribution.
  id: totrans-38
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 安装Linux发行版。
- en: Install the mail server applications in this book.
  id: totrans-39
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 安装本书中的邮件服务器应用程序。
- en: Apply any patches.
  id: totrans-40
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 应用任何补丁。
- en: Restore application configuration data backups.
  id: totrans-41
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 恢复应用程序配置数据备份。
- en: Restore user data backups.
  id: totrans-42
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 恢复用户数据备份。
- en: Reboot
  id: totrans-43
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 重新启动
- en: Compared to image backups, this approach will take slightly longer and involves
    more steps, but does have a number of advantages.
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 与映像备份相比，这种方法需要的时间略长，涉及的步骤更多，但确实具有许多优点。
- en: Replacement disks need not be of the same size or geometry.
  id: totrans-45
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 替换磁盘不需要与原来的大小或几何相同。
- en: As long as your Linux distribution supports the new hardware, there are no compatibility
    issues.
  id: totrans-46
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 只要您的Linux发行版支持新硬件，就不会出现兼容性问题。
- en: Backup file sizes are much smaller.
  id: totrans-47
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 备份文件大小要小得多。
- en: Restoration of individual files is much simpler.
  id: totrans-48
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 恢复单个文件要简单得多。
- en: As mentioned before, major system failures are not that common. Although the
    steps to complete a full restore are a little more cumbersome than image backups,
    the advantages of smaller and faster backups along with the ease of selective
    restoration of user data are significant.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 如前所述，主要系统故障并不常见。尽管完成完全恢复的步骤比映像备份更繁琐，但较小且更快的备份以及用户数据选择性恢复的优势是显著的。
- en: To reduce the likelihood of an unexpected disk failure, system tools are available
    to monitor the health of disk drives. For more information, visit [http://en.wikipedia.org/wiki/S.M.A.R.T.](http://en.wikipedia.org/wiki/S.M.A.R.T).
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 为了减少意外磁盘故障的可能性，系统工具可用于监视磁盘驱动器的健康状况。有关更多信息，请访问[http://en.wikipedia.org/wiki/S.M.A.R.T.](http://en.wikipedia.org/wiki/S.M.A.R.T)。
- en: Ad hoc backups
  id: totrans-51
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 临时备份
- en: File system backups back up whole file systems only, not individual files or
    directories. Occasionally we may wish to take a copy of just a few files after
    a significant configuration change to one of our applications.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 文件系统备份仅备份整个文件系统，而不是单个文件或目录。偶尔，我们可能希望在我们的应用程序的重大配置更改后复制几个文件的副本。
- en: Using standard Linux tools such as `tar` or `cp`, important changed files can
    be copied to a directory on a file system that is part of the normal backup schedule.
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 使用标准的Linux工具，如`tar`或`cp`，可以将重要的更改文件复制到正常备份计划的文件系统中的目录。
- en: What to back up
  id: totrans-54
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 备份什么
- en: The big question always associated with backups is, "What should we back up?"
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 备份始终伴随着一个大问题：“我们应该备份什么？”
- en: There are many things that contribute to our final decision. Of course, we want
    to back up our server's configuration because it is essential to our server's
    functionality. But we also want to back up the users' data because it is a valuable
    asset to our business. Is there a company policy that says people may use e-mail
    for private communication? If there is, should we back up those messages as well?
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 有许多因素影响我们最终的决定。当然，我们希望备份服务器的配置，因为这对服务器的功能至关重要。但我们也希望备份用户的数据，因为这是我们业务的宝贵资产。公司是否有政策允许人们使用电子邮件进行私人通信？如果有，我们是否也应该备份这些消息？
- en: We should only back up what we need to restore the system to a functional state.
    This saves space on the backup media and shortens the time required to perform
    a backup and restore if necessary.
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 我们应该只备份我们需要将系统恢复到正常状态所需的内容。这可以节省备份介质上的空间，并缩短执行备份和必要时恢复所需的时间。
- en: After all, the space on any backup media is limited and thus precious. It is
    more important to back up all the users' mails than to have a complete backup
    of the `/tmp` directory. Also, the less data we back up, the less time is required
    to perform the backup, thus returning our system's resources (CPU cycles, I/O
    bandwidth) more quickly to their main purpose—handling users' mails.
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 毕竟，备份介质上的空间是有限的，因此宝贵的。备份所有用户的邮件比完全备份“/tmp”目录更重要。此外，我们备份的数据越少，执行备份所需的时间就越少，因此更快地将系统资源（CPU周期、I/O带宽）返回到它们的主要用途——处理用户的邮件。
- en: 'The following is list of items we need to backup to get a working system:'
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 以下是我们需要备份以获得可用系统的项目列表：
- en: System inventory
  id: totrans-60
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 系统清单
- en: Installed software that the services require
  id: totrans-61
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 服务所需的已安装软件
- en: Software configuration files
  id: totrans-62
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 软件配置文件
- en: Users' credentials
  id: totrans-63
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 用户的凭据
- en: Users' mailboxes
  id: totrans-64
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 用户的邮箱
- en: Log files (for billing purposes and end user requests)
  id: totrans-65
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 日志文件（用于计费目的和最终用户请求）
- en: Postfix mail queue
  id: totrans-66
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Postfix邮件队列
- en: The following sections describe each of these items discussed.
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: 以下各节描述了讨论的每个项目。
- en: System inventory
  id: totrans-68
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 系统清单
- en: In the event of a partial or total hardware failure, it is useful to make a
    note of our current system layout. In most cases, replacement hardware will often
    be as good as, if not better, than our current setup. In order to restore our
    system, we will need to know how disks are partitioned and how the mount points
    organized. It would be difficult to restore our users' data onto a disk that is
    too small.
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 在部分或完全硬件故障的情况下，记录当前系统布局是有用的。在大多数情况下，替换硬件通常会和甚至更好地满足我们当前的设置。为了恢复我们的系统，我们需要知道磁盘如何分区以及挂载点的组织方式。将我们的用户数据恢复到一个太小的磁盘上将会很困难。
- en: 'Using the output from following commands, we will have enough information to
    recreate our disk layout:'
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 使用以下命令的输出，我们将有足够的信息来重新创建我们的磁盘布局：
- en: '[PRE0]'
  id: totrans-71
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: This command prints out the partition table for each disk and saves the output
    to a file.
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 该命令打印出每个磁盘的分区表，并将输出保存到文件中。
- en: '[PRE1]'
  id: totrans-73
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: This command appends the capacity and usage of each mount point to our file.
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 该命令将每个挂载点的容量和使用情况追加到我们的文件中。
- en: '[PRE2]'
  id: totrans-75
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: The `mount` command lists the current mount points, which we append to the file.
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: “mount”命令列出当前的挂载点，我们将其追加到文件中。
- en: Additional information may be in the file `/etc/fstab`, which we will backup
    later.
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 可能还有其他信息在文件“/etc/fstab”中，我们稍后会备份。
- en: Obtaining a list of installed software
  id: totrans-78
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 获取已安装软件的列表
- en: In order to restore our installed software, we need to have a list of software
    currently installed.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 为了恢复我们安装的软件，我们需要有当前安装的软件列表。
- en: In Debian, this is given by the following command. The `installed_software.txt`
    file contains the current state of which software on the system is installed/not
    installed.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 在Debian中，可以使用以下命令。文件“installed_software.txt”包含系统上已安装/未安装的软件的当前状态。
- en: '[PRE3]'
  id: totrans-81
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'With an RPM-based distribution, that would be:'
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 在基于RPM的发行版中，这将是：
- en: '[PRE4]'
  id: totrans-83
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: In a Debian-based system, this file can later be used to install the same set
    of software.
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 在基于Debian的系统中，稍后可以使用此文件安装相同的软件集。
- en: '[PRE5]'
  id: totrans-85
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: In the `dselect` utility, select `i` for `install` and then confirm the installation.
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 在“dselect”实用程序中，选择“i”进行“安装”，然后确认安装。
- en: 'With an RPM-based distribution, that would be:'
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 在基于RPM的发行版中，这将是：
- en: '[PRE6]'
  id: totrans-88
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: Note
  id: totrans-89
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: The commands just discussed list only the software installed via a package manager.
    If you have installed software from source, then make a note of the application
    and version you installed.
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 刚才讨论的命令仅列出通过软件包管理器安装的软件。如果您从源代码安装了软件，请记下您安装的应用程序和版本。
- en: System configuration files
  id: totrans-91
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 系统配置文件
- en: 'The server will not perform its expected duties without these. As a minimum,
    the configuration files that need to be backed up are:'
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 如果没有这些，服务器将无法执行预期的职责。至少需要备份的配置文件包括：
- en: '`/etc/courier:` This directory holds Courier-IMAP''s configuration data.'
  id: totrans-93
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: “/etc/courier:”该目录保存了Courier-IMAP的配置数据。
- en: '`/etc/postfix:` This directory holds Postfix''s configuration data.'
  id: totrans-94
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: “/etc/postfix:”该目录保存了Postfix的配置数据。
- en: The directory tree `/etc` includes items such as network settings, routings,
    and much more, which we would otherwise need to memorize. It is recommended to
    backup the whole `/etc` tree.
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 目录树“/etc”包括诸如网络设置、路由等项目，我们否则需要记住。建议备份整个“/etc”树。
- en: Note
  id: totrans-96
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: If you have installed software from source with configuration files in non-standard
    locations, be sure to include those configuration files in your backup candidate
    list.
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您从非标准位置安装了带有配置文件的软件，请确保将这些配置文件包含在备份候选列表中。
- en: Authentication data
  id: totrans-98
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 认证数据
- en: Users cannot authenticate themselves using their username and password combination
    without this. The data that needs to be backed up depends on the way the authentication
    is done and would include three files`—/etc/passwd, /etc/shadow`, and `/etc/group`,
    along with a MySQL database (if the users' credentials are stored in that database).
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 用户如果没有这些，将无法使用他们的用户名和密码组合进行身份验证。需要备份的数据取决于认证的方式，并且可能包括三个文件“/etc/passwd，/etc/shadow”和“/etc/group”，以及一个MySQL数据库（如果用户的凭据存储在该数据库中）。
- en: The users' mailboxes
  id: totrans-100
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 用户的邮箱
- en: This is where the users' mails are stored. This includes the whole directory
    tree of `/home` and below. This is the bulk of our backup—vast amounts of data.
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 这是用户的邮件存储位置。这包括整个“/home”及其子目录树。这是我们备份的主要内容——大量的数据。
- en: Log files
  id: totrans-102
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 日志文件
- en: We should at least store the logs generated by Postfix and Courier. These will
    be needed to process user requests such as, "Where did my mail go?". If users
    are billed based on mail volume sent and/or received, we will definitely need
    a backup of Postfix's logs.
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 我们至少应该存储由Postfix和Courier生成的日志。这些将需要用于处理用户请求，比如“我的邮件去哪了？”。如果用户根据发送和/或接收的邮件量计费，我们肯定需要备份Postfix的日志。
- en: As Postfix's and Courier's logs are normally written by the system's `syslogd`
    daemon, we need to check the `/etc/syslog.conf` file to see where these logs go.
    Both programs log their messages with the `syslog` mail facility.
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 由于Postfix和Courier的日志通常是由系统的`syslogd`守护程序写入的，我们需要检查`/etc/syslog.conf`文件，看看这些日志去哪里。这两个程序都使用`syslog`邮件设施记录它们的消息。
- en: To ensure complete coverage, it is wise to back up the whole directory tree
    of `/var/log`.
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 为了确保完全覆盖，最好备份`/var/log`的整个目录树。
- en: The mail queue
  id: totrans-106
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 邮件队列
- en: It may or may not make sense to back up the Postfix queue of a working system,
    depending on the situation.
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 根据情况，备份工作系统的Postfix队列可能有意义，也可能没有意义。
- en: With Postfix, e-mail messages hit the disk at least twice.
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 使用Postfix，电子邮件消息至少会两次进入磁盘。
- en: The first time that the e-mail messages hit your drive is when they are being
    accepted by Postfix; they are written to Postfix's `queue_directory` before delivery
    continues.
  id: totrans-109
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 电子邮件消息第一次到达您的驱动器是在被Postfix接受时；它们被写入Postfix的`queue_directory`，然后交付继续进行。
- en: Note
  id: totrans-110
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: More disk I/O may be generated by a virus scanner or a program that detects
    spam (for example, `clamav` and `spamassassin`).
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 病毒扫描程序或检测垃圾邮件的程序（例如`clamav`和`spamassassin`）可能会产生更多的磁盘I/O。
- en: If it's mail for local domains, our server is the final destination for these
    mails and their lifespan in the `queue_directory` is extremely short. They hit
    the queue, just to be delivered to the user's mailbox immediately afterwards.
    That's the second time they hit the disk.
  id: totrans-112
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果是本地域的邮件，我们的服务器是这些邮件的最终目的地，在`queue_directory`中的寿命极短。它们进入队列，然后立即传递到用户的邮箱。这是它们第二次进入磁盘。
- en: 'If it''s mail that goes to other domains (because the server acts as a relay),
    then Postfix will immediately contact the recipient''s mail server and try to
    deliver the message there. Only in case of problems will the queue ever contain
    a significant number of e-mails not yet delivered. These problems are:'
  id: totrans-113
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果是发往其他域的邮件（因为服务器充当中继），那么Postfix将立即联系收件人的邮件服务器，并尝试在那里传递消息。只有在出现问题的情况下，队列中才会包含大量尚未传递的电子邮件。这些问题包括：
- en: '**The** `content_filter` **is slow or not operational:** For example, `clamsmtp`
    or any other product.'
  id: totrans-114
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`content_filter`很慢或者无法运行：例如`clamsmtp`或其他产品。'
- en: '**Remote sites have problems:** Large free e-mail providers often have problems
    and thus may not be able to accept our e-mails immediately.'
  id: totrans-115
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**远程站点存在问题：**大型免费电子邮件提供商经常出现问题，因此可能无法立即接受我们的电子邮件。'
- en: In both these cases, the deferred queue will fill up with mail that's still
    to be delivered and that should obviously be backed up in case of a failure. If
    the server is very busy, there may be quite a bit of deferred mail in the queue.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 在这两种情况下，延迟队列将填满尚未传递的邮件，显然在发生故障时应该备份。如果服务器非常忙，队列中可能会有相当多的延迟邮件。
- en: The Postfix mail queue includes the directory tree `/var/spool/postfix` and
    below.
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: Postfix邮件队列包括目录树`/var/spool/postfix`及其子目录。
- en: What not to back up
  id: totrans-118
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 不需要备份的内容
- en: We do not need to back up all of the installed binaries as these can simply
    be reinstalled using the aforementioned "list of installed software". Of course
    this assumes that the installation media is available when we need to reconstruct
    our system. As security conscious administrators, we keep our system up-to-date
    by installing the vendors' patches. Over the course of time, the versions of the
    installed and subsequently patched software will differ significantly from the
    versions that came on the installation media. If these updates can be installed
    via the Internet (for example using Red Hat's up2date or Debian apt-get), we don't
    have to keep them on site.
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 我们不需要备份所有已安装的二进制文件，因为这些可以通过前面提到的“已安装软件列表”简单地重新安装。当我们需要重建系统时，这当然假定安装介质是可用的。作为注重安全的管理员，我们通过安装供应商的补丁来保持系统的最新状态。随着时间的推移，已安装和随后打补丁的软件版本将与安装介质上的版本有很大不同。如果这些更新可以通过互联网安装（例如使用Red
    Hat的up2date或Debian的apt-get），我们就不必将它们保存在现场。
- en: Backing up users' e-mail
  id: totrans-120
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 备份用户的电子邮件
- en: We will be using dump to backup the whole partition containing our mailboxes.
    The dump command copies files on a file system to a specified disk, tape, or other
    media.
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将使用dump来备份包含我们邮箱的整个分区。dump命令将文件系统上的文件复制到指定的磁盘、磁带或其他媒体。
- en: 'Some of the reasons for using it are:'
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 使用它的一些原因是：
- en: It is incredibly fast (in my tests, the network is the bottleneck)
  id: totrans-123
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它非常快（在我的测试中，网络是瓶颈）
- en: It is simple (one command suffices)
  id: totrans-124
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它很简单（一个命令就足够了）
- en: It can run unattended (for example, as `cron` job)
  id: totrans-125
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它可以无人值守运行（例如，作为`cron`作业）
- en: It does not need any additional software to be installed
  id: totrans-126
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它不需要安装任何额外的软件
- en: It does not need a GUI
  id: totrans-127
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它不需要图形用户界面
- en: It is very mature having been around since AT&T UNIX Version 6, circa 1975
  id: totrans-128
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 自1975年左右的AT&T UNIX版本6以来，它已经非常成熟了
- en: The `restore` command performs the opposite of `dump`. A backup of a file system
    taken using `dump` can be restored as the complete file system or you can selectively
    restore certain files or directories.
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: '`restore`命令执行与`dump`相反的操作。使用`dump`备份的文件系统可以作为完整的文件系统进行恢复，或者可以选择性地恢复某些文件或目录。'
- en: Mail storage
  id: totrans-130
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 邮件存储
- en: We recommend putting the mailboxes (`/home`) on a separate partition for many
    reasons.
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: 我们建议将邮箱（`/home`）放在单独的分区上，有很多原因。
- en: File system maintenance can be performed independently from other parts of the
    system (simply unmount `/home`, perform an `fsck`, mount it again).
  id: totrans-132
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 文件系统维护可以独立于系统的其他部分进行（简单地卸载`/home`，执行`fsck`，然后再次挂载）。
- en: It is possible to put that partition on a separate disk or on a RAID, thus separating
    the users' I/O (on that partition) from the system's I/O (logs, mail queue, virus
    scanner).
  id: totrans-133
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 可以将该分区放在单独的磁盘或RAID上，从而将用户的I/O（在该分区上）与系统的I/O（日志、邮件队列、病毒扫描程序）分开。
- en: 'Most important of all:'
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 最重要的是：
- en: Using `dump/restore`, we can dump whole partitions. (OK, that's not entirely
    true, but a `dump/restore` is done easily only with whole partitions.)
  id: totrans-135
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用`dump/restore`，我们可以转储整个分区。（好吧，这并不完全正确，但是只有整个分区才能轻松进行`dump/restore`。）
- en: An overfull partition containing the mailboxes will not negatively influence
    the system's ability to write log files or other important system information.
    If all the data (logs, mailboxes, the system files) were on a single partition,
    filling this partition would cause logging to stop.
  id: totrans-136
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 包含邮箱的超额分区不会对系统写入日志文件或其他重要系统信息产生负面影响。如果所有数据（日志、邮箱、系统文件）都在一个分区上，填满这个分区将导致日志记录停止。
- en: Both Courier and Postfix use the Maildir format for users' mailboxes. They store
    each piece of mail as a separate file allowing easy restore operations even for
    single mails.
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: Courier和Postfix都使用Maildir格式存储用户邮箱。它们将每封邮件存储为单独的文件，即使对于单个邮件，也可以轻松进行恢复操作。
- en: Backup operations are very easy with the Maildir format.
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: 使用Maildir格式非常容易进行备份操作。
- en: '"Back up an e-mail" corresponds to "back up a file to the backup media".'
  id: totrans-139
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: “备份电子邮件”对应于“将文件备份到备份介质”。
- en: '"Restore an e-mail" corresponds to "restore a file from the backup media".'
  id: totrans-140
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: “恢复电子邮件”对应于“从备份介质中恢复文件”。
- en: '"Back up a mailbox" corresponds to "back up a Maildir and all its subdirectories
    to the backup media".'
  id: totrans-141
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: “备份邮箱”对应于“将Maildir及其所有子目录备份到备份介质”。
- en: '"Restore a mailbox" corresponds to "restore a Maildir and all its subdirectories
    from the backup media".'
  id: totrans-142
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: “恢复邮箱”对应于“从备份介质中恢复Maildir及其所有子目录”。
- en: Using dump
  id: totrans-143
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用dump
- en: There are basically two approaches to backing up data. The simple method stores
    all data, whenever we perform a backup. This is called a full backup. Its advantage
    is the simplicity, and its main disadvantage is the sheer amount of data that
    needs to be stored on the backup media. This problem is addressed by the concept
    of the incremental backup. An incremental backup saves the changes only since
    the last incremental (or full) backup.
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 基本上有两种备份数据的方法。简单的方法是在每次备份时存储所有数据。这称为完整备份。它的优点是简单性，主要缺点是需要存储在备份介质上的大量数据。这个问题通过增量备份的概念得到解决。增量备份仅保存自上次增量（或完整）备份以来的更改。
- en: If the space on the backup media allows for a full backup everyday, we can do
    that for the sake of simplicity. That way we only need to look at the last intact
    backup to restore all the data.
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: 如果备份介质上的空间允许每天进行完整备份，我们可以为了简单起见这样做。这样我们只需要查看最后一个完整备份来恢复所有数据。
- en: Incremental backups are simple. The backup software needs to back up only those
    files and directories that have recently been created or changed since the last
    backup.
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: 增量备份很简单。备份软件只需要备份自上次备份以来最近创建或更改的文件和目录。
- en: 'If the space doesn''t allow for that simple solution, we could use this scheme
    instead:'
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 如果空间不允许使用这种简单的解决方案，我们可以使用以下方案：
- en: Perform a full backup every week
  id: totrans-148
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 每周执行一次完整备份
- en: Do six incremental backups, one each day
  id: totrans-149
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 每天进行六次增量备份
- en: If we need to restore from scratch, restore the last full backup, then restore
    up to six incremental backups. That way we lose at most one day of mail which
    is as close as we can get with a daily backup interval. Later we shall see more
    sophisticated incremental backup strategies to reduce the number of incremental
    restorations required after restoring a full dump.
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 如果我们需要从头开始恢复，首先恢复最后一个完整备份，然后恢复最多六个增量备份。这样我们最多会丢失一天的邮件，这是我们在每日备份间隔下能够做到的。稍后我们将看到更复杂的增量备份策略，以减少恢复完整转储后需要的增量恢复次数。
- en: For detailed information on `dump(8)` and `restore(8)` see the system manual
    pages.
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 有关“dump(8)”和“restore(8)”的详细信息，请参阅系统手册页。
- en: We shall now look at the actual task of backing up the mailboxes using the `dump`
    command.
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们将看一下使用“dump”命令备份邮箱的实际任务。
- en: Full dump
  id: totrans-153
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 完整转储
- en: We're now about to perform a full backup of the partition containing our users'
    Maildirs. In this example, this partition will be `/dev/sdb1` (the first partition
    of our SATA disk). So, we will want to back up `/dev/sdb1`.
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 我们现在将执行包含用户Maildirs的分区的完整备份。在这个例子中，这个分区将是“/dev/sdb1”（我们的SATA磁盘的第一个分区）。因此，我们将要备份“/dev/sdb1”。
- en: 'To find out which partition we need to back up on our system, we need to examine
    the output of the `mount` command:'
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: 要找出我们需要在系统上备份的分区，我们需要检查“mount”命令的输出：
- en: '[PRE7]'
  id: totrans-156
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: '[PRE8]'
  id: totrans-157
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: As we can see, `/home` is the partition of `/dev/sdb1`.
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以看到，“/home”是“/dev/sdb1”的分区。
- en: Our plan is to use the `dump` tool to create the backup for this partition.
    This backup data needs to go to our backup medium, which could be another disk,
    a tape or, in our case, a disk in the remote backup server.
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: 我们的计划是使用“dump”工具为这个分区创建备份。这些备份数据需要传输到我们的备份介质，可以是另一块磁盘、磁带，或者在我们的情况下是远程备份服务器上的磁盘。
- en: There are various methods to get data across the network, one of them being
    `ssh`. It is a network protocol that facilitates secure communications between
    two devices.
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: 有各种方法可以在网络上传输数据，其中之一是“ssh”。这是一种网络协议，可以促进两个设备之间的安全通信。
- en: To get our backup data across the network onto another disk in the backup server,
    we use the power of Linux to marry the `dump` program and `ssh` protocol.
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: 为了将我们的备份数据通过网络传输到备份服务器中的另一块磁盘，我们利用Linux的强大功能来结合“dump”程序和“ssh”协议。
- en: The output of the `dump` program will be fed into `gzip` to compress the dump,
    then fed to `ssh`, which in turn spawns another program `dd` on the backup server
    to finally write that data onto its disk.
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: “dump”程序的输出将被输入到“gzip”中以压缩转储，然后传输到“ssh”，然后在备份服务器上生成另一个“dd”程序，最终将数据写入其磁盘。
- en: The following lines of code give a full dump of the partition containing the
    mailboxes to a file on a remote system. We are assuming that the mailboxes are
    on the partition `/dev/sdb1` mounted as `/home`.
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: 以下代码行将分区中的邮箱完全转储到远程系统上的文件。我们假设邮箱位于挂载为“/home”的分区“/dev/sdb1”上。
- en: 'As root, run the following commands:'
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: 以root用户身份运行以下命令：
- en: '[PRE9]'
  id: totrans-165
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'The command looks complicated, so let''s break it down in each of the steps:'
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: 该命令看起来很复杂，所以让我们逐步分解每个步骤：
- en: '`dump -0 -u -b 1024 -f -` performs a level `0` (`full`) dump of the partition
    `/dev/sdb1` (which contains `/home` in our example) using a block size of `1024`
    (for maximum performance) and updates (`-u`) the file `/var/lib/dumpdates` after
    the dump had been successful. The `-u` option is important because it records
    the date and time of this dump, so subsequent incremental dumps can determine
    which files have been changed or created since the last dump. The output of the
    dump goes to a file (`-f`) specified as (`-`), which indicates `stdout`, the standard
    output.'
  id: totrans-167
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`dump -0 -u -b 1024 -f -`执行分区`/dev/sdb1`（在我们的示例中包含`/home`）的级别`0`（`full`）转储，使用块大小`1024`（以获得最佳性能），并在成功转储后更新（`-u`）文件`/var/lib/dumpdates`。`-u`选项很重要，因为它记录了此转储的日期和时间，因此随后的增量转储可以确定自上次转储以来已更改或创建的文件。转储的输出进入指定为（`-`）的文件（`-f`），该文件表示`stdout`，标准输出。'
- en: As the `dump` data goes to standard output (`stdout`), we can pipe that output
    into `gzip` to compress the size of the dump. The `-c` option tells `gzip` to
    write the compressed output to `stdout`.
  id: totrans-168
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 由于`dump`数据进入标准输出（`stdout`），我们可以将该输出管道传输到`gzip`以压缩转储的大小。`-c`选项告诉`gzip`将压缩输出写入`stdout`。
- en: The compressed level 0 dump output is then piped to the `ssh` command, which
    makes a remote connection to the system `backup-host.domain.com` logging in as
    `user`. Once logged in, the remote system executes the `dd` command. We recommend
    the use of the key-based authentication scheme that `ssh` offers. This way, the
    backup can run unattended, as nobody has to enter the password needed to log in
    as `user` on `backup-host.domain.com`.
  id: totrans-169
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 然后，压缩级别0的转储输出被传送到`ssh`命令，该命令与系统`backup-host.domain.com`建立远程连接，以`user`身份登录。一旦登录，远程系统执行`dd`命令。我们建议使用`ssh`提供的基于密钥的身份验证方案。这样，备份可以无人值守运行，因为没有人需要输入登录`backup-host.domain.com`上的`user`所需的密码。
- en: On the remote server, the final step is to write the output using the `dd` command.
    The output filename is specified by the `of` option to `dd`. The output filename
    has been constructed in such a way as to easily identify the file system, the
    date and time the dump was taken, the level of the dump, and the suffix `.gz`
    to indicate that this dump file has been compressed. The filename portion `$(date
    +%Y%m%d%H%M%S`) is a shell expansion performed on the local system (not the remote
    system) to output the current date and time in `YYYYMMDDHHMMSS` format. The final
    output filename will be something similar to `20090727115323.dump.0.gz`.
  id: totrans-170
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在远程服务器上，最后一步是使用`dd`命令写入输出。输出文件名由`dd`的`of`选项指定。输出文件名已经构造成易于识别文件系统、转储日期和时间、转储级别以及后缀`.gz`以指示此转储文件已被压缩。文件名部分`$(date
    +%Y%m%d%H%M%S`)是在本地系统上执行的shell扩展（而不是远程系统），以输出当前日期和时间以`YYYYMMDDHHMMSS`格式。最终的输出文件名将类似于`20090727115323.dump.0.gz`。
- en: For more information on each of the commands, see the system manual pages for
    `dump, gzip, ssh, dd`, and `date`.
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: 有关每个命令的更多信息，请参阅`dump、gzip、ssh、dd`和`date`的系统手册页面。
- en: 'The output will look similar to the following:'
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: 输出将类似于以下内容：
- en: '![Full dump](img/8648_10_01.jpg)'
  id: totrans-173
  prefs: []
  type: TYPE_IMG
  zh: '![完整转储](img/8648_10_01.jpg)'
- en: This next example will simply write the backup data to a directory no `stdout`
    wizardry this time!
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: 下一个示例将简单地将备份数据写入一个目录，这次没有`stdout`的巫术！
- en: 'The following lines of code give a full dump of the partition containing the
    mailboxes to a file on a separate disk to hold the backups:'
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: 以下代码行将完整转储包含邮箱的分区写入一个单独的磁盘上的文件以保存备份：
- en: '[PRE10]'
  id: totrans-176
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: This is, of course, much faster and simpler than sending all the data across
    the network via `ssh` with the data encryption and decryption carried out during
    the transit (which takes a lot of time and CPU power), but if our server is burnt
    to cinders, a backup on a built-in hard drive won't help at all.
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: 当然，这比通过`ssh`将所有数据加密并在传输过程中进行解密（这需要大量时间和CPU功率）快得多简单得多，但如果我们的服务器被烧毁，内置硬盘上的备份将毫无帮助。
- en: Keep in mind that `/backupdirectory/fulldump` can also be an NFS mount or an
    SMB mount. This would give you both, the advantage of a simple command line and
    an off site backup. So, make sure you do have an offsite backup. It's easy enough
    either way.
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: 请记住，`/backupdirectory/fulldump`也可以是NFS挂载或SMB挂载。这将为您提供简单命令行和远程备份的优势。因此，请确保您有远程备份。无论哪种方式都很容易。
- en: Incremental dumps
  id: totrans-179
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 增量转储
- en: Incremental dumps are performed in exactly the same way as a full dump except
    that we change the level option from 0 to either 1, 2, or 3, and so on depending
    on how many changes we wish to back up. Remember, a level number above 0 tells
    dump to copy all files new or modified since the last dump of a lower level. This
    is best illustrated with some examples. For clarity, we shall be simply dumping
    to a file, but in practice we would normally use the same sequence of commands
    as discussed using `gzip, ssh, dd`, and so on.
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: 增量转储的执行方式与完整转储完全相同，只是我们将级别选项从0更改为1、2或3，等等，具体取决于我们希望备份多少更改。请记住，级别数字大于0告诉转储复制自上次较低级别转储以来新建或修改的所有文件。这最好通过一些示例来说明。为了清晰起见，我们将简单地转储到一个文件中，但在实践中，我们通常会使用与使用`gzip、ssh、dd`等相同的命令序列。
- en: 'Let''s assume our level 0 dump was taken on Sunday night. The first incremental
    dump (level 1, indicated by the `-1` option) is then taken on Monday night like
    this:'
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
  zh: 假设我们的级别0转储是在星期日晚上进行的。第一个增量转储（级别1，由`-1`选项指示）然后在星期一晚上进行，如下所示：
- en: '[PRE11]'
  id: totrans-182
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: This saves everything that is new or has changed since the last full dump to
    `mon.dump.1`. This dump file will be much smaller than the previous full dump
    containing only the changes made on Monday. Assume, on the following day we repeat
    this level 1 dump
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: 这将保存自上次完整转储以来新建或更改的所有内容到`mon.dump.1`。这个转储文件将比之前的完整转储小得多，只包含星期一的更改。假设在第二天我们重复这个级别1转储
- en: '[PRE12]'
  id: totrans-184
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: The second incremental dump, `tue.dump.1`, will contain all the changes made
    on Monday and Tuesday because a level 1 dump will back up everything that has
    changed since the level 0 dump. In order to recover the system back to the latest
    backup, we would have to restore only Tuesday's backup. Therefore one might consider
    that the dump taken on Monday is now obsolete; however, should a user wish to
    recover a file created on a Monday and accidentally deleted on a Tuesday, our
    first backup is still required.
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
  zh: 第二个增量转储“tue.dump.1”将包含周一和周二所做的所有更改，因为1级转储将备份自0级转储以来发生的所有更改。为了将系统恢复到最新的备份，我们只需要恢复周二的备份。因此，有人可能认为周一的转储现在已经过时；然而，如果用户希望恢复在周一创建并在周二意外删除的文件，我们仍然需要第一次备份。
- en: Repeatedly performing level 1 dumps allows for very quick recovery as only two
    dump files need to be restored, the level 0 dump and the latest level 1 dump.
    The downside is that each subsequent dump file grows in size and takes longer
    and longer to complete. This scheme is sometimes called differential backup.
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: 反复执行1级转储允许非常快速的恢复，因为只需要恢复两个转储文件，即0级转储和最新的1级转储。缺点是每个后续转储文件的大小都会增加，并且完成时间会越来越长。这种方案有时被称为差异备份。
- en: An alternative is to use additional dump levels to reduce the size of each backup
    file.
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
  zh: 另一种选择是使用额外的转储级别来减少每个备份文件的大小。
- en: 'For example, the following sequence of commands perform a number of incremental
    backups after our initial level 0 dump:'
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，以下一系列命令在我们的初始0级转储后执行了许多增量备份：
- en: '[PRE13]'
  id: totrans-189
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: In this example, each day's dump file contains only the new and changed files
    since the previous dump. Each dump operation from Tuesday onwards will complete
    more quickly and result in smaller file sizes than in our previous example. However,
    recovery will take longer. To recover to the latest backup, we would need to restore
    our full dump, then restore each of the incremental dumps from Monday through
    Thursday in order.
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个例子中，每天的转储文件只包含自上一个转储以来的新文件和更改文件。从周二开始的每个转储操作将更快地完成，并且生成的文件大小比我们之前的例子要小。然而，恢复将需要更长时间。要恢复到最新的备份，我们需要恢复完整的转储，然后按顺序恢复从周一到周四的每个增量转储。
- en: 'Trying these examples on a small temporary file system might be a useful exercise
    in order to understand the interaction between different levels of dumps. Each
    dump file can be examined using the following command:'
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: 在一个小的临时文件系统上尝试这些示例可能是一个有用的练习，以便了解不同级别的转储之间的交互。可以使用以下命令检查每个转储文件：
- en: '[PRE14]'
  id: totrans-192
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: For the curious, the file `/var/lib/dumpdates` can also be examined after each
    dump to verify the date and level of each dump.
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: 对于好奇的人，文件`/var/lib/dumpdates`也可以在每次转储后进行检查，以验证每次转储的日期和级别。
- en: As was stated at the beginning of this chapter, everything is a trade-off, so
    choosing the appropriate backup strategy involves balancing media costs, personnel
    costs, and recovery time.
  id: totrans-194
  prefs: []
  type: TYPE_NORMAL
  zh: 正如本章开头所述，一切都是一种权衡，因此选择适当的备份策略涉及平衡媒体成本、人员成本和恢复时间。
- en: So far, all of our backups have been performed with the disks mounted, which
    makes verifying the backup impossible. The reason for this is that data we were
    just backing up is constantly in flux. Remember that each file represents an e-mail.
    Whenever a user gets new mail or deletes old mail, the state of the file system
    changes. Users constantly get mail, read mail, and delete mail, even when they're
    about to perform a backup.
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
  zh: 到目前为止，我们所有的备份都是在挂载的磁盘上执行的，这使得验证备份是不可能的。原因是我们刚刚备份的数据不断变化。请记住，每个文件代表一封电子邮件。每当用户收到新邮件或删除旧邮件时，文件系统的状态都会发生变化。用户不断地收邮件、阅读邮件和删除邮件，即使在进行备份之前也是如此。
- en: The `restore` command does have the `-C` option to compare a dump with the original
    disk contents, but this is sensible only if the file system we are dumping is
    unmounted. In most cases, unmounting each file system is not practical and would
    interrupt service significantly.
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
  zh: '`restore`命令确实有`-C`选项，用于将转储与原始磁盘内容进行比较，但只有在我们转储的文件系统未挂载时才是明智的。在大多数情况下，卸载每个文件系统是不切实际的，并且会显著中断服务。'
- en: Using restore
  id: totrans-197
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用restore
- en: All the data that has been backed up will need to be restored before it can
    be used.
  id: totrans-198
  prefs: []
  type: TYPE_NORMAL
  zh: 所有已备份的数据在使用之前都需要被恢复。
- en: This can be done in two ways, interactively or non interactively.
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
  zh: 这可以通过两种方式完成，交互式或非交互式。
- en: Interactive restore
  id: totrans-200
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 交互式恢复
- en: To restore data from a dump interactively, we need to copy the dump from our
    backup media onto our system or perform the selection of files to restore on the
    computer we stored the dump in. If we are extracting only a few files, this can
    be performed in a temporary directory and the resulting files can be moved to
    the correct location once the restore has been completed. For larger numbers of
    files, for example a whole user account, we can `cd` to the ultimate destination
    before starting the restore.
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
  zh: 要交互地从转储中恢复数据，我们需要将转储从备份介质复制到我们的系统上，或者在存储转储的计算机上执行文件选择以进行恢复。如果我们只提取几个文件，可以在临时目录中执行此操作，并在恢复完成后将生成的文件移动到正确的位置。对于更多的文件，例如整个用户帐户，我们可以在开始恢复之前`cd`到最终目的地。
- en: 'For an interactive restore, run the following command:'
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: 对于交互式恢复，请运行以下命令：
- en: '[PRE15]'
  id: totrans-203
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: The`>` is the prompt of the interactive interface to restore. It is a spartan
    interface with limited commands available. It allows navigation through the dump
    as if we were on a live file system. Use `ls` and `cd` to show directory contents
    or change directories. Issue `?` to get a list of supported commands.
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
  zh: '`>`是交互式接口的提示符，用于恢复。这是一个简陋的界面，可用的命令有限。它允许通过转储进行导航，就好像我们在实时文件系统上一样。使用`ls`和`cd`来显示目录内容或更改目录。输入`?`以获取支持的命令列表。'
- en: 'Once we have found the data we want to restore, type either of the following
    commands:'
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦找到要恢复的数据，输入以下命令之一：
- en: '`> add directoryname`'
  id: totrans-206
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`> add directoryname`'
- en: '`> add filename`'
  id: totrans-207
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`> add filename`'
- en: This adds the particular `directoryname` and all data below it, or just the
    `filename` to the set of files that need to be restored. Repeat for additional
    files or directories.
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
  zh: 这将把特定的“目录名”和其下所有数据，或者只是“文件名”添加到需要还原的文件集中。对于其他文件或目录重复此操作。
- en: Once we are done with adding all the data that needs to be recovered, we issue
    the `extract` command.
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦我们添加了所有需要恢复的数据，我们发出`extract`命令。
- en: '![Interactive restore](img/8648_10_02.jpg)'
  id: totrans-210
  prefs: []
  type: TYPE_IMG
  zh: '![交互式还原](img/8648_10_02.jpg)'
- en: The output shown in the previous screenshot relates to volume numbers on magnetic
    tape. A dump file may have been split over a multi-volume tape set, but when dealing
    with dump files on hard disk, choose volume `1`. We would normally select `n`
    to retain the current ownership and permissions of the working directory.
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
  zh: 前一个屏幕截图中显示的输出与磁带上的卷号有关。一个转储文件可能已经分割成多卷磁带集，但在处理硬盘上的转储文件时，选择卷`1`。通常我们会选择`n`以保留工作目录的当前所有权和权限。
- en: 'Once the necessary files have been extracted, issue the following command:'
  id: totrans-212
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦必要的文件被提取出来，执行以下命令：
- en: '[PRE16]'
  id: totrans-213
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: Do this with the last full dump and each incremental dump in order, up to the
    last incremental dump available. This makes sure that we restore all changes since
    the last full backup.
  id: totrans-214
  prefs: []
  type: TYPE_NORMAL
  zh: 对于最后一个完整转储和每个增量转储，按顺序进行，直到可用的最后一个增量转储。这样可以确保我们还原自上次完整备份以来的所有更改。
- en: Note
  id: totrans-215
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: If the data we are restoring hasn't changed between two dumps, we will not find
    it in the second incremental dump at all.
  id: totrans-216
  prefs: []
  type: TYPE_NORMAL
  zh: 如果我们要还原的数据在两次转储之间没有发生变化，我们在第二个增量转储中将找不到它。
- en: Non-interactive restore across the network
  id: totrans-217
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 网络上的非交互式还原
- en: The manual approach makes sense if we want to restore just a few mailboxes.
    If we want a complete recovery of all mailboxes, we need to use the non-interactive
    scheme. This doesn't need additional storage space on the target system, as the
    dump data is being piped across the network.
  id: totrans-218
  prefs: []
  type: TYPE_NORMAL
  zh: 如果我们只想还原几个邮箱，手动方法是有意义的。如果我们需要完全恢复所有邮箱，我们需要使用非交互式方案。这不需要目标系统上的额外存储空间，因为转储数据正在通过网络传输。
- en: 'Recreate the file system on our newly installed, freshly partitioned hard disk
    and mount it:'
  id: totrans-219
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们新安装的、新分区的硬盘上重新创建文件系统并挂载它：
- en: '[PRE17]'
  id: totrans-220
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: The `-j` option to `mke2fs` creates a ext3 journaling file system on `/dev/sdb1`
    and it's mounted as `/home`.
  id: totrans-221
  prefs: []
  type: TYPE_NORMAL
  zh: '`-j`选项对`mke2fs`在`/dev/sdb1`上创建一个ext3日志文件系统，并将其挂载为`/home`。'
- en: Please note that we need to recreate the data using the same file system you
    used when creating the backup!
  id: totrans-222
  prefs: []
  type: TYPE_NORMAL
  zh: 请注意，我们需要使用创建备份时使用的相同文件系统来重新创建数据！
- en: Let the restore begin.
  id: totrans-223
  prefs: []
  type: TYPE_NORMAL
  zh: 让还原开始。
- en: '[PRE18]'
  id: totrans-224
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: Just like when we performed the backup across the network, we now do the same
    with the restore.
  id: totrans-225
  prefs: []
  type: TYPE_NORMAL
  zh: 就像我们在网络上执行备份时一样，现在我们也要用还原来做同样的操作。
- en: '[PRE19]'
  id: totrans-226
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: The previous line executes the following command as the `user` on the `backup-host.domain.com`
    host, although this time with the `dd` command using the `if` option to read the
    compressed dump file and sending the output to `stdout`.
  id: totrans-227
  prefs: []
  type: TYPE_NORMAL
  zh: 前一行将以下命令作为`backup-host.domain.com`主机上的`user`执行，尽管这次使用`dd`命令使用`if`选项读取压缩的转储文件并将输出发送到`stdout`。
- en: '[PRE20]'
  id: totrans-228
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: The output is piped across the network and fed into `gunzip` to uncompress the
    file and ultimately piped to `restore -r -f -`. The `-r` option instructs restore
    to rebuild the whole file system from the dump file's contents to the original
    locations using the original permissions and ownerships. If you wish, you may
    use the `-v` option with `restore` for verbose output.
  id: totrans-229
  prefs: []
  type: TYPE_NORMAL
  zh: 输出通过网络传输并输入到`gunzip`中解压文件，最终传输到`restore -r -f -`。`-r`选项指示还原从转储文件的内容到原始位置使用原始权限和所有权重新构建整个文件系统。如果需要，可以使用`restore`的`-v`选项进行详细输出。
- en: Note
  id: totrans-230
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: It is necessary to ensure we are located in the correct directory before issuing
    the `restore` command, otherwise serious damage may occur to an existing file
    system.
  id: totrans-231
  prefs: []
  type: TYPE_NORMAL
  zh: 在发出`restore`命令之前，必须确保我们位于正确的目录中，否则可能会对现有文件系统造成严重损坏。
- en: 'The output from the restore will look something like this:'
  id: totrans-232
  prefs: []
  type: TYPE_NORMAL
  zh: 还原的输出看起来会像这样：
- en: '[PRE21]'
  id: totrans-233
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: The warning about the existence of `lost+found` is normal and can be safely
    ignored.
  id: totrans-234
  prefs: []
  type: TYPE_NORMAL
  zh: 关于`lost+found`存在的警告是正常的，可以安全地忽略。
- en: This operation should then be repeated for each incremental dump file that is
    required to return the system to the required state. If we restore the incremental
    dumps in the wrong order, we will get the error "Incremental tape too low" or
    "Incremental tape too high". Once we have received one of these errors, we cannot
    complete the full restore and must restart the restoration from the level 0 dump.
  id: totrans-235
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，这个操作应该对每个需要将系统恢复到所需状态的增量转储文件重复进行。如果我们以错误的顺序还原增量转储，将会出现错误“增量磁带太低”或“增量磁带太高”。一旦我们收到这些错误中的一个，就无法完成完整的还原，必须从级别0的转储重新开始还原。
- en: When using the `-r` option to the restore command, it will create the file `restoresymtable`.
    This is a checkpoint file that the restore command uses when we are restoring
    multiple dumps as an aid to help the next `restore` command determine which directories
    or files need updating, creating, or deleting.
  id: totrans-236
  prefs: []
  type: TYPE_NORMAL
  zh: 当使用`-r`选项执行还原命令时，它将创建文件`restoresymtable`。这是一个检查点文件，还原命令在还原多个转储时使用它来帮助下一个`restore`命令确定哪些目录或文件需要更新、创建或删除。
- en: Once the file system has been completely restored and verified, we should remove
    the `restoresymtable` file. If this file is included in the next dump, the old
    `restoresymtable` file could end up overwriting the one that is being created
    at that time and prevent additional dumps from being restored.
  id: totrans-237
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦文件系统完全还原并验证，我们应该删除`restoresymtable`文件。如果这个文件包含在下一个转储中，旧的`restoresymtable`文件可能会覆盖正在创建的文件，并阻止其他转储的还原。
- en: As the final step, perform a level 0 `dump` of the newly restored file system.
  id: totrans-238
  prefs: []
  type: TYPE_NORMAL
  zh: 作为最后一步，对新还原的文件系统执行级别0的`dump`。
- en: Backing up configurations and logs
  id: totrans-239
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 备份配置和日志
- en: There are two approaches to the backup of configuration data and important log
    files.
  id: totrans-240
  prefs: []
  type: TYPE_NORMAL
  zh: 备份配置数据和重要日志文件有两种方法。
- en: '**Store the data on our backup media:** Using this method, we will back up
    directly to our backup server.'
  id: totrans-241
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**将数据存储在我们的备份介质上：**使用这种方法，我们将直接备份到我们的备份服务器。'
- en: '**Add the data to our backup schedule:** This approach will include the necessary
    files as a part of our user data backup.'
  id: totrans-242
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**将数据添加到我们的备份计划中：**这种方法将包括必要的文件作为我们用户数据备份的一部分。'
- en: Either case is equally valid and is really a matter of personal preference.
  id: totrans-243
  prefs: []
  type: TYPE_NORMAL
  zh: 任何一种情况都是同样有效的，实际上是个人偏好的问题。
- en: 'As a reminder, earlier we made a list of the important parts of the system
    that require backup. These were:'
  id: totrans-244
  prefs: []
  type: TYPE_NORMAL
  zh: 作为提醒，之前我们列出了需要备份的系统重要部分。这些是：
- en: '| Important part of the system | Example command |'
  id: totrans-245
  prefs: []
  type: TYPE_TB
  zh: '|系统的重要部分|示例命令|'
- en: '| --- | --- |'
  id: totrans-246
  prefs: []
  type: TYPE_TB
  zh: '|---|---|'
- en: '| System inventory | `disk_layout.txt` |'
  id: totrans-247
  prefs: []
  type: TYPE_TB
  zh: '|系统清单|`disk_layout.txt`|'
- en: '| List of installed software | `installed_software.txt` |'
  id: totrans-248
  prefs: []
  type: TYPE_TB
  zh: '|已安装软件列表|`installed_software.txt`|'
- en: '| System configuration files | `/etc` |'
  id: totrans-249
  prefs: []
  type: TYPE_TB
  zh: '|系统配置文件|`/etc`|'
- en: '| Authentication data | `/etc/password /etc/groups /etc/shadow` |'
  id: totrans-250
  prefs: []
  type: TYPE_TB
  zh: '|认证数据|`/etc/password /etc/groups /etc/shadow`|'
- en: '| Log files | `/var/log` |'
  id: totrans-251
  prefs: []
  type: TYPE_TB
  zh: '|日志文件|`/var/log`|'
- en: '| Mail queue | `/var/spool/postfix` |'
  id: totrans-252
  prefs: []
  type: TYPE_TB
  zh: '|邮件队列|`/var/spool/postfix`|'
- en: As each system is different, you should ensure that the example commands given
    next cover all the necessary files.
  id: totrans-253
  prefs: []
  type: TYPE_NORMAL
  zh: 由于每个系统都不同，您应该确保下面给出的示例命令涵盖了所有必要的文件。
- en: Transferring configurations and logs to backup media
  id: totrans-254
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 将配置和日志传输到备份介质
- en: 'To keep it simple, we just use the `tar` tool to create an archive of the files
    and directories listed previously, and store it in the same directory as the full
    or incremental dumps on the backup server:'
  id: totrans-255
  prefs: []
  type: TYPE_NORMAL
  zh: 为了简化操作，我们只需使用`tar`工具创建文件和目录的存档，并将其存储在备份服务器上完整或增量转储的相同目录中：
- en: '[PRE22]'
  id: totrans-256
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: Alternatively, we can create the `tar` archive on the `/home` file system and
    have it backed up as part of our normal backup schedule.
  id: totrans-257
  prefs: []
  type: TYPE_NORMAL
  zh: 或者，我们可以在`/home`文件系统上创建`tar`存档，并将其作为我们正常备份计划的一部分进行备份。
- en: '[PRE23]'
  id: totrans-258
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: In both cases, we use the `tar` command with the options `c` to create an archive,
    `z` to compress, and `f` as the output archive name. Also note that we have restricted
    access to the `/home/config` directory as it contains archives with sensitive
    information that should be protected.
  id: totrans-259
  prefs: []
  type: TYPE_NORMAL
  zh: 在这两种情况下，我们使用`tar`命令，选项为`c`创建存档，`z`压缩，`f`作为输出存档名称。还要注意，我们已经限制了对`/home/config`目录的访问，因为它包含了应该受到保护的敏感信息的存档。
- en: For more information on `tar`, please see the system manual pages.
  id: totrans-260
  prefs: []
  type: TYPE_NORMAL
  zh: 有关`tar`的更多信息，请参阅系统手册页。
- en: Restoring the configuration
  id: totrans-261
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 恢复配置
- en: 'Depending on the method used earlier, restoring our configuration and log files
    is relatively simple. We can either copy the required archive from the backup
    server or use the archive directly from `/home/config`. In either case, untarring
    the archive is performed using the following commands:'
  id: totrans-262
  prefs: []
  type: TYPE_NORMAL
  zh: 根据之前使用的方法，恢复我们的配置和日志文件相对简单。我们可以从备份服务器复制所需的存档，或者直接使用`/home/config`中的存档。在任何情况下，解压存档都是使用以下命令执行的：
- en: '[PRE24]'
  id: totrans-263
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: Note that we have created and moved into a temporary directory before expanding
    the archive. If our current directory was `/` when we executed the `tar` command,
    we would have overwritten all the files in `/etc, /var/log`, and `/var/spool/postfix`
    with potentially undesirable results.
  id: totrans-264
  prefs: []
  type: TYPE_NORMAL
  zh: 请注意，在扩展存档之前，我们已经创建并移动到了一个临时目录。如果我们执行`tar`命令时当前目录是`/`，我们将覆盖`/etc、/var/log`和`/var/spool/postfix`中的所有文件，可能会产生不良后果。
- en: Now that we have untarred the archive, we can compare and copy the files we
    need to restore.
  id: totrans-265
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经解压了存档，我们可以比较并复制我们需要恢复的文件。
- en: Automating backups
  id: totrans-266
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 自动化备份
- en: Now that we have seen how to back up our system, we need to put in place an
    automated procedure to remove the drudgery of manually invoking `dump` at regular
    intervals.
  id: totrans-267
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经看到如何备份我们的系统，我们需要建立一个自动化的程序来消除手动调用`dump`的繁琐。
- en: The manual pages for dump do provide some guidance on how often to back up and
    at which level to reduce restoration time.
  id: totrans-268
  prefs: []
  type: TYPE_NORMAL
  zh: 转储的手册页确实提供了一些关于多久进行备份以及在哪个级别减少恢复时间的指导。
- en: '*In the event of a catastrophic disk event, the time required to restore all
    the necessary backup tapes or files to disk can be kept to a minimum by staggering
    the incremental dumps. An efficient method of staggering incremental dumps to
    minimize the number of tapes follows:*'
  id: totrans-269
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: '*在发生灾难性的磁盘事件时，通过错开增量转储的时间，可以将将所有必要的备份磁带或文件恢复到磁盘所需的时间最小化。错开增量转储的有效方法以最小化磁带数量如下：*'
- en: '*Always start with a level 0 backup. This should be done at set intervals,
    say once a month or once every two months, and on a set of fresh tapes that is
    saved forever*.'
  id: totrans-270
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: '*始终从0级备份开始。这应该在固定的时间间隔内进行，比如每个月或每两个月一次，并且使用一组永久保存的新磁带*。'
- en: '*After a level 0, dumps of active file systems are taken on a daily basis,
    using a modified Tower of Hanoi algorithm, with this sequence of dump levels:
    3 2 5 4 7 6 9 8 9 9 . . . For the daily dumps, it should be possible to use a
    fixed number of tapes for each day, used on a weekly basis. Each week, a level
    1 dump is taken, and the daily Hanoi sequence repeats beginning with 3\. For weekly
    dumps, another fixed set of tapes per dumped file system is used, also on a cyclical
    basis*.'
  id: totrans-271
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: '*在进行0级备份后，每天对活动文件系统进行转储，使用修改后的汉诺塔算法，转储级别的顺序为：3 2 5 4 7 6 9 8 9 9 . . . 对于每天的转储，应该可以使用固定数量的磁带，每周使用一次。每周进行1级转储，并且每天的汉诺塔序列从3开始重复。对于每周转储，每个转储的文件系统也使用一组固定的磁带，也是循环使用的*。'
- en: '*After several months or so, the daily and weekly tapes should get rotated
    out of the dump cycle and fresh tapes brought in*.'
  id: totrans-272
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: '*几个月后，每天和每周的磁带应该被从转储周期中移出，并带入新的磁带*。'
- en: This sequence of dumps looks rather bizarre and needs a little more explanation.
    Working through the process will illustrate how we minimize the size of dumps
    taken and reduce the number required to restore.
  id: totrans-273
  prefs: []
  type: TYPE_NORMAL
  zh: 这一系列转储看起来相当奇怪，需要更多的解释。通过这个过程，我们将说明如何最小化转储的大小并减少恢复所需的数量。
- en: Once the level 3 dump is taken, restoration is only a matter of restoring the
    dumps 0 and 3\. After the second day, the level 2 dump will back up everything
    changed since the last dump at a lower level, that is, level 0\. This renders
    the level 3 dump ineffective. The level 5 dump then backs up the changes since
    the level 2 dump. As the sequence progresses using higher and lower levels to
    skip days, previous dumps become ineffective and are no longer required to complete
    a full restore. Each of the dumps should still be retained, in case we need to
    restore individual files deleted by accident at some later time.
  id: totrans-274
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦进行了级别3的转储，恢复只是恢复转储0和3。第二天后，级别2的转储将备份自上次较低级别的转储以来发生的所有更改，即级别0。这使级别3的转储无效。然后，级别5的转储将备份自级别2转储以来的更改。随着序列的进行，使用更高级别和更低级别来跳过天数，以前的转储变得无效，不再需要完成完全恢复。每个转储仍应保留，以防我们需要在以后的某个时间恢复意外删除的单个文件。
- en: By the end of the week, a level 1 dump is performed rendering all the previous
    weeks' dump levels obsolete, and the sequence restarts until the end of the month
    when a new level 0 dump is taken.
  id: totrans-275
  prefs: []
  type: TYPE_NORMAL
  zh: 到了周末，执行级别1的转储，使之前几周的转储级别都变得过时，然后在月底重新开始，进行新的级别0的转储。
- en: 'The following table illustrates which dump levels are taken for each day and
    the number of restorations required to recover the data to the latest version:'
  id: totrans-276
  prefs: []
  type: TYPE_NORMAL
  zh: 以下表格说明了每天采取的转储级别以及恢复数据到最新版本所需的次数：
- en: '| Day of month | Dump level | Restore levels required |'
  id: totrans-277
  prefs: []
  type: TYPE_TB
  zh: '| 日期 | 转储级别 | 需要的恢复级别 |'
- en: '| --- | --- | --- |'
  id: totrans-278
  prefs: []
  type: TYPE_TB
  zh: '| --- | --- | --- |'
- en: '| 1 | 0 | 0 |'
  id: totrans-279
  prefs: []
  type: TYPE_TB
  zh: '| 1 | 0 | 0 |'
- en: '| 2, 9, 16, 23, 30 | 3 | 0, 1*, 3 |'
  id: totrans-280
  prefs: []
  type: TYPE_TB
  zh: '| 2, 9, 16, 23, 30 | 3 | 0, 1*, 3 |'
- en: '| 3, 10, 17, 24, 31 | 2 | 0, 1*, 2 |'
  id: totrans-281
  prefs: []
  type: TYPE_TB
  zh: '| 3, 10, 17, 24, 31 | 2 | 0, 1*, 2 |'
- en: '| 4, 11, 18, 25 | 5 | 0, 1*, 2, 5 |'
  id: totrans-282
  prefs: []
  type: TYPE_TB
  zh: '| 4, 11, 18, 25 | 5 | 0, 1*, 2, 5 |'
- en: '| 5, 12, 19, 26 | 4 | 0, 1*, 2, 4 |'
  id: totrans-283
  prefs: []
  type: TYPE_TB
  zh: '| 5, 12, 19, 26 | 4 | 0, 1*, 2, 4 |'
- en: '| 6, 13, 20, 27 | 7 | 0, 1*, 2, 4, 7 |'
  id: totrans-284
  prefs: []
  type: TYPE_TB
  zh: '| 6, 13, 20, 27 | 7 | 0, 1*, 2, 4, 7 |'
- en: '| 7, 14, 21, 28 | 6 | 0, 1*, 2, 4, 6 |'
  id: totrans-285
  prefs: []
  type: TYPE_TB
  zh: '| 7, 14, 21, 28 | 6 | 0, 1*, 2, 4, 6 |'
- en: '| 8, 15, 22, 29 | 1 | 0,1 |'
  id: totrans-286
  prefs: []
  type: TYPE_TB
  zh: '| 8, 15, 22, 29 | 1 | 0,1 |'
- en: Note
  id: totrans-287
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: During the first week, the level 1 dumps (marked with *) are not required during
    the restoration process. From the eighth day, the level 1 dump is always required.
  id: totrans-288
  prefs: []
  type: TYPE_NORMAL
  zh: 在第一周，级别1的转储（标有*）在恢复过程中不是必需的。从第八天开始，级别1的转储总是必需的。
- en: As we can see from the table, even at the end of a month only a few dumps are
    required to restore our data, rather than several dozen when creating incremental
    daily dumps.
  id: totrans-289
  prefs: []
  type: TYPE_NORMAL
  zh: 从表中我们可以看到，即使在月底，只需要几次转储就可以恢复我们的数据，而不是每天创建增量转储时需要的几十次。
- en: With our monthly backup schedule, a simple script and the addition of some entries
    to `cron` will complete the automated backup process.
  id: totrans-290
  prefs: []
  type: TYPE_NORMAL
  zh: 通过我们的月度备份计划，一个简单的脚本和添加一些条目到`cron`，将完成自动备份过程。
- en: Backup script
  id: totrans-291
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 备份脚本
- en: The following example bash script will archive our system configuration and
    log files, and dump the requested file system to a remote backup server. This
    is only a sample script and should be modified to suit your needs. Any error checking
    and logging has been omitted for clarity.
  id: totrans-292
  prefs: []
  type: TYPE_NORMAL
  zh: 以下示例bash脚本将存档我们的系统配置和日志文件，并将请求的文件系统转储到远程备份服务器。这只是一个示例脚本，应根据您的需求进行修改。为了清晰起见，任何错误检查和日志记录都已省略。
- en: '[PRE25]'
  id: totrans-293
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: The script expects 3 parameters the name of the dump, the partition to be dumped,
    and the dump level.
  id: totrans-294
  prefs: []
  type: TYPE_NORMAL
  zh: 该脚本需要3个参数，转储的名称，要转储的分区和转储级别。
- en: 'The typical usage is as follows:'
  id: totrans-295
  prefs: []
  type: TYPE_NORMAL
  zh: 典型的用法如下：
- en: '[PRE26]'
  id: totrans-296
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: The previous script archives `/etc` each time it runs. You may wish to move
    these commands to a separate script to perform this task weekly or even monthly.
    This is particularly important if the script will be used to dump other file systems
    as well.
  id: totrans-297
  prefs: []
  type: TYPE_NORMAL
  zh: 上一个脚本每次运行都会存档`/etc`。您可能希望将这些命令移到一个单独的脚本中，每周或每月执行此任务。如果脚本将用于转储其他文件系统，则这一点尤为重要。
- en: Old dump files from previous months are not removed by the script and could
    fill up our backup server preventing future backups. It is prudent to put procedures
    in place to either remove or archive old dump files depending on the organization's
    data retention policy.
  id: totrans-298
  prefs: []
  type: TYPE_NORMAL
  zh: 脚本不会删除以前几个月的旧转储文件，这可能会填满我们的备份服务器，从而阻止未来的备份。最好制定程序，根据组织的数据保留政策，删除或存档旧的转储文件。
- en: Adding crontab entries
  id: totrans-299
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 添加crontab条目
- en: Running our backup script automatically each night is just a matter of using
    the entries from our backup schedule table and executing the script to dump the
    correct partition. The following example `crontab` entries execute our script
    each night at 02:10 to dump `/home`. On the first of each month, a level 0 dump
    is performed and then a weekly level 1 dump is performed every seven days after
    that. The other entries implement the modified "Towers of Hanoi" algorithm.
  id: totrans-300
  prefs: []
  type: TYPE_NORMAL
  zh: 每晚自动运行我们的备份脚本只是使用备份计划表中的条目并执行脚本来转储正确的分区。以下示例`crontab`条目每晚在02:10执行我们的脚本来转储`/home`。每个月的第一天，执行级别0的转储，然后每隔七天执行一次每周级别1的转储。其他条目实现了修改后的“汉诺塔”算法。
- en: '[PRE27]'
  id: totrans-301
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: Once our automated backup procedure has been put in place, we need to keep an
    eye out for any errors and verify the integrity of the dump files on the remote
    server.
  id: totrans-302
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦我们的自动备份程序就位，我们需要密切关注任何错误，并验证远程服务器上转储文件的完整性。
- en: Verifying restoration procedures
  id: totrans-303
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 验证恢复程序
- en: Even with the best planning in the world, things go wrong and always at the
    most inconvenient moment.
  id: totrans-304
  prefs: []
  type: TYPE_NORMAL
  zh: 即使做了最好的计划，事情也会出错，而且总是在最不方便的时候。
- en: Taking a proactive approach to disaster recovery with good planning and practice
    will highlight any problems at an early stage before it is too late. Verifying
    the integrity of system backups is only really possible by restoring them and
    checking that the restored system is fully operational.
  id: totrans-305
  prefs: []
  type: TYPE_NORMAL
  zh: 采取积极的灾难恢复方法，进行良好的规划和实践，将在太迟之前就能发现任何问题。验证系统备份的完整性只有通过恢复它们并检查恢复的系统是否完全可操作才是真正可能的。
- en: You should ask yourself questions such as, "What actions are necessary if the
    remote server fails?" Do you repair the backup server first or switch to another
    server to reduce the size of the window without backups? If the mail server fails,
    are you familiar with the restoration procedures? Is replacement hardware available
    at short notice, for example, on a Sunday?
  id: totrans-306
  prefs: []
  type: TYPE_NORMAL
  zh: 您应该问自己一些问题，比如，“如果远程服务器出现故障，需要采取哪些措施？”您是先修复备份服务器还是切换到另一台服务器以减小没有备份的时间窗口？如果邮件服务器出现故障，您是否熟悉恢复程序？例如，是否可以在短时间内获得替换硬件，比如在星期天？
- en: There are many horror stories of administrators diligently taking backups only
    to find that when required the backups are useless because of a tape drive error
    or a minor syntax error in the backup script that overwrites valid dump files
    with bad data.
  id: totrans-307
  prefs: []
  type: TYPE_NORMAL
  zh: 有许多管理员勤奋地进行备份，却发现在需要时备份无用，因为磁带驱动器错误或备份脚本中的轻微语法错误覆盖了有效的转储文件，导致数据损坏。
- en: Invent scenarios for yourself and practice a full bare metal restore on spare
    hardware, or the recovery of an individual users' e-mail.
  id: totrans-308
  prefs: []
  type: TYPE_NORMAL
  zh: 为自己构想情景，并在备用硬件上练习完全裸金属恢复，或者恢复单个用户的电子邮件。
- en: Verifying that your restoration procedures work will give you the confidence
    that you can recover from data loss.
  id: totrans-309
  prefs: []
  type: TYPE_NORMAL
  zh: 验证恢复程序是否有效将使您相信您可以从数据丢失中恢复过来。
- en: Summary
  id: totrans-310
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 总结
- en: In this chapter, we described how to back up e-mail and the mail server configuration.
    We started off with an introduction to what you should consider worth backing
    up and ended with a sophisticated solution using automated full and incremental
    backups.
  id: totrans-311
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们描述了如何备份电子邮件和邮件服务器配置。我们从介绍应该考虑备份的内容开始，最后使用自动完全和增量备份的复杂解决方案结束。
- en: In particular, we described the process using the `dump` command, and how to
    take copies of our data. We used the `restore` command to recover a complete file
    system and selective files.
  id: totrans-312
  prefs: []
  type: TYPE_NORMAL
  zh: 特别是，我们描述了使用`dump`命令的过程，以及如何复制我们的数据。我们使用`restore`命令来恢复完整的文件系统和选择性文件。
- en: This chapter guides you through the process of backing up and restoring your
    server's precious data. It shows why to back up, what data to back up, the different
    backup and restore methods, and a procedure to take automatic daily backups.
  id: totrans-313
  prefs: []
  type: TYPE_NORMAL
  zh: 本章指导您备份和恢复服务器宝贵数据的过程。它展示了为什么要备份，备份哪些数据，不同的备份和恢复方法，以及进行自动每日备份的程序。
- en: After implementing all the procedures we have shown you in this chapter, you
    will sleep a lot better and, in any case, your users will love the range and functionality
    your system can offer.
  id: totrans-314
  prefs: []
  type: TYPE_NORMAL
  zh: 在实施本章中向您展示的所有程序之后，您将睡得更香甜，而且无论如何，您的用户都会喜欢系统所能提供的范围和功能。
